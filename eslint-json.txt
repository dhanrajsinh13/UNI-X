[{"filePath":"C:\\Projects\\UNI-X\\__tests__\\lib\\auth.test.ts","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":64,"column":19,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":64,"endColumn":42}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { hashPassword, verifyPassword, generateToken, verifyToken } from '@/lib/auth'\r\n\r\ndescribe('Authentication Library', () => {\r\n  describe('Password Hashing', () => {\r\n    it('should hash a password successfully', async () => {\r\n      const password = 'TestPassword123!'\r\n      const hashed = await hashPassword(password)\r\n      \r\n      expect(hashed).toBeDefined()\r\n      expect(hashed).not.toBe(password)\r\n      expect(hashed.length).toBeGreaterThan(20)\r\n    })\r\n    \r\n    it('should reject passwords shorter than 8 characters', async () => {\r\n      await expect(hashPassword('short')).rejects.toThrow('Password must be at least 8 characters')\r\n    })\r\n    \r\n    it('should verify correct password', async () => {\r\n      const password = 'TestPassword123!'\r\n      const hashed = await hashPassword(password)\r\n      const isValid = await verifyPassword(password, hashed)\r\n      \r\n      expect(isValid).toBe(true)\r\n    })\r\n    \r\n    it('should reject incorrect password', async () => {\r\n      const password = 'TestPassword123!'\r\n      const hashed = await hashPassword(password)\r\n      const isValid = await verifyPassword('WrongPassword123!', hashed)\r\n      \r\n      expect(isValid).toBe(false)\r\n    })\r\n  })\r\n  \r\n  describe('JWT Token Operations', () => {\r\n    it('should generate a valid JWT token', () => {\r\n      const userId = 123\r\n      const token = generateToken(userId)\r\n      \r\n      expect(token).toBeDefined()\r\n      expect(typeof token).toBe('string')\r\n      expect(token.split('.')).toHaveLength(3) // JWT has 3 parts\r\n    })\r\n    \r\n    it('should verify a valid token', () => {\r\n      const userId = 456\r\n      const token = generateToken(userId)\r\n      const decoded = verifyToken(token)\r\n      \r\n      expect(decoded).toBeDefined()\r\n      expect(decoded?.userId).toBe(userId)\r\n      expect(decoded?.jti).toBeDefined()\r\n    })\r\n    \r\n    it('should reject an invalid token', () => {\r\n      const invalidToken = 'invalid.token.here'\r\n      const decoded = verifyToken(invalidToken)\r\n      \r\n      expect(decoded).toBeNull()\r\n    })\r\n    \r\n    it('should reject a token with wrong secret', () => {\r\n      // Create token with different secret\r\n      const jwt = require('jsonwebtoken')\r\n      const token = jwt.sign({ userId: 789 }, 'wrong-secret', { expiresIn: '1h' })\r\n      const decoded = verifyToken(token)\r\n      \r\n      expect(decoded).toBeNull()\r\n    })\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\__tests__\\lib\\validation.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'validateInteger' is defined but never used.","line":6,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  isValidEmail,\r\n  isStrongPassword,\r\n  sanitizeString,\r\n  validateUsername,\r\n  validateInteger,\r\n  sanitizeMongoQuery,\r\n  isValidUrl,\r\n  validatePrivacySettings\r\n} from '@/lib/validation'\r\n\r\ndescribe('Validation Library', () => {\r\n  describe('Email Validation', () => {\r\n    it('should validate correct email addresses', () => {\r\n      expect(isValidEmail('user@example.com')).toBe(true)\r\n      expect(isValidEmail('test.user@domain.co.uk')).toBe(true)\r\n      expect(isValidEmail('user+tag@example.com')).toBe(true)\r\n    })\r\n    \r\n    it('should reject invalid email addresses', () => {\r\n      expect(isValidEmail('invalid')).toBe(false)\r\n      expect(isValidEmail('user@')).toBe(false)\r\n      expect(isValidEmail('@example.com')).toBe(false)\r\n      expect(isValidEmail('')).toBe(false)\r\n    })\r\n  })\r\n  \r\n  describe('Password Strength', () => {\r\n    it('should validate strong passwords', () => {\r\n      const result = isStrongPassword('StrongP@ss123')\r\n      expect(result.valid).toBe(true)\r\n    })\r\n    \r\n    it('should reject weak passwords', () => {\r\n      expect(isStrongPassword('short').valid).toBe(false)\r\n      expect(isStrongPassword('nouppercase123').valid).toBe(false)\r\n      expect(isStrongPassword('NOLOWERCASE123').valid).toBe(false)\r\n      expect(isStrongPassword('NoNumbers!').valid).toBe(false)\r\n    })\r\n  })\r\n  \r\n  describe('String Sanitization', () => {\r\n    it('should remove HTML tags', () => {\r\n      const input = '<script>alert(\"xss\")</script>Hello'\r\n      const sanitized = sanitizeString(input)\r\n      expect(sanitized).not.toContain('<script>')\r\n      expect(sanitized).toContain('Hello')\r\n    })\r\n    \r\n    it('should remove javascript: protocol', () => {\r\n      const input = 'javascript:alert(1)'\r\n      const sanitized = sanitizeString(input)\r\n      expect(sanitized).not.toContain('javascript:')\r\n    })\r\n    \r\n    it('should respect max length', () => {\r\n      const input = 'a'.repeat(2000)\r\n      const sanitized = sanitizeString(input, 100)\r\n      expect(sanitized.length).toBeLessThanOrEqual(100)\r\n    })\r\n  })\r\n  \r\n  describe('Username Validation', () => {\r\n    it('should validate correct usernames', () => {\r\n      const result = validateUsername('john_doe')\r\n      expect(result.valid).toBe(true)\r\n      expect(result.sanitized).toBe('john_doe')\r\n    })\r\n    \r\n    it('should reject invalid usernames', () => {\r\n      expect(validateUsername('ab').valid).toBe(false) // too short\r\n      expect(validateUsername('a'.repeat(50)).valid).toBe(false) // too long\r\n      expect(validateUsername('user@name').valid).toBe(false) // invalid chars\r\n    })\r\n    \r\n    it('should sanitize username to lowercase', () => {\r\n      const result = validateUsername('JohnDoe')\r\n      expect(result.valid).toBe(true)\r\n      expect(result.sanitized).toBe('johndoe')\r\n    })\r\n  })\r\n  \r\n  describe('MongoDB Query Sanitization', () => {\r\n    it('should remove $ operators from user input', () => {\r\n      const malicious = { $where: 'malicious code' }\r\n      const sanitized = sanitizeMongoQuery(malicious)\r\n      expect(sanitized.$where).toBeUndefined()\r\n    })\r\n    \r\n    it('should preserve safe values', () => {\r\n      const safe = { username: 'john', age: 25 }\r\n      const sanitized = sanitizeMongoQuery(safe)\r\n      expect(sanitized.username).toBe('john')\r\n      expect(sanitized.age).toBe(25)\r\n    })\r\n  })\r\n  \r\n  describe('URL Validation', () => {\r\n    it('should validate HTTP and HTTPS URLs', () => {\r\n      expect(isValidUrl('https://example.com')).toBe(true)\r\n      expect(isValidUrl('http://example.com')).toBe(true)\r\n    })\r\n    \r\n    it('should reject invalid protocols', () => {\r\n      expect(isValidUrl('javascript:alert(1)')).toBe(false)\r\n      expect(isValidUrl('ftp://example.com')).toBe(false)\r\n    })\r\n  })\r\n  \r\n  describe('Privacy Settings Validation', () => {\r\n    it('should validate correct privacy settings', () => {\r\n      const settings = {\r\n        is_private: true,\r\n        show_online_status: false,\r\n        who_can_message: 'followers'\r\n      }\r\n      const result = validatePrivacySettings(settings)\r\n      expect(result.valid).toBe(true)\r\n    })\r\n    \r\n    it('should reject invalid who_can_message values', () => {\r\n      const settings = { who_can_message: 'invalid' }\r\n      const result = validatePrivacySettings(settings)\r\n      expect(result.valid).toBe(false)\r\n    })\r\n    \r\n    it('should reject non-boolean values for boolean fields', () => {\r\n      const settings = { is_private: 'yes' }\r\n      const result = validatePrivacySettings(settings)\r\n      expect(result.valid).toBe(false)\r\n    })\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\create-post\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\landing\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\messages\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'memo' is defined but never used.","line":4,"column":78,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":82},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isConnected' is assigned a value but never used.","line":57,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":57,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'leaveConversation' is assigned a value but never used.","line":57,"column":50,"nodeType":null,"messageId":"unusedVar","endLine":57,"endColumn":67},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1759,1762],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1759,1762],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'messagesLoading' is assigned a value but never used.","line":66,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":66,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'lastRefreshAtRef' is assigned a value but never used.","line":78,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":78,"endColumn":25},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'refreshTimeoutRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'refreshTimeoutRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":115,"column":40,"nodeType":"Identifier","endLine":115,"endColumn":47},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadConversations'. Either include it or remove the dependency array.","line":121,"column":6,"nodeType":"ArrayExpression","endLine":121,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [user, token, loadConversations]","fix":{"range":[4284,4297],"text":"[user, token, loadConversations]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4856,4859],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4856,4859],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4879,4882],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4879,4882],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":143,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5275,5278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5275,5278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":239,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":239,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":240,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":240,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":241,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":241,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":242,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":242,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":243,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":243,"endColumn":34},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'user'. Either include it or remove the dependency array.","line":245,"column":6,"nodeType":"ArrayExpression","endLine":245,"endColumn":120,"suggestions":[{"desc":"Update the dependencies array to be: [socket, activeConversation, user.id, onNewMessage, onTyping, onStoppedTyping, onMessageUnsent, onMessageDeleted, user]","fix":{"range":[9308,9422],"text":"[socket, activeConversation, user.id, onNewMessage, onTyping, onStoppedTyping, onMessageUnsent, onMessageDeleted, user]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'handleConversationClick' and 'startNewConversation'. Either include them or remove the dependency array.","line":317,"column":6,"nodeType":"ArrayExpression","endLine":317,"endColumn":55,"suggestions":[{"desc":"Update the dependencies array to be: [searchParams, user, conversations, isMobileView, handleConversationClick, startNewConversation]","fix":{"range":[12113,12162],"text":"[searchParams, user, conversations, isMobileView, handleConversationClick, startNewConversation]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":334,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":334,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12804,12807],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12804,12807],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":355,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":355,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13595,13598],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13595,13598],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":357,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":357,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13626,13629],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13626,13629],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":360,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":360,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13785,13788],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13785,13788],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":361,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":361,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13831,13834],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13831,13834],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":363,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":363,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13874,13877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13874,13877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":364,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":364,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13904,13907],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13904,13907],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":364,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":364,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13940,13943],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13940,13943],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":372,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":372,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14223,14226],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14223,14226],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":372,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":372,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14237,14240],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14237,14240],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":375,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":375,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14396,14399],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14396,14399],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":388,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":388,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15007,15010],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15007,15010],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":405,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":405,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15600,15603],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15600,15603],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":428,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":428,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16364,16367],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16364,16367],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":538,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":538,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19931,19934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19931,19934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":728,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":728,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25671,25674],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25671,25674],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":764,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":764,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26819,26822],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26819,26822],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":794,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":794,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27664,27667],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27664,27667],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":825,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":825,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28610,28613],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28610,28613],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":1129,"column":48,"nodeType":null,"messageId":"unusedVar","endLine":1129,"endColumn":53}],"suppressedMessages":[],"errorCount":23,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport Image from 'next/image'\r\nimport React, { useState, useRef, useEffect, useMemo, Suspense, useCallback, memo } from 'react';\r\nimport { useSearchParams } from 'next/navigation';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport { useSocket } from '../../contexts/SocketContext';\r\nimport { fetchAPI, dataFetcher } from '../../lib/dataFetcher';\r\n\r\ninterface Conversation {\r\n  conversationId: string;\r\n  otherUser: {\r\n    id: number;\r\n    name: string;\r\n    profile_image: string | null;\r\n  };\r\n  lastMessage: {\r\n    id: number;\r\n    text: string;\r\n    mediaUrl: string | null;\r\n    createdAt: string;\r\n    senderId: number;\r\n    isFromMe: boolean;\r\n  };\r\n  unreadCount: number;\r\n}\r\n\r\ninterface Message {\r\n  id: number;\r\n  senderId: number;\r\n  receiverId: number;\r\n  messageText: string;\r\n  mediaUrl: string | null;\r\n  createdAt: string;\r\n  sender: {\r\n    id: number;\r\n    name: string;\r\n    profile_image: string | null;\r\n  };\r\n  receiver: {\r\n    id: number;\r\n    name: string;\r\n    profile_image: string | null;\r\n  };\r\n  clientId?: string;\r\n  reaction?: string | null;\r\n  replyTo?: {\r\n    id: number;\r\n    text: string;\r\n    senderName: string;\r\n  } | null;\r\n  deleted_for?: number[];\r\n}\r\n\r\nconst MessagesPageInner = () => {\r\n  const { user, token } = useAuth();\r\n  const { socket, isConnected, joinConversation, leaveConversation, startTyping, stopTyping, onNewMessage, onMessageUnsent, onMessageDeleted, onTyping, onStoppedTyping, sendMessage } = useSocket();\r\n  const searchParams = useSearchParams();\r\n\r\n  const [conversations, setConversations] = useState<Conversation[]>([]);\r\n  const [activeConversation, setActiveConversation] = useState<string | null>(null);\r\n  const [activeOtherUser, setActiveOtherUser] = useState<any>(null);\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [input, setInput] = useState('');\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [messagesLoading, setMessagesLoading] = useState(false);\r\n  const [isMobileView, setIsMobileView] = useState(false);\r\n  const [showConversations, setShowConversations] = useState(true);\r\n  const [typingUsers, setTypingUsers] = useState<{ userId: number; userName: string }[]>([]);\r\n  const [openDropdown, setOpenDropdown] = useState<string | null>(null);\r\n  const [selectedMessageId, setSelectedMessageId] = useState<number | null>(null);\r\n  const [replyingTo, setReplyingTo] = useState<{ id: number; text: string; senderName: string } | null>(null);\r\n  const [showEmojiPicker, setShowEmojiPicker] = useState<number | null>(null);\r\n  const [dropdownPosition, setDropdownPosition] = useState<{ [key: number]: 'top' | 'bottom' }>({});\r\n  const convFetchControllerRef = useRef<AbortController | null>(null);\r\n  const msgsFetchControllerRef = useRef<AbortController | null>(null);\r\n  const refreshTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const lastRefreshAtRef = useRef<number>(0);\r\n  const messageActionsRef = useRef<HTMLDivElement>(null);\r\n  const emojiPickerRef = useRef<HTMLDivElement>(null);\r\n  const [showConfirmModal, setShowConfirmModal] = useState<{\r\n    isOpen: boolean;\r\n    action: 'delete' | 'block' | null;\r\n    conversationId: string | null;\r\n    otherUserName: string;\r\n  }>({\r\n    isOpen: false,\r\n    action: null,\r\n    conversationId: null,\r\n    otherUserName: ''\r\n  });\r\n\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const dropdownRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Find current conversation data\r\n  const currentConversation = useMemo(() => conversations.find(conv => conv.conversationId === activeConversation), [conversations, activeConversation]);\r\n\r\n  // Load conversations on mount\r\n  useEffect(() => {\r\n    if (user && token) {\r\n      loadConversations();\r\n    }\r\n\r\n    // Cleanup function\r\n    return () => {\r\n      if (convFetchControllerRef.current) {\r\n        convFetchControllerRef.current.abort();\r\n      }\r\n      if (msgsFetchControllerRef.current) {\r\n        msgsFetchControllerRef.current.abort();\r\n      }\r\n      if (refreshTimeoutRef.current) {\r\n        clearTimeout(refreshTimeoutRef.current);\r\n      }\r\n      if (typingTimeoutRef.current) {\r\n        clearTimeout(typingTimeoutRef.current);\r\n      }\r\n    };\r\n  }, [user, token]);\r\n\r\n  // Socket event listeners\r\n  useEffect(() => {\r\n    if (!socket) return;\r\n    const offNew = onNewMessage((messageData: Message) => {\r\n      const convId = [messageData.senderId, messageData.receiverId].sort().join('-');\r\n      if (activeConversation && convId === activeConversation) {\r\n        setMessages(prev => {\r\n          // 1) exact id dedupe\r\n          if (prev.some(m => m.id === messageData.id)) return prev;\r\n          // 2) clientId reconciliation\r\n          if (messageData.clientId) {\r\n            const idx = prev.findIndex(m => (m as any).clientId && (m as any).clientId === messageData.clientId);\r\n            if (idx !== -1) {\r\n              const copy = [...prev];\r\n              copy[idx] = { ...messageData };\r\n              return copy;\r\n            }\r\n          }\r\n          // 3) fallback for my own last optimistic\r\n          if (user && messageData.senderId === user.id && prev.length > 0) {\r\n            const last = prev[prev.length - 1] as any;\r\n            const sameContent = last?.messageText === messageData.messageText && last?.receiverId === messageData.receiverId;\r\n            const recent = Math.abs(new Date(messageData.createdAt).getTime() - new Date(last?.createdAt || 0).getTime()) < 5000;\r\n            const looksOptimistic = !!last?.clientId || (typeof last?.id === 'number' && last.id < 0);\r\n            if (sameContent && recent && looksOptimistic) {\r\n              const copy = [...prev];\r\n              copy[copy.length - 1] = { ...messageData };\r\n              return copy;\r\n            }\r\n          }\r\n          return [...prev, messageData];\r\n        });\r\n      }\r\n      setConversations(prev => {\r\n        const idx = prev.findIndex(c => c.conversationId === convId);\r\n        const updated: Conversation = {\r\n          conversationId: convId,\r\n          otherUser: idx >= 0 ? prev[idx].otherUser : {\r\n            id: messageData.senderId === user?.id ? messageData.receiver.id : messageData.sender.id,\r\n            name: messageData.senderId === user?.id ? messageData.receiver.name : messageData.sender.name,\r\n            profile_image: messageData.senderId === user?.id ? messageData.receiver.profile_image : messageData.sender.profile_image,\r\n          },\r\n          lastMessage: {\r\n            id: messageData.id,\r\n            text: messageData.messageText,\r\n            mediaUrl: messageData.mediaUrl,\r\n            createdAt: messageData.createdAt,\r\n            senderId: messageData.senderId,\r\n            isFromMe: messageData.senderId === user?.id,\r\n          },\r\n          unreadCount: (activeConversation && convId === activeConversation) ? 0 : (idx >= 0 ? (prev[idx].unreadCount + 1) : 1),\r\n        };\r\n\r\n        // Only update if conversation doesn't exist or last message changed\r\n        if (idx === -1) {\r\n          return [updated, ...prev];\r\n        }\r\n\r\n        const existing = prev[idx];\r\n        if (existing.lastMessage?.id === messageData.id &&\r\n          existing.lastMessage?.text === messageData.messageText) {\r\n          return prev; // No change needed\r\n        }\r\n\r\n        const copy = [...prev];\r\n        copy.splice(idx, 1);\r\n        return [updated, ...copy];\r\n      });\r\n\r\n      // No need to refresh conversations - we're updating them in real-time above\r\n    });\r\n    const offTyping = onTyping((data: { userId: number; userName: string }) => {\r\n      setTypingUsers(prev => {\r\n        const exists = prev.find(u => u.userId === data.userId);\r\n        if (!exists) {\r\n          return [...prev, data];\r\n        }\r\n        return prev;\r\n      });\r\n    });\r\n    const offStopped = onStoppedTyping((data: { userId: number }) => {\r\n      setTypingUsers(prev => prev.filter(u => u.userId !== data.userId));\r\n    });\r\n\r\n    // Listen for message unsent events\r\n    const offUnsent = onMessageUnsent((data: { messageId: number }) => {\r\n      console.log('Message unsent event received:', data.messageId);\r\n      setMessages(prev => prev.filter(msg => msg.id !== data.messageId));\r\n\r\n      // Update conversation last message if needed\r\n      setConversations(prev => prev.map(conv => {\r\n        if (conv.lastMessage?.id === data.messageId) {\r\n          return {\r\n            ...conv,\r\n            lastMessage: {\r\n              ...conv.lastMessage,\r\n              text: 'This message was unsent',\r\n              mediaUrl: null\r\n            }\r\n          };\r\n        }\r\n        return conv;\r\n      }));\r\n    });\r\n\r\n    // Listen for message deleted events (for current user only)\r\n    const offDeleted = onMessageDeleted((data: { messageId: number }) => {\r\n      console.log('Message deleted event received:', data.messageId);\r\n      setMessages(prev => prev.map(msg =>\r\n        msg.id === data.messageId\r\n          ? { ...msg, deleted_for: [...(msg.deleted_for || []), user?.id || 0] }\r\n          : msg\r\n      ));\r\n    });\r\n\r\n    return () => {\r\n      offNew && offNew();\r\n      offTyping && offTyping();\r\n      offStopped && offStopped();\r\n      offUnsent && offUnsent();\r\n      offDeleted && offDeleted();\r\n    };\r\n  }, [socket, activeConversation, user?.id, onNewMessage, onTyping, onStoppedTyping, onMessageUnsent, onMessageDeleted]);\r\n\r\n  // Scroll to bottom of messages (only for new messages)\r\n  const prevMessagesLengthRef = useRef(messages.length);\r\n  useEffect(() => {\r\n    if (messages.length > prevMessagesLengthRef.current) {\r\n      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n    }\r\n    prevMessagesLengthRef.current = messages.length;\r\n  }, [messages.length]);\r\n\r\n  // Check if mobile view\r\n  useEffect(() => {\r\n    const handleResize = () => {\r\n      setIsMobileView(window.innerWidth < 768);\r\n    };\r\n\r\n    handleResize();\r\n    window.addEventListener('resize', handleResize);\r\n    return () => window.removeEventListener('resize', handleResize);\r\n  }, []);\r\n\r\n  // Handle clicks outside dropdown to close it\r\n  useEffect(() => {\r\n    const handleClickOutside = (event: MouseEvent) => {\r\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\r\n        setOpenDropdown(null);\r\n      }\r\n      if (messageActionsRef.current && !messageActionsRef.current.contains(event.target as Node)) {\r\n        // Don't close if clicking inside emoji picker\r\n        if (emojiPickerRef.current && emojiPickerRef.current.contains(event.target as Node)) {\r\n          return;\r\n        }\r\n        setSelectedMessageId(null);\r\n        setShowEmojiPicker(null);\r\n      }\r\n      // Close emoji picker if clicking outside\r\n      if (emojiPickerRef.current && !emojiPickerRef.current.contains(event.target as Node)) {\r\n        setShowEmojiPicker(null);\r\n      }\r\n    };\r\n\r\n    document.addEventListener('mousedown', handleClickOutside);\r\n    return () => document.removeEventListener('mousedown', handleClickOutside);\r\n  }, []);\r\n\r\n  // Handle user query parameter (from profile message button)\r\n  // Accept either ?user=<id> or ?userId=<id> so calls work consistently\r\n  useEffect(() => {\r\n    const rawUserId = searchParams?.get('user') || searchParams?.get('userId');\r\n    if (rawUserId && user) {\r\n      const otherUserId = parseInt(rawUserId);\r\n      if (isNaN(otherUserId) || otherUserId === user.id) return;\r\n\r\n      const conversationId = [user.id, otherUserId].sort().join('-');\r\n\r\n      // Check if conversation already exists\r\n      const existingConversation = conversations.find(conv => conv.conversationId === conversationId);\r\n\r\n      if (existingConversation) {\r\n        // Open existing conversation\r\n        handleConversationClick(existingConversation);\r\n      } else {\r\n        // Start new conversation - we'll need to fetch user details first\r\n        startNewConversation(otherUserId);\r\n      }\r\n\r\n      // Hide conversations panel on mobile when a conversation is opened\r\n      if (isMobileView) {\r\n        setShowConversations(false);\r\n      }\r\n    }\r\n  }, [searchParams, user, conversations, isMobileView]);\r\n\r\n  const loadConversations = useCallback(async (isBackground: boolean = false) => {\r\n    if (!token) return;\r\n    if (convFetchControllerRef.current) {\r\n      try { convFetchControllerRef.current.abort(); } catch { }\r\n    }\r\n    const controller = new AbortController();\r\n    convFetchControllerRef.current = controller;\r\n    try {\r\n      const data = await fetchAPI('/api/messages/conversations', {\r\n        token,\r\n        cacheTTL: 10000, // 10 seconds cache for conversations\r\n        signal: controller.signal\r\n      }) as { conversations: Conversation[] };\r\n\r\n      setConversations(data.conversations || []);\r\n    } catch (error: any) {\r\n      if (error?.name === 'AbortError') return;\r\n      console.error('Error loading conversations:', error);\r\n    } finally {\r\n      if (!isBackground) setIsLoading(false);\r\n    }\r\n  }, [token]);\r\n\r\n  const loadMessages = useCallback(async (otherUserId: number) => {\r\n    if (!token) return;\r\n    if (msgsFetchControllerRef.current) {\r\n      try { msgsFetchControllerRef.current.abort(); } catch { }\r\n    }\r\n    const controller = new AbortController();\r\n    msgsFetchControllerRef.current = controller;\r\n    setMessagesLoading(true);\r\n    try {\r\n      const data = await fetchAPI(`/api/messages/conversation/${otherUserId}`, {\r\n        token,\r\n        cacheTTL: 5000, // 5 seconds cache for messages\r\n        signal: controller.signal\r\n      }) as { messages: Message[]; otherUser: any };\r\n\r\n      const fetched: any[] = data.messages || [];\r\n      setMessages(prev => {\r\n        if (!prev || prev.length === 0) return fetched;\r\n        const byClientId = new Map<string, any>();\r\n        const byId = new Map<number, any>();\r\n\r\n        for (const m of prev as any[]) {\r\n          if ((m as any).clientId) byClientId.set((m as any).clientId, m);\r\n          byId.set(m.id, m);\r\n        }\r\n\r\n        const merged = [...prev];\r\n        for (const fm of fetched) {\r\n          if (byId.has(fm.id)) continue;\r\n          if (fm.clientId && byClientId.has(fm.clientId)) {\r\n            const idx = merged.findIndex((m: any) => (m as any).clientId === fm.clientId);\r\n            if (idx !== -1) { merged[idx] = fm; continue; }\r\n          }\r\n          const last = merged[merged.length - 1] as any;\r\n          const sameContent = last?.messageText === fm.messageText && last?.receiverId === fm.receiverId;\r\n          const looksOptimistic = !!last?.clientId || (typeof last?.id === 'number' && last.id < 0);\r\n          const recent = Math.abs(new Date(fm.createdAt).getTime() - new Date(last?.createdAt || 0).getTime()) < 5000;\r\n          if (sameContent && looksOptimistic && recent) {\r\n            merged[merged.length - 1] = fm;\r\n          } else {\r\n            merged.push(fm);\r\n          }\r\n        }\r\n        return merged;\r\n      });\r\n      setActiveOtherUser(data.otherUser);\r\n    } catch (error: any) {\r\n      if (error?.name === 'AbortError') return;\r\n      console.error('Error loading messages:', error);\r\n    } finally {\r\n      setMessagesLoading(false);\r\n    }\r\n  }, [token]);\r\n\r\n  const handleSendMessage = useCallback(async () => {\r\n    if (!input.trim() || !activeOtherUser || !user) return;\r\n\r\n    // Capture the current input value before any state updates\r\n    const messageText = input.trim();\r\n    const clientId = `${user.id}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;\r\n\r\n    console.log('Sending message:', messageText); // Debug log\r\n\r\n    const optimistic: any = {\r\n      id: -Date.now(),\r\n      senderId: user.id,\r\n      receiverId: activeOtherUser.id,\r\n      messageText,\r\n      mediaUrl: null,\r\n      createdAt: new Date().toISOString(),\r\n      sender: { id: user.id, name: user.name, profile_image: null },\r\n      receiver: { id: activeOtherUser.id, name: activeOtherUser.name, profile_image: activeOtherUser.profile_image || null },\r\n      clientId,\r\n      replyTo: replyingTo ? {\r\n        id: replyingTo.id,\r\n        text: replyingTo.text,\r\n        senderName: replyingTo.senderName\r\n      } : null,\r\n    };\r\n\r\n    // Clear input immediately to prevent double-send\r\n    setInput('');\r\n    setReplyingTo(null);\r\n\r\n    setMessages(prev => {\r\n      const now = Date.now();\r\n      const last = prev[prev.length - 1] as any;\r\n      const sameContent = last?.messageText === messageText && last?.receiverId === activeOtherUser.id && last?.senderId === user.id;\r\n      const recent = Math.abs(now - new Date(last?.createdAt || 0).getTime()) < 2000;\r\n      if (sameContent && recent) return prev;\r\n      return [...prev, optimistic];\r\n    });\r\n\r\n    sendMessage({\r\n      receiverId: activeOtherUser.id,\r\n      messageText,\r\n      clientId,\r\n      replyToId: replyingTo?.id || null\r\n    });\r\n\r\n    stopTyping(activeOtherUser.id, user.id);\r\n  }, [input, activeOtherUser, user, replyingTo, sendMessage, stopTyping]);\r\n\r\n  const handleKeyPress = useCallback((e: React.KeyboardEvent) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSendMessage();\r\n    }\r\n  }, [handleSendMessage]);\r\n\r\n  const handleTyping = useCallback((value: string) => {\r\n    console.log('Input changed to:', value); // Debug log\r\n    setInput(value);\r\n\r\n    if (!user || !activeOtherUser) return;\r\n\r\n    // Clear existing timeout\r\n    if (typingTimeoutRef.current) {\r\n      clearTimeout(typingTimeoutRef.current);\r\n    }\r\n\r\n    // Start typing indicator\r\n    if (value.trim()) {\r\n      startTyping(activeOtherUser.id, user.id, user.name);\r\n\r\n      // Stop typing after 2 seconds of inactivity\r\n      typingTimeoutRef.current = setTimeout(() => {\r\n        stopTyping(activeOtherUser.id, user.id);\r\n      }, 2000);\r\n    } else {\r\n      stopTyping(activeOtherUser.id, user.id);\r\n    }\r\n  }, [user, activeOtherUser, startTyping, stopTyping]);\r\n\r\n  const formatTimestamp = useCallback((dateString: string) => {\r\n    if (!dateString) return '';\r\n\r\n    const date = new Date(dateString);\r\n    if (isNaN(date.getTime())) return '';\r\n\r\n    const now = new Date();\r\n    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);\r\n\r\n    // Less than 15 seconds\r\n    if (diffInSeconds < 15) {\r\n      return 'now';\r\n    }\r\n    // 15-59 seconds: show seconds in 5-second increments\r\n    else if (diffInSeconds < 60) {\r\n      const seconds = Math.floor(diffInSeconds / 5) * 5; // Round down to nearest 5\r\n      return `${seconds}s`;\r\n    }\r\n    // 1-59 minutes: show minutes\r\n    else if (diffInSeconds < 3600) {\r\n      const minutes = Math.floor(diffInSeconds / 60);\r\n      return `${minutes}m`;\r\n    }\r\n    // 1-23 hours: show hours\r\n    else if (diffInSeconds < 86400) {\r\n      const hours = Math.floor(diffInSeconds / 3600);\r\n      return `${hours}h`;\r\n    }\r\n    // 1+ days: show days\r\n    else {\r\n      const days = Math.floor(diffInSeconds / 86400);\r\n      return `${days}d`;\r\n    }\r\n  }, []);\r\n\r\n  const handleConversationClick = useCallback((conversation: Conversation) => {\r\n    const convId = conversation.conversationId;\r\n\r\n    // Clear old messages immediately to prevent showing wrong conversation\r\n    setMessages([]);\r\n    setActiveConversation(convId);\r\n    setActiveOtherUser(conversation.otherUser);\r\n\r\n    // Join the conversation room\r\n    joinConversation(conversation.otherUser.id);\r\n\r\n    // Load messages for this conversation\r\n    loadMessages(conversation.otherUser.id);\r\n\r\n    if (isMobileView) {\r\n      setShowConversations(false);\r\n    }\r\n  }, [joinConversation, loadMessages, isMobileView]);\r\n\r\n  const startNewConversation = useCallback(async (otherUserId: number) => {\r\n    if (!user || !token) return;\r\n\r\n    try {\r\n      // Fetch user details for the new conversation\r\n      const data = await fetchAPI(`/api/users/${otherUserId}`, {\r\n        token: token || '',\r\n        cacheTTL: 60000 // 60 seconds cache for user details\r\n      }) as { user: any };\r\n\r\n      const otherUser = data.user;\r\n\r\n      // Create conversation ID\r\n      const conversationId = [user.id, otherUserId].sort().join('-');\r\n\r\n      // Set up the conversation\r\n      setActiveConversation(conversationId);\r\n      setActiveOtherUser(otherUser);\r\n      setMessages([]); // Start with empty messages\r\n\r\n      // Join the conversation room\r\n      joinConversation(otherUserId);\r\n\r\n      if (isMobileView) {\r\n        setShowConversations(false);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error starting new conversation:', error);\r\n    }\r\n  }, [user, token, joinConversation, isMobileView]);\r\n\r\n  const isTyping = activeOtherUser && typingUsers.some(u => u.userId === activeOtherUser.id);\r\n\r\n  // Conversation CRUD Actions\r\n  const handleConversationAction = (action: 'delete' | 'archive' | 'unread' | 'block', conversationId: string, otherUserName: string) => {\r\n    setOpenDropdown(null);\r\n\r\n    if (action === 'delete' || action === 'block') {\r\n      setShowConfirmModal({\r\n        isOpen: true,\r\n        action,\r\n        conversationId,\r\n        otherUserName\r\n      });\r\n    } else if (action === 'archive') {\r\n      handleArchiveConversation(conversationId);\r\n    } else if (action === 'unread') {\r\n      handleMarkAsUnread(conversationId);\r\n    }\r\n  };\r\n\r\n  const handleDeleteConversation = async (conversationId: string) => {\r\n    if (!token) return;\r\n\r\n    try {\r\n      await fetchAPI(`/api/messages/conversations/${conversationId}/delete`, {\r\n        method: 'DELETE',\r\n        token,\r\n        skipCache: true\r\n      });\r\n\r\n      // Remove from conversations list\r\n      setConversations(prev => prev.filter(conv => conv.conversationId !== conversationId));\r\n\r\n      // Clear active conversation if it was deleted\r\n      if (activeConversation === conversationId) {\r\n        setActiveConversation(null);\r\n        setActiveOtherUser(null);\r\n        setMessages([]);\r\n      }\r\n\r\n      // Clear cache\r\n      dataFetcher.clearCache('/api/messages/conversations');\r\n    } catch (error) {\r\n      console.error('Error deleting conversation:', error);\r\n    }\r\n  };\r\n\r\n  const handleArchiveConversation = async (conversationId: string) => {\r\n    if (!token) return;\r\n\r\n    try {\r\n      await fetchAPI(`/api/messages/conversations/${conversationId}/archive`, {\r\n        method: 'POST',\r\n        token,\r\n        skipCache: true\r\n      });\r\n\r\n      // Remove from conversations list (archived conversations can be shown separately later)\r\n      setConversations(prev => prev.filter(conv => conv.conversationId !== conversationId));\r\n\r\n      // Clear active conversation if it was archived\r\n      if (activeConversation === conversationId) {\r\n        setActiveConversation(null);\r\n        setActiveOtherUser(null);\r\n        setMessages([]);\r\n      }\r\n\r\n      // Clear cache\r\n      dataFetcher.clearCache('/api/messages/conversations');\r\n    } catch (error) {\r\n      console.error('Error archiving conversation:', error);\r\n    }\r\n  };\r\n\r\n  const handleMarkAsUnread = async (conversationId: string) => {\r\n    if (!token) return;\r\n\r\n    try {\r\n      await fetchAPI(`/api/messages/conversations/${conversationId}/unread`, {\r\n        method: 'POST',\r\n        token,\r\n        skipCache: true\r\n      });\r\n\r\n      // Update conversation to show as unread\r\n      setConversations(prev => prev.map(conv =>\r\n        conv.conversationId === conversationId\r\n          ? { ...conv, unreadCount: conv.unreadCount || 1 }\r\n          : conv\r\n      ));\r\n\r\n      // Clear cache\r\n      dataFetcher.clearCache('/api/messages/conversations');\r\n    } catch (error) {\r\n      console.error('Error marking as unread:', error);\r\n    }\r\n  };\r\n\r\n  const handleBlockUser = async (conversationId: string) => {\r\n    if (!token) return;\r\n\r\n    try {\r\n      await fetchAPI(`/api/messages/conversations/${conversationId}/block`, {\r\n        method: 'POST',\r\n        token,\r\n        skipCache: true\r\n      });\r\n\r\n      // Remove from conversations list\r\n      setConversations(prev => prev.filter(conv => conv.conversationId !== conversationId));\r\n\r\n      // Clear active conversation if user was blocked\r\n      if (activeConversation === conversationId) {\r\n        setActiveConversation(null);\r\n        setActiveOtherUser(null);\r\n        setMessages([]);\r\n      }\r\n\r\n      // Clear cache\r\n      dataFetcher.clearCache('/api/messages/conversations');\r\n    } catch (error) {\r\n      console.error('Error blocking user:', error);\r\n    }\r\n  };\r\n\r\n  const confirmAction = () => {\r\n    if (!showConfirmModal.conversationId || !showConfirmModal.action) return;\r\n\r\n    if (showConfirmModal.action === 'delete') {\r\n      handleDeleteConversation(showConfirmModal.conversationId);\r\n    } else if (showConfirmModal.action === 'block') {\r\n      handleBlockUser(showConfirmModal.conversationId);\r\n    }\r\n\r\n    setShowConfirmModal({\r\n      isOpen: false,\r\n      action: null,\r\n      conversationId: null,\r\n      otherUserName: ''\r\n    });\r\n  };\r\n\r\n  // Message Actions\r\n  const handleUnsendMessage = async (messageId: number) => {\r\n    console.log('Unsending message:', messageId);\r\n    if (!token) {\r\n      console.error('No token available');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetchAPI(`/api/messages/${messageId}/unsend`, {\r\n        method: 'POST',\r\n        token,\r\n        skipCache: true\r\n      });\r\n\r\n      console.log('Message unsent successfully:', response);\r\n\r\n      // Remove from local state immediately (socket will handle other user)\r\n      setMessages(prev => prev.filter(msg => msg.id !== messageId));\r\n      setSelectedMessageId(null);\r\n\r\n      // Clear message cache\r\n      if (activeOtherUser) {\r\n        dataFetcher.clearCache(`/api/messages/conversation/${activeOtherUser.id}`);\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error unsending message:', error);\r\n\r\n      // Even if API fails, try to remove from UI (might already be deleted)\r\n      setMessages(prev => prev.filter(msg => msg.id !== messageId));\r\n      setSelectedMessageId(null);\r\n    }\r\n  };\r\n\r\n  const handleDeleteMessage = async (messageId: number) => {\r\n    console.log('Deleting message for me:', messageId);\r\n    if (!token) {\r\n      console.error('No token available');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await fetchAPI(`/api/messages/${messageId}`, {\r\n        method: 'DELETE',\r\n        token,\r\n        skipCache: true\r\n      });\r\n\r\n      console.log('Message deleted for me successfully');\r\n      // Mark message as deleted for current user (add to deleted_for array)\r\n      setMessages(prev => prev.map(msg =>\r\n        msg.id === messageId\r\n          ? { ...msg, deleted_for: [...(msg.deleted_for || []), user?.id || 0] }\r\n          : msg\r\n      ));\r\n      setSelectedMessageId(null);\r\n\r\n      // Clear message cache\r\n      if (activeOtherUser) {\r\n        dataFetcher.clearCache(`/api/messages/conversation/${activeOtherUser.id}`);\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Error deleting message:', error);\r\n    }\r\n  };\r\n\r\n  const handleReactToMessage = async (messageId: number, emoji: string) => {\r\n    console.log('Reacting to message:', messageId, 'with emoji:', emoji);\r\n    if (!token) {\r\n      console.error('No token available');\r\n      return;\r\n    }\r\n\r\n    // Close pickers immediately for better UX\r\n    setShowEmojiPicker(null);\r\n    setSelectedMessageId(null);\r\n\r\n    // Optimistically update UI\r\n    setMessages(prev => prev.map(msg =>\r\n      msg.id === messageId ? { ...msg, reaction: emoji } : msg\r\n    ));\r\n\r\n    try {\r\n      await fetchAPI(`/api/messages/${messageId}/react`, {\r\n        method: 'POST',\r\n        token,\r\n        body: JSON.stringify({ emoji }),\r\n        skipCache: true\r\n      });\r\n\r\n      console.log('Reaction added successfully');\r\n    } catch (error: any) {\r\n      console.error('Error reacting to message:', error);\r\n      // Revert on failure\r\n      setMessages(prev => prev.map(msg =>\r\n        msg.id === messageId ? { ...msg, reaction: null } : msg\r\n      ));\r\n    }\r\n  };\r\n\r\n  const handleRemoveReaction = async (messageId: number) => {\r\n    console.log('Removing reaction from message:', messageId);\r\n    if (!token) {\r\n      console.error('No token available');\r\n      return;\r\n    }\r\n\r\n    // Optimistically remove UI\r\n    const previousReaction = messages.find(msg => msg.id === messageId)?.reaction;\r\n    setMessages(prev => prev.map(msg =>\r\n      msg.id === messageId ? { ...msg, reaction: null } : msg\r\n    ));\r\n\r\n    try {\r\n      await fetchAPI(`/api/messages/${messageId}/react`, {\r\n        method: 'POST',\r\n        token,\r\n        body: JSON.stringify({ emoji: null }),\r\n        skipCache: true\r\n      });\r\n\r\n      console.log('Reaction removed successfully');\r\n    } catch (error: any) {\r\n      console.error('Error removing reaction:', error);\r\n      // Revert on error\r\n      setMessages(prev => prev.map(msg =>\r\n        msg.id === messageId ? { ...msg, reaction: previousReaction } : msg\r\n      ));\r\n    }\r\n  };\r\n\r\n  const handleCopyMessage = (text: string) => {\r\n    navigator.clipboard.writeText(text).then(() => {\r\n      // Could show a toast notification here\r\n      console.log('Message copied to clipboard');\r\n      setSelectedMessageId(null);\r\n    }).catch(err => {\r\n      console.error('Failed to copy message:', err);\r\n    });\r\n  };\r\n\r\n  const handleReplyToMessage = (message: Message) => {\r\n    setReplyingTo({\r\n      id: message.id,\r\n      text: message.messageText,\r\n      senderName: message.sender.name\r\n    });\r\n    setSelectedMessageId(null);\r\n  };\r\n\r\n  const cancelReply = () => {\r\n    setReplyingTo(null);\r\n  };\r\n\r\n  // Memoize filtered messages to prevent unnecessary re-renders\r\n  const displayedMessages = useMemo(() => {\r\n    return messages.filter(message => !message.deleted_for?.includes(user?.id || 0));\r\n  }, [messages, user?.id]);\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"h-screen bg-gray-50 flex items-center justify-center\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"h-screen bg-gray-50 flex overflow-hidden\">\r\n      {/* Sidebar - Conversations */}\r\n      {(!isMobileView || showConversations) && (\r\n        <div className=\"w-full md:w-96 bg-white border-r border-gray-200 flex flex-col pb-16 md:pb-0 shadow-sm\">\r\n          {/* Header */}\r\n          <div className=\"p-6 border-b border-gray-100 bg-gradient-to-b from-white to-gray-50/50\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <div>\r\n                <h1 className=\"text-2xl font-bold text-gray-900 mb-1\">Messages</h1>\r\n                <p className=\"text-sm text-gray-500\">{conversations.length} conversation{conversations.length !== 1 ? 's' : ''}</p>\r\n              </div>\r\n              <button className=\"p-2.5 hover:bg-green-50 text-gray-600 hover:text-green-600 rounded-xl transition-all hover:shadow-sm\">\r\n                <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                  <path d=\"M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10\"\r\n                    stroke=\"currentColor\"\r\n                    strokeWidth=\"1.5\"\r\n                    strokeLinecap=\"round\"\r\n                    strokeLinejoin=\"round\"\r\n                  />\r\n                </svg>\r\n              </button>\r\n            </div>\r\n\r\n            {/* Search */}\r\n            <div className=\"relative\">\r\n              <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\r\n                <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"text-gray-400\">\r\n                  <path d=\"M21 21L16.514 16.506M19 10.5C19 15.194 15.194 19 10.5 19S2 15.194 2 10.5 5.806 2 10.5 2 19 5.806 19 10.5Z\"\r\n                    stroke=\"currentColor\"\r\n                    strokeWidth=\"2\"\r\n                    strokeLinecap=\"round\"\r\n                    strokeLinejoin=\"round\"\r\n                  />\r\n                </svg>\r\n              </div>\r\n              <input\r\n                id=\"conversation-search\"\r\n                name=\"search\"\r\n                type=\"text\"\r\n                placeholder=\"Search conversations...\"\r\n                className=\"w-full pl-10 pr-4 py-2.5 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 focus:bg-white transition-all text-sm\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Conversations List */}\r\n          <div className=\"flex-1 overflow-y-auto\">\r\n            {conversations.length === 0 ? (\r\n              <div className=\"p-8 text-center\">\r\n                <div className=\"w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n                  <svg className=\"w-10 h-10 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\r\n                  </svg>\r\n                </div>\r\n                <p className=\"text-gray-900 font-semibold mb-1\">No conversations yet</p>\r\n                <p className=\"text-sm text-gray-500\">Start messaging someone to see conversations here</p>\r\n              </div>\r\n            ) : (\r\n              conversations.map((conversation) => (\r\n                <div\r\n                  key={conversation.conversationId}\r\n                  className={`relative group cursor-pointer transition-all border-b border-gray-100 ${activeConversation === conversation.conversationId\r\n                    ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-l-green-500'\r\n                    : 'hover:bg-gray-50 border-l-4 border-l-transparent'\r\n                    }`}\r\n                >\r\n                  <div\r\n                    onClick={() => handleConversationClick(conversation)}\r\n                    className=\"p-4\"\r\n                  >\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <div className=\"relative flex-shrink-0\">\r\n                        <div className={`w-14 h-14 rounded-full overflow-hidden ring-2 shadow-sm transition-all ${activeConversation === conversation.conversationId\r\n                          ? 'ring-green-500'\r\n                          : 'ring-white group-hover:ring-gray-200'\r\n                          }`}>\r\n                          <Image\r\n                            src={conversation.otherUser.profile_image || '/uploads/DefaultProfile.jpg'}\r\n                            alt={conversation.otherUser.name}\r\n                            className=\"w-full h-full object-cover\"\r\n                            onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n                          />\r\n                        </div>\r\n                        {/* Online status indicator - can be added later */}\r\n                        {/* <div className=\"absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white\"></div> */}\r\n                      </div>\r\n\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <div className=\"flex items-center justify-between mb-1\">\r\n                          <h3 className=\"font-semibold text-gray-900 text-sm truncate pr-2\">\r\n                            {conversation.otherUser.name}\r\n                          </h3>\r\n                          <div className=\"flex items-center gap-2 flex-shrink-0\">\r\n                            <span className=\"text-xs text-gray-500\">\r\n                              {formatTimestamp(conversation.lastMessage.createdAt)}\r\n                            </span>\r\n                            {conversation.unreadCount > 0 && (\r\n                              <div className=\"min-w-[20px] h-5 px-1.5 bg-green-600 rounded-full flex items-center justify-center shadow-sm\">\r\n                                <span className=\"text-xs font-bold text-white\">{conversation.unreadCount}</span>\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                        <p className={`text-sm truncate ${conversation.unreadCount > 0\r\n                          ? 'font-medium text-gray-900'\r\n                          : 'text-gray-600'\r\n                          }`}>\r\n                          {conversation.lastMessage.isFromMe ? (\r\n                            <span className=\"text-gray-500\">You: </span>\r\n                          ) : null}\r\n                          {conversation.lastMessage.text || 'No message content'}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Three-dot menu */}\r\n                  <div className=\"absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                    <button\r\n                      onClick={(e) => {\r\n                        e.stopPropagation();\r\n                        setOpenDropdown(openDropdown === conversation.conversationId ? null : conversation.conversationId);\r\n                      }}\r\n                      className=\"p-2 text-gray-500 hover:text-gray-900 hover:bg-white rounded-lg transition-all shadow-sm hover:shadow\"\r\n                    >\r\n                      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                        <path d=\"M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                        <path d=\"M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                        <path d=\"M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                      </svg>\r\n                    </button>\r\n\r\n                    {/* Dropdown Menu */}\r\n                    {openDropdown === conversation.conversationId && (\r\n                      <div\r\n                        ref={dropdownRef}\r\n                        className=\"absolute right-0 top-10 w-48 bg-white rounded-xl shadow-lg border border-gray-200 py-1.5 z-50\"\r\n                      >\r\n                        <button\r\n                          onClick={() => handleConversationAction('unread', conversation.conversationId, conversation.otherUser.name)}\r\n                          className=\"w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition-colors\"\r\n                        >\r\n                          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                            <path d=\"M21.99 6.86C21.99 6.86 22 7.75 22 12C22 16.25 21.99 17.14 21.99 17.14C21.99 18.24 21.31 19.19 20.24 19.5C19.17 19.81 17.99 19.5 17.17 18.68L16 17.51C15.59 17.1 14.99 16.86 14.35 16.86H6C3.79 16.86 2 15.07 2 12.86V6.86C2 4.65 3.79 2.86 6 2.86H18C20.21 2.86 22 4.65 22 6.86Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                            <circle cx=\"7\" cy=\"9.86\" r=\"1.5\" fill=\"currentColor\" />\r\n                            <circle cx=\"12\" cy=\"9.86\" r=\"1.5\" fill=\"currentColor\" />\r\n                            <circle cx=\"17\" cy=\"9.86\" r=\"1.5\" fill=\"currentColor\" />\r\n                          </svg>\r\n                          Mark as unread\r\n                        </button>\r\n\r\n                        <button\r\n                          onClick={() => handleConversationAction('archive', conversation.conversationId, conversation.otherUser.name)}\r\n                          className=\"w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3 transition-colors\"\r\n                        >\r\n                          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                            <path d=\"M21 8V21H3V8M1 3H23L21 8H3L1 3Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                            <path d=\"M10 12H14\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                          </svg>\r\n                          Archive\r\n                        </button>\r\n\r\n                        <div className=\"border-t border-gray-100 my-1.5\"></div>\r\n\r\n                        <button\r\n                          onClick={() => handleConversationAction('block', conversation.conversationId, conversation.otherUser.name)}\r\n                          className=\"w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3 transition-colors\"\r\n                        >\r\n                          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                            <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                            <path d=\"M4.93 4.93L19.07 19.07\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" />\r\n                          </svg>\r\n                          Block user\r\n                        </button>\r\n\r\n                        <button\r\n                          onClick={() => handleConversationAction('delete', conversation.conversationId, conversation.otherUser.name)}\r\n                          className=\"w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3 transition-colors\"\r\n                        >\r\n                          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                            <path d=\"M3 6H5H21M8 6V4C8 3.44772 8.44772 3 9 3H15C15.5523 3 16 3.44772 16 4V6M19 6V20C19 20.5523 18.5523 21 18 21H6C5.44772 21 5 20.5523 5 20V6H19Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                            <path d=\"M10 11V17M14 11V17\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                          </svg>\r\n                          Delete chat\r\n                        </button>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              ))\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Chat Area */}\r\n      {(!isMobileView || !showConversations) && activeConversation ? (\r\n        <div className=\"flex-1 flex flex-col h-full bg-white rounded-tl-3xl shadow-lg\">\r\n          {/* Chat Header */}\r\n          <div className=\"p-5 border-b border-gray-100 bg-gradient-to-r from-white to-gray-50 flex-shrink-0\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex items-center gap-3\">\r\n                {isMobileView && (\r\n                  <button\r\n                    onClick={() => setShowConversations(true)}\r\n                    className=\"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all\"\r\n                  >\r\n                    <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                      <path d=\"M15 18L9 12L15 6\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                    </svg>\r\n                  </button>\r\n                )}\r\n                <div className=\"relative\">\r\n                  <div className=\"w-12 h-12 rounded-full overflow-hidden ring-2 ring-green-500 shadow-sm\">\r\n                    <Image\r\n                      src={currentConversation?.otherUser?.profile_image || '/uploads/DefaultProfile.jpg'}\r\n                      alt={currentConversation?.otherUser?.name || 'User'}\r\n                      className=\"w-full h-full object-cover\"\r\n                      onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n                    />\r\n                  </div>\r\n                  {/* Online status indicator */}\r\n                  <div className=\"absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-white\"></div>\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"font-semibold text-gray-900\">\r\n                    {currentConversation?.otherUser?.name}\r\n                  </h3>\r\n                  <p className=\"text-xs text-green-600 font-medium flex items-center gap-1\">\r\n                    <span className=\"w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse\"></span>\r\n                    Active now\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex items-center gap-2\">\r\n                <button className=\"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors\">\r\n                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M22 16.92V20C22 20.5304 21.7893 21.0391 21.4142 21.4142C21.0391 21.7893 20.5304 22 20 22C17.9289 21.9972 15.8799 21.5641 14 20.73C12.2719 19.9686 10.7419 18.8187 9.51 17.36C8.05128 16.1281 6.90145 14.5981 6.14 12.87C5.30593 10.9901 4.87284 8.94107 4.87 6.87C4.87 6.33956 5.08071 5.83086 5.45578 5.45578C5.83086 5.08071 6.33956 4.87 6.87 4.87H10.05C10.5625 4.86511 11.056 5.0365 11.4432 5.35235C11.8303 5.6682 12.0839 6.10842 12.16 6.6C12.3034 7.68107 12.5857 8.73007 13 9.72C13.1397 10.0156 13.187 10.3467 13.1358 10.6699C13.0847 10.9932 12.9379 11.2934 12.72 11.53L11.26 12.99C12.2774 14.8075 13.7325 16.2626 15.55 17.28L17.01 15.82C17.2466 15.6021 17.5468 15.4553 17.8701 15.4042C18.1933 15.353 18.5244 15.4003 18.82 15.54C19.8099 15.9543 20.8589 16.2366 21.94 16.38C22.4416 16.4561 22.8918 16.7197 23.2077 17.1168C23.5235 17.514 23.6849 18.0175 23.67 18.53L22 16.92Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                  </svg>\r\n                </button>\r\n                <button className=\"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors\">\r\n                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M15.75 10.5V6C15.75 5.20435 15.4339 4.44129 14.8713 3.87868C14.3087 3.31607 13.5456 3 12.75 3H5.25C4.45435 3 3.69129 3.31607 3.12868 3.87868C2.56607 4.44129 2.25 5.20435 2.25 6V15C2.25 15.7956 2.56607 16.5587 3.12868 17.1213C3.69129 17.6839 4.45435 18 5.25 18H8.25M15.75 10.5L21.75 4.5M15.75 10.5V15C15.75 15.7956 16.0661 16.5587 16.6287 17.1213C17.1913 17.6839 17.9544 18 18.75 18H21.75V4.5H18.75C17.9544 4.5 17.1913 4.81607 16.6287 5.37868C16.0661 5.94129 15.75 6.70435 15.75 7.5V10.5Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                  </svg>\r\n                </button>\r\n                <button className=\"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors\">\r\n                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M11.25 11.25L4.5 6V19.5L11.25 11.25ZM11.25 11.25L19.5 6V19.5L11.25 11.25Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                  </svg>\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Messages */}\r\n          <div className=\"flex-1 overflow-y-auto p-4 bg-white pb-32 md:pb-4 will-change-scroll\">\r\n            <div className=\"max-w-2xl mx-auto space-y-4\">\r\n              {displayedMessages.map((message, index) => {\r\n                const isFromMe = message.senderId === user?.id;\r\n                // Use a more unique key that handles both real and optimistic messages\r\n                const messageKey = message.id > 0 ? `msg-${message.id}` : `temp-${message.id}-${message.createdAt}`;\r\n                return (\r\n                  <div\r\n                    key={messageKey}\r\n                    className={`group flex ${isFromMe ? 'justify-end' : 'justify-start'} relative`}\r\n                  >\r\n                    <div className={`flex ${isFromMe ? 'flex-row-reverse' : 'flex-row'} items-end gap-2 max-w-[70%]`}>\r\n                      {/* Message Bubble */}\r\n                      <div className=\"relative\">\r\n                        {/* Reply Preview */}\r\n                        {message.replyTo && (\r\n                          <div className={`text-xs px-3 py-1.5 mb-1 rounded-lg border-l-2 ${isFromMe\r\n                            ? 'bg-white/20 border-white/40'\r\n                            : 'bg-gray-200 border-gray-400'\r\n                            }`}>\r\n                            <div className=\"font-semibold opacity-80\">{message.replyTo.senderName}</div>\r\n                            <div className=\"opacity-60 truncate\">{message.replyTo.text}</div>\r\n                          </div>\r\n                        )}\r\n\r\n                        <div\r\n                          className={`rounded-2xl px-4 py-3 ${isFromMe\r\n                            ? 'bg-[#FFAF50] text-black'\r\n                            : 'bg-gray-100 text-gray-900'\r\n                            }`}\r\n                        >\r\n                          <p className=\"text-sm leading-relaxed\">{message.messageText}</p>\r\n                          <p className=\"text-xs mt-1 opacity-70\">\r\n                            {formatTimestamp(message.createdAt)}\r\n                          </p>\r\n                        </div>\r\n\r\n                        {/* Reaction */}\r\n                        {message.reaction && (\r\n                          <button\r\n                            onClick={(e) => {\r\n                              e.stopPropagation();\r\n                              handleRemoveReaction(message.id);\r\n                            }}\r\n                            className=\"absolute -bottom-2 -right-2 bg-white border border-gray-200 rounded-full px-1.5 py-0.5 text-xs shadow-sm hover:bg-gray-50 hover:scale-110 transition-all cursor-pointer active:scale-95\"\r\n                            title=\"Tap to remove reaction\"\r\n                          >\r\n                            {message.reaction}\r\n                          </button>\r\n                        )}\r\n                      </div>\r\n\r\n                      {/* Three-dot Menu Button */}\r\n                      <div className=\"relative\">\r\n                        <button\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            const button = e.currentTarget;\r\n                            const rect = button.getBoundingClientRect();\r\n                            const windowHeight = window.innerHeight;\r\n                            const spaceBelow = windowHeight - rect.bottom;\r\n                            const dropdownHeight = 280; // Approximate dropdown height\r\n\r\n                            // Show dropdown above if not enough space below\r\n                            const position = spaceBelow < dropdownHeight ? 'top' : 'bottom';\r\n                            setDropdownPosition(prev => ({ ...prev, [message.id]: position }));\r\n                            setSelectedMessageId(selectedMessageId === message.id ? null : message.id);\r\n                          }}\r\n                          className=\"opacity-0 group-hover:opacity-100 p-1.5 hover:bg-gray-200 rounded-full transition-all\"\r\n                          title=\"More actions\"\r\n                        >\r\n                          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                            <path d=\"M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                            <path d=\"M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                            <path d=\"M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                          </svg>\r\n                        </button>\r\n\r\n                        {/* Dropdown Menu */}\r\n                        {selectedMessageId === message.id && (\r\n                          <div\r\n                            ref={messageActionsRef}\r\n                            className={`absolute ${isFromMe ? 'right-0' : 'left-0'} ${dropdownPosition[message.id] === 'top' ? 'bottom-8' : 'top-8'\r\n                              } w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-[100]`}\r\n                          >\r\n                            {/* React Option */}\r\n                            <button\r\n                              onClick={() => setShowEmojiPicker(showEmojiPicker === message.id ? null : message.id)}\r\n                              className=\"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3\"\r\n                            >\r\n                              <span className=\"text-base\">≡ƒÿè</span>\r\n                              <span>React</span>\r\n                            </button>\r\n\r\n                            {/* Reply Option */}\r\n                            <button\r\n                              onClick={() => handleReplyToMessage(message)}\r\n                              className=\"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3\"\r\n                            >\r\n                              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                                <path d=\"M9 10H15M9 14H12M3 18V6C3 5.46957 3.21071 4.96086 3.58579 4.58579C3.96086 4.21071 4.46957 4 5 4H19C19.5304 4 20.0391 4.21071 20.4142 4.58579C20.7893 4.96086 21 5.46957 21 6V14C21 14.5304 20.7893 15.0391 20.4142 15.4142C20.0391 15.7893 19.5304 16 19 16H7L3 18Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                              </svg>\r\n                              <span>Reply</span>\r\n                            </button>\r\n\r\n                            {/* Copy Option */}\r\n                            <button\r\n                              onClick={() => handleCopyMessage(message.messageText)}\r\n                              className=\"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3\"\r\n                            >\r\n                              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                                <path d=\"M8 16H6C5.46957 16 4.96086 15.7893 4.58579 15.4142C4.21071 15.0391 4 14.5304 4 14V6C4 5.46957 4.21071 4.96086 4.58579 4.58579C4.96086 4.21071 5.46957 4 6 4H14C14.5304 4 15.0391 4.21071 15.4142 4.58579C15.7893 4.96086 16 5.46957 16 6V8M10 20H18C18.5304 20 19.0391 19.7893 19.4142 19.4142C19.7893 19.0391 20 18.5304 20 18V10C20 9.46957 19.7893 8.96086 19.4142 8.58579C19.0391 8.21071 18.5304 8 18 8H10C9.46957 8 8.96086 8.21071 8.58579 8.58579C8.21071 8.96086 8 9.46957 8 10V18C8 18.5304 8.21071 19.0391 8.58579 19.4142C8.96086 19.7893 9.46957 20 10 20Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                              </svg>\r\n                              <span>Copy</span>\r\n                            </button>\r\n\r\n                            <div className=\"border-t border-gray-100 my-1\"></div>\r\n\r\n                            {/* Unsend Option - Only for own messages */}\r\n                            {isFromMe && (\r\n                              <button\r\n                                onClick={() => handleUnsendMessage(message.id)}\r\n                                className=\"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3\"\r\n                              >\r\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                                  <path d=\"M9 13L15 7M15 13L9 7M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                                </svg>\r\n                                <span>Unsend</span>\r\n                              </button>\r\n                            )}\r\n\r\n                            {/* Delete Option */}\r\n                            <button\r\n                              onClick={() => handleDeleteMessage(message.id)}\r\n                              className=\"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3\"\r\n                            >\r\n                              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                                <path d=\"M3 6H5H21M8 6V4C8 3.44772 8.44772 3 9 3H15C15.5523 3 16 3.44772 16 4V6M19 6V20C19 20.5523 18.5523 21 18 21H6C5.44772 21 5 20.5523 5 20V6H19Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                              </svg>\r\n                              <span>Delete for me</span>\r\n                            </button>\r\n                          </div>\r\n                        )}\r\n\r\n                        {/* Emoji Picker */}\r\n                        {showEmojiPicker === message.id && (\r\n                          <div\r\n                            ref={emojiPickerRef}\r\n                            onClick={(e) => e.stopPropagation()}\r\n                            className={`absolute ${isFromMe ? 'right-0' : 'left-0'} ${dropdownPosition[message.id] === 'top' ? 'bottom-8' : 'top-8'\r\n                              } bg-white border border-gray-200 rounded-lg shadow-lg p-2 flex gap-1 z-[100]`}>\r\n                            {['Γ¥ñ∩╕Å', '≡ƒÿé', '≡ƒÿ«', '≡ƒÿó', '≡ƒÿí', '≡ƒæì', '≡ƒæÄ', '≡ƒöÑ'].map(emoji => (\r\n                              <button\r\n                                key={emoji}\r\n                                onClick={(e) => {\r\n                                  e.stopPropagation();\r\n                                  handleReactToMessage(message.id, emoji);\r\n                                }}\r\n                                className=\"hover:bg-gray-100 rounded p-1 transition-colors text-lg\"\r\n                              >\r\n                                {emoji}\r\n                              </button>\r\n                            ))}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                );\r\n              })}\r\n              <div ref={messagesEndRef} />\r\n            </div>\r\n          </div>\r\n\r\n\r\n          {/* Input */}\r\n          <div className=\"p-4 border-t border-gray-200 bg-white flex-shrink-0 fixed md:relative bottom-16 md:bottom-auto left-0 right-0 md:left-auto md:right-auto z-[60]\">\r\n            <div className=\"max-w-2xl mx-auto\">\r\n              {/* Reply Preview */}\r\n              {replyingTo && (\r\n                <div className=\"mb-2 bg-gray-50 border border-gray-200 rounded-lg p-3 flex items-center justify-between\">\r\n                  <div className=\"flex-1 min-w-0\">\r\n                    <div className=\"flex items-center gap-2 text-xs text-gray-500 mb-1\">\r\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                        <path d=\"M9 10H15M9 14H12M3 18V6C3 5.46957 3.21071 4.96086 3.58579 4.58579C3.96086 4.21071 4.46957 4 5 4H19C19.5304 4 20.0391 4.21071 20.4142 4.58579C20.7893 4.96086 21 5.46957 21 6V14C21 14.5304 20.7893 15.0391 20.4142 15.4142C20.0391 15.7893 19.5304 16 19 16H7L3 18Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                      </svg>\r\n                      <span className=\"font-semibold\">Replying to {replyingTo.senderName}</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-gray-700 truncate\">{replyingTo.text}</p>\r\n                  </div>\r\n                  <button\r\n                    onClick={cancelReply}\r\n                    className=\"p-1 text-gray-400 hover:text-gray-600 transition-colors\"\r\n                  >\r\n                    <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                      <path d=\"M6 18L18 6M6 6L18 18\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                    </svg>\r\n                  </button>\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"flex items-end gap-2 md:gap-3\">\r\n                {/* Hide extra buttons on mobile, show only on desktop */}\r\n                <button className=\"hidden md:block p-2 text-gray-600 hover:text-gray-900 transition-colors\">\r\n                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                  </svg>\r\n                </button>\r\n\r\n                <div className=\"flex-1 relative\">\r\n                  <textarea\r\n                    id=\"message-input\"\r\n                    name=\"message\"\r\n                    value={input}\r\n                    onChange={(e) => handleTyping(e.target.value)}\r\n                    onKeyPress={handleKeyPress}\r\n                    placeholder=\"Message...\"\r\n                    className=\"w-full px-4 py-3 bg-gray-100 rounded-2xl border-0 focus:outline-none focus:ring-2 focus:ring-[#FFAF50]/20 focus:bg-white transition-all text-gray-900 text-sm resize-none max-h-32\"\r\n                    rows={1}\r\n                    style={{ minHeight: '44px' }}\r\n                  />\r\n                  {isTyping && (\r\n                    <div className=\"absolute -top-7 left-0 text-xs text-gray-500 italic flex items-center gap-1\">\r\n                      <span className=\"w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce\"></span>\r\n                      <span className=\"w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce\" style={{ animationDelay: '0.2s' }}></span>\r\n                      <span className=\"w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce\" style={{ animationDelay: '0.4s' }}></span>\r\n                      <span className=\"ml-1\">{activeOtherUser.name} is typing...</span>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Hide extra buttons on mobile, show only on desktop */}\r\n                <button className=\"hidden md:block p-2.5 text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-xl transition-all\">\r\n                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M21.44 11.05L12.25 6.77C11.91 6.58 11.5 6.58 11.16 6.77L1.97 11.05C1.55 11.27 1.55 11.73 1.97 11.95L11.16 16.23C11.5 16.42 11.91 16.42 12.25 16.23L21.44 11.95C21.86 11.73 21.86 11.27 21.44 11.05Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                  </svg>\r\n                </button>\r\n\r\n                <button className=\"hidden md:block p-2.5 text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-xl transition-all\">\r\n                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M15.182 15.182C13.556 16.808 11.926 18.434 9.879 18.434C7.832 18.434 6.202 16.808 6.202 14.761C6.202 12.714 7.832 11.088 9.879 11.088C11.926 11.088 13.556 12.714 13.556 14.761M15.182 15.182L22 22M15.182 15.182C16.808 13.556 18.434 11.926 18.434 9.879C18.434 7.832 16.808 6.202 14.761 6.202C12.714 6.202 11.088 7.832 11.088 9.879C11.088 11.926 12.714 13.556 14.761 13.556\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                  </svg>\r\n                </button>\r\n\r\n                {input.trim() ? (\r\n                  <button\r\n                    onClick={handleSendMessage}\r\n                    className=\"px-5 py-2.5 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition-all shadow-sm hover:shadow text-sm flex-shrink-0 flex items-center gap-2\"\r\n                  >\r\n                    <span>Send</span>\r\n                    <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                      <path d=\"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                    </svg>\r\n                  </button>\r\n                ) : (\r\n                  <button className=\"p-2.5 text-gray-500 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all flex-shrink-0\">\r\n                    <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                      <path d=\"M19 14C20.49 12.54 22 10.79 22 8.5C22 7.04131 21.4205 5.64236 20.3891 4.61091C19.3576 3.57946 17.9587 3 16.5 3C14.74 3 13.5 3.5 12 5C10.5 3.5 9.26 3 7.5 3C6.04131 3 4.64236 3.57946 3.61091 4.61091C2.57946 5.64236 2 7.04131 2 8.5C2 10.79 3.51 12.54 5 14L12 21L19 14Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                    </svg>\r\n                  </button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        !activeConversation && !isMobileView && (\r\n          <div className=\"flex-1 flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100\">\r\n            <div className=\"text-center\">\r\n              <div className=\"w-28 h-28 bg-gradient-to-br from-green-100 to-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg\">\r\n                <svg width=\"48\" height=\"48\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"text-green-600\">\r\n                  <path d=\"M8.5 12H8.51M12 12H12.01M15.5 12H15.51M21 12C21 16.418 16.97 20 12 20C10.89 20 9.84 19.79 8.88 19.42L3 21L4.58 15.12C4.21 14.16 4 13.11 4 12C4 7.582 8.03 4 12 4C16.97 4 21 7.582 21 12Z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                </svg>\r\n              </div>\r\n              <h3 className=\"text-xl font-bold text-gray-900 mb-2\">Your Messages</h3>\r\n              <p className=\"text-gray-600\">Select a conversation to start messaging</p>\r\n            </div>\r\n          </div>\r\n        )\r\n      )}\r\n\r\n      {/* Confirmation Modal */}\r\n      {showConfirmModal.isOpen && (\r\n        <div className=\"fixed inset-0 bg-black/20 backdrop-blur-xs bg-opacity-50 flex items-center justify-center z-50\">\r\n          <div className=\"bg-white rounded-lg p-6 max-w-md w-full mx-4\">\r\n            <div className=\"flex items-center gap-3 mb-4\">\r\n              <div className={`w-10 h-10 rounded-full flex items-center justify-center ${showConfirmModal.action === 'delete' ? 'bg-red-100' : 'bg-orange-100'\r\n                }`}>\r\n                {showConfirmModal.action === 'delete' ? (\r\n                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M3 6H5H21M8 6V4C8 3.44772 8.44772 3 9 3H15C15.5523 3 16 3.44772 16 4V6M19 6V20C19 20.5523 18.5523 21 18 21H6C5.44772 21 5 20.5523 5 20V6H19Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"text-red-600\" />\r\n                  </svg>\r\n                ) : (\r\n                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"1.5\" className=\"text-orange-600\" />\r\n                    <path d=\"M4.93 4.93L19.07 19.07\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" className=\"text-orange-600\" />\r\n                  </svg>\r\n                )}\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-lg font-semibold text-gray-900\">\r\n                  {showConfirmModal.action === 'delete' ? 'Delete conversation' : 'Block user'}\r\n                </h3>\r\n                <p className=\"text-sm text-gray-600\">\r\n                  {showConfirmModal.action === 'delete'\r\n                    ? `Are you sure you want to delete your conversation with ${showConfirmModal.otherUserName}? This action cannot be undone.`\r\n                    : `Are you sure you want to block ${showConfirmModal.otherUserName}? They won't be able to message you anymore.`\r\n                  }\r\n                </p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex justify-end gap-3\">\r\n              <button\r\n                onClick={() => setShowConfirmModal({ isOpen: false, action: null, conversationId: null, otherUserName: '' })}\r\n                className=\"px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors\"\r\n              >\r\n                Cancel\r\n              </button>\r\n              <button\r\n                onClick={confirmAction}\r\n                className={`px-4 py-2 text-white rounded-lg transition-colors ${showConfirmModal.action === 'delete'\r\n                  ? 'bg-red-600 hover:bg-red-700'\r\n                  : 'bg-orange-600 hover:bg-orange-700'\r\n                  }`}\r\n              >\r\n                {showConfirmModal.action === 'delete' ? 'Delete' : 'Block'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst MessagesPage = () => {\r\n  return (\r\n    <Suspense fallback={<div className=\"h-screen bg-white flex items-center justify-center\"><div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-[#FFAF50]\"></div></div>}>\r\n      <MessagesPageInner />\r\n    </Suspense>\r\n  );\r\n};\r\n\r\nexport default MessagesPage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\notifications\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[483,486],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[483,486],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loadingRequests' is assigned a value but never used.","line":40,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1823,1826],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1823,1826],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2106,2109],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2106,2109],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2634,2637],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2634,2637],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4148,4151],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4148,4151],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":294,"column":70,"nodeType":null,"messageId":"unusedVar","endLine":294,"endColumn":75}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useEffect, useMemo, useState } from 'react';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useSocket } from '../../contexts/SocketContext';\nimport { fetchAPI, dataFetcher } from '../../lib/dataFetcher';\nimport Image from 'next/image'\n\ninterface Notification {\n  id: string;\n  type: 'like' | 'comment' | 'follow' | 'mention' | 'system';\n  message: string;\n  time: string;\n  read: boolean;\n  avatar?: string;\n  action?: string;\n  meta?: any;\n}\n\ninterface FollowRequest {\n  id: number;\n  requester_id: number;\n  requester: {\n    id: number;\n    name: string;\n    username?: string;\n    profile_image?: string;\n  };\n  created_at: string;\n}\n\nexport default function NotificationsPage() {\n  const [notifications, setNotifications] = useState<Notification[]>([]);\n  const [filter, setFilter] = useState<'all' | 'unread'>('all');\n  const { user, token } = useAuth();\n  const { onNotification, onMessageNotification } = useSocket();\n\n  // Follow requests state\n  const [followRequests, setFollowRequests] = useState<FollowRequest[]>([]);\n  const [loadingRequests, setLoadingRequests] = useState(false);\n\n  // Load from localStorage for persistence\n  useEffect(() => {\n    try {\n      const raw = localStorage.getItem('notifications');\n      if (raw) {\n        const parsed = JSON.parse(raw);\n        if (Array.isArray(parsed)) setNotifications(parsed);\n      }\n    } catch { }\n  }, []);\n\n  // Load follow requests\n  useEffect(() => {\n    const loadRequests = async () => {\n      if (!token) return;\n      setLoadingRequests(true);\n      try {\n        const data = await fetchAPI<{ requests: FollowRequest[] }>(\n          '/api/users/requests',\n          { token, cacheTTL: 10000 } // Cache for 10 seconds\n        );\n        setFollowRequests(data.requests || []);\n      } catch (err: any) {\n        console.error('Failed to load follow requests:', err);\n      } finally {\n        setLoadingRequests(false);\n      }\n    };\n    loadRequests();\n  }, [token]);\n\n  // Subscribe to socket notifications\n  useEffect(() => {\n    const unsubGeneric = onNotification?.((notif: any) => {\n      setNotifications(prev => {\n        const next = [{\n          id: notif.id || `${Date.now()}`,\n          type: notif.type || 'system',\n          message: notif.message || 'Notification',\n          time: new Date().toISOString(),\n          read: false,\n          meta: notif.meta,\n        } as Notification, ...prev].slice(0, 200);\n        try { localStorage.setItem('notifications', JSON.stringify(next)); } catch { }\n        return next;\n      });\n    });\n\n    const unsubMessage = onMessageNotification?.((msg: any) => {\n      setNotifications(prev => {\n        const next = [{\n          id: `${msg.id || Date.now()}`,\n          type: 'system',\n          message: `New message from ${msg.senderName || 'someone'}`,\n          time: new Date().toISOString(),\n          read: false,\n          meta: { conversationId: msg.conversationId, senderId: msg.senderId },\n        } as Notification, ...prev].slice(0, 200);\n        try { localStorage.setItem('notifications', JSON.stringify(next)); } catch { }\n        return next;\n      });\n    });\n\n    return () => {\n      if (typeof unsubGeneric === 'function') unsubGeneric();\n      if (typeof unsubMessage === 'function') unsubMessage();\n    };\n  }, [onNotification, onMessageNotification]);\n\n  // Move useMemo before early return to follow Rules of Hooks\n  const filteredNotifications = useMemo(() => (\n    filter === 'unread'\n      ? notifications.filter(n => !n.read)\n      : notifications\n  ), [filter, notifications]);\n\n  const unreadCount = notifications.filter(n => !n.read).length;\n\n  const handleFollowRequest = async (requestId: number, action: 'approve' | 'reject') => {\n    if (!token) return;\n    try {\n      await fetchAPI('/api/users/requests', {\n        method: 'POST',\n        token,\n        body: JSON.stringify({ requestId, action }),\n        skipCache: true\n      });\n\n      setFollowRequests(prev => prev.filter(req => req.id !== requestId));\n\n      // Clear cache after approval/rejection\n      dataFetcher.clearCache('/api/users/requests');\n    } catch (err: any) {\n      console.error('Error handling follow request:', err);\n      alert(err.message || 'Failed to handle request');\n    }\n  };\n\n  const markAsRead = (id: string) => {\n    setNotifications(prev =>\n      prev.map(notif =>\n        notif.id === id ? { ...notif, read: true } : notif\n      )\n    );\n  };\n\n  const markAllAsRead = () => {\n    setNotifications(prev =>\n      prev.map(notif => ({ ...notif, read: true }))\n    );\n  };\n\n  if (!user) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-16 h-16 border-4 border-[#FFAF50] border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const getNotificationIcon = (type: string) => {\n    switch (type) {\n      case 'like':\n        return 'Γ¥ñ∩╕Å';\n      case 'comment':\n        return '≡ƒÆ¼';\n      case 'follow':\n        return '≡ƒæÑ';\n      case 'mention':\n        return '≡ƒôó';\n      case 'system':\n        return 'ΓÜÖ∩╕Å';\n      default:\n        return '≡ƒöö';\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between mb-8\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900\">Notifications</h1>\n            {unreadCount > 0 && (\n              <p className=\"text-gray-600 mt-1\">{unreadCount} unread notification{unreadCount !== 1 ? 's' : ''}</p>\n            )}\n          </div>\n\n          <div className=\"flex items-center gap-4\">\n            {/* Filter */}\n            <div className=\"flex bg-gray-100 rounded-lg p-1\">\n              <button\n                onClick={() => setFilter('all')}\n                className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${filter === 'all'\n                    ? 'bg-[#FFAF50] text-black'\n                    : 'text-gray-600 hover:text-gray-900'\n                  }`}\n              >\n                All\n              </button>\n              <button\n                onClick={() => setFilter('unread')}\n                className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${filter === 'unread'\n                    ? 'bg-[#FFAF50] text-black'\n                    : 'text-gray-600 hover:text-gray-900'\n                  }`}\n              >\n                Unread ({unreadCount})\n              </button>\n            </div>\n\n            {/* Mark all as read */}\n            {unreadCount > 0 && (\n              <button\n                onClick={markAllAsRead}\n                className=\"text-[#FFAF50] hover:text-orange-600 font-semibold text-sm\"\n              >\n                Mark all as read\n              </button>\n            )}\n          </div>\n        </div>\n\n        {/* Follow Requests Section */}\n        {followRequests.length > 0 && (\n          <div className=\"bg-white rounded-lg shadow-sm border border-gray-100 mb-6\">\n            <div className=\"p-6 border-b border-gray-100\">\n              <h2 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2\">\n                <svg className=\"w-5 h-5 text-gray-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\" />\n                </svg>\n                Follow Requests\n                <span className=\"px-2 py-0.5 text-xs font-medium bg-green-100 text-green-700 rounded-full\">\n                  {followRequests.length}\n                </span>\n              </h2>\n            </div>\n\n            <div className=\"divide-y divide-gray-100\">\n              {followRequests.map((request) => (\n                <div key={request.id} className=\"p-6 hover:bg-gray-50 transition-colors\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3 min-w-0 flex-1\">\n                      <Image\n                        src={request.requester?.profile_image || '/uploads/DefaultProfile.jpg'}\n                        alt={request.requester?.name}\n                        className=\"w-12 h-12 rounded-full object-cover ring-2 ring-white shadow-sm\"\n                      />\n                      <div className=\"min-w-0 flex-1\">\n                        <div className=\"font-semibold text-gray-900 truncate\">{request.requester?.name}</div>\n                        {request.requester?.username && (\n                          <div className=\"text-sm text-gray-500 truncate\">@{request.requester.username}</div>\n                        )}\n                        <div className=\"text-xs text-gray-400 mt-0.5\">\n                          {new Date(request.created_at).toLocaleDateString('en-US', {\n                            month: 'short',\n                            day: 'numeric',\n                            hour: '2-digit',\n                            minute: '2-digit'\n                          })}\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"flex gap-2 ml-4\">\n                      <button\n                        onClick={() => handleFollowRequest(request.id, 'approve')}\n                        className=\"px-5 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition-colors shadow-sm\"\n                      >\n                        Accept\n                      </button>\n                      <button\n                        onClick={() => handleFollowRequest(request.id, 'reject')}\n                        className=\"px-5 py-2 bg-white hover:bg-gray-50 text-gray-700 text-sm font-semibold rounded-lg transition-colors border border-gray-300 shadow-sm\"\n                      >\n                        Decline\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Notifications List */}\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-100\">\n          {filteredNotifications.length > 0 ? (\n            <div className=\"divide-y divide-gray-100\">\n              {filteredNotifications.slice(0, 50).map((notification, index) => (\n                <div\n                  key={notification.id}\n                  className={`p-6 hover:bg-gray-50 transition-colors cursor-pointer ${!notification.read ? 'bg-blue-50' : ''\n                    }`}\n                  onClick={() => markAsRead(notification.id)}\n                >\n                  <div className=\"flex items-start gap-4\">\n                    {/* Avatar or Icon */}\n                    <div className=\"flex-shrink-0\">\n                      {notification.avatar ? (\n                        <div className=\"w-12 h-12 bg-gradient-to-br from-[#FFAF50] to-orange-400 rounded-full flex items-center justify-center text-white font-bold text-sm\">\n                          {notification.avatar}\n                        </div>\n                      ) : (\n                        <div className=\"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-2xl\">\n                          {getNotificationIcon(notification.type)}\n                        </div>\n                      )}\n                    </div>\n\n                    {/* Content */}\n                    <div className=\"flex-1 min-w-0\">\n                      <p className={`text-sm ${!notification.read ? 'font-semibold text-gray-900' : 'text-gray-700'}`}>\n                        {notification.message}\n                      </p>\n                      <p className=\"text-xs text-gray-500 mt-1\">\n                        {notification.time}\n                      </p>\n                    </div>\n\n                    {/* Unread indicator */}\n                    {!notification.read && (\n                      <div className=\"w-2 h-2 bg-[#FFAF50] rounded-full flex-shrink-0 mt-2\"></div>\n                    )}\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-center py-16\">\n              <div className=\"text-6xl mb-4\">≡ƒöö</div>\n              <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">\n                {filter === 'unread' ? 'No unread notifications' : 'No notifications yet'}\n              </h3>\n              <p className=\"text-gray-600\">\n                {filter === 'unread'\n                  ? 'You\\'re all caught up!'\n                  : 'Notifications about likes, comments, and follows will appear here'\n                }\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Settings */}\n        <div className=\"mt-8 bg-white rounded-lg shadow-sm border border-gray-100 p-6\">\n          <h2 className=\"text-lg font-semibold text-gray-900 mb-4\">Notification Settings</h2>\n          <div className=\"space-y-4\">\n            <label className=\"flex items-center justify-between\">\n              <span className=\"text-gray-700\">Email notifications</span>\n              <input type=\"checkbox\" className=\"toggle\" defaultChecked />\n            </label>\n            <label className=\"flex items-center justify-between\">\n              <span className=\"text-gray-700\">Push notifications</span>\n              <input type=\"checkbox\" className=\"toggle\" defaultChecked />\n            </label>\n            <label className=\"flex items-center justify-between\">\n              <span className=\"text-gray-700\">Comment notifications</span>\n              <input type=\"checkbox\" className=\"toggle\" defaultChecked />\n            </label>\n            <label className=\"flex items-center justify-between\">\n              <span className=\"text-gray-700\">Follow notifications</span>\n              <input type=\"checkbox\" className=\"toggle\" defaultChecked />\n            </label>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\profile\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":59,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1919,1922],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1919,1922],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchUserProfile'. Either include it or remove the dependency array.","line":68,"column":6,"nodeType":"ArrayExpression","endLine":68,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchUserProfile, id, token]","fix":{"range":[2190,2201],"text":"[fetchUserProfile, id, token]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":80,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2545,2548],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2545,2548],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'postData' is defined but never used.","line":452,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":452,"endColumn":51},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":460,"column":104,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[23113,23148],"text":" shares posts, they&apos;ll appear here."},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[23113,23148],"text":" shares posts, they&lsquo;ll appear here."},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[23113,23148],"text":" shares posts, they&#39;ll appear here."},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[23113,23148],"text":" shares posts, they&rsquo;ll appear here."},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport Image from 'next/image'\r\nimport { useParams, useRouter } from 'next/navigation';\r\nimport { useAuth } from '../../../contexts/AuthContext';\r\nimport PostCard from '../../../components/PostCard';\r\nimport PostModal from '../../../components/PostModal';\r\nimport FollowButton from '../../../components/FollowButton';\r\nimport FollowersListModal from '../../../components/FollowersListModal';\r\nimport MiniChatWindow from '../../../components/MiniChatWindow';\r\nimport { fetchAPI, dataFetcher } from '../../../lib/dataFetcher';\r\n\r\n// User profile from API\r\ninterface UserProfile {\r\n  id: number;\r\n  name: string;\r\n  username?: string;\r\n  college_id?: string;\r\n  department: string;\r\n  year: number;\r\n  created_at: string;\r\n  bio?: string | null;\r\n  profile_image?: string | null;\r\n  posts?: Post[];\r\n  follower_count?: number;\r\n  following_count?: number;\r\n  post_count?: number;\r\n  is_following?: boolean;\r\n  is_private?: boolean;\r\n  requested?: boolean;\r\n  can_view?: boolean;\r\n}\r\n\r\n// Post from API\r\ninterface Post {\r\n  id: number;\r\n  content: string;\r\n  category: string;\r\n  media_url?: string;\r\n  media_type?: string;\r\n  aura_count: number;\r\n  comment_count: number;\r\n  user_liked: boolean;\r\n  created_at: string;\r\n  user_id: number;\r\n}\r\n\r\nconst ProfilePage = () => {\r\n  const params = useParams();\r\n  const router = useRouter();\r\n  const { user, token } = useAuth();\r\n  const id = params?.id ? String(params.id) : '';\r\n  const [userProfile, setUserProfile] = useState<UserProfile | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [activeTab, setActiveTab] = useState('posts');\r\n  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');\r\n  const [showFollowModal, setShowFollowModal] = useState<{ open: boolean; type: 'followers' | 'following' } | null>(null);\r\n  const [selectedPost, setSelectedPost] = useState<any>(null);\r\n  const [isModalOpen, setIsModalOpen] = useState(false);\r\n  const [showMiniChat, setShowMiniChat] = useState(false);\r\n  const [isBlocked, setIsBlocked] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (id && token) {\r\n      fetchUserProfile();\r\n    }\r\n  }, [id, token]);\r\n\r\n  const fetchUserProfile = async () => {\r\n    try {\r\n      setLoading(true);\r\n      setIsBlocked(false);\r\n      const data = await fetchAPI<{ user: UserProfile }>(\r\n        `/api/users/${id}`,\r\n        { token: token || undefined, cacheTTL: 60000 } // Cache for 1 minute\r\n      );\r\n\r\n      setUserProfile(data.user);\r\n    } catch (error: any) {\r\n      console.error('Error fetching user profile:', error.message);\r\n      if (error.message?.includes('not accessible') || error.message?.includes('blocked')) {\r\n        setIsBlocked(true);\r\n      }\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleFollowChange = (isFollowing: boolean, followerCount: number) => {\r\n    if (userProfile) {\r\n      setUserProfile({\r\n        ...userProfile,\r\n        is_following: isFollowing,\r\n        follower_count: followerCount\r\n      });\r\n      // Clear profile cache after follow/unfollow\r\n      dataFetcher.clearCache(`/api/users/${id}`);\r\n    }\r\n  };\r\n\r\n  const handlePostClick = (post: Post) => {\r\n    const modalPost = {\r\n      id: post.id,\r\n      authorId: userProfile?.id,\r\n      authorName: userProfile?.name || '',\r\n      authorDept: userProfile?.department || '',\r\n      authorYear: userProfile?.year || 1,\r\n      content: post.content,\r\n      category: post.category,\r\n      auraCount: post.aura_count,\r\n      commentCount: post.comment_count || 0,\r\n      timestamp: new Date(post.created_at).toLocaleDateString(),\r\n      profilePic: userProfile?.profile_image || undefined,\r\n      mediaUrl: post.media_url,\r\n      mediaType: post.media_type?.toLowerCase() as 'image' | 'video',\r\n      userLiked: post.user_liked\r\n    };\r\n    setSelectedPost(modalPost);\r\n    setIsModalOpen(true);\r\n  };\r\n\r\n  const handleCloseModal = () => {\r\n    setIsModalOpen(false);\r\n    setSelectedPost(null);\r\n  };\r\n\r\n  const handleMessage = () => {\r\n    // On mobile, open the full messages page directly. On desktop, open mini chat.\r\n    if (typeof window !== 'undefined' && window.innerWidth < 768) {\r\n      router.push(`/messages?user=${userProfile?.id}`);\r\n      return;\r\n    }\r\n\r\n    // Open mini chat window\r\n    setShowMiniChat(true);\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"w-16 h-16 border-4 border-[#FFAF50] border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\r\n          <p className=\"text-gray-600\">Loading...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!userProfile) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <p className=\"text-gray-600\">User not found</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (isBlocked) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\r\n        <div className=\"text-center max-w-md mx-auto p-8\">\r\n          <div className=\"w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6\">\r\n            <svg className=\"w-10 h-10 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n              <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n              <path d=\"M4.93 4.93L19.07 19.07\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n            </svg>\r\n          </div>\r\n          <h2 className=\"text-2xl font-bold text-gray-900 mb-3\">User Not Accessible</h2>\r\n          <p className=\"text-gray-600 mb-6\">\r\n            You cannot view this profile. This may be because you or this user has blocked the other.\r\n          </p>\r\n          <button\r\n            onClick={() => router.push('/')}\r\n            className=\"px-6 py-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition-colors\"\r\n          >\r\n            Go to Home\r\n          </button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const isOwnProfile = user && user.id === userProfile.id;\r\n\r\n  return (\r\n    <div className='bg-white'>\r\n      <div className=\" bg-white max-w-4xl mx-auto px-4 py-8\">\r\n        {/* Profile Header */}\r\n        <div className=\"mb-8\">\r\n          <div className=\"flex flex-col md:flex-row items-start gap-8 mb-6\">\r\n            {/* Avatar */}\r\n            <div className=\"mx-auto md:mx-0\">\r\n              <div className=\"w-32 h-32 md:w-40 md:h-40 bg-gradient-to-br from-[#FFAF50] to-orange-400 rounded-full overflow-hidden ring-4 ring-white shadow-xl\">\r\n                <Image\r\n                  src={userProfile.profile_image || '/uploads/DefaultProfile.jpg'}\r\n                  alt={userProfile.name}\r\n                  className=\"w-full h-full object-cover rounded-full\"\r\n                  onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            {/* User Info */}\r\n            <div className=\"flex-1 text-center md:text-left w-full\">\r\n              {/* Username and Actions */}\r\n              <div className=\"flex flex-col md:flex-row md:items-center gap-4 mb-4\">\r\n                <div className=\"flex items-center justify-center md:justify-start gap-2\">\r\n                  <h1 className=\"text-xl md:text-2xl font-light\">{userProfile.username || userProfile.name}</h1>\r\n                </div>\r\n\r\n                {/* Action Buttons - only show if not own profile and user is logged in */}\r\n                {!isOwnProfile && user && (\r\n                  <div className=\"flex items-center justify-center md:justify-start gap-3\">\r\n                    <FollowButton\r\n                      userId={userProfile.id}\r\n                      isFollowing={userProfile.is_following || false}\r\n                      requested={userProfile.requested || false}\r\n                      onFollowChange={handleFollowChange}\r\n                      size=\"md\"\r\n                    />\r\n                    {/* Message Button - hidden if profile is private and not following */}\r\n                    {(!userProfile.is_private || userProfile.is_following) && (\r\n                      <button\r\n                        onClick={handleMessage}\r\n                        className=\"flex items-center gap-2 px-4 py-2 bg-[#FFAF50] hover:bg-orange-400 text-black font-medium text-sm rounded-lg transition-all duration-200 hover:shadow-md active:scale-95\"\r\n                      >\r\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                          <path d=\"M8.5 19H8C4 19 2 17 2 13V8C2 4 4 2 8 2H16C20 2 22 4 22 8V13C22 17 20 19 16 19H15.5C15.19 19 14.89 19.15 14.7 19.4L13.2 21.4C12.54 22.28 11.46 22.28 10.8 21.4L9.3 19.4C9.14 19.18 8.77 19 8.5 19Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeMiterlimit=\"10\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                          <path d=\"M15.9965 11H16.0054\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                          <path d=\"M11.9955 11H12.0045\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                          <path d=\"M7.99451 11H8.00349\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                        </svg>\r\n                        Message\r\n                      </button>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {/* Stats */}\r\n              <div className=\"flex items-center justify-center md:justify-start gap-8 mb-4\">\r\n                <div className=\"text-center md:text-left\">\r\n                  <span className=\"font-semibold text-gray-900\">{userProfile.post_count || userProfile.posts?.length || 0}</span>\r\n                  <span className=\"text-gray-600 ml-1\">posts</span>\r\n                </div>\r\n                <button\r\n                  onClick={() => setShowFollowModal({ open: true, type: 'followers' })}\r\n                  className=\"text-center md:text-left hover:underline\"\r\n                >\r\n                  <span className=\"font-semibold text-gray-900\">{userProfile.follower_count || 0}</span>\r\n                  <span className=\"text-gray-600 ml-1\">followers</span>\r\n                </button>\r\n                <button\r\n                  onClick={() => setShowFollowModal({ open: true, type: 'following' })}\r\n                  className=\"text-center md:text-left hover:underline\"\r\n                >\r\n                  <span className=\"font-semibold text-gray-900\">{userProfile.following_count || 0}</span>\r\n                  <span className=\"text-gray-600 ml-1\">following</span>\r\n                </button>\r\n              </div>\r\n\r\n              {/* Bio */}\r\n              <div className=\"text-center md:text-left\">\r\n                <h2 className=\"font-semibold text-gray-900 mb-1\">{userProfile.name}</h2>\r\n                <p className=\"text-gray-600 text-sm mb-1\">{userProfile.department} ΓÇó {userProfile.year}rd Year</p>\r\n                {userProfile.bio && (\r\n                  <p className=\"text-gray-800 text-sm leading-relaxed mb-2\">{userProfile.bio}</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Tabs */}\r\n        <div className=\"border-t border-gray-200\">\r\n          <div className=\"flex items-center justify-center gap-16 pt-4\">\r\n            <button\r\n              onClick={() => { setActiveTab('posts'); setViewMode('grid'); }}\r\n              className={`flex items-center gap-2 pb-3 px-1 text-xs font-medium uppercase tracking-wide ${activeTab === 'posts'\r\n                ? 'border-t-2 border-gray-900 text-gray-900'\r\n                : 'text-gray-500 hover:text-gray-700'\r\n                }`}\r\n            >\r\n              <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                <rect x=\"3\" y=\"3\" width=\"7\" height=\"7\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n                <rect x=\"14\" y=\"3\" width=\"7\" height=\"7\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n                <rect x=\"3\" y=\"14\" width=\"7\" height=\"7\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n                <rect x=\"14\" y=\"14\" width=\"7\" height=\"7\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n              </svg>\r\n              Posts\r\n            </button>\r\n\r\n            {/* Only show saved/tagged tabs for own profile */}\r\n            {isOwnProfile && (\r\n              <>\r\n                <button\r\n                  onClick={() => setActiveTab('saved')}\r\n                  className={`flex items-center gap-2 pb-3 px-1 text-xs font-medium uppercase tracking-wide ${activeTab === 'saved'\r\n                    ? 'border-t-2 border-gray-900 text-gray-900'\r\n                    : 'text-gray-500 hover:text-gray-700'\r\n                    }`}\r\n                >\r\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M5 7.8C5 6.11984 5 5.27976 5.32698 4.63803C5.6146 4.07354 6.07354 3.6146 6.63803 3.32698C7.27976 3 8.11984 3 9.8 3H14.2C15.8802 3 16.7202 3 17.362 3.32698C17.9265 3.6146 18.3854 4.07354 18.673 4.63803C19 5.27976 19 6.11984 19 7.8V21L12 17L5 21V7.8Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                  </svg>\r\n                  Saved\r\n                </button>\r\n\r\n                <button\r\n                  onClick={() => setActiveTab('tagged')}\r\n                  className={`flex items-center gap-2 pb-3 px-1 text-xs font-medium uppercase tracking-wide ${activeTab === 'tagged'\r\n                    ? 'border-t-2 border-gray-900 text-gray-900'\r\n                    : 'text-gray-500 hover:text-gray-700'\r\n                    }`}\r\n                >\r\n                  <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M17.25 6.75L22.5 12L17.25 17.25H4.5V6.75H17.25Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                    <path d=\"M9 9.75L12 12.75L15 9.75\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                  </svg>\r\n                  Tagged\r\n                </button>\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"mt-6\">\r\n          {activeTab === 'posts' && (\r\n            <div className=\"space-y-6\">\r\n              {/* Private account gate */}\r\n              {!isOwnProfile && userProfile.is_private && userProfile.can_view === false && (\r\n                <div className=\"text-center py-16\">\r\n                  <div className=\"text-4xl mb-3\">≡ƒöÆ</div>\r\n                  <div className=\"text-gray-900 text-lg font-semibold mb-1\">This account is private</div>\r\n                  <div className=\"text-gray-500 text-sm\">Follow to see their photos and videos.</div>\r\n                </div>\r\n              )}\r\n\r\n              {(!userProfile.is_private || isOwnProfile || userProfile.can_view) && (\r\n                <>\r\n                  {/* View Toggle */}\r\n                  <div className=\"flex items-center justify-end gap-2\">\r\n                    <button\r\n                      onClick={() => setViewMode('grid')}\r\n                      className={`p-2 rounded-lg ${viewMode === 'grid' ? 'bg-gray-500' : 'hover:bg-gray-50'}`}\r\n                    >\r\n                      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                        <rect x=\"3\" y=\"3\" width=\"7\" height=\"7\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                        <rect x=\"14\" y=\"3\" width=\"7\" height=\"7\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                        <rect x=\"3\" y=\"14\" width=\"7\" height=\"7\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                        <rect x=\"14\" y=\"14\" width=\"7\" height=\"7\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                      </svg>\r\n                    </button>\r\n                    <button\r\n                      onClick={() => setViewMode('list')}\r\n                      className={`p-2 rounded-lg ${viewMode === 'list' ? 'bg-gray-100' : 'hover:bg-gray-50'}`}\r\n                    >\r\n                      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                        <line x1=\"8\" y1=\"6\" x2=\"21\" y2=\"6\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                        <line x1=\"8\" y1=\"12\" x2=\"21\" y2=\"12\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                        <line x1=\"8\" y1=\"18\" x2=\"21\" y2=\"18\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                        <line x1=\"3\" y1=\"6\" x2=\"3.01\" y2=\"6\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                        <line x1=\"3\" y1=\"12\" x2=\"3.01\" y2=\"12\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                        <line x1=\"3\" y1=\"18\" x2=\"3.01\" y2=\"18\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                      </svg>\r\n                    </button>\r\n                  </div>\r\n\r\n                  {userProfile.posts && userProfile.posts.length > 0 ? (\r\n                    viewMode === 'grid' ? (\r\n                      <div className=\"grid grid-cols-3 gap-1 md:gap-4\">\r\n                        {userProfile.posts.map(post => (\r\n                          <div\r\n                            key={post.id}\r\n                            className=\"aspect-square bg-gradient-to-br from-gray-100 to-gray-200 rounded-none md:rounded-lg overflow-hidden group cursor-pointer relative\"\r\n                            onClick={() => handlePostClick(post)}\r\n                          >\r\n                            {post.media_url ? (\r\n                              post.media_type?.toLowerCase() === 'video' ? (\r\n                                <video\r\n                                  src={post.media_url}\r\n                                  className=\"w-full h-full object-cover group-hover:scale-105 transition-transform duration-300\"\r\n                                  muted\r\n                                  preload=\"metadata\"\r\n                                  onError={(e) => {\r\n                                    console.error('Video load error:', e);\r\n                                    e.currentTarget.style.display = 'none';\r\n                                  }}\r\n                                />\r\n                              ) : (\r\n                                <Image\r\n                                  src={post.media_url}\r\n                                  alt={post.content}\r\n                                  className=\"w-full h-full object-cover group-hover:scale-105 transition-transform duration-300\"\r\n                                  loading=\"lazy\"\r\n                                  onError={(e) => {\r\n                                    console.error('Image load error:', e);\r\n                                    e.currentTarget.style.display = 'none';\r\n                                  }}\r\n                                  onLoad={() => {\r\n                                    console.log('Image loaded successfully:', post.media_url);\r\n                                  }}\r\n                                />\r\n                              )\r\n                            ) : (\r\n                              <div className=\"w-full h-full bg-gradient-to-br from-[#FFAF50]/20 to-orange-200 flex flex-col items-center justify-center p-4\">\r\n                                <p className=\"text-gray-700 text-sm text-center line-clamp-3\">{post.content}</p>\r\n                              </div>\r\n                            )}\r\n                            <div className=\"absolute inset-0 bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center\">\r\n                              <div className=\"opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center gap-4 text-white\">\r\n                                <div className=\"flex items-center gap-1\">\r\n                                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 100 100\" fill=\"white\">\r\n                                    <polygon points=\"77.333,33.31 55.438,33.31 75.43,1.829 47.808,1.829 23.198,51.05 41.882,51.05 21.334,99.808\" />\r\n                                  </svg>\r\n                                  <span className=\"font-semibold\">{post.aura_count}</span>\r\n                                </div>\r\n                                <div className=\"flex items-center gap-1\">\r\n                                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n                                    <path d=\"M8.5 12H8.51M12 12H12.01M15.5 12H15.51M21 12C21 16.418 16.97 20 12 20C10.89 20 9.84 19.79 8.88 19.42L3 21L4.58 15.12C4.21 14.16 4 13.11 4 12C4 7.582 8.03 4 12 4C16.97 4 21 7.582 21 12Z\"\r\n                                      stroke=\"white\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                                  </svg>\r\n                                  <span className=\"font-semibold\">{post.comment_count || 0}</span>\r\n                                </div>\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    ) : (\r\n                      <div className=\"space-y-6\">\r\n                        {userProfile.posts.map(post => (\r\n                          <PostCard\r\n                            key={post.id}\r\n                            id={post.id}\r\n                            authorId={userProfile.id}\r\n                            authorName={userProfile.name}\r\n                            authorDept={userProfile.department}\r\n                            authorYear={userProfile.year}\r\n                            content={post.content}\r\n                            category={post.category}\r\n                            auraCount={post.aura_count}\r\n                            commentCount={post.comment_count || 0}\r\n                            timestamp={new Date(post.created_at).toLocaleDateString()}\r\n                            mediaUrl={post.media_url}\r\n                            mediaType={post.media_type as 'image' | 'video'}\r\n                            userLiked={post.user_liked}\r\n                            profilePic={userProfile.profile_image || undefined}\r\n                            onPostClick={(postData) => handlePostClick(post)}\r\n                          />\r\n                        ))}\r\n                      </div>\r\n                    )\r\n                  ) : (\r\n                    <div className=\"text-center py-16\">\r\n                      <div className=\"text-gray-600 text-lg font-light mb-2\">No posts yet</div>\r\n                      <div className=\"text-gray-500 text-sm\">When {userProfile.name} shares posts, they'll appear here.</div>\r\n                    </div>\r\n                  )}\r\n                </>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'saved' && (\r\n            <div className=\"text-center py-16\">\r\n              <svg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"mx-auto mb-4 text-gray-300\">\r\n                <path d=\"M5 7.8C5 6.11984 5 5.27976 5.32698 4.63803C5.6146 4.07354 6.07354 3.6146 6.63803 3.32698C7.27976 3 8.11984 3 9.8 3H14.2C15.8802 3 16.7202 3 17.362 3.32698C17.9265 3.6146 18.3854 4.07354 18.673 4.63803C19 5.27976 19 6.11984 19 7.8V21L12 17L5 21V7.8Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n              </svg>\r\n              <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">No saved posts yet</h3>\r\n              <p className=\"text-gray-600\">Save posts to see them here</p>\r\n            </div>\r\n          )}\r\n\r\n          {activeTab === 'tagged' && (\r\n            <div className=\"text-center py-16\">\r\n              <svg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"mx-auto mb-4 text-gray-300\">\r\n                <path d=\"M17.25 6.75L22.5 12L17.25 17.25H4.5V6.75H17.25Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n              </svg>\r\n              <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">No tagged posts</h3>\r\n              <p className=\"text-gray-600\">When people tag {userProfile.name} in posts, they&apos;ll appear here</p>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Followers/Following Modal */}\r\n        {showFollowModal?.open && (\r\n          <FollowersListModal\r\n            isOpen={showFollowModal.open}\r\n            onClose={() => setShowFollowModal(null)}\r\n            userId={userProfile.id}\r\n            type={showFollowModal.type}\r\n          />\r\n        )}\r\n\r\n        {/* Post Modal */}\r\n        {isModalOpen && selectedPost && (\r\n          <PostModal\r\n            isOpen={isModalOpen}\r\n            onClose={handleCloseModal}\r\n            post={selectedPost}\r\n            canManage={false}\r\n          />\r\n        )}\r\n\r\n        {/* Mini Chat Window */}\r\n        {showMiniChat && userProfile && (\r\n          <MiniChatWindow\r\n            isOpen={showMiniChat}\r\n            onClose={() => setShowMiniChat(false)}\r\n            otherUser={{\r\n              id: userProfile.id,\r\n              name: userProfile.name,\r\n              profile_image: userProfile.profile_image,\r\n              department: userProfile.department,\r\n              year: userProfile.year\r\n            }}\r\n          />\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ProfilePage;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\profile\\me\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":157,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":157,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":192,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":192,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":236,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":236,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8754,8757],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8754,8757],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":251,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":251,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9210,9213],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9210,9213],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":300,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":300,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10716,10719],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10716,10719],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleTabChange' is assigned a value but never used.","line":347,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":347,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":358,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":358,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12524,12527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12524,12527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":359,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":359,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12609,12612],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12609,12612],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchUserProfile'. Either include it or remove the dependency array.","line":360,"column":6,"nodeType":"ArrayExpression","endLine":360,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchUserProfile]","fix":{"range":[12621,12623],"text":"[fetchUserProfile]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":406,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":406,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14244,14247],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14244,14247],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":419,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":419,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14772,14775],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14772,14775],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":486,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":486,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16694,16697],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16694,16697],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handlePostClick' is assigned a value but never used.","line":499,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":499,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":561,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":561,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19133,19136],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19133,19136],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":606,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":606,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20492,20495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20492,20495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":640,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":640,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21600,21603],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21600,21603],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchUserProfile'. Either include it or remove the dependency array.","line":277,"column":6,"nodeType":"ArrayExpression","endLine":277,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [user, token, fetchUserProfile]","fix":{"range":[9882,9895],"text":"[user, token, fetchUserProfile]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":11,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport Image from 'next/image'\r\nimport React, { useState, useEffect, useRef } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { useAuth } from '@/../../contexts/AuthContext';\r\nimport PostCard from '@/../../components/PostCard';\r\nimport PostModal from '@/../../components/PostModal';\r\nimport FollowersListModal from '@/../../components/FollowersListModal';\r\nimport { useIsMobile } from '@/../../hooks/useIsMobile';\r\nimport { fetchAPI, dataFetcher } from '@/../../lib/dataFetcher';\r\n\r\n// User profile from API\r\ninterface UserProfile {\r\n  id: number;\r\n  name: string;\r\n  username?: string;\r\n  college_id?: string;\r\n  department: string;\r\n  year: number;\r\n  created_at: string;\r\n  bio?: string | null;\r\n  profile_image?: string | null;\r\n  posts?: Post[];\r\n  _count?: {\r\n    posts: number;\r\n    followers: number;\r\n    following: number;\r\n  };\r\n  follower_count?: number;\r\n  following_count?: number;\r\n  post_count?: number;\r\n  is_private?: boolean;\r\n}\r\n\r\n// Post from API\r\ninterface Post {\r\n  id: number;\r\n  content: string;\r\n  category: string;\r\n  media_url?: string;\r\n  media_type?: string;\r\n  aura_count: number;\r\n  user_liked: boolean;\r\n  created_at: string;\r\n  author: {\r\n    id: number;\r\n    name: string;\r\n    department: string;\r\n    year: number;\r\n  };\r\n}\r\n\r\n// Helper to infer media type reliably\r\nfunction inferPostType(post: Post): 'image' | 'video' {\r\n  const declared = (post.media_type || '').toLowerCase();\r\n  if (declared === 'image' || declared === 'video') return declared as 'image' | 'video';\r\n  const url = (post.media_url || '').toLowerCase();\r\n  if (!url) return 'image';\r\n  if (url.includes('/video/') || /(\\.mp4|\\.webm|\\.mov|\\.avi|\\.wmv)$/i.test(url)) return 'video';\r\n  return 'image';\r\n}\r\n\r\n// PostModal expected type\r\ninterface PostModalData {\r\n  id: number;\r\n  authorName: string;\r\n  authorDept: string;\r\n  authorYear: number;\r\n  content: string;\r\n  category?: string;\r\n  auraCount: number;\r\n  commentCount: number;\r\n  timestamp: string;\r\n  profilePic?: string;\r\n  mediaUrl?: string;\r\n  mediaType?: 'image' | 'video';\r\n  location?: string;\r\n  userLiked?: boolean;\r\n  mediaCarousel?: Array<{\r\n    url: string;\r\n    type: 'image' | 'video';\r\n  }>;\r\n}\r\n\r\n// Video Grid Tile Component with hover-to-play\r\ninterface VideoGridTileProps {\r\n  post: Post;\r\n  onClick: () => void;\r\n}\r\n\r\nconst VideoGridTile: React.FC<VideoGridTileProps> = ({ post, onClick }) => {\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const [isVideoHovered, setIsVideoHovered] = useState(false);\r\n  const [videoDuration, setVideoDuration] = useState<number | null>(null);\r\n  const [videoError, setVideoError] = useState(false);\r\n  const [videoLoaded, setVideoLoaded] = useState(false);\r\n\r\n  const formatDuration = (seconds: number): string => {\r\n    const mins = Math.floor(seconds / 60);\r\n    const secs = Math.floor(seconds % 60);\r\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n  };\r\n\r\n  const handleVideoMouseEnter = () => {\r\n    setIsVideoHovered(true);\r\n    if (videoRef.current) {\r\n      videoRef.current.play().catch(console.error);\r\n    }\r\n  };\r\n\r\n  const handleVideoMouseLeave = () => {\r\n    setIsVideoHovered(false);\r\n    if (videoRef.current) {\r\n      videoRef.current.pause();\r\n      videoRef.current.currentTime = 0;\r\n    }\r\n  };\r\n\r\n  const handleVideoLoadedMetadata = () => {\r\n    if (videoRef.current) {\r\n      setVideoDuration(videoRef.current.duration);\r\n      setVideoLoaded(true);\r\n      console.log('Profile video loaded successfully:', post.media_url);\r\n    }\r\n  };\r\n\r\n  const kind = inferPostType(post);\r\n\r\n  return (\r\n    <button onClick={onClick} className=\"group relative aspect-square bg-gray-100 overflow-hidden rounded-2xl\">\r\n      {post.media_url ? (\r\n        kind === 'video' ? (\r\n          !videoError ? (\r\n            <div\r\n              className=\"relative w-full h-full\"\r\n              onMouseEnter={handleVideoMouseEnter}\r\n              onMouseLeave={handleVideoMouseLeave}\r\n            >\r\n              {/* Loading state for videos */}\r\n              {!videoLoaded && (\r\n                <div className=\"absolute inset-0 bg-gray-100 rounded-2xl flex items-center justify-center z-10\">\r\n                  <div className=\"text-center\">\r\n                    <div className=\"text-2xl mb-2\">≡ƒÄÑ</div>\r\n                    <div className=\"text-sm text-gray-500\">Loading...</div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n              <video\r\n                ref={videoRef}\r\n                src={post.media_url}\r\n                className=\"w-full h-full object-cover rounded-2xl\"\r\n                muted\r\n                playsInline\r\n                preload=\"metadata\"\r\n                onLoadedMetadata={handleVideoLoadedMetadata}\r\n                onError={(e) => {\r\n                  console.error('Profile video error:', post.media_url);\r\n                  setVideoError(true);\r\n                }}\r\n                onLoadStart={() => {\r\n                  console.log('Profile video loading started:', post.media_url);\r\n                }}\r\n              />\r\n              {/* Duration badge - hidden on hover */}\r\n              {videoDuration && !isVideoHovered && videoLoaded && (\r\n                <div className=\"absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded\">\r\n                  {formatDuration(videoDuration)}\r\n                </div>\r\n              )}\r\n            </div>\r\n          ) : (\r\n            <div className=\"w-full h-full flex items-center justify-center text-gray-400 bg-gray-100 rounded-2xl\">\r\n              <div className=\"text-center\">\r\n                <div className=\"text-2xl mb-2\">≡ƒÄÑ</div>\r\n                <div className=\"text-sm\">Video unavailable</div>\r\n              </div>\r\n            </div>\r\n          )\r\n        ) : (\r\n          <Image src={post.media_url} alt={post.content?.slice(0, 40)} className=\"w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 rounded-2xl\" />\r\n        )\r\n      ) : (\r\n        <div className=\"w-full h-full flex items-center justify-center text-gray-400 text-sm p-4 rounded-2xl\">{post.content}</div>\r\n      )}\r\n    </button>\r\n  );\r\n};\r\n\r\nexport default function ProfilePage() {\r\n  const { user, token } = useAuth();\r\n  const router = useRouter();\r\n  const isMobile = useIsMobile();\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [userProfile, setUserProfile] = useState<UserProfile | null>(null);\r\n  const [posts, setPosts] = useState<Post[]>([]);\r\n  const [savedPosts, setSavedPosts] = useState<Post[]>([]);\r\n  const [taggedPosts, setTaggedPosts] = useState<Post[]>([]);\r\n  const [activeTab, setActiveTab] = useState<'posts' | 'saved' | 'tagged'>('posts');\r\n  const [loading, setLoading] = useState(true);\r\n  const [tabLoading, setTabLoading] = useState(false);\r\n  const [selectedPost, setSelectedPost] = useState<PostModalData | null>(null);\r\n  const [isModalOpen, setIsModalOpen] = useState(false);\r\n  const [showFollowModal, setShowFollowModal] = useState<{ open: boolean; type: 'followers' | 'following' } | null>(null);\r\n  const [editForm, setEditForm] = useState({\r\n    name: user?.name || '',\r\n    department: user?.department || '',\r\n    year: user?.year || 1\r\n  });\r\n  const [editUsername, setEditUsername] = useState('');\r\n  const [editBio, setEditBio] = useState('');\r\n  const [editPfp, setEditPfp] = useState<string | null>(null);\r\n  const [savingProfile, setSavingProfile] = useState(false);\r\n  const [profileError, setProfileError] = useState<string | null>(null);\r\n  const [uploadingPfp, setUploadingPfp] = useState(false);\r\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // New: media filter for posts (All / Images / Reels)\r\n  const [postMediaFilter, setPostMediaFilter] = useState<'all' | 'images' | 'reels'>('all');\r\n\r\n  // Mobile fullscreen overlay state\r\n  const [isFullscreenListOpen, setIsFullscreenListOpen] = useState(false);\r\n  const [fullscreenStartPostId, setFullscreenStartPostId] = useState<number | null>(null);\r\n  const scrollRef = useRef<HTMLDivElement | null>(null);\r\n  const isMountedRef = useRef(true);\r\n  const [optionsPostId, setOptionsPostId] = useState<number | null>(null);\r\n  const [isDeletingId, setIsDeletingId] = useState<number | null>(null);\r\n  const [isSavingId, setIsSavingId] = useState<number | null>(null);\r\n\r\n  // Scroll to tapped post when overlay opens (must be before any early returns)\r\n  useEffect(() => {\r\n    if (isFullscreenListOpen && fullscreenStartPostId && scrollRef.current) {\r\n      const el = scrollRef.current.querySelector<HTMLDivElement>(`[data-post-id=\"${fullscreenStartPostId}\"]`);\r\n      if (el) {\r\n        el.scrollIntoView({ behavior: 'auto', block: 'start' } as any);\r\n      }\r\n    }\r\n  }, [isFullscreenListOpen, fullscreenStartPostId]);\r\n\r\n  useEffect(() => {\r\n    return () => { isMountedRef.current = false; };\r\n  }, []);\r\n\r\n  const loadProfileFromCache = () => {\r\n    try {\r\n      const raw = localStorage.getItem('me_profile_cache');\r\n      if (!raw) return null;\r\n      const parsed = JSON.parse(raw) as { timestamp: number; user: UserProfile };\r\n      if (parsed?.user) {\r\n        setUserProfile(parsed.user as any);\r\n        setPosts(parsed.user.posts || []);\r\n        return parsed.user;\r\n      }\r\n    } catch { }\r\n    return null;\r\n  };\r\n\r\n  const saveProfileToCache = (profile: UserProfile) => {\r\n    try {\r\n      const payload = JSON.stringify({ timestamp: Date.now(), user: profile });\r\n      localStorage.setItem('me_profile_cache', payload);\r\n    } catch { }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (user && token) {\r\n      const cached = loadProfileFromCache();\r\n      if (cached) {\r\n        setLoading(false);\r\n        fetchUserProfile(true);\r\n      } else {\r\n        fetchUserProfile(false);\r\n      }\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user, token]);\r\n\r\n  const fetchUserProfile = async (background: boolean) => {\r\n    setProfileError(null);\r\n    if (!background) setLoading(true);\r\n\r\n    console.log('Starting profile fetch...');\r\n\r\n    try {\r\n      const data = await fetchAPI('/api/users/me', {\r\n        token: token || '',\r\n        cacheTTL: background ? 0 : 60000, // Skip cache for background refresh, 60s cache otherwise\r\n        skipCache: background\r\n      }) as { user: UserProfile };\r\n\r\n      if (!isMountedRef.current) return;\r\n      console.log('Profile fetched successfully');\r\n      setUserProfile(data.user);\r\n      setEditUsername(data.user?.username || '');\r\n      setEditBio(data.user?.bio || '');\r\n      setEditPfp(data.user?.profile_image || null);\r\n      setPosts(data.user.posts || []);\r\n      saveProfileToCache(data.user);\r\n    } catch (error: any) {\r\n      console.error('Error fetching profile:', error);\r\n      const errorMsg = error?.name === 'AbortError'\r\n        ? 'Profile load timed out. Please check your connection.'\r\n        : 'Network error loading profile. Please try again.';\r\n      setProfileError(errorMsg);\r\n    } finally {\r\n      if (!isMountedRef.current) return;\r\n      if (!background) setLoading(false);\r\n      console.log('Profile fetch completed');\r\n    }\r\n  };\r\n\r\n  const fetchSavedPosts = async () => {\r\n    setTabLoading(true);\r\n    try {\r\n      const data = await fetchAPI('/api/users/me/saved', {\r\n        token: token || '',\r\n        cacheTTL: 30000 // 30 seconds cache for saved posts\r\n      }) as { posts: Post[] };\r\n\r\n      setSavedPosts(data.posts || []);\r\n    } catch (error) {\r\n      console.error('Error fetching saved posts:', error);\r\n      setSavedPosts([]);\r\n    } finally {\r\n      setTabLoading(false);\r\n    }\r\n  };\r\n\r\n  const fetchTaggedPosts = async () => {\r\n    setTabLoading(true);\r\n    try {\r\n      const data = await fetchAPI('/api/users/me/tagged', {\r\n        token: token || '',\r\n        cacheTTL: 30000 // 30 seconds cache for tagged posts\r\n      }) as { posts: Post[] };\r\n\r\n      setTaggedPosts(data.posts || []);\r\n    } catch (error) {\r\n      console.error('Error fetching tagged posts:', error);\r\n      setTaggedPosts([]);\r\n    } finally {\r\n      setTabLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleTabChange = (tab: 'posts' | 'saved' | 'tagged') => {\r\n    setActiveTab(tab);\r\n    if (tab === 'saved' && savedPosts.length === 0) {\r\n      fetchSavedPosts();\r\n    } else if (tab === 'tagged' && taggedPosts.length === 0) {\r\n      fetchTaggedPosts();\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const handler = () => fetchUserProfile(true);\r\n    window.addEventListener('followCountsChanged', handler as any);\r\n    return () => window.removeEventListener('followCountsChanged', handler as any);\r\n  }, []);\r\n\r\n  // Listen for new post creation\r\n  useEffect(() => {\r\n    const handlePostCreated = (event: CustomEvent) => {\r\n      const newPost = event.detail;\r\n      if (newPost) {\r\n        console.log('New post created, adding to profile:', newPost);\r\n        // Add new post to the beginning of the posts array\r\n        setPosts(prev => [newPost, ...prev]);\r\n\r\n        // Update user profile post count\r\n        if (userProfile) {\r\n          const updatedProfile = {\r\n            ...userProfile,\r\n            posts: [newPost, ...(userProfile.posts || [])],\r\n            _count: {\r\n              posts: (userProfile._count?.posts || 0) + 1,\r\n              followers: userProfile._count?.followers || 0,\r\n              following: userProfile._count?.following || 0\r\n            }\r\n          };\r\n          setUserProfile(updatedProfile);\r\n          saveProfileToCache(updatedProfile);\r\n        }\r\n      }\r\n    };\r\n\r\n    window.addEventListener('postCreated', handlePostCreated as EventListener);\r\n    return () => window.removeEventListener('postCreated', handlePostCreated as EventListener);\r\n  }, [userProfile]);\r\n\r\n  if (!user || (loading && !userProfile)) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"w-16 h-16 border-4 border-[#FFAF50] border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\r\n          <p className=\"text-gray-600\">Loading...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const handleSave = async () => {\r\n    setSavingProfile(true);\r\n    try {\r\n      const payload: any = { ...editForm, bio: editBio, username: editUsername, profile_image: editPfp };\r\n      const data = await fetchAPI('/api/users/me', {\r\n        method: 'PUT',\r\n        token: token || '',\r\n        body: JSON.stringify(payload),\r\n        skipCache: true\r\n      }) as { user: UserProfile };\r\n\r\n      setUserProfile(data.user);\r\n      setIsEditing(false);\r\n      setHasUnsavedChanges(false);\r\n      saveProfileToCache(data.user);\r\n      dataFetcher.clearCache('/api/users/me'); // Clear cache after update\r\n    } catch (error: any) {\r\n      console.error('Error updating profile:', error);\r\n      alert(error.message || 'Failed to update profile');\r\n    } finally {\r\n      setSavingProfile(false);\r\n    }\r\n  };\r\n\r\n  const handleCancelEdit = () => {\r\n    if (hasUnsavedChanges) {\r\n      if (confirm('You have unsaved changes. Discard them?')) {\r\n        resetEditForm();\r\n        setIsEditing(false);\r\n        setHasUnsavedChanges(false);\r\n      }\r\n    } else {\r\n      resetEditForm();\r\n      setIsEditing(false);\r\n    }\r\n  };\r\n\r\n  const resetEditForm = () => {\r\n    setEditForm({\r\n      name: userProfile?.name || user?.name || '',\r\n      department: userProfile?.department || user?.department || '',\r\n      year: userProfile?.year || user?.year || 1\r\n    });\r\n    setEditUsername(userProfile?.username || '');\r\n    setEditBio(userProfile?.bio || '');\r\n    setEditPfp(userProfile?.profile_image || null);\r\n  };\r\n\r\n  const handleFormChange = () => {\r\n    setHasUnsavedChanges(true);\r\n  };\r\n\r\n  const handleProfilePicUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    // Validate file type\r\n    if (!file.type.startsWith('image/')) {\r\n      alert('Please select an image file');\r\n      return;\r\n    }\r\n\r\n    // Validate file size (max 10MB to match server config)\r\n    if (file.size > 10 * 1024 * 1024) {\r\n      alert('Image size should be less than 10MB');\r\n      return;\r\n    }\r\n\r\n    setUploadingPfp(true);\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append('file', file);\r\n\r\n      // Upload to our API endpoint\r\n      const data = await fetchAPI('/api/users/upload-profile-pic', {\r\n        method: 'POST',\r\n        token: token || '',\r\n        body: formData,\r\n        skipCache: true\r\n      }) as { url: string };\r\n\r\n      setEditPfp(data.url);\r\n      dataFetcher.clearCache('/api/users/me'); // Clear cache after upload\r\n    } catch (error: any) {\r\n      console.error('Profile picture upload error:', error);\r\n      const errorMessage = error.message || 'Failed to upload image';\r\n      alert(`Upload failed: ${errorMessage}`);\r\n    } finally {\r\n      setUploadingPfp(false);\r\n      // Reset file input\r\n      if (fileInputRef.current) {\r\n        fileInputRef.current.value = '';\r\n      }\r\n    }\r\n  };\r\n\r\n  const handlePostClick = (postCardData: {\r\n    id: number;\r\n    authorName: string;\r\n    authorDept: string;\r\n    authorYear: number;\r\n    content: string;\r\n    category?: string;\r\n    auraCount: number;\r\n    commentCount: number;\r\n    timestamp: string;\r\n    profilePic?: string;\r\n    mediaUrl?: string;\r\n    mediaType?: 'image' | 'video';\r\n    userLiked?: boolean;\r\n  }) => {\r\n    const modalPost: PostModalData = {\r\n      id: postCardData.id,\r\n      authorName: postCardData.authorName,\r\n      authorDept: postCardData.authorDept,\r\n      authorYear: postCardData.authorYear,\r\n      content: postCardData.content,\r\n      category: postCardData.category,\r\n      auraCount: postCardData.auraCount,\r\n      commentCount: postCardData.commentCount,\r\n      timestamp: postCardData.timestamp,\r\n      profilePic: postCardData.profilePic,\r\n      mediaUrl: postCardData.mediaUrl,\r\n      mediaType: postCardData.mediaType,\r\n      userLiked: postCardData.userLiked,\r\n      location: undefined\r\n    };\r\n    setSelectedPost(modalPost);\r\n    setIsModalOpen(true);\r\n  };\r\n\r\n  const handleCloseModal = () => {\r\n    setIsModalOpen(false);\r\n    setSelectedPost(null);\r\n  };\r\n\r\n  // Open mobile fullscreen list\r\n  const openFullscreenFromGrid = (postId: number) => {\r\n    if (isMobile) {\r\n      setFullscreenStartPostId(postId);\r\n      setIsFullscreenListOpen(true);\r\n    } else {\r\n      const p = posts.find((pp) => pp.id === postId);\r\n      if (!p) return;\r\n      const modalPost: PostModalData = {\r\n        id: p.id,\r\n        authorName: userProfile?.name || user.name,\r\n        authorDept: userProfile?.department || user.department,\r\n        authorYear: userProfile?.year || user.year,\r\n        content: p.content,\r\n        category: p.category,\r\n        auraCount: p.aura_count || 0,\r\n        commentCount: 0,\r\n        timestamp: new Date(p.created_at).toLocaleDateString(),\r\n        profilePic: userProfile?.profile_image || undefined,\r\n        mediaUrl: p.media_url,\r\n        mediaType: (p.media_type as 'image' | 'video') || undefined,\r\n        userLiked: p.user_liked,\r\n      } as any;\r\n      setSelectedPost(modalPost);\r\n      setIsModalOpen(true);\r\n    }\r\n  };\r\n\r\n  const handleDeletePostMobile = async (postId: number) => {\r\n    if (!token) return;\r\n    if (!confirm('Delete this post? This cannot be undone.')) return;\r\n    setIsDeletingId(postId);\r\n    try {\r\n      await fetchAPI(`/api/posts/${postId}`, {\r\n        method: 'DELETE',\r\n        token,\r\n        skipCache: true\r\n      });\r\n\r\n      // Update state\r\n      setPosts(prev => {\r\n        const updated = prev.filter(p => p.id !== postId);\r\n\r\n        // Update cache with new posts array\r\n        if (userProfile) {\r\n          const updatedProfile = {\r\n            ...userProfile,\r\n            posts: updated,\r\n            _count: {\r\n              posts: (userProfile._count?.posts || 0) - 1,\r\n              followers: userProfile._count?.followers || 0,\r\n              following: userProfile._count?.following || 0\r\n            }\r\n          };\r\n          saveProfileToCache(updatedProfile);\r\n          setUserProfile(updatedProfile);\r\n        }\r\n\r\n        return updated;\r\n      });\r\n\r\n      // Clear relevant caches\r\n      dataFetcher.clearCache('/api/users/me');\r\n      dataFetcher.clearCache(`/api/posts/${postId}`);\r\n      dataFetcher.clearCache('/api/posts');\r\n\r\n      window.dispatchEvent(new CustomEvent('postDeleted', { detail: { id: postId } }));\r\n    } catch (error: any) {\r\n      alert(error.message || 'Failed to delete post');\r\n    } finally {\r\n      setIsDeletingId(null);\r\n      setOptionsPostId(null);\r\n    }\r\n  };\r\n\r\n  const handleEditCaptionMobile = async (postId: number, current: string) => {\r\n    if (!token) return;\r\n    const next = window.prompt('Edit caption', current || '');\r\n    if (next === null) return; // cancelled\r\n    const trimmed = next.trim();\r\n    if (!trimmed) {\r\n      alert('Caption cannot be empty');\r\n      return;\r\n    }\r\n    setIsSavingId(postId);\r\n    try {\r\n      await fetchAPI(`/api/posts/${postId}`, {\r\n        method: 'PUT',\r\n        token,\r\n        body: JSON.stringify({ caption: trimmed }),\r\n        skipCache: true\r\n      });\r\n\r\n      setPosts(prev => prev.map(p => p.id === postId ? { ...p, content: trimmed } : p));\r\n\r\n      // Clear relevant caches\r\n      dataFetcher.clearCache('/api/users/me');\r\n      dataFetcher.clearCache(`/api/posts/${postId}`);\r\n      dataFetcher.clearCache('/api/posts');\r\n\r\n      window.dispatchEvent(new CustomEvent('postUpdated', { detail: { id: postId, content: trimmed } }));\r\n    } catch (error: any) {\r\n      alert(error.message || 'Failed to update caption');\r\n    } finally {\r\n      setIsSavingId(null);\r\n      setOptionsPostId(null);\r\n    }\r\n  };\r\n\r\n  const followerCount = userProfile?.follower_count ?? userProfile?._count?.followers ?? 0;\r\n  const followingCount = userProfile?.following_count ?? userProfile?._count?.following ?? 0;\r\n\r\n  const currentPosts = activeTab === 'posts' ? posts : activeTab === 'saved' ? savedPosts : taggedPosts;\r\n  const displayPosts = (() => {\r\n    if (activeTab !== 'posts') return currentPosts;\r\n    if (postMediaFilter === 'images') return currentPosts.filter(p => inferPostType(p) === 'image');\r\n    if (postMediaFilter === 'reels') return currentPosts.filter(p => inferPostType(p) === 'video');\r\n    return currentPosts;\r\n  })();\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-white\">\r\n      {profileError && (\r\n        <div className=\"max-w-4xl mx-auto px-4 pt-4\">\r\n          <div className=\"p-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md\">\r\n            {profileError}\r\n          </div>\r\n        </div>\r\n      )}\r\n      <div className=\"max-w-4xl mx-auto px-4 py-8\">\r\n        {/* Profile Header - compact like Instagram */}\r\n        <div className=\"bg-white p-4 md:p-6 mb-4\">\r\n          <div className=\"flex items-start gap-8\">\r\n            <div className=\"w-28 h-28 md:w-36 md:h-36 rounded-full overflow-hidden bg-gradient-to-br from-gray-200 to-gray-300\">\r\n              <Image\r\n                src={(userProfile?.profile_image || '/uploads/DefaultProfile.jpg') as string}\r\n                alt={userProfile?.name || user.name}\r\n                className=\"w-full h-full object-cover\"\r\n                onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex-1\">\r\n              <div className=\"flex items-center gap-4 mb-4 flex-wrap\">\r\n                <h2 className=\"text-xl md:text-2xl text-gray-800 font-bold\">{userProfile?.username || user.username}</h2>\r\n                <button onClick={() => { setIsEditing(true); resetEditForm(); }} className=\"px-4 py-1.5 text-sm text-lime-300/70 font-semibold rounded-md border border-lime-300/70 hover:bg-gray-50\">Edit Profile</button>\r\n              </div>              <div className=\"flex items-center gap-8 mb-3 text-sm text-gray-800\">\r\n                <div><span className=\"font-semibold mr-1\">{userProfile?.post_count ?? userProfile?._count?.posts ?? posts.length}</span>posts</div>\r\n                <button onClick={() => setShowFollowModal({ open: true, type: 'followers' })} className=\"hover:underline\"><span className=\"font-semibold mr-1\">{followerCount}</span>followers</button>\r\n                <button onClick={() => setShowFollowModal({ open: true, type: 'following' })} className=\"hover:underline\"><span className=\"font-semibold mr-1\">{followingCount}</span>following</button>\r\n              </div>\r\n\r\n              <div className=\"text-sm\">\r\n                <div className=\"font-semibold text-gray-600\">{userProfile?.name || user.name}</div>\r\n                {userProfile?.bio && <div className=\"text-gray-700 whitespace-pre-line\">{userProfile.bio}</div>}\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {isEditing && (\r\n            <div className={`fixed inset-0 z-50 ${isMobile ? '' : 'bg-black/50 flex items-center justify-center p-4'}`}>\r\n              <div className={`${isMobile ? 'w-full h-full bg-white' : 'bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden'}`}>\r\n                {/* Header */}\r\n                <div className=\"sticky top-0 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between\">\r\n                  <button\r\n                    onClick={handleCancelEdit}\r\n                    className=\"text-gray-600 hover:text-gray-900 text-sm font-medium\"\r\n                  >\r\n                    {hasUnsavedChanges ? 'Discard' : 'Cancel'}\r\n                  </button>\r\n                  <h3 className=\"text-lg font-semibold text-gray-900\">Edit Profile</h3>\r\n                  <button\r\n                    onClick={handleSave}\r\n                    disabled={savingProfile}\r\n                    className=\"text-[#FFAF50] hover:text-[#FFAF50]/80 font-semibold text-sm disabled:opacity-50\"\r\n                  >\r\n                    {savingProfile ? 'Saving...' : 'Save'}\r\n                  </button>\r\n                </div>\r\n\r\n                {/* Content */}\r\n                <div className=\"overflow-y-auto\" style={{ maxHeight: isMobile ? 'calc(100vh - 57px)' : 'calc(90vh - 57px)' }}>\r\n                  <div className=\"p-6 space-y-6\">\r\n                    {/* Profile Picture */}\r\n                    <div className=\"flex flex-col items-center gap-4\">\r\n                      <div className=\"w-24 h-24 rounded-full overflow-hidden bg-gray-100\">\r\n                        <Image\r\n                          src={editPfp || '/uploads/DefaultProfile.jpg'}\r\n                          alt=\"Preview\"\r\n                          className=\"w-full h-full object-cover\"\r\n                          onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n                        />\r\n                      </div>\r\n                      <div className=\"text-center\">\r\n                        <input\r\n                          ref={fileInputRef}\r\n                          type=\"file\"\r\n                          accept=\"image/*\"\r\n                          onChange={(e) => { handleProfilePicUpload(e); handleFormChange(); }}\r\n                          className=\"hidden\"\r\n                          id=\"profile-pic-upload\"\r\n                        />\r\n                        <label\r\n                          htmlFor=\"profile-pic-upload\"\r\n                          className={`inline-block px-4 py-2 rounded-lg text-sm font-medium cursor-pointer ${uploadingPfp\r\n                            ? 'bg-gray-100 text-gray-400 cursor-not-allowed'\r\n                            : 'bg-gray-100 text-gray-800 hover:bg-gray-200'\r\n                            }`}\r\n                        >\r\n                          {uploadingPfp ? (\r\n                            <span className=\"flex items-center gap-2\">\r\n                              <div className=\"w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin\"></div>\r\n                              Uploading...\r\n                            </span>\r\n                          ) : (\r\n                            'Change Photo'\r\n                          )}\r\n                        </label>\r\n                        <div className=\"text-xs text-gray-500 mt-2\">\r\n                          Max 10MB ΓÇó JPG, PNG, GIF\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Form Fields */}\r\n                    <div className=\"space-y-4\">\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">Name</label>\r\n                        <input\r\n                          value={editForm.name}\r\n                          onChange={(e) => { setEditForm({ ...editForm, name: e.target.value }); handleFormChange(); }}\r\n                          className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent\"\r\n                          placeholder=\"Enter your name\"\r\n                        />\r\n                      </div>\r\n\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">Username</label>\r\n                        <input\r\n                          value={editUsername}\r\n                          onChange={(e) => { setEditUsername(e.target.value); handleFormChange(); }}\r\n                          className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent\"\r\n                          placeholder=\"Enter your username\"\r\n                        />\r\n                      </div>\r\n\r\n                      <div>\r\n                        <label className=\"block text-sm font-medium text-gray-700 mb-1\">Bio</label>\r\n                        <textarea\r\n                          value={editBio}\r\n                          onChange={(e) => { setEditBio(e.target.value); handleFormChange(); }}\r\n                          rows={4}\r\n                          className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent resize-none\"\r\n                          placeholder=\"Tell us about yourself\"\r\n                        />\r\n                        <div className=\"text-xs text-gray-500 mt-1 text-right\">\r\n                          {editBio.length} / 150\r\n                        </div>\r\n                      </div>\r\n\r\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        <div>\r\n                          <label className=\"block text-sm font-medium text-gray-700 mb-1\">Department</label>\r\n                          <input\r\n                            value={editForm.department}\r\n                            onChange={(e) => { setEditForm({ ...editForm, department: e.target.value }); handleFormChange(); }}\r\n                            className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent\"\r\n                            placeholder=\"Your department\"\r\n                          />\r\n                        </div>\r\n\r\n                        <div>\r\n                          <label className=\"block text-sm font-medium text-gray-700 mb-1\">Year</label>\r\n                          <select\r\n                            value={editForm.year}\r\n                            onChange={(e) => { setEditForm({ ...editForm, year: parseInt(e.target.value) }); handleFormChange(); }}\r\n                            className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent bg-white\"\r\n                          >\r\n                            <option value={1}>1st Year</option>\r\n                            <option value={2}>2nd Year</option>\r\n                            <option value={3}>3rd Year</option>\r\n                            <option value={4}>4th Year</option>\r\n                          </select>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Grid posts like Instagram */}\r\n        <div className=\"bg-white rounded-lg\">\r\n          <div className=\"flex items-center justify-center gap-8 px-8 pt-3 border border-gray-200 rounded-2xl text-xs font-semibold tracking-wider text-gray-500\">\r\n            <button\r\n              onClick={() => setActiveTab('posts')}\r\n              className={`py-3 border-t-2 ${activeTab === 'posts' ? 'border-gray-900 text-gray-900' : 'border-transparent hover:text-gray-700'} transition-colors`}\r\n            >\r\n              POSTS\r\n            </button>\r\n            <button\r\n              onClick={() => setActiveTab('saved')}\r\n              className={`py-3 border-t-2 ${activeTab === 'saved' ? 'border-gray-900 text-gray-900' : 'border-transparent hover:text-gray-700'} transition-colors`}\r\n            >\r\n              SAVED\r\n            </button>\r\n            <button\r\n              onClick={() => setActiveTab('tagged')}\r\n              className={`py-3 border-t-2 ${activeTab === 'tagged' ? 'border-gray-900 text-gray-900' : 'border-transparent hover:text-gray-700'} transition-colors`}\r\n            >\r\n              TAGGED\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"p-4 md:p-6\">\r\n            {activeTab === 'posts' && (\r\n              <div className=\"flex items-center gap-2 mb-4\">\r\n                <button\r\n                  onClick={() => setPostMediaFilter('all')}\r\n                  className={`px-3 py-1.5 rounded-full text-xs border ${postMediaFilter === 'all' ? 'border-gray-900 text-gray-900' : 'border-gray-200 text-gray-600'} transition-colors`}\r\n                >\r\n                  All\r\n                </button>\r\n                <button\r\n                  onClick={() => setPostMediaFilter('images')}\r\n                  className={`px-3 py-1.5 rounded-full text-xs border ${postMediaFilter === 'images' ? 'border-gray-900 text-gray-900' : 'border-gray-200 text-gray-600'} transition-colors`}\r\n                >\r\n                  Images\r\n                </button>\r\n                <button\r\n                  onClick={() => setPostMediaFilter('reels')}\r\n                  className={`px-3 py-1.5 rounded-full text-xs border ${postMediaFilter === 'reels' ? 'border-gray-900 text-gray-900' : 'border-gray-200 text-gray-600'} transition-colors`}\r\n                >\r\n                  Reels\r\n                </button>\r\n              </div>\r\n            )}\r\n\r\n            {tabLoading ? (\r\n              <div className=\"flex items-center justify-center py-16\">\r\n                <div className=\"w-8 h-8 border-4 border-gray-200 border-t-[#FFAF50] rounded-full animate-spin\"></div>\r\n              </div>\r\n            ) : (() => {\r\n              if (displayPosts && displayPosts.length > 0) {\r\n                return (\r\n                  <div className=\"grid grid-cols-3 gap-1 md:gap-4\">\r\n                    {displayPosts.map((p) => (\r\n                      <VideoGridTile\r\n                        key={p.id}\r\n                        post={p}\r\n                        onClick={() => openFullscreenFromGrid(p.id)}\r\n                      />\r\n                    ))}\r\n                  </div>\r\n                );\r\n              } else {\r\n                const emptyMessage =\r\n                  activeTab === 'posts' ? 'No posts yet' :\r\n                    activeTab === 'saved' ? 'No saved posts yet' :\r\n                      'No tagged posts yet';\r\n\r\n                const emptyDescription =\r\n                  activeTab === 'posts' ? 'Share photos and videos to see them on your profile.' :\r\n                    activeTab === 'saved' ? 'Save posts you want to see again. Only you can see what you\\'ve saved.' :\r\n                      'When people tag you in photos, they\\'ll appear here.';\r\n\r\n                return (\r\n                  <div className=\"text-center py-16\">\r\n                    <div className=\"text-gray-600 text-lg font-light mb-2\">{emptyMessage}</div>\r\n                    <div className=\"text-gray-500 text-sm\">{emptyDescription}</div>\r\n                  </div>\r\n                );\r\n              }\r\n            })()}\r\n          </div>\r\n        </div>\r\n\r\n\r\n        {/* Post Modal */}\r\n        {selectedPost && (\r\n          <PostModal\r\n            isOpen={isModalOpen}\r\n            onClose={handleCloseModal}\r\n            post={selectedPost}\r\n            canManage={true}\r\n          />\r\n        )}\r\n\r\n        {showFollowModal?.open && (\r\n          <FollowersListModal\r\n            isOpen={showFollowModal.open}\r\n            onClose={() => setShowFollowModal(null)}\r\n            userId={'me'}\r\n            type={showFollowModal.type}\r\n          />\r\n        )}\r\n      </div>\r\n\r\n      {/* Mobile Fullscreen Vertical List Overlay */}\r\n      {isFullscreenListOpen && isMobile && (\r\n        <div className=\"fixed inset-0 z-[60] bg-white/95 text-white\">\r\n          {/* Header */}\r\n          <div className=\"sticky top-0 z-[61] bg-white/90 text-black backdrop-blur px-4 py-3 flex items-center justify-between\">\r\n            <button\r\n              onClick={() => setIsFullscreenListOpen(false)}\r\n              className=\"text-black text-sm\"\r\n            >\r\n              Close\r\n            </button>\r\n            <div className=\"text-sm opacity-75\">{currentPosts?.length || 0} posts</div>\r\n            <div className=\"w-10\" />\r\n          </div>\r\n\r\n          {/* Scrollable feed */}\r\n          <div ref={scrollRef} className=\"h-[calc(100%-48px)] overflow-y-auto snap-y snap-mandatory\">\r\n            {currentPosts?.map((p) => (\r\n              <div key={p.id} data-post-id={p.id} className=\"snap-start\">\r\n                <div className=\"relative\">\r\n                  <PostCard\r\n                    id={p.id}\r\n                    authorId={userProfile?.id}\r\n                    authorName={userProfile?.name || user.name}\r\n                    authorDept={userProfile?.department || user.department}\r\n                    authorYear={userProfile?.year || user.year}\r\n                    content={p.content}\r\n                    category={p.category}\r\n                    auraCount={p.aura_count || 0}\r\n                    commentCount={0}\r\n                    timestamp={new Date(p.created_at).toLocaleDateString()}\r\n                    profilePic={userProfile?.profile_image || undefined}\r\n                    mediaUrl={p.media_url}\r\n                    mediaType={(p.media_type as 'image' | 'video') || undefined}\r\n                    userLiked={p.user_liked}\r\n                    onPostClick={(pc) => {\r\n                      const modalPost: PostModalData = {\r\n                        id: pc.id,\r\n                        authorName: pc.authorName,\r\n                        authorDept: pc.authorDept,\r\n                        authorYear: pc.authorYear,\r\n                        content: pc.content,\r\n                        category: pc.category,\r\n                        auraCount: pc.auraCount,\r\n                        commentCount: pc.commentCount,\r\n                        timestamp: pc.timestamp,\r\n                        profilePic: pc.profilePic,\r\n                        mediaUrl: pc.mediaUrl,\r\n                        mediaType: pc.mediaType,\r\n                        userLiked: pc.userLiked,\r\n                      };\r\n                      setSelectedPost(modalPost);\r\n                      setIsModalOpen(true);\r\n                    }}\r\n                    edgeToEdge\r\n                  />\r\n\r\n                  {/* Mobile options menu (three dots) */}\r\n                  <div className=\"absolute top-2 right-2 z-[62] md:hidden\">\r\n                    <button\r\n                      onClick={(e) => { e.stopPropagation(); setOptionsPostId(optionsPostId === p.id ? null : p.id); }}\r\n                      className=\"w-8 h-8 rounded-full bg-white/80 text-gray-700 hover:bg-white shadow flex items-center justify-center\"\r\n                      title=\"Options\"\r\n                    >\r\n                      <span className=\"text-xl leading-none\">Γï«</span>\r\n                    </button>\r\n                    {optionsPostId === p.id && (\r\n                      <div className=\"absolute right-0 mt-2 w-44 bg-white border border-gray-100 rounded-xl shadow-lg z-[63]\">\r\n                        <button\r\n                          onClick={(e) => { e.stopPropagation(); handleEditCaptionMobile(p.id, p.content); }}\r\n                          disabled={isSavingId === p.id}\r\n                          className=\"w-full text-left px-4 py-2 text-sm hover:bg-gray-50 disabled:opacity-50\"\r\n                        >\r\n                          {isSavingId === p.id ? 'Saving...' : 'Edit caption'}\r\n                        </button>\r\n                        <button\r\n                          onClick={(e) => { e.stopPropagation(); handleDeletePostMobile(p.id); }}\r\n                          disabled={isDeletingId === p.id}\r\n                          className=\"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 disabled:opacity-50\"\r\n                        >\r\n                          {isDeletingId === p.id ? 'DeletingΓÇª' : 'Delete post'}\r\n                        </button>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ))}\r\n            <div className=\"h-10\" />\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":26,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'saving' is assigned a value but never used.","line":29,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2561,2564],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2561,2564],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":82,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3239,3242],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3239,3242],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":102,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3816,3819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3816,3819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4535,4538],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4535,4538],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5893,5896],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5893,5896],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":180,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6198,6201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6198,6201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":201,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6972,6975],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6972,6975],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":202,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":202,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7018,7021],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7018,7021],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":228,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":228,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7605,7608],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7605,7608],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":243,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":243,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8175,8178],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8175,8178],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":275,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":275,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9101,9104],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9101,9104],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":597,"column":54,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[29438,29542],"text":"\r\n                              Let others see when you&apos;re active on UNI-X\r\n                            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[29438,29542],"text":"\r\n                              Let others see when you&lsquo;re active on UNI-X\r\n                            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[29438,29542],"text":"\r\n                              Let others see when you&#39;re active on UNI-X\r\n                            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[29438,29542],"text":"\r\n                              Let others see when you&rsquo;re active on UNI-X\r\n                            "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":623,"column":54,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[31167,31275],"text":"\r\n                              Let others see when you&apos;ve read their messages\r\n                            "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[31167,31275],"text":"\r\n                              Let others see when you&lsquo;ve read their messages\r\n                            "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[31167,31275],"text":"\r\n                              Let others see when you&#39;ve read their messages\r\n                            "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[31167,31275],"text":"\r\n                              Let others see when you&rsquo;ve read their messages\r\n                            "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport Image from 'next/image'\r\nimport React, { useEffect, useState, useRef } from 'react';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport { useRouter } from 'next/navigation';\r\nimport { useIsMobile } from '../../hooks/useIsMobile';\r\nimport { fetchAPI, dataFetcher } from '../../lib/dataFetcher';\r\n\r\ntype SettingsSection = 'account-privacy' | 'edit-profile' | 'notifications' | 'password';\r\n\r\ninterface BlockedUser {\r\n  id: number;\r\n  blocked_user_id: number;\r\n  blocked_user: {\r\n    id: number;\r\n    name: string;\r\n    username?: string;\r\n    profile_image?: string;\r\n  };\r\n  created_at: string;\r\n}\r\n\r\nexport default function SettingsPage() {\r\n  const { token, user, logout } = useAuth();\r\n  const router = useRouter();\r\n  const isMobile = useIsMobile();\r\n  const [loading, setLoading] = useState(true);\r\n  const [saving, setSaving] = useState(false);\r\n  const [isPrivate, setIsPrivate] = useState<boolean>(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [message, setMessage] = useState<string | null>(null);\r\n  const [activeSection, setActiveSection] = useState<SettingsSection>('account-privacy');\r\n\r\n  // Additional privacy settings\r\n  const [showOnlineStatus, setShowOnlineStatus] = useState<boolean>(true);\r\n  const [showReadReceipts, setShowReadReceipts] = useState<boolean>(true);\r\n  const [whoCanMessage, setWhoCanMessage] = useState<'everyone' | 'followers'>('everyone');\r\n  const [whoCanComment, setWhoCanComment] = useState<'everyone' | 'followers'>('everyone');\r\n\r\n  // Blocked users\r\n  const [blockedUsers, setBlockedUsers] = useState<BlockedUser[]>([]);\r\n  const [loadingBlocked, setLoadingBlocked] = useState(false);\r\n\r\n  // Edit Profile Modal States\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [editForm, setEditForm] = useState({\r\n    name: user?.name || '',\r\n    department: user?.department || '',\r\n    year: user?.year || 1\r\n  });\r\n  const [editUsername, setEditUsername] = useState('');\r\n  const [editBio, setEditBio] = useState('');\r\n  const [editPfp, setEditPfp] = useState<string | null>(null);\r\n  const [savingProfile, setSavingProfile] = useState(false);\r\n  const [uploadingPfp, setUploadingPfp] = useState(false);\r\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  useEffect(() => {\r\n    const load = async () => {\r\n      if (!token) { setLoading(false); return; }\r\n      setLoading(true);\r\n      setError(null);\r\n      try {\r\n        const data = await fetchAPI<{ user: any }>(\r\n          '/api/users/me',\r\n          { token, cacheTTL: 30000 }\r\n        );\r\n\r\n        setIsPrivate(!!data.user?.is_private);\r\n\r\n        // Load additional privacy settings from localStorage (since they're not in DB yet)\r\n        const savedSettings = localStorage.getItem('privacySettings');\r\n        if (savedSettings) {\r\n          const parsed = JSON.parse(savedSettings);\r\n          setShowOnlineStatus(parsed.showOnlineStatus ?? true);\r\n          setShowReadReceipts(parsed.showReadReceipts ?? true);\r\n          setWhoCanMessage(parsed.whoCanMessage ?? 'everyone');\r\n          setWhoCanComment(parsed.whoCanComment ?? 'everyone');\r\n        }\r\n      } catch (err: any) {\r\n        setError(err.message || 'Failed to load settings');\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n    load();\r\n  }, [token]);\r\n\r\n  useEffect(() => {\r\n    // Load blocked users\r\n    const loadBlockedUsers = async () => {\r\n      if (!token) return;\r\n      setLoadingBlocked(true);\r\n      try {\r\n        const data = await fetchAPI<{ blockedUsers: BlockedUser[] }>(\r\n          '/api/users/blocked',\r\n          { token, cacheTTL: 10000 } // Cache for 10 seconds\r\n        );\r\n        setBlockedUsers(data.blockedUsers || []);\r\n      } catch (err: any) {\r\n        console.error('Failed to load blocked users:', err);\r\n      } finally {\r\n        setLoadingBlocked(false);\r\n      }\r\n    };\r\n    loadBlockedUsers();\r\n  }, [token]);\r\n\r\n  const handleUnblockUser = async (blockedUserId: number) => {\r\n    if (!token) return;\r\n    try {\r\n      await fetchAPI(`/api/users/block/${blockedUserId}`, {\r\n        method: 'DELETE',\r\n        token,\r\n        skipCache: true\r\n      });\r\n\r\n      setBlockedUsers(prev => prev.filter(blocked => blocked.blocked_user_id !== blockedUserId));\r\n      setMessage('User unblocked successfully');\r\n      setTimeout(() => setMessage(null), 3000);\r\n\r\n      // Clear cache\r\n      dataFetcher.clearCache('/api/users/blocked');\r\n    } catch (err: any) {\r\n      console.error('Error unblocking user:', err);\r\n      setError(err.message || 'Failed to unblock user');\r\n      setTimeout(() => setError(null), 3000);\r\n    }\r\n  };\r\n\r\n  const savePrivacySettings = () => {\r\n    // Save to localStorage (in production, you'd save to backend)\r\n    // TODO: Migrate to backend API when privacy settings schema is added to User model\r\n    // Recommended fields to add to User schema:\r\n    // - show_online_status: boolean\r\n    // - show_read_receipts: boolean  \r\n    // - who_can_message: 'everyone' | 'followers'\r\n    // - who_can_comment: 'everyone' | 'followers'\r\n    const settings = {\r\n      showOnlineStatus,\r\n      showReadReceipts,\r\n      whoCanMessage,\r\n      whoCanComment\r\n    };\r\n    localStorage.setItem('privacySettings', JSON.stringify(settings));\r\n  };\r\n\r\n  const onSave = async () => {\r\n    if (!token) return;\r\n    setSaving(true);\r\n    setError(null);\r\n    setMessage(null);\r\n    try {\r\n      await fetchAPI('/api/users/me', {\r\n        method: 'PUT',\r\n        token,\r\n        body: JSON.stringify({ is_private: isPrivate }),\r\n        skipCache: true\r\n      });\r\n\r\n      savePrivacySettings(); // Save other privacy settings\r\n      dataFetcher.clearCache('/api/users/me'); // Clear user cache\r\n      setMessage('Settings saved');\r\n      setTimeout(() => setMessage(null), 3000);\r\n    } catch (err: any) {\r\n      setError(err.message || 'Failed to save settings');\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  // Edit Profile Functions\r\n  const resetEditForm = async () => {\r\n    if (!token) return;\r\n\r\n    try {\r\n      // Fetch latest user data\r\n      const data = await fetchAPI<{ user: any }>(\r\n        '/api/users/me',\r\n        { token, skipCache: true } // Skip cache to get fresh data\r\n      );\r\n\r\n      const latestUser = data.user;\r\n\r\n      setEditForm({\r\n        name: latestUser.name || '',\r\n        department: latestUser.department || '',\r\n        year: latestUser.year || 1\r\n      });\r\n      setEditUsername(latestUser.username || '');\r\n      setEditBio(latestUser.bio || '');\r\n      setEditPfp(latestUser.profile_image || null);\r\n    } catch (error) {\r\n      console.error('Error loading user data:', error);\r\n      // Fallback to cached user data\r\n      if (user) {\r\n        setEditForm({ name: user.name || '', department: user.department || '', year: user.year || 1 });\r\n        setEditUsername(user.username || '');\r\n        setEditBio((user as any).bio || '');\r\n        setEditPfp((user as any).profile_image || null);\r\n      }\r\n    }\r\n\r\n    setHasUnsavedChanges(false);\r\n  };\r\n\r\n  const handleFormChange = () => {\r\n    setHasUnsavedChanges(true);\r\n  };\r\n\r\n  const handleCancelEdit = () => {\r\n    if (hasUnsavedChanges) {\r\n      if (confirm('You have unsaved changes. Are you sure you want to discard them?')) {\r\n        setIsEditing(false);\r\n        setHasUnsavedChanges(false);\r\n        resetEditForm();\r\n      }\r\n    } else {\r\n      setIsEditing(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveProfile = async () => {\r\n    setSavingProfile(true);\r\n    try {\r\n      const payload: any = { ...editForm, bio: editBio, username: editUsername, profile_image: editPfp };\r\n      await fetchAPI('/api/users/me', {\r\n        method: 'PUT',\r\n        token: token || '',\r\n        body: JSON.stringify(payload),\r\n        skipCache: true\r\n      });\r\n\r\n      setIsEditing(false);\r\n      setHasUnsavedChanges(false);\r\n      dataFetcher.clearCache('/api/users/me'); // Clear user cache\r\n      setMessage('Profile updated successfully');\r\n      setTimeout(() => setMessage(null), 3000);\r\n      // Reload user data\r\n      window.location.reload();\r\n    } catch (error: any) {\r\n      console.error('Error updating profile:', error);\r\n      alert(error.message || 'Failed to update profile');\r\n    } finally {\r\n      setSavingProfile(false);\r\n    }\r\n  };\r\n\r\n  const handleProfilePicUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    if (file.size > 10 * 1024 * 1024) {\r\n      alert('File size must be less than 10MB');\r\n      return;\r\n    }\r\n\r\n    setUploadingPfp(true);\r\n    const formData = new FormData();\r\n    formData.append('file', file);\r\n\r\n    try {\r\n      const data = await fetchAPI('/api/users/upload-profile-pic', {\r\n        method: 'POST',\r\n        token: token || '',\r\n        body: formData,\r\n        skipCache: true\r\n      }) as { url: string };\r\n\r\n      setEditPfp(data.url);\r\n      setHasUnsavedChanges(true);\r\n      dataFetcher.clearCache('/api/users/me'); // Clear user cache\r\n    } catch (error: any) {\r\n      console.error('Error uploading profile picture:', error);\r\n      alert(error.message || 'Failed to upload profile picture');\r\n    } finally {\r\n      setUploadingPfp(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50\">\r\n      <div className=\"flex h-screen overflow-hidden\">\r\n        {/* Modern Sidebar */}\r\n        <div className=\"w-80 bg-white border-r border-gray-200 flex flex-col shadow-sm\">\r\n          {/* Header */}\r\n          <div className=\"p-6 border-b border-gray-100\">\r\n            <h1 className=\"text-2xl font-bold text-gray-900\">Settings</h1>\r\n            <p className=\"text-sm text-gray-500 mt-1\">Manage your account preferences</p>\r\n          </div>\r\n\r\n          {/* Settings Sections */}\r\n          <div className=\"flex-1 overflow-y-auto py-4\">\r\n            <div className=\"px-4 space-y-2\">\r\n              {/* Account Section */}\r\n              <div className=\"mb-4\">\r\n                <p className=\"text-xs font-semibold text-gray-400 uppercase tracking-wider px-3 mb-2\">Account</p>\r\n\r\n                <button\r\n                  onClick={async () => {\r\n                    setIsEditing(true);\r\n                    await resetEditForm();\r\n                  }}\r\n                  className=\"w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-left hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 group\"\r\n                >\r\n                  <div className=\"p-2 rounded-lg bg-gray-100 group-hover:bg-green-100 transition-colors\">\r\n                    <svg className=\"w-5 h-5 text-gray-600 group-hover:text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\" />\r\n                    </svg>\r\n                  </div>\r\n                  <div className=\"flex-1\">\r\n                    <span className=\"font-medium text-gray-900\">Edit Profile</span>\r\n                    <p className=\"text-xs text-gray-500\">Update your information</p>\r\n                  </div>\r\n                  <svg className=\"w-5 h-5 text-gray-400 group-hover:text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                  </svg>\r\n                </button>\r\n\r\n                <button\r\n                  onClick={() => setActiveSection('notifications')}\r\n                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-left ${activeSection === 'notifications'\r\n                    ? 'bg-gradient-to-r from-green-100 to-emerald-100 shadow-sm'\r\n                    : 'hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50'\r\n                    } group`}\r\n                >\r\n                  <div className={`p-2 rounded-lg transition-colors ${activeSection === 'notifications' ? 'bg-green-200' : 'bg-gray-100 group-hover:bg-green-100'\r\n                    }`}>\r\n                    <svg className={`w-5 h-5 ${activeSection === 'notifications' ? 'text-green-700' : 'text-gray-600 group-hover:text-green-600'\r\n                      }`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9\" />\r\n                    </svg>\r\n                  </div>\r\n                  <div className=\"flex-1\">\r\n                    <span className={`font-medium ${activeSection === 'notifications' ? 'text-green-700' : 'text-gray-900'}`}>\r\n                      Notifications\r\n                    </span>\r\n                    <p className=\"text-xs text-gray-500\">Manage alerts</p>\r\n                  </div>\r\n                  <svg className={`w-5 h-5 ${activeSection === 'notifications' ? 'text-green-600' : 'text-gray-400 group-hover:text-green-600'\r\n                    }`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                  </svg>\r\n                </button>\r\n              </div>\r\n\r\n              {/* Privacy Section */}\r\n              <div className=\"mb-4\">\r\n                <p className=\"text-xs font-semibold text-gray-400 uppercase tracking-wider px-3 mb-2\">Privacy & Security</p>\r\n\r\n                <button\r\n                  onClick={() => setActiveSection('account-privacy')}\r\n                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-left ${activeSection === 'account-privacy'\r\n                    ? 'bg-gradient-to-r from-green-100 to-emerald-100 shadow-sm'\r\n                    : 'hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50'\r\n                    } group`}\r\n                >\r\n                  <div className={`p-2 rounded-lg transition-colors ${activeSection === 'account-privacy' ? 'bg-green-200' : 'bg-gray-100 group-hover:bg-green-100'\r\n                    }`}>\r\n                    <svg className={`w-5 h-5 ${activeSection === 'account-privacy' ? 'text-green-700' : 'text-gray-600 group-hover:text-green-600'\r\n                      }`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\" />\r\n                    </svg>\r\n                  </div>\r\n                  <div className=\"flex-1\">\r\n                    <span className={`font-medium ${activeSection === 'account-privacy' ? 'text-green-700' : 'text-gray-900'}`}>\r\n                      Account Privacy\r\n                    </span>\r\n                    <p className=\"text-xs text-gray-500\">Control visibility</p>\r\n                  </div>\r\n                  {isPrivate && (\r\n                    <span className=\"px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full\">\r\n                      Private\r\n                    </span>\r\n                  )}\r\n                  <svg className={`w-5 h-5 ${activeSection === 'account-privacy' ? 'text-green-600' : 'text-gray-400 group-hover:text-green-600'\r\n                    }`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                  </svg>\r\n                </button>\r\n\r\n                <button\r\n                  onClick={() => setActiveSection('password')}\r\n                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-left ${activeSection === 'password'\r\n                    ? 'bg-gradient-to-r from-green-100 to-emerald-100 shadow-sm'\r\n                    : 'hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50'\r\n                    } group`}\r\n                >\r\n                  <div className={`p-2 rounded-lg transition-colors ${activeSection === 'password' ? 'bg-green-200' : 'bg-gray-100 group-hover:bg-green-100'\r\n                    }`}>\r\n                    <svg className={`w-5 h-5 ${activeSection === 'password' ? 'text-green-700' : 'text-gray-600 group-hover:text-green-600'\r\n                      }`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z\" />\r\n                    </svg>\r\n                  </div>\r\n                  <div className=\"flex-1\">\r\n                    <span className={`font-medium ${activeSection === 'password' ? 'text-green-700' : 'text-gray-900'}`}>\r\n                      Close Friends\r\n                    </span>\r\n                    <p className=\"text-xs text-gray-500\">Manage lists</p>\r\n                  </div>\r\n                  <svg className={`w-5 h-5 ${activeSection === 'password' ? 'text-green-600' : 'text-gray-400 group-hover:text-green-600'\r\n                    }`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                  </svg>\r\n                </button>\r\n              </div>\r\n\r\n              {/* Logout Button */}\r\n              <div className=\"pt-4 border-t border-gray-100\">\r\n                <button\r\n                  onClick={logout}\r\n                  className=\"w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-left hover:bg-red-50 group\"\r\n                >\r\n                  <div className=\"p-2 rounded-lg bg-gray-100 group-hover:bg-red-100 transition-colors\">\r\n                    <svg className=\"w-5 h-5 text-gray-600 group-hover:text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1\" />\r\n                    </svg>\r\n                  </div>\r\n                  <span className=\"font-medium text-gray-900 group-hover:text-red-600\">Log out</span>\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Main Content Area */}\r\n        <div className=\"flex-1 overflow-y-auto bg-gray-50\">\r\n          {loading ? (\r\n            <div className=\"flex items-center justify-center h-full\">\r\n              <div className=\"animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent\"></div>\r\n            </div>\r\n          ) : (\r\n            <div className=\"max-w-4xl mx-auto px-8 py-10\">\r\n              {/* Account Privacy Section */}\r\n              {activeSection === 'account-privacy' && (\r\n                <div>\r\n                  {/* Header */}\r\n                  <div className=\"mb-8\">\r\n                    <h2 className=\"text-3xl font-bold text-gray-900 mb-2\">Account Privacy</h2>\r\n                    <p className=\"text-gray-600\">Control who can see your content and interact with you</p>\r\n                  </div>\r\n\r\n                  {/* Alerts */}\r\n                  {error && (\r\n                    <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-xl flex items-start gap-3\">\r\n                      <svg className=\"w-5 h-5 text-red-600 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                      </svg>\r\n                      <div>\r\n                        <p className=\"text-sm font-medium text-red-900\">Error</p>\r\n                        <p className=\"text-sm text-red-700\">{error}</p>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                  {message && (\r\n                    <div className=\"mb-6 p-4 bg-green-50 border border-green-200 rounded-xl flex items-start gap-3\">\r\n                      <svg className=\"w-5 h-5 text-green-600 mt-0.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                      </svg>\r\n                      <div>\r\n                        <p className=\"text-sm font-medium text-green-900\">Success</p>\r\n                        <p className=\"text-sm text-green-700\">{message}</p>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"space-y-6\">\r\n                    {/* Account Visibility Card */}\r\n                    <div className=\"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden\">\r\n                      <div className=\"p-6 border-b border-gray-100\">\r\n                        <h3 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2\">\r\n                          <svg className=\"w-5 h-5 text-gray-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\r\n                          </svg>\r\n                          Account Visibility\r\n                        </h3>\r\n                      </div>\r\n\r\n                      {/* Private Account Toggle */}\r\n                      <div className=\"p-6\">\r\n                        <div className=\"flex items-start justify-between gap-6\">\r\n                          <div className=\"flex-1\">\r\n                            <div className=\"font-semibold text-gray-900 mb-2 flex items-center gap-2\">\r\n                              Private account\r\n                              {isPrivate && (\r\n                                <span className=\"px-2 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full\">\r\n                                  Active\r\n                                </span>\r\n                              )}\r\n                            </div>\r\n                            <div className=\"text-sm text-gray-600 leading-relaxed\">\r\n                              When your account is public, your profile and posts can be seen by anyone.\r\n                              When private, only approved followers can see what you share.\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"flex-shrink-0\">\r\n                            <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                              <input\r\n                                type=\"checkbox\"\r\n                                checked={isPrivate}\r\n                                onChange={(e) => {\r\n                                  setIsPrivate(e.target.checked);\r\n                                  setTimeout(() => onSave(), 100);\r\n                                }}\r\n                                className=\"sr-only peer\"\r\n                              />\r\n                              <div className=\"w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-100 rounded-full peer peer-checked:after:translate-x-7 peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600\"></div>\r\n                            </label>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Interactions Section */}\r\n                    <div className=\"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden\">\r\n                      <div className=\"p-6 border-b border-gray-100\">\r\n                        <h3 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2\">\r\n                          <svg className=\"w-5 h-5 text-gray-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\r\n                          </svg>\r\n                          Interactions\r\n                        </h3>\r\n                      </div>\r\n\r\n                      <div className=\"p-6 space-y-6\">\r\n                        {/* Who Can Comment */}\r\n                        <div className=\"flex items-start justify-between gap-6\">\r\n                          <div className=\"flex-1\">\r\n                            <div className=\"font-semibold text-gray-900 mb-2\">Who can comment on your posts</div>\r\n                            <div className=\"text-sm text-gray-600\">\r\n                              Control who can comment on your posts\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"flex-shrink-0\">\r\n                            <select\r\n                              value={whoCanComment}\r\n                              onChange={(e) => {\r\n                                setWhoCanComment(e.target.value as 'everyone' | 'followers');\r\n                                savePrivacySettings();\r\n                              }}\r\n                              className=\"bg-white text-gray-900 border border-gray-300 rounded-lg px-4 py-2.5 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 hover:border-gray-400 transition-colors\"\r\n                            >\r\n                              <option value=\"everyone\">Everyone</option>\r\n                              <option value=\"followers\">Followers only</option>\r\n                            </select>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"border-t border-gray-100\"></div>\r\n\r\n                        {/* Who Can Message */}\r\n                        <div className=\"flex items-start justify-between gap-6\">\r\n                          <div className=\"flex-1\">\r\n                            <div className=\"font-semibold text-gray-900 mb-2\">Who can message you</div>\r\n                            <div className=\"text-sm text-gray-600\">\r\n                              Control who can send you direct messages\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"flex-shrink-0\">\r\n                            <select\r\n                              value={whoCanMessage}\r\n                              onChange={(e) => {\r\n                                setWhoCanMessage(e.target.value as 'everyone' | 'followers');\r\n                                savePrivacySettings();\r\n                              }}\r\n                              className=\"bg-white text-gray-900 border border-gray-300 rounded-lg px-4 py-2.5 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 hover:border-gray-400 transition-colors\"\r\n                            >\r\n                              <option value=\"everyone\">Everyone</option>\r\n                              <option value=\"followers\">Followers only</option>\r\n                            </select>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Activity Status Section */}\r\n                    <div className=\"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden\">\r\n                      <div className=\"p-6 border-b border-gray-100\">\r\n                        <h3 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2\">\r\n                          <svg className=\"w-5 h-5 text-gray-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\r\n                          </svg>\r\n                          Activity Status\r\n                        </h3>\r\n                      </div>\r\n\r\n                      <div className=\"p-6 space-y-6\">\r\n                        {/* Show Online Status */}\r\n                        <div className=\"flex items-start justify-between gap-6\">\r\n                          <div className=\"flex-1\">\r\n                            <div className=\"font-semibold text-gray-900 mb-2\">Show online status</div>\r\n                            <div className=\"text-sm text-gray-600\">\r\n                              Let others see when you're active on UNI-X\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"flex-shrink-0\">\r\n                            <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                              <input\r\n                                type=\"checkbox\"\r\n                                checked={showOnlineStatus}\r\n                                onChange={(e) => {\r\n                                  setShowOnlineStatus(e.target.checked);\r\n                                  savePrivacySettings();\r\n                                }}\r\n                                className=\"sr-only peer\"\r\n                              />\r\n                              <div className=\"w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-100 rounded-full peer peer-checked:after:translate-x-7 peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600\"></div>\r\n                            </label>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"border-t border-gray-100\"></div>\r\n\r\n                        {/* Show Read Receipts */}\r\n                        <div className=\"flex items-start justify-between gap-6\">\r\n                          <div className=\"flex-1\">\r\n                            <div className=\"font-semibold text-gray-900 mb-2\">Show read receipts</div>\r\n                            <div className=\"text-sm text-gray-600\">\r\n                              Let others see when you've read their messages\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"flex-shrink-0\">\r\n                            <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                              <input\r\n                                type=\"checkbox\"\r\n                                checked={showReadReceipts}\r\n                                onChange={(e) => {\r\n                                  setShowReadReceipts(e.target.checked);\r\n                                  savePrivacySettings();\r\n                                }}\r\n                                className=\"sr-only peer\"\r\n                              />\r\n                              <div className=\"w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-100 rounded-full peer peer-checked:after:translate-x-7 peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600\"></div>\r\n                            </label>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Blocked Users Section */}\r\n                    <div className=\"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden\">\r\n                      <div className=\"p-6 border-b border-gray-100\">\r\n                        <h3 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2\">\r\n                          <svg className=\"w-5 h-5 text-gray-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n                            <path d=\"M4.93 4.93L19.07 19.07\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n                          </svg>\r\n                          Blocked Users\r\n                          {blockedUsers.length > 0 && (\r\n                            <span className=\"px-2 py-0.5 text-xs font-medium bg-red-100 text-red-700 rounded-full\">\r\n                              {blockedUsers.length}\r\n                            </span>\r\n                          )}\r\n                        </h3>\r\n                      </div>\r\n\r\n                      <div className=\"p-6\">\r\n                        {loadingBlocked ? (\r\n                          <div className=\"flex items-center justify-center py-12\">\r\n                            <div className=\"animate-spin rounded-full h-8 w-8 border-4 border-green-500 border-t-transparent\"></div>\r\n                          </div>\r\n                        ) : blockedUsers.length === 0 ? (\r\n                          <div className=\"text-center py-12\">\r\n                            <svg className=\"w-16 h-16 text-gray-300 mx-auto mb-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                              <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n                              <path d=\"M4.93 4.93L19.07 19.07\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n                            </svg>\r\n                            <p className=\"text-gray-500 font-medium\">No blocked users</p>\r\n                            <p className=\"text-sm text-gray-400 mt-1\">Users you block will appear here</p>\r\n                          </div>\r\n                        ) : (\r\n                          <div className=\"space-y-3\">\r\n                            {blockedUsers.map((blocked) => (\r\n                              <div key={blocked.id} className=\"flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100 hover:border-gray-200 transition-colors\">\r\n                                <div className=\"flex items-center gap-3 min-w-0 flex-1\">\r\n                                  <Image\r\n                                    src={blocked.blocked_user?.profile_image || '/uploads/DefaultProfile.jpg'}\r\n                                    alt={blocked.blocked_user?.name}\r\n                                    className=\"w-12 h-12 rounded-full object-cover ring-2 ring-white shadow-sm grayscale\"\r\n                                  />\r\n                                  <div className=\"min-w-0 flex-1\">\r\n                                    <div className=\"font-semibold text-gray-900 truncate\">{blocked.blocked_user?.name}</div>\r\n                                    {blocked.blocked_user?.username && (\r\n                                      <div className=\"text-sm text-gray-500 truncate\">@{blocked.blocked_user.username}</div>\r\n                                    )}\r\n                                    <div className=\"text-xs text-gray-400 mt-0.5\">\r\n                                      Blocked {new Date(blocked.created_at).toLocaleDateString()}\r\n                                    </div>\r\n                                  </div>\r\n                                </div>\r\n                                <button\r\n                                  onClick={() => handleUnblockUser(blocked.blocked_user_id)}\r\n                                  className=\"px-5 py-2 bg-white hover:bg-gray-50 text-gray-700 text-sm font-semibold rounded-lg transition-colors border border-gray-300 shadow-sm ml-4\"\r\n                                >\r\n                                  Unblock\r\n                                </button>\r\n                              </div>\r\n                            ))}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Data & History Section */}\r\n                    <div className=\"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden\">\r\n                      <div className=\"p-6 border-b border-gray-100\">\r\n                        <h3 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2\">\r\n                          <svg className=\"w-5 h-5 text-gray-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z\" />\r\n                          </svg>\r\n                          Data & History\r\n                        </h3>\r\n                      </div>\r\n\r\n                      <div className=\"p-6 space-y-3\">\r\n                        <button className=\"w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors text-left border border-gray-200\">\r\n                          <div>\r\n                            <div className=\"font-semibold text-gray-900 mb-1\">Download your data</div>\r\n                            <div className=\"text-sm text-gray-600\">\r\n                              Get a copy of your UNI-X data\r\n                            </div>\r\n                          </div>\r\n                          <svg className=\"w-5 h-5 text-gray-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                          </svg>\r\n                        </button>\r\n\r\n                        <button className=\"w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors text-left border border-gray-200\">\r\n                          <div>\r\n                            <div className=\"font-semibold text-gray-900 mb-1\">Clear search history</div>\r\n                            <div className=\"text-sm text-gray-600\">\r\n                              Remove your recent searches\r\n                            </div>\r\n                          </div>\r\n                          <svg className=\"w-5 h-5 text-gray-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                          </svg>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Danger Zone */}\r\n                    <div className=\"bg-white rounded-2xl shadow-sm border border-red-200 overflow-hidden\">\r\n                      <div className=\"p-6 border-b border-red-100 bg-red-50\">\r\n                        <h3 className=\"text-lg font-semibold text-red-700 flex items-center gap-2\">\r\n                          <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\r\n                          </svg>\r\n                          Danger Zone\r\n                        </h3>\r\n                      </div>\r\n\r\n                      <div className=\"p-6 space-y-3\">\r\n                        <button\r\n                          onClick={() => {\r\n                            if (confirm('Are you sure you want to deactivate your account? You can reactivate it anytime by logging in.')) {\r\n                              // Implement deactivation logic\r\n                              alert('Account deactivation feature coming soon');\r\n                            }\r\n                          }}\r\n                          className=\"w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors text-left border border-gray-300\"\r\n                        >\r\n                          <div>\r\n                            <div className=\"font-semibold text-gray-900 mb-1\">Deactivate account</div>\r\n                            <div className=\"text-sm text-gray-600\">\r\n                              Temporarily disable your account\r\n                            </div>\r\n                          </div>\r\n                          <svg className=\"w-5 h-5 text-gray-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\r\n                          </svg>\r\n                        </button>\r\n\r\n                        <button\r\n                          onClick={() => {\r\n                            if (confirm('ΓÜá∩╕Å WARNING: This will permanently delete your account and all your data. This action cannot be undone. Are you absolutely sure?')) {\r\n                              // Implement deletion logic\r\n                              alert('Account deletion feature coming soon');\r\n                            }\r\n                          }}\r\n                          className=\"w-full flex items-center justify-between p-4 bg-red-50 hover:bg-red-100 rounded-xl transition-colors text-left border border-red-300\"\r\n                        >\r\n                          <div>\r\n                            <div className=\"font-semibold text-red-700 mb-1\">Delete account</div>\r\n                            <div className=\"text-sm text-red-600\">\r\n                              Permanently delete your account and data\r\n                            </div>\r\n                          </div>\r\n                          <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\r\n                          </svg>\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Edit Profile Modal */}\r\n      {isEditing && (\r\n        <div className={`fixed inset-0 z-50 ${isMobile ? '' : 'bg-black/50 flex items-center justify-center p-4'}`}>\r\n          <div className={`${isMobile ? 'w-full h-full bg-white' : 'bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden'}`}>\r\n            {/* Header */}\r\n            <div className=\"sticky top-0 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between\">\r\n              <button\r\n                onClick={handleCancelEdit}\r\n                className=\"text-gray-600 hover:text-gray-900 text-sm font-medium\"\r\n              >\r\n                {hasUnsavedChanges ? 'Discard' : 'Cancel'}\r\n              </button>\r\n              <h3 className=\"text-lg font-semibold text-gray-900\">Edit Profile</h3>\r\n              <button\r\n                onClick={handleSaveProfile}\r\n                disabled={savingProfile}\r\n                className=\"text-[#FFAF50] hover:text-[#FFAF50]/80 font-semibold text-sm disabled:opacity-50\"\r\n              >\r\n                {savingProfile ? 'Saving...' : 'Save'}\r\n              </button>\r\n            </div>\r\n\r\n            {/* Content */}\r\n            <div className=\"overflow-y-auto\" style={{ maxHeight: isMobile ? 'calc(100vh - 57px)' : 'calc(90vh - 57px)' }}>\r\n              <div className=\"p-6 space-y-6\">\r\n                {/* Profile Picture */}\r\n                <div className=\"flex flex-col items-center gap-4\">\r\n                  <div className=\"w-24 h-24 rounded-full overflow-hidden bg-gray-100\">\r\n                    <Image\r\n                      src={editPfp || '/uploads/DefaultProfile.jpg'}\r\n                      alt=\"Preview\"\r\n                      className=\"w-full h-full object-cover\"\r\n                      onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n                    />\r\n                  </div>\r\n                  <div className=\"text-center\">\r\n                    <input\r\n                      ref={fileInputRef}\r\n                      type=\"file\"\r\n                      accept=\"image/*\"\r\n                      onChange={(e) => { handleProfilePicUpload(e); handleFormChange(); }}\r\n                      className=\"hidden\"\r\n                      id=\"profile-pic-upload\"\r\n                    />\r\n                    <label\r\n                      htmlFor=\"profile-pic-upload\"\r\n                      className={`inline-block px-4 py-2 rounded-lg text-sm font-medium cursor-pointer ${uploadingPfp\r\n                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'\r\n                        : 'bg-gray-100 text-gray-800 hover:bg-gray-200'\r\n                        }`}\r\n                    >\r\n                      {uploadingPfp ? (\r\n                        <span className=\"flex items-center gap-2\">\r\n                          <div className=\"w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin\"></div>\r\n                          Uploading...\r\n                        </span>\r\n                      ) : (\r\n                        'Change Photo'\r\n                      )}\r\n                    </label>\r\n                    <div className=\"text-xs text-gray-500 mt-2\">\r\n                      Max 10MB ΓÇó JPG, PNG, GIF\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Form Fields */}\r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">Name</label>\r\n                    <input\r\n                      value={editForm.name}\r\n                      onChange={(e) => { setEditForm({ ...editForm, name: e.target.value }); handleFormChange(); }}\r\n                      className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent\"\r\n                      placeholder=\"Enter your name\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">Username</label>\r\n                    <input\r\n                      value={editUsername}\r\n                      onChange={(e) => { setEditUsername(e.target.value); handleFormChange(); }}\r\n                      className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent\"\r\n                      placeholder=\"Enter your username\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-700 mb-1\">Bio</label>\r\n                    <textarea\r\n                      value={editBio}\r\n                      onChange={(e) => { setEditBio(e.target.value); handleFormChange(); }}\r\n                      rows={4}\r\n                      maxLength={150}\r\n                      className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent resize-none\"\r\n                      placeholder=\"Tell us about yourself\"\r\n                    />\r\n                    <div className=\"text-xs text-gray-500 mt-1 text-right\">\r\n                      {editBio.length} / 150\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-1\">Department</label>\r\n                      <input\r\n                        value={editForm.department}\r\n                        onChange={(e) => { setEditForm({ ...editForm, department: e.target.value }); handleFormChange(); }}\r\n                        className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent\"\r\n                        placeholder=\"Your department\"\r\n                      />\r\n                    </div>\r\n\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-1\">Year</label>\r\n                      <select\r\n                        value={editForm.year}\r\n                        onChange={(e) => { setEditForm({ ...editForm, year: parseInt(e.target.value) }); handleFormChange(); }}\r\n                        className=\"w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent bg-white\"\r\n                      >\r\n                        <option value={1}>1st Year</option>\r\n                        <option value={2}>2nd Year</option>\r\n                        <option value={3}>3rd Year</option>\r\n                        <option value={4}>4th Year</option>\r\n                      </select>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\suggestions\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1125,1128],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1125,1128],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1357,1360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1357,1360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1838,1841],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1838,1841],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport Image from 'next/image'\r\nimport React from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport { useAuth } from '../../contexts/AuthContext'\r\nimport FollowButton from '../../components/FollowButton'\r\nimport { fetchAPI } from '../../lib/dataFetcher'\r\n\r\ninterface SuggestedUser {\r\n  id: number\r\n  name: string\r\n  username?: string\r\n  department?: string\r\n  year?: number\r\n  profile_image?: string\r\n  mutualFriends?: number\r\n  mutualFriendNames?: string[]\r\n  reason?: string\r\n  follower_count?: number\r\n  score?: number\r\n}\r\n\r\nexport default function SuggestionsPage() {\r\n  const { token, user } = useAuth()\r\n  const router = useRouter()\r\n  const [loading, setLoading] = React.useState(true)\r\n  const [error, setError] = React.useState<string>('')\r\n  const [suggestions, setSuggestions] = React.useState<SuggestedUser[]>([])\r\n\r\n  React.useEffect(() => {\r\n    let isCancelled = false\r\n    const load = async () => {\r\n      if (!token) {\r\n        setLoading(false)\r\n        return\r\n      }\r\n      setLoading(true)\r\n      setError('')\r\n      try {\r\n        const data = await fetchAPI<{ suggestions: any[] }>(\r\n          '/api/users/suggestions?limit=50&algorithm=advanced',\r\n          { token, cacheTTL: 300000 } // Cache for 5 minutes\r\n        )\r\n\r\n        const suggestedUsers: SuggestedUser[] = (data.suggestions || []).map((s: any) => ({\r\n          id: s.id,\r\n          name: s.name,\r\n          username: s.username,\r\n          department: s.department,\r\n          year: s.year,\r\n          profile_image: s.profile_image,\r\n          mutualFriends: s.mutualFriends,\r\n          mutualFriendNames: s.mutualFriendNames,\r\n          reason: s.reason,\r\n          follower_count: s.follower_count,\r\n          score: s.score\r\n        }))\r\n\r\n        if (!isCancelled) setSuggestions(suggestedUsers)\r\n      } catch (e: any) {\r\n        if (!isCancelled) setError(e.message || 'Failed to load suggestions')\r\n      } finally {\r\n        if (!isCancelled) setLoading(false)\r\n      }\r\n    }\r\n    load()\r\n    return () => { isCancelled = true }\r\n  }, [token, user?.id])\r\n\r\n  const removeOnFollow = (userId: number) => {\r\n    setSuggestions(prev => prev.filter(u => u.id !== userId))\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-white pb-20 md:pb-8\">\r\n      <div className=\"max-w-3xl mx-auto px-4 py-6\">\r\n        <div className=\"mb-4 flex items-center justify-between\">\r\n          <h1 className=\"text-xl font-semibold text-gray-900\">Suggested for you</h1>\r\n          <button className=\"text-sm text-gray-500 hover:text-gray-700\" onClick={() => router.back()}>Back</button>\r\n        </div>\r\n\r\n        {loading && (\r\n          <div className=\"space-y-3\">\r\n            {[...Array(8)].map((_, i) => (\r\n              <div key={i} className=\"flex items-center justify-between p-3 border border-gray-100 rounded-lg\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"w-10 h-10 rounded-full bg-gray-200 animate-pulse\" />\r\n                  <div>\r\n                    <div className=\"h-3 w-32 bg-gray-200 rounded mb-2 animate-pulse\" />\r\n                    <div className=\"h-3 w-20 bg-gray-100 rounded animate-pulse\" />\r\n                  </div>\r\n                </div>\r\n                <div className=\"h-8 w-20 bg-gray-200 rounded animate-pulse\" />\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        {!loading && error && (\r\n          <div className=\"p-4 text-sm text-red-600 border border-red-200 rounded-lg\">{error}</div>\r\n        )}\r\n\r\n        {!loading && !error && suggestions.length === 0 && (\r\n          <div className=\"p-6 text-center text-gray-500\">No suggestions right now.</div>\r\n        )}\r\n\r\n        {!loading && !error && suggestions.length > 0 && (\r\n          <div className=\"space-y-2\">\r\n            {suggestions.map(u => (\r\n              <div key={u.id} className=\"flex items-center justify-between p-3 border border-gray-100 rounded-lg hover:bg-gray-50 cursor-pointer\" onClick={() => router.push(`/profile/${u.id}`)}>\r\n                <div className=\"flex items-center gap-3 min-w-0 flex-1\">\r\n                  <Image\r\n                    src={u.profile_image || '/uploads/DefaultProfile.jpg'}\r\n                    alt={u.name}\r\n                    className=\"w-12 h-12 rounded-full object-cover\"\r\n                    onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n                  />\r\n                  <div className=\"min-w-0 flex-1\">\r\n                    <p className=\"text-sm font-semibold text-gray-900 truncate\">{u.name}</p>\r\n                    <p className=\"text-xs text-gray-500 truncate\">\r\n                      {u.username && <span className=\"text-gray-400\">@{u.username} ┬╖ </span>}\r\n                      {u.department && `${u.department} ┬╖ Year ${u.year}`}\r\n                    </p>\r\n                    {u.reason && (\r\n                      <p className=\"text-xs text-gray-600 mt-1 truncate\">\r\n                        {u.reason}\r\n                      </p>\r\n                    )}\r\n                    {u.follower_count !== undefined && u.follower_count > 0 && (\r\n                      <p className=\"text-xs text-gray-400 mt-1\">\r\n                        {u.follower_count} follower{u.follower_count !== 1 ? 's' : ''}\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n                <div onClick={(e) => e.stopPropagation()}>\r\n                  <FollowButton\r\n                    userId={u.id}\r\n                    isFollowing={false}\r\n                    size=\"md\"\r\n                    onFollowChange={(isFollowing) => { if (isFollowing) removeOnFollow(u.id) }}\r\n                  />\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\swipe\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'swipeDirection' is assigned a value but never used.","line":32,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":32,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":54,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1604,1607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1604,1607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1961,1964],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1961,1964],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2120,2123],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2120,2123],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":91,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2867,2870],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2867,2870],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport React, { useState, useEffect, useCallback, useRef } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport { useAuth } from '../../contexts/AuthContext'\r\nimport { fetchAPI, dataFetcher } from '../../lib/dataFetcher'\r\nimport Image from 'next/image'\r\n\r\ninterface SwipeUser {\r\n  id: number\r\n  name: string\r\n  username: string\r\n  department?: string\r\n  year?: number\r\n  bio?: string\r\n  profile_image?: string\r\n  college_name?: string\r\n  interests?: string[]\r\n  mutualFriends?: number\r\n  mutualFriendNames?: string[]\r\n  reason?: string\r\n  images?: string[]\r\n}\r\n\r\nexport default function SwipePage() {\r\n  const { token, user } = useAuth()\r\n  const router = useRouter()\r\n  const [users, setUsers] = useState<SwipeUser[]>([])\r\n  const [currentIndex, setCurrentIndex] = useState(0)\r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState<string>('')\r\n  const [swipeDirection, setSwipeDirection] = useState<'left' | 'right' | null>(null)\r\n  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 })\r\n  const [isDragging, setIsDragging] = useState(false)\r\n  const [history, setHistory] = useState<{ user: SwipeUser; action: 'skip' | 'connect' }[]>([])\r\n  const cardRef = useRef<HTMLDivElement>(null)\r\n  const startPosRef = useRef({ x: 0, y: 0 })\r\n\r\n  useEffect(() => {\r\n    if (!user) {\r\n      router.push('/landing')\r\n      return\r\n    }\r\n\r\n    let isCancelled = false\r\n\r\n    const loadUsers = async () => {\r\n      if (!token) return\r\n\r\n      setLoading(true)\r\n      setError('')\r\n\r\n      try {\r\n        const data = await fetchAPI<{ suggestions: any[] }>(\r\n          '/api/users/suggestions?limit=20&algorithm=advanced',\r\n          {\r\n            token,\r\n            cacheTTL: 300000\r\n          }\r\n        )\r\n\r\n        if (!isCancelled) {\r\n          // Filter for users with mutual connections or interests\r\n          const eligibleUsers: SwipeUser[] = (data.suggestions || [])\r\n            .filter((s: any) =>\r\n              (s.mutualFriends && s.mutualFriends > 0) ||\r\n              (s.interests && s.interests.length > 0)\r\n            )\r\n            .map((s: any) => ({\r\n              id: s.id,\r\n              name: s.name,\r\n              username: s.username,\r\n              department: s.department,\r\n              year: s.year,\r\n              bio: s.bio,\r\n              profile_image: s.profile_image,\r\n              college_name: s.college_name,\r\n              interests: s.interests || [],\r\n              mutualFriends: s.mutualFriends,\r\n              mutualFriendNames: s.mutualFriendNames,\r\n              reason: s.reason,\r\n              images: s.profile_image ? [s.profile_image] : []\r\n            }))\r\n\r\n          setUsers(eligibleUsers)\r\n\r\n          if (eligibleUsers.length === 0) {\r\n            setError('No eligible users found. Check back later!')\r\n          }\r\n        }\r\n      } catch (e: any) {\r\n        console.error('Failed to load users:', e)\r\n        if (!isCancelled) {\r\n          setError(e.message || 'Failed to load users')\r\n        }\r\n      } finally {\r\n        if (!isCancelled) {\r\n          setLoading(false)\r\n        }\r\n      }\r\n    }\r\n\r\n    loadUsers()\r\n\r\n    return () => {\r\n      isCancelled = true\r\n    }\r\n  }, [token, user, router])\r\n\r\n  const handleSwipe = useCallback(async (direction: 'left' | 'right') => {\r\n    const currentUser = users[currentIndex]\r\n    if (!currentUser || !token) return\r\n\r\n    setSwipeDirection(direction)\r\n\r\n    // Add to history for undo\r\n    setHistory(prev => [...prev, { user: currentUser, action: direction === 'right' ? 'connect' : 'skip' }])\r\n\r\n    // If swiping right, follow the user\r\n    if (direction === 'right') {\r\n      try {\r\n        await fetchAPI(`/api/users/${currentUser.id}/follow`, {\r\n          method: 'POST',\r\n          token,\r\n          skipCache: true\r\n        })\r\n\r\n        // Clear caches\r\n        dataFetcher.clearCache('/api/users/suggestions')\r\n        dataFetcher.clearCache('/api/users/me/following')\r\n\r\n        // Vibrate on success (if supported)\r\n        if (navigator.vibrate) {\r\n          navigator.vibrate(50)\r\n        }\r\n      } catch (error) {\r\n        console.error('Follow error:', error)\r\n      }\r\n    }\r\n\r\n    // Move to next card after animation\r\n    setTimeout(() => {\r\n      setCurrentIndex(prev => prev + 1)\r\n      setSwipeDirection(null)\r\n      setDragOffset({ x: 0, y: 0 })\r\n    }, 300)\r\n  }, [users, currentIndex, token])\r\n\r\n  const handleUndo = useCallback(() => {\r\n    if (history.length === 0) return\r\n\r\n    const lastAction = history[history.length - 1]\r\n    setHistory(prev => prev.slice(0, -1))\r\n    setCurrentIndex(prev => prev - 1)\r\n\r\n    // If last action was connect, unfollow\r\n    if (lastAction.action === 'connect' && token) {\r\n      fetchAPI(`/api/users/${lastAction.user.id}/follow`, {\r\n        method: 'DELETE',\r\n        token,\r\n        skipCache: true\r\n      }).catch(console.error)\r\n    }\r\n  }, [history, token])\r\n\r\n  // Touch/Mouse event handlers\r\n  const handleStart = useCallback((clientX: number, clientY: number) => {\r\n    setIsDragging(true)\r\n    startPosRef.current = { x: clientX, y: clientY }\r\n  }, [])\r\n\r\n  const handleMove = useCallback((clientX: number, clientY: number) => {\r\n    if (!isDragging) return\r\n\r\n    const deltaX = clientX - startPosRef.current.x\r\n    const deltaY = clientY - startPosRef.current.y\r\n    setDragOffset({ x: deltaX, y: deltaY })\r\n  }, [isDragging])\r\n\r\n  const handleEnd = useCallback(() => {\r\n    if (!isDragging) return\r\n    setIsDragging(false)\r\n\r\n    const threshold = 100\r\n    if (Math.abs(dragOffset.x) > threshold) {\r\n      handleSwipe(dragOffset.x > 0 ? 'right' : 'left')\r\n    } else {\r\n      setDragOffset({ x: 0, y: 0 })\r\n    }\r\n  }, [isDragging, dragOffset, handleSwipe])\r\n\r\n  // Mouse events\r\n  const onMouseDown = (e: React.MouseEvent) => {\r\n    e.preventDefault()\r\n    handleStart(e.clientX, e.clientY)\r\n  }\r\n\r\n  const onMouseMove = (e: React.MouseEvent) => {\r\n    handleMove(e.clientX, e.clientY)\r\n  }\r\n\r\n  const onMouseUp = () => {\r\n    handleEnd()\r\n  }\r\n\r\n  // Touch events\r\n  const onTouchStart = (e: React.TouchEvent) => {\r\n    const touch = e.touches[0]\r\n    handleStart(touch.clientX, touch.clientY)\r\n  }\r\n\r\n  const onTouchMove = (e: React.TouchEvent) => {\r\n    const touch = e.touches[0]\r\n    handleMove(touch.clientX, touch.clientY)\r\n  }\r\n\r\n  const onTouchEnd = () => {\r\n    handleEnd()\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (isDragging) {\r\n      document.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY))\r\n      document.addEventListener('mouseup', handleEnd)\r\n      return () => {\r\n        document.removeEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY))\r\n        document.removeEventListener('mouseup', handleEnd)\r\n      }\r\n    }\r\n  }, [isDragging, handleMove, handleEnd])\r\n\r\n  const currentUser = users[currentIndex]\r\n  const rotation = isDragging ? dragOffset.x / 20 : 0\r\n  const opacity = isDragging ? Math.max(0.5, 1 - Math.abs(dragOffset.x) / 300) : 1\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-bg-secondary to-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-16 w-16 border-b-4 border-accent mx-auto mb-4\"></div>\r\n          <p className=\"text-text-secondary\">Finding connections...</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (error || !currentUser) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-br from-bg-secondary to-white flex items-center justify-center px-4\">\r\n        <div className=\"text-center max-w-md\">\r\n          <svg className=\"w-20 h-20 text-text-tertiary mx-auto mb-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\" />\r\n          </svg>\r\n          <h2 className=\"text-2xl font-bold text-text mb-2\">\r\n            {currentIndex >= users.length ? \"That's everyone!\" : \"No Connections Yet\"}\r\n          </h2>\r\n          <p className=\"text-text-secondary mb-6\">\r\n            {error || \"Connect with more people to unlock swipe discovery. Build your network by following friends and joining communities.\"}\r\n          </p>\r\n          <button\r\n            onClick={() => router.push('/')}\r\n            className=\"btn-primary\"\r\n          >\r\n            Go to Home\r\n          </button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-bg-secondary to-white pb-20 md:pb-8\">\r\n      {/* Header */}\r\n      <div className=\"bg-white border-b border-border-light sticky top-0 z-10\">\r\n        <div className=\"max-w-lg mx-auto px-4 py-4 flex items-center justify-between\">\r\n          <button\r\n            onClick={() => router.back()}\r\n            className=\"p-2 hover:bg-gray-50 rounded-full transition-colors\"\r\n          >\r\n            <svg className=\"w-6 h-6 text-text\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\r\n            </svg>\r\n          </button>\r\n          <h1 className=\"text-lg font-bold bg-gradient-to-r from-orange-500 to-emerald-500 bg-clip-text text-transparent\">\r\n            Discover\r\n          </h1>\r\n          <div className=\"w-10\"></div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Card Stack */}\r\n      <div className=\"max-w-lg mx-auto px-4 pt-8\">\r\n        <div className=\"relative h-[600px]\">\r\n          {/* Next card (preview) */}\r\n          {users[currentIndex + 1] && (\r\n            <div className=\"absolute inset-0 bg-white rounded-3xl shadow-md scale-95 opacity-50\"></div>\r\n          )}\r\n\r\n          {/* Current card */}\r\n          <div\r\n            ref={cardRef}\r\n            className=\"absolute inset-0 bg-white rounded-3xl shadow-2xl overflow-hidden cursor-grab active:cursor-grabbing transition-transform\"\r\n            style={{\r\n              transform: `translateX(${dragOffset.x}px) translateY(${dragOffset.y}px) rotate(${rotation}deg)`,\r\n              opacity,\r\n              transition: isDragging ? 'none' : 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s'\r\n            }}\r\n            onMouseDown={onMouseDown}\r\n            onMouseMove={isDragging ? onMouseMove : undefined}\r\n            onMouseUp={onMouseUp}\r\n            onMouseLeave={isDragging ? onMouseUp : undefined}\r\n            onTouchStart={onTouchStart}\r\n            onTouchMove={onTouchMove}\r\n            onTouchEnd={onTouchEnd}\r\n          >\r\n            {/* Swipe indicators */}\r\n            {isDragging && (\r\n              <>\r\n                <div\r\n                  className=\"absolute top-8 right-8 bg-error text-white px-6 py-3 rounded-full font-bold text-xl transform rotate-12 border-4 border-white shadow-lg z-10\"\r\n                  style={{ opacity: dragOffset.x < -50 ? Math.min(1, -dragOffset.x / 100) : 0 }}\r\n                >\r\n                  SKIP\r\n                </div>\r\n                <div\r\n                  className=\"absolute top-8 left-8 bg-success text-white px-6 py-3 rounded-full font-bold text-xl transform -rotate-12 border-4 border-white shadow-lg z-10\"\r\n                  style={{ opacity: dragOffset.x > 50 ? Math.min(1, dragOffset.x / 100) : 0 }}\r\n                >\r\n                  CONNECT\r\n                </div>\r\n              </>\r\n            )}\r\n\r\n            {/* Profile Image */}\r\n            <div className=\"relative h-96\">\r\n              <Image\r\n                src={currentUser.profile_image || '/default-avatar.png'}\r\n                alt={currentUser.name}\r\n                className=\"w-full h-full object-cover\"\r\n              />\r\n              <div className=\"absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/60\"></div>\r\n            </div>\r\n\r\n            {/* User Info */}\r\n            <div className=\"p-6 space-y-4\">\r\n              <div>\r\n                <h2 className=\"text-3xl font-bold text-text mb-1\">{currentUser.name}</h2>\r\n                <p className=\"text-text-secondary\">@{currentUser.username}</p>\r\n              </div>\r\n\r\n              {currentUser.department && (\r\n                <div className=\"flex items-center gap-2 text-text-secondary\">\r\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\r\n                  </svg>\r\n                  <span>\r\n                    {currentUser.department}\r\n                    {currentUser.year && ` ΓÇó Year ${currentUser.year}`}\r\n                  </span>\r\n                </div>\r\n              )}\r\n\r\n              {currentUser.bio && (\r\n                <p className=\"text-text-secondary text-sm line-clamp-2\">{currentUser.bio}</p>\r\n              )}\r\n\r\n              {/* Mutual Friends */}\r\n              {currentUser.mutualFriends && currentUser.mutualFriends > 0 && (\r\n                <div className=\"bg-accent/10 rounded-xl p-3\">\r\n                  <p className=\"text-accent font-semibold text-sm\">\r\n                    {currentUser.mutualFriends} mutual {currentUser.mutualFriends === 1 ? 'friend' : 'friends'}\r\n                  </p>\r\n                  {currentUser.mutualFriendNames && currentUser.mutualFriendNames.length > 0 && (\r\n                    <p className=\"text-text-secondary text-xs mt-1\">\r\n                      {currentUser.mutualFriendNames.slice(0, 3).join(', ')}\r\n                      {currentUser.mutualFriends > 3 && ` +${currentUser.mutualFriends - 3} more`}\r\n                    </p>\r\n                  )}\r\n                </div>\r\n              )}\r\n\r\n              {/* Interests */}\r\n              {currentUser.interests && currentUser.interests.length > 0 && (\r\n                <div>\r\n                  <p className=\"text-sm font-medium text-text-secondary mb-2\">Common Interests</p>\r\n                  <div className=\"flex flex-wrap gap-2\">\r\n                    {currentUser.interests.slice(0, 5).map((interest, idx) => (\r\n                      <span\r\n                        key={idx}\r\n                        className=\"px-3 py-1 bg-bg-secondary rounded-full text-sm text-text\"\r\n                      >\r\n                        {interest}\r\n                      </span>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Action Buttons */}\r\n        <div className=\"flex items-center justify-center gap-6 mt-8\">\r\n          <button\r\n            onClick={() => handleSwipe('left')}\r\n            className=\"w-16 h-16 rounded-full bg-white shadow-lg hover:shadow-xl transition-all hover:scale-110 active:scale-95 flex items-center justify-center border-2 border-error text-error\"\r\n          >\r\n            <svg className=\"w-8 h-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n            </svg>\r\n          </button>\r\n\r\n          {history.length > 0 && (\r\n            <button\r\n              onClick={handleUndo}\r\n              className=\"w-12 h-12 rounded-full bg-white shadow-lg hover:shadow-xl transition-all hover:scale-110 active:scale-95 flex items-center justify-center text-text-secondary\"\r\n            >\r\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6\" />\r\n              </svg>\r\n            </button>\r\n          )}\r\n\r\n          <button\r\n            onClick={() => handleSwipe('right')}\r\n            className=\"w-16 h-16 rounded-full bg-gradient-to-r from-orange-500 to-emerald-500 shadow-lg hover:shadow-xl transition-all hover:scale-110 active:scale-95 flex items-center justify-center text-white\"\r\n          >\r\n            <svg className=\"w-8 h-8\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\r\n              <path d=\"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z\" />\r\n            </svg>\r\n          </button>\r\n        </div>\r\n\r\n        {/* Progress indicator */}\r\n        <div className=\"mt-6 text-center\">\r\n          <p className=\"text-text-tertiary text-sm\">\r\n            {currentIndex + 1} / {users.length}\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\app\\uniwall\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1620,1623],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1620,1623],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1954,1957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1954,1957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport React, { useState, useCallback, useMemo } from 'react';\r\nimport MasonryTile from '../../components/MasonryTile';\r\nimport PostModal from '../../components/PostModal';\r\nimport { usePosts } from '../../hooks/usePosts';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\n\r\n// PostModal expected type\r\ninterface PostModalData {\r\n  id: number;\r\n  authorId?: number;\r\n  authorName: string;\r\n  authorDept: string;\r\n  authorYear: number;\r\n  content: string;\r\n  category?: string;\r\n  auraCount: number;\r\n  commentCount: number;\r\n  timestamp: string;\r\n  profilePic?: string;\r\n  mediaUrl?: string;\r\n  mediaType?: 'image' | 'video';\r\n  location?: string;\r\n  userLiked?: boolean;\r\n  mediaCarousel?: Array<{\r\n    url: string;\r\n    type: 'image' | 'video';\r\n  }>;\r\n}\r\n\r\n// Post from API\r\ninterface Post {\r\n  id: number;\r\n  content: string;\r\n  category: string;\r\n  media_url?: string;\r\n  media_type?: string;\r\n  aura_count: number;\r\n  user_liked: boolean;\r\n  created_at: string;\r\n  author: {\r\n    id: number;\r\n    name: string;\r\n    department: string;\r\n    year: number;\r\n  };\r\n}\r\n\r\nexport default function UniWallPage() {\r\n  const [selectedCategory, setSelectedCategory] = useState<string>('all');\r\n  const [selectedPost, setSelectedPost] = useState<PostModalData | null>(null);\r\n  const [isModalOpen, setIsModalOpen] = useState(false);\r\n  const { user } = useAuth();\r\n  const { posts, loading, error, refetch } = usePosts(\r\n    selectedCategory === 'all' ? undefined : selectedCategory,\r\n    50\r\n  );\r\n\r\n  // Sync feed with inline updates/deletes\r\n  React.useEffect(() => {\r\n    const handleUpdated = (e: any) => {\r\n      const { id, content } = e.detail || {};\r\n      if (!id) return;\r\n      // Optimistically update selected modal content if open\r\n      if (selectedPost && selectedPost.id === id) {\r\n        setSelectedPost({ ...selectedPost, content: content ?? selectedPost.content });\r\n      }\r\n    };\r\n    const handleDeleted = (e: any) => {\r\n      const { id } = e.detail || {};\r\n      if (selectedPost && selectedPost.id === id) {\r\n        setIsModalOpen(false);\r\n        setSelectedPost(null);\r\n      }\r\n      // Let usePosts hook handle list removal\r\n    };\r\n    window.addEventListener('postUpdated', handleUpdated as EventListener);\r\n    window.addEventListener('postDeleted', handleDeleted as EventListener);\r\n    return () => {\r\n      window.removeEventListener('postUpdated', handleUpdated as EventListener);\r\n      window.removeEventListener('postDeleted', handleDeleted as EventListener);\r\n    };\r\n  }, [selectedPost]);\r\n\r\n  // Filter posts that have media only\r\n  const mediaOnlyPosts = useMemo(() => \r\n    posts.filter((post: Post) => post.media_url),\r\n    [posts]\r\n  );\r\n\r\n  const openPost = useCallback((post: Post) => {\r\n    const modalPost: PostModalData = {\r\n      id: post.id,\r\n      authorName: post.author.name,\r\n      authorDept: post.author.department,\r\n      authorYear: post.author.year,\r\n      content: post.content,\r\n      category: post.category,\r\n      auraCount: post.aura_count,\r\n      commentCount: 0,\r\n      timestamp: new Date(post.created_at).toLocaleDateString(),\r\n      profilePic: undefined,\r\n      mediaUrl: post.media_url,\r\n      mediaType: post.media_type as 'image' | 'video',\r\n      userLiked: post.user_liked,\r\n    };\r\n    setSelectedPost(modalPost);\r\n    setIsModalOpen(true);\r\n  }, []);\r\n\r\n  const handleCloseModal = useCallback(() => {\r\n    setIsModalOpen(false);\r\n    setSelectedPost(null);\r\n  }, []);\r\n\r\n  const categories = [\r\n    { id: 'all', name: 'All', emoji: '≡ƒöÑ' },\r\n    { id: 'academic', name: 'Academic', emoji: '≡ƒôÜ' },\r\n    { id: 'events', name: 'Events', emoji: '≡ƒÄë' },\r\n    { id: 'clubs', name: 'Clubs', emoji: '≡ƒæÑ' },\r\n    { id: 'sports', name: 'Sports', emoji: 'ΓÜ╜' },\r\n    { id: 'social', name: 'Social', emoji: '≡ƒÆ¼' },\r\n    { id: 'general', name: 'General', emoji: '≡ƒÆ¡' },\r\n  ];\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <div className=\"text-6xl mb-4\">≡ƒöÆ</div>\r\n          <h2 className=\"text-2xl font-bold text-gray-900 mb-2\">Access Denied</h2>\r\n          <p className=\"text-gray-600\">Please log in to view the wall</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-white\">\r\n      <div className=\"max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <h1 className=\"text-xl font-semibold text-gray-900\">Uniwall</h1>\r\n          <div className=\"flex items-center space-x-2 text-sm\">\r\n            {categories.map((category) => (\r\n              <button\r\n                key={category.id}\r\n                onClick={() => setSelectedCategory(category.id)}\r\n                className={`px-3 py-1 rounded-full border transition-colors ${\r\n                  selectedCategory === category.id \r\n                    ? 'border-gray-900 text-gray-900 bg-gray-50' \r\n                    : 'border-gray-200 text-gray-600 hover:border-gray-300'\r\n                }`}\r\n              >\r\n                <span className=\"mr-1\">{category.emoji}</span>\r\n                {category.name}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        {loading ? (\r\n          <div className=\"flex justify-center items-center py-12\">\r\n            <div className=\"w-8 h-8 border-4 border-[#FFAF50] border-t-transparent rounded-full animate-spin\"></div>\r\n          </div>\r\n        ) : error ? (\r\n          <div className=\"text-center py-12\">\r\n            <p className=\"text-gray-600 mb-4\">Unable to load posts</p>\r\n            <button \r\n              onClick={refetch}\r\n              className=\"text-[#FFAF50] font-semibold hover:text-orange-600\"\r\n            >\r\n              Try Again\r\n            </button>\r\n          </div>\r\n        ) : mediaOnlyPosts.length > 0 ? (\r\n          <div className=\"[column-fill:_balance] gap-4 sm:columns-[14rem] md:columns-[16rem] lg:columns-[18rem] xl:columns-[20rem] 2xl:columns-[22rem]\">\r\n            {mediaOnlyPosts.map((post: Post) => (\r\n              <div key={post.id} className=\"mb-4 break-inside-avoid\">\r\n                <MasonryTile\r\n                  id={post.id}\r\n                  mediaUrl={post.media_url!}\r\n                  mediaType={(post.media_type?.toLowerCase() as 'image' | 'video') || 'image'}\r\n                  title={post.content}\r\n                  onClick={() => openPost(post)}\r\n                />\r\n              </div>\r\n            ))}\r\n          </div>\r\n        ) : (\r\n          <div className=\"text-center py-12\">\r\n            <div className=\"text-6xl mb-4\">≡ƒô╖</div>\r\n            <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">No media posts yet</h3>\r\n            <p className=\"text-gray-600\">Be the first to share a photo or video!</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {selectedPost && (\r\n        <PostModal\r\n          isOpen={isModalOpen}\r\n          onClose={handleCloseModal}\r\n          post={selectedPost}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\AuthModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":64,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":64,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useCallback } from 'react';\nimport { useAuth } from '../contexts/AuthContext';\n\ninterface AuthModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  initialMode?: 'login' | 'register';\n}\n\nconst AuthModal: React.FC<AuthModalProps> = ({ isOpen, onClose, initialMode = 'login' }) => {\n  const [mode, setMode] = useState<'login' | 'register'>(initialMode);\n  const [formData, setFormData] = useState({\n    name: '',\n    username: '',\n    email: '',\n    college_id: '',\n    password: '',\n    department: '',\n    year: '',\n    bio: '',\n    profile_image: '',\n  });\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState('');\n\n  const { login, register } = useAuth();\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n    setError('');\n\n    try {\n      let success = false;\n      \n      if (mode === 'login') {\n        success = await login(formData.college_id, formData.password);\n      } else {\n        const result = await register({\n          name: formData.name,\n          username: formData.username,\n          email: formData.email,\n          college_id: formData.college_id,\n          password: formData.password,\n          department: formData.department,\n          year: parseInt(formData.year),\n          bio: formData.bio || undefined,\n          profile_image: formData.profile_image || undefined,\n        });\n        success = result.success;\n        if (!success) {\n          setError(result.message || 'Registration failed');\n        }\n      }\n\n      if (success) {\n        onClose();\n        setFormData({ name: '', username: '', email: '', college_id: '', password: '', department: '', year: '', bio: '', profile_image: '' });\n      } else {\n        setError(mode === 'login' ? 'Invalid credentials' : (error || 'Registration failed'));\n      }\n    } catch (error) {\n      setError('An error occurred. Please try again.');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleInputChange = useCallback((e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {\n    setFormData(prev => ({\n      ...prev,\n      [e.target.name]: e.target.value\n    }));\n  }, []);\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"modal-overlay\">\n      <div className=\"modal-container\">\n        {/* Header */}\n        <div className=\"modal-header\">\n          <h2 className=\"text-xl font-semibold text-text\">\n            {mode === 'login' ? 'Sign In to UNI-X' : 'Join UNI-X'}\n          </h2>\n          <button\n            onClick={onClose}\n            className=\"btn-icon\"\n          >\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n              <path d=\"M18 6L6 18M6 6L18 18\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\n            </svg>\n          </button>\n        </div>\n\n        {/* Content */}\n        <div className=\"modal-body\">\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            {mode === 'register' && (\n              <div>\n                <label className=\"block text-sm font-medium text-text mb-1.5\">\n                  Full Name\n                </label>\n                <input\n                  type=\"text\"\n                  name=\"name\"\n                  value={formData.name}\n                  onChange={handleInputChange}\n                  required\n                  className=\"input\"\n                  placeholder=\"Enter your full name\"\n                />\n              </div>\n            )}\n\n            {mode === 'register' && (\n              <div>\n                <label className=\"block text-sm font-medium text-text mb-1.5\">\n                  Email\n                </label>\n                <input\n                  type=\"email\"\n                  name=\"email\"\n                  value={formData.email}\n                  onChange={handleInputChange}\n                  required\n                  className=\"input\"\n                  placeholder=\"you@example.com\"\n                />\n              </div>\n            )}\n\n            <div>\n              <label className=\"block text-sm font-medium text-text mb-1.5\">\n                College ID\n              </label>\n              <input\n                type=\"text\"\n                name=\"college_id\"\n                value={formData.college_id}\n                onChange={handleInputChange}\n                required\n                className=\"input\"\n                placeholder=\"Enter your college ID\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-text mb-1.5\">\n                Password\n              </label>\n              <input\n                type=\"password\"\n                name=\"password\"\n                value={formData.password}\n                onChange={handleInputChange}\n                required\n                className=\"input\"\n                placeholder=\"Enter your password\"\n              />\n            </div>\n\n            {mode === 'register' && (\n              <>\n                <div>\n                  <label className=\"block text-sm font-medium text-text mb-1.5\">\n                    Department\n                  </label>\n                  <select\n                    name=\"department\"\n                    value={formData.department}\n                    onChange={handleInputChange}\n                    required\n                    className=\"input\"\n                  >\n                    <option value=\"\">Select Department</option>\n                    <option value=\"Bachelor  of Computer Applications\">Masters of Computer Applications</option>\n                    <option value=\"Masters of Computer Applications\">Masters of Computer Applications</option>\n                    <option value=\"Bachelor of Business Administration\">Bachelor of Business Administration</option>\n                    <option value=\"Masters of Business Administration\">Masters of Business Administration</option>\n                    <option value=\"Others\">Others</option>\n                  </select>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-text mb-1.5\">\n                    Year\n                  </label>\n                  <select\n                    name=\"year\"\n                    value={formData.year}\n                    onChange={handleInputChange}\n                    required\n                    className=\"input\"\n                  >\n                    <option value=\"\">Select Year</option>\n                    <option value=\"1\">1st Year</option>\n                    <option value=\"2\">2nd Year</option>\n                    <option value=\"3\">3rd Year</option>\n                    <option value=\"4\">4th Year</option>\n                    <option value=\"5\">5th Year</option>\n                    <option value=\"6\">Graduate</option>\n                  </select>\n                </div>\n              </>\n            )}\n\n            {error && (\n              <div className=\"text-error text-sm text-center bg-error/10 py-2 px-4 rounded-lg\">\n                {error}\n              </div>\n            )}\n\n            <button\n              type=\"submit\"\n              disabled={isLoading}\n              className=\"btn-primary w-full btn-lg\"\n            >\n              {isLoading ? (\n                <>\n                  <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\"></div>\n                  {mode === 'login' ? 'Signing In...' : 'Creating Account...'}\n                </>\n              ) : (\n                mode === 'login' ? 'Sign In' : 'Create Account'\n              )}\n            </button>\n          </form>\n\n          <div className=\"mt-6 text-center\">\n            <button\n              onClick={() => setMode(mode === 'login' ? 'register' : 'login')}\n              className=\"link text-sm font-semibold\"\n            >\n              {mode === 'login' ? 'Need an account? Sign up' : 'Already have an account? Sign in'}\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default AuthModal;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\ClientProviders.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\ConditionalChatbot.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\ContactsList.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadContacts'. Either include it or remove the dependency array.","line":30,"column":6,"nodeType":"ArrayExpression","endLine":30,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadContacts]","fix":{"range":[848,850],"text":"[loadContacts]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":51,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1470,1473],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1470,1473],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useState, useEffect, useCallback, useMemo } from 'react';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport { fetchAPI } from '../lib/dataFetcher';\r\nimport Image from 'next/image'\r\n\r\ninterface User {\r\n  id: number;\r\n  name: string;\r\n  email: string;\r\n  department?: string;\r\n  year?: number;\r\n  profileImageUrl?: string;\r\n}\r\n\r\ninterface ContactsListProps {\r\n  onSelectUser: (user: User) => void;\r\n  selectedUserId?: number;\r\n}\r\n\r\nconst ContactsList: React.FC<ContactsListProps> = ({ onSelectUser, selectedUserId }) => {\r\n  const { user } = useAuth();\r\n  const [contacts, setContacts] = useState<User[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [error, setError] = useState('');\r\n\r\n  useEffect(() => {\r\n    loadContacts();\r\n  }, []);\r\n\r\n  const loadContacts = useCallback(async () => {\r\n    setIsLoading(true);\r\n    setError('');\r\n\r\n    try {\r\n      const token = localStorage.getItem('token');\r\n      if (!token) {\r\n        setError('Please log in to view contacts');\r\n        return;\r\n      }\r\n\r\n      const data = await fetchAPI<{ users: User[] }>(\r\n        '/api/users',\r\n        { token, cacheTTL: 120000 } // Cache contacts for 2 minutes\r\n      );\r\n\r\n      // Filter out current user from contacts\r\n      const filteredContacts = data.users?.filter((u: User) => u.id !== user?.id) || [];\r\n      setContacts(filteredContacts);\r\n    } catch (err: any) {\r\n      console.error('Error loading contacts:', err);\r\n      setError(err.message || 'Failed to load contacts');\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [user?.id]);\r\n\r\n  const filteredContacts = useMemo(() =>\r\n    contacts.filter(contact =>\r\n      contact.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n      contact.email.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n      (contact.department && contact.department.toLowerCase().includes(searchTerm.toLowerCase()))\r\n    ),\r\n    [contacts, searchTerm]\r\n  );\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"bg-white rounded-lg shadow-lg p-6\">\r\n        <div className=\"animate-pulse space-y-4\">\r\n          <div className=\"h-10 bg-gray-200 rounded\"></div>\r\n          {[...Array(5)].map((_, i) => (\r\n            <div key={i} className=\"flex items-center space-x-3\">\r\n              <div className=\"w-10 h-10 bg-gray-200 rounded-full\"></div>\r\n              <div className=\"flex-1\">\r\n                <div className=\"h-4 bg-gray-200 rounded w-3/4 mb-2\"></div>\r\n                <div className=\"h-3 bg-gray-200 rounded w-1/2\"></div>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"bg-white rounded-lg shadow-lg p-6\">\r\n        <div className=\"text-center text-red-500\">\r\n          <p>{error}</p>\r\n          <button\r\n            onClick={loadContacts}\r\n            className=\"mt-2 text-[#FFAF50] hover:underline\"\r\n          >\r\n            Try again\r\n          </button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-white rounded-lg shadow-lg\">\r\n      {/* Header */}\r\n      <div className=\"p-4 border-b border-gray-200 bg-gradient-to-r from-[#FFAF50] to-orange-400\">\r\n        <h2 className=\"text-lg font-semibold text-white mb-3\">Contacts</h2>\r\n        <input\r\n          type=\"text\"\r\n          placeholder=\"Search contacts...\"\r\n          value={searchTerm}\r\n          onChange={(e) => setSearchTerm(e.target.value)}\r\n          className=\"w-full px-3 py-2 rounded-lg border border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\r\n        />\r\n      </div>\r\n\r\n      {/* Contacts List */}\r\n      <div className=\"max-h-96 overflow-y-auto\">\r\n        {filteredContacts.length === 0 ? (\r\n          <div className=\"p-6 text-center text-gray-500\">\r\n            <div className=\"text-4xl mb-2\">≡ƒæÑ</div>\r\n            <p>\r\n              {searchTerm\r\n                ? `No contacts found for \"${searchTerm}\"`\r\n                : 'No contacts available'\r\n              }\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"divide-y divide-gray-200\">\r\n            {filteredContacts.map((contact) => (\r\n              <button\r\n                key={contact.id}\r\n                onClick={() => onSelectUser(contact)}\r\n                className={`w-full p-4 text-left hover:bg-gray-50 transition-colors flex items-center space-x-3 ${selectedUserId === contact.id ? 'bg-orange-50 border-r-4 border-[#FFAF50]' : ''\r\n                  }`}\r\n              >\r\n                <Image\r\n                  src={contact.profileImageUrl || '/uploads/DefaultProfile.jpg'}\r\n                  alt={contact.name}\r\n                  className=\"w-10 h-10 rounded-full object-cover\"\r\n                  onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n                />\r\n                <div className=\"flex-1 min-w-0\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <p className=\"font-medium text-gray-900 truncate\">\r\n                      {contact.name}\r\n                    </p>\r\n                    {selectedUserId === contact.id && (\r\n                      <div className=\"w-2 h-2 bg-[#FFAF50] rounded-full\"></div>\r\n                    )}\r\n                  </div>\r\n                  <p className=\"text-sm text-gray-500 truncate\">\r\n                    {contact.department ? `${contact.department} - Year ${contact.year}` : contact.email}\r\n                  </p>\r\n                </div>\r\n              </button>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ContactsList;","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\CreatePostModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has missing dependencies: 'clampOffsets', 'offsetX', and 'offsetY'. Either include them or remove the dependency array.","line":189,"column":6,"nodeType":"ArrayExpression","endLine":189,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [zoom, cropAspect, imgNatural, clampOffsets, offsetX, offsetY]","fix":{"range":[8511,8541],"text":"[zoom, cropAspect, imgNatural, clampOffsets, offsetX, offsetY]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":231,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":231,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10228,10231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10228,10231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":495,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":495,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20467,20470],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20467,20470],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":496,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":496,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20521,20524],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20521,20524],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":499,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":499,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20665,20668],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20665,20668],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":500,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":500,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20719,20722],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20719,20722],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport Image from 'next/image'\r\nimport React, { useState, useRef, useMemo, useCallback } from 'react';\r\nimport { useAuth } from '../contexts/AuthContext';\r\n\r\ninterface CreatePostModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n}\r\n\r\nconst CreatePostModal: React.FC<CreatePostModalProps> = ({ isOpen, onClose }) => {\r\n  const [selectedMedia, setSelectedMedia] = useState<File | null>(null);\r\n  const [previewUrl, setPreviewUrl] = useState<string>('');\r\n  const [editedPreviewUrl, setEditedPreviewUrl] = useState<string>('');\r\n  const [editedBlob, setEditedBlob] = useState<Blob | null>(null);\r\n  const [caption, setCaption] = useState('');\r\n  const [category, setCategory] = useState('general');\r\n  const [captionTouched, setCaptionTouched] = useState(false);\r\n  const [step, setStep] = useState<'upload' | 'edit' | 'share'>('upload');\r\n  const [isUploading, setIsUploading] = useState(false);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n  const imageRef = useRef<HTMLImageElement>(null);\r\n  const rafRef = useRef<number | null>(null);\r\n  const [showDiscardConfirm, setShowDiscardConfirm] = useState(false);\r\n\r\n  // Edit state (images only)\r\n  const [editTab, setEditTab] = useState<'filters' | 'adjust'>('filters');\r\n  const [cropAspect, setCropAspect] = useState<'original' | '1:1' | '4:5' | '16:9'>('1:1');\r\n  const [zoom, setZoom] = useState<number>(1);\r\n  const [brightness, setBrightness] = useState<number>(1);\r\n  const [contrast, setContrast] = useState<number>(1);\r\n  const [saturation, setSaturation] = useState<number>(1);\r\n  const [hue, setHue] = useState<number>(0);\r\n  const [blur, setBlur] = useState<number>(0);\r\n  const [imgNatural, setImgNatural] = useState<{ w: number; h: number } | null>(null);\r\n  const [offsetX, setOffsetX] = useState<number>(0);\r\n  const [offsetY, setOffsetY] = useState<number>(0);\r\n  const [isDragging, setIsDragging] = useState<boolean>(false);\r\n  const dragStartRef = useRef<{ x: number; y: number; ox: number; oy: number } | null>(null);\r\n  const previewBoxRef = useRef<HTMLDivElement>(null);\r\n\r\n  const cssFilter = useMemo(() => {\r\n    return `brightness(${brightness}) contrast(${contrast}) saturate(${saturation}) hue-rotate(${hue}deg) blur(${blur}px)`;\r\n  }, [brightness, contrast, saturation, hue, blur]);\r\n\r\n  const getAspectClass = useCallback((aspect: 'original' | '1:1' | '4:5' | '16:9'): string => {\r\n    switch (aspect) {\r\n      case '1:1':\r\n        return 'aspect-square';\r\n      case '4:5':\r\n        return 'aspect-[4/5]';\r\n      case '16:9':\r\n        return 'aspect-video';\r\n      case 'original':\r\n      default:\r\n        return 'aspect-square';\r\n    }\r\n  }, []);\r\n\r\n  type FilterPreset = {\r\n    name: string;\r\n    values: { brightness: number; contrast: number; saturation: number; hue: number; blur: number };\r\n    css: string;\r\n  };\r\n\r\n  const filterPresets: FilterPreset[] = [\r\n    { name: 'Original', values: { brightness: 1, contrast: 1, saturation: 1, hue: 0, blur: 0 }, css: 'none' },\r\n    { name: 'Aden', values: { brightness: 1.08, contrast: 0.9, saturation: 0.85, hue: -10, blur: 0 }, css: 'brightness(1.08) contrast(0.9) saturate(0.85) hue-rotate(-10deg)' },\r\n    { name: 'Clarendon', values: { brightness: 1.05, contrast: 1.2, saturation: 1.1, hue: 0, blur: 0 }, css: 'brightness(1.05) contrast(1.2) saturate(1.1)' },\r\n    { name: 'Crema', values: { brightness: 1.06, contrast: 0.95, saturation: 0.9, hue: 5, blur: 0 }, css: 'brightness(1.06) contrast(0.95) saturate(0.9) hue-rotate(5deg)' },\r\n    { name: 'Gingham', values: { brightness: 1.05, contrast: 0.9, saturation: 0.8, hue: 0, blur: 0 }, css: 'brightness(1.05) contrast(0.9) saturate(0.8)' },\r\n    { name: 'Juno', values: { brightness: 1.05, contrast: 1.1, saturation: 1.25, hue: 5, blur: 0 }, css: 'brightness(1.05) contrast(1.1) saturate(1.25) hue-rotate(5deg)' },\r\n    { name: 'Lark', values: { brightness: 1.1, contrast: 0.95, saturation: 1.05, hue: 0, blur: 0 }, css: 'brightness(1.1) contrast(0.95) saturate(1.05)' },\r\n    { name: 'Mono', values: { brightness: 1, contrast: 1.15, saturation: 0, hue: 0, blur: 0 }, css: 'contrast(1.15) saturate(0)' },\r\n    { name: 'Vivid', values: { brightness: 1.05, contrast: 1.1, saturation: 1.35, hue: 0, blur: 0 }, css: 'brightness(1.05) contrast(1.1) saturate(1.35)' },\r\n  ];\r\n\r\n  const [activePreset, setActivePreset] = useState<string>('Original');\r\n\r\n  const applyPreset = useCallback((preset: FilterPreset) => {\r\n    setBrightness(preset.values.brightness);\r\n    setContrast(preset.values.contrast);\r\n    setSaturation(preset.values.saturation);\r\n    setHue(preset.values.hue);\r\n    setBlur(preset.values.blur);\r\n    setActivePreset(preset.name);\r\n  }, []);\r\n\r\n  const applyEditsToImage = async (imageUrl: string): Promise<Blob | null> => {\r\n    return new Promise((resolve) => {\r\n      const img = new window.Image();\r\n      img.crossOrigin = 'anonymous';\r\n      img.onload = () => {\r\n        const naturalWidth = img.naturalWidth || img.width;\r\n        const naturalHeight = img.naturalHeight || img.height;\r\n\r\n        // Determine canvas size based on selected aspect\r\n        let canvasWidth = 1080;\r\n        let canvasHeight = 1080;\r\n        if (cropAspect === '4:5') {\r\n          canvasWidth = 1080; canvasHeight = 1350;\r\n        } else if (cropAspect === '16:9') {\r\n          canvasWidth = 1280; canvasHeight = 720;\r\n        } else if (cropAspect === 'original') {\r\n          const aspect = naturalWidth / naturalHeight;\r\n          canvasWidth = 1080;\r\n          canvasHeight = Math.round(canvasWidth / aspect);\r\n        }\r\n\r\n        const canvas = document.createElement('canvas');\r\n        canvas.width = canvasWidth;\r\n        canvas.height = canvasHeight;\r\n        const ctx = canvas.getContext('2d');\r\n        if (!ctx) { resolve(null); return; }\r\n\r\n        // Apply filter\r\n        ctx.filter = cssFilter;\r\n\r\n        // Compute cover scale and center drawing, with zoom\r\n        const scale = Math.max(canvasWidth / naturalWidth, canvasHeight / naturalHeight) * zoom;\r\n        const drawWidth = naturalWidth * scale;\r\n        const drawHeight = naturalHeight * scale;\r\n        // Map preview pan offsets (in preview pixels) to canvas pixels\r\n        let panXCanvas = 0;\r\n        let panYCanvas = 0;\r\n        if (previewBoxRef.current) {\r\n          const boxW = previewBoxRef.current.clientWidth;\r\n          const boxH = previewBoxRef.current.clientHeight;\r\n          const scaleFactorX = canvasWidth / boxW;\r\n          const scaleFactorY = canvasHeight / boxH;\r\n          panXCanvas = offsetX * scaleFactorX;\r\n          panYCanvas = offsetY * scaleFactorY;\r\n        }\r\n        const dx = (canvasWidth - drawWidth) / 2 + panXCanvas;\r\n        const dy = (canvasHeight - drawHeight) / 2 + panYCanvas;\r\n\r\n        ctx.drawImage(img, dx, dy, drawWidth, drawHeight);\r\n\r\n        canvas.toBlob((blob) => {\r\n          resolve(blob);\r\n        }, 'image/jpeg', 0.92);\r\n      };\r\n      img.onerror = () => resolve(null);\r\n      img.src = imageUrl;\r\n    });\r\n  };\r\n\r\n  const resetEdits = useCallback(() => {\r\n    setEditTab('filters');\r\n    setCropAspect('1:1');\r\n    setZoom(1);\r\n    setBrightness(1);\r\n    setContrast(1);\r\n    setSaturation(1);\r\n    setHue(0);\r\n    setBlur(0);\r\n    setOffsetX(0);\r\n    setOffsetY(0);\r\n    setActivePreset('Original');\r\n  }, []);\r\n\r\n  const computeDisplaySize = useCallback((): { boxW: number; boxH: number; dispW: number; dispH: number } | null => {\r\n    if (!previewBoxRef.current || !imgNatural) return null;\r\n    const boxW = previewBoxRef.current.clientWidth;\r\n    const boxH = previewBoxRef.current.clientHeight;\r\n    const scaleToCover = Math.max(boxW / imgNatural.w, boxH / imgNatural.h) * zoom;\r\n    const dispW = imgNatural.w * scaleToCover;\r\n    const dispH = imgNatural.h * scaleToCover;\r\n    return { boxW, boxH, dispW, dispH };\r\n  }, [imgNatural, zoom]);\r\n\r\n  const clampOffsets = useCallback((x: number, y: number): { x: number; y: number } => {\r\n    const size = computeDisplaySize();\r\n    if (!size) return { x, y };\r\n    const maxX = Math.max(0, (size.dispW - size.boxW) / 2);\r\n    const maxY = Math.max(0, (size.dispH - size.boxH) / 2);\r\n    return {\r\n      x: Math.max(-maxX, Math.min(maxX, x)),\r\n      y: Math.max(-maxY, Math.min(maxY, y)),\r\n    };\r\n  }, [computeDisplaySize]);\r\n\r\n  // Keep pan within bounds on zoom/aspect/image load changes\r\n  React.useEffect(() => {\r\n    const clamped = clampOffsets(offsetX, offsetY);\r\n    if (clamped.x !== offsetX) setOffsetX(clamped.x);\r\n    if (clamped.y !== offsetY) setOffsetY(clamped.y);\r\n  }, [zoom, cropAspect, imgNatural]);\r\n\r\n  const onPointerDown = (e: React.MouseEvent | React.TouchEvent) => {\r\n    const point = 'touches' in e ? e.touches[0] : (e as React.MouseEvent);\r\n    dragStartRef.current = { x: point.clientX, y: point.clientY, ox: offsetX, oy: offsetY };\r\n    setIsDragging(true);\r\n  };\r\n\r\n  const onPointerMove = (e: React.MouseEvent | React.TouchEvent) => {\r\n    if (!isDragging || !dragStartRef.current) return;\r\n    const point = 'touches' in e ? e.touches[0] : (e as React.MouseEvent);\r\n    const dx = point.clientX - dragStartRef.current.x;\r\n    const dy = point.clientY - dragStartRef.current.y;\r\n    const clamped = clampOffsets(dragStartRef.current.ox + dx, dragStartRef.current.oy + dy);\r\n    if (rafRef.current) cancelAnimationFrame(rafRef.current);\r\n    rafRef.current = requestAnimationFrame(() => {\r\n      setOffsetX(clamped.x);\r\n      setOffsetY(clamped.y);\r\n    });\r\n  };\r\n\r\n  const onPointerUp = () => {\r\n    setIsDragging(false);\r\n    dragStartRef.current = null;\r\n  };\r\n\r\n  const { user, token } = useAuth();\r\n\r\n  async function downscaleImageFile(file: File, maxDimension: number = 2048): Promise<File> {\r\n    try {\r\n      const bitmap = await createImageBitmap(file);\r\n      const { width, height } = bitmap;\r\n      const scale = Math.min(1, maxDimension / Math.max(width, height));\r\n      if (scale >= 1) return file;\r\n      const targetW = Math.round(width * scale);\r\n      const targetH = Math.round(height * scale);\r\n      const canvas = document.createElement('canvas');\r\n      canvas.width = targetW;\r\n      canvas.height = targetH;\r\n      const ctx = canvas.getContext('2d');\r\n      if (!ctx) return file;\r\n      ctx.imageSmoothingEnabled = true;\r\n      try { (ctx as any).imageSmoothingQuality = 'high'; } catch { }\r\n      ctx.drawImage(bitmap, 0, 0, targetW, targetH);\r\n      const blob: Blob | null = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.9));\r\n      if (!blob) return file;\r\n      return new File([blob], file.name.replace(/\\.(\\w+)$/i, '.jpg'), { type: 'image/jpeg' });\r\n    } catch {\r\n      return file;\r\n    }\r\n  }\r\n\r\n  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = event.target.files?.[0];\r\n    if (file) {\r\n      if (previewUrl) URL.revokeObjectURL(previewUrl);\r\n      const processed = file.type.startsWith('image/') ? await downscaleImageFile(file, 2048) : file;\r\n      setSelectedMedia(processed);\r\n      const url = URL.createObjectURL(processed);\r\n      setPreviewUrl(url);\r\n      setStep('edit');\r\n      resetEdits();\r\n    }\r\n  };\r\n\r\n  const handleDragOver = (e: React.DragEvent) => {\r\n    e.preventDefault();\r\n  };\r\n\r\n  const handleDrop = (e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    const file = e.dataTransfer.files[0];\r\n    if (file && (file.type.startsWith('image/') || file.type.startsWith('video/'))) {\r\n      if (previewUrl) URL.revokeObjectURL(previewUrl);\r\n      setSelectedMedia(file);\r\n      const url = URL.createObjectURL(file);\r\n      setPreviewUrl(url);\r\n      setStep('edit');\r\n      resetEdits();\r\n    }\r\n  };\r\n\r\n  const handleShare = async () => {\r\n    if (!caption.trim()) { setCaptionTouched(true); return; }\r\n\r\n    setIsUploading(true);\r\n\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append('caption', caption);\r\n      formData.append('category', category);\r\n\r\n      if (selectedMedia) {\r\n        if (selectedMedia.type.startsWith('image/')) {\r\n          // Use the already edited image blob stored in state\r\n          if (editedBlob) {\r\n            const editedFile = new File([editedBlob], `edited-${selectedMedia.name.replace(/\\.(\\w+)$/i, '.jpg')}`, { type: 'image/jpeg' });\r\n            formData.append('media', editedFile);\r\n          } else {\r\n            // Fallback: apply edits if somehow blob is not set\r\n            const blob = await applyEditsToImage(previewUrl);\r\n            if (blob) {\r\n              const editedFile = new File([blob], `edited-${selectedMedia.name.replace(/\\.(\\w+)$/i, '.jpg')}`, { type: 'image/jpeg' });\r\n              formData.append('media', editedFile);\r\n            } else {\r\n              formData.append('media', selectedMedia);\r\n            }\r\n          }\r\n        } else {\r\n          formData.append('media', selectedMedia);\r\n        }\r\n      }\r\n\r\n      // Get token from localStorage (you'll need to implement auth context)\r\n      const authToken = token || localStorage.getItem('token');\r\n\r\n      const response = await fetch('/api/posts', {\r\n        method: 'POST',\r\n        headers: {\r\n          ...(authToken && { Authorization: `Bearer ${authToken}` }),\r\n        },\r\n        body: formData,\r\n      });\r\n\r\n      if (response.ok) {\r\n        const result = await response.json();\r\n        console.log('Post created successfully:', result);\r\n\r\n        // Reset modal\r\n        setSelectedMedia(null);\r\n        setPreviewUrl('');\r\n        setCaption('');\r\n        setCategory('general');\r\n        setStep('upload');\r\n        onClose();\r\n\r\n        // You could emit an event here to refresh the feed\r\n        window.dispatchEvent(new CustomEvent('postCreated', { detail: result.post }));\r\n      } else {\r\n        const error = await response.json();\r\n        alert(error.error || 'Failed to create post');\r\n      }\r\n    } catch (error) {\r\n      console.error('Upload error:', error);\r\n      alert('Failed to create post');\r\n    } finally {\r\n      setIsUploading(false);\r\n    }\r\n  };\r\n\r\n  const handleBack = () => {\r\n    if (step === 'edit') {\r\n      setStep('upload');\r\n      setSelectedMedia(null);\r\n      if (previewUrl) URL.revokeObjectURL(previewUrl);\r\n      if (editedPreviewUrl) URL.revokeObjectURL(editedPreviewUrl);\r\n      setPreviewUrl('');\r\n      setEditedPreviewUrl('');\r\n      resetEdits();\r\n    } else if (step === 'share') {\r\n      setStep('edit');\r\n    }\r\n  };\r\n\r\n  const handleNext = async () => {\r\n    // Apply edits to image and create edited preview for share step\r\n    if (selectedMedia?.type.startsWith('image/')) {\r\n      const blob = await applyEditsToImage(previewUrl);\r\n      if (blob) {\r\n        if (editedPreviewUrl) URL.revokeObjectURL(editedPreviewUrl);\r\n        const editedUrl = URL.createObjectURL(blob);\r\n        setEditedPreviewUrl(editedUrl);\r\n        setEditedBlob(blob);\r\n      }\r\n    }\r\n    setStep('share');\r\n  };\r\n\r\n  const reset = () => {\r\n    setSelectedMedia(null);\r\n    if (previewUrl) URL.revokeObjectURL(previewUrl);\r\n    if (editedPreviewUrl) URL.revokeObjectURL(editedPreviewUrl);\r\n    setPreviewUrl('');\r\n    setEditedPreviewUrl('');\r\n    setEditedBlob(null);\r\n    setCaption('');\r\n    setStep('upload');\r\n    resetEdits();\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  const handleOverlayClick = (e: React.MouseEvent<HTMLDivElement>) => {\r\n    if (e.target === e.currentTarget) {\r\n      if (step === 'upload') {\r\n        reset();\r\n        onClose();\r\n      } else {\r\n        setShowDiscardConfirm(true);\r\n      }\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center z-modal p-4\" onClick={handleOverlayClick}>\r\n      <div className=\"bg-white rounded-2xl md:rounded-xl w-full max-w-lg md:max-w-2xl max-h-[90vh] overflow-auto shadow-2xl ring-1 ring-black/5\">\r\n        {/* Header */}\r\n        <div className=\"sticky top-0 z-10 flex items-center justify-between p-4 border-b border-gray-200 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/70\">\r\n          {step !== 'upload' && (\r\n            <button\r\n              onClick={handleBack}\r\n              className=\"p-1.5 hover:bg-gray-100 rounded-full transition-colors shadow-sm\"\r\n            >\r\n              <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                <path d=\"M15 18L9 12L15 6\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n              </svg>\r\n            </button>\r\n          )}\r\n\r\n          <h2 className=\"text-lg font-semibold text-gray-900 flex-1 text-center\">\r\n            {step === 'upload' && 'Create new post'}\r\n            {step === 'edit' && 'Edit'}\r\n            {step === 'share' && 'Share'}\r\n          </h2>\r\n\r\n          {step === 'edit' && (\r\n            <button\r\n              onClick={handleNext}\r\n              className=\"text-[#FFAF50] font-semibold hover:text-orange-600 transition-colors\"\r\n            >\r\n              Next\r\n            </button>\r\n          )}\r\n\r\n          {step === 'share' && (\r\n            <button\r\n              onClick={handleShare}\r\n              disabled={isUploading || !caption.trim()}\r\n              className=\"text-[#FFAF50] font-semibold hover:text-orange-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\r\n            >\r\n              {isUploading ? (\r\n                <>\r\n                  <div className=\"w-4 h-4 border-2 border-[#FFAF50] border-t-transparent rounded-full animate-spin\"></div>\r\n                  Sharing...\r\n                </>\r\n              ) : (\r\n                'Share'\r\n              )}\r\n            </button>\r\n          )}\r\n\r\n          {step === 'upload' && (\r\n            <button\r\n              onClick={() => { reset(); onClose(); }}\r\n              className=\"p-1.5 hover:bg-gray-100 rounded-full transition-colors shadow-sm\"\r\n            >\r\n              <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                <path d=\"M18 6L6 18M6 6L18 18\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n              </svg>\r\n            </button>\r\n          )}\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"flex-1\">\r\n          {step === 'upload' && (\r\n            <div className=\"p-8 md:p-16\">\r\n              <div\r\n                className=\"border-2 border-dashed border-gray-300 rounded-xl p-8 md:p-16 text-center hover:border-[#FFAF50] transition-colors cursor-pointer\"\r\n                onDragOver={handleDragOver}\r\n                onDrop={handleDrop}\r\n                onClick={() => fileInputRef.current?.click()}\r\n              >\r\n                <div className=\"flex flex-col items-center\">\r\n                  <div className=\"w-16 h-16 md:w-20 md:h-20 mb-4 text-gray-400\">\r\n                    <svg viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"w-full h-full\">\r\n                      <path d=\"M21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19ZM8.5 13.5L11 16.51L14.5 12L19 18H5L8.5 13.5Z\" fill=\"currentColor\" />\r\n                      <path d=\"M14 8.5C14 9.88071 12.8807 11 11.5 11C10.1193 11 9 9.88071 9 8.5C9 7.11929 10.1193 6 11.5 6C12.8807 6 14 7.11929 14 8.5Z\" fill=\"currentColor\" />\r\n                    </svg>\r\n                  </div>\r\n                  <h3 className=\"text-xl md:text-2xl font-light text-gray-900 mb-2\">\r\n                    Drag photos and videos here\r\n                  </h3>\r\n                  <button className=\"bg-[#FFAF50] text-black px-6 py-2 rounded-lg font-medium hover:bg-orange-500 transition-colors\">\r\n                    Select from computer\r\n                  </button>\r\n                </div>\r\n              </div>\r\n\r\n              <input\r\n                ref={fileInputRef}\r\n                type=\"file\"\r\n                accept=\"image/*,video/*\"\r\n                onChange={handleFileSelect}\r\n                className=\"hidden\"\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          {step === 'edit' && previewUrl && (\r\n            <div className=\"flex flex-col md:flex-row max-h-[70vh]\">\r\n              {/* Preview with crop/aspect on the left */}\r\n              <div className=\"flex-1 p-4\">\r\n                <div\r\n                  ref={previewBoxRef}\r\n                  className={`${getAspectClass(cropAspect)} bg-black flex items-center justify-center md:max-h-[60vh] relative overflow-hidden rounded-2xl shadow-lg`}\r\n                  onMouseDown={onPointerDown as any}\r\n                  onMouseMove={onPointerMove as any}\r\n                  onMouseUp={onPointerUp}\r\n                  onMouseLeave={onPointerUp}\r\n                  onTouchStart={onPointerDown as any}\r\n                  onTouchMove={onPointerMove as any}\r\n                  onTouchEnd={onPointerUp}\r\n                >\r\n                  {selectedMedia?.type.startsWith('image/') ? (\r\n                    <Image\r\n                      ref={imageRef}\r\n                      src={previewUrl}\r\n                      alt=\"Preview\"\r\n                      className={`pointer-events-none select-none transition-transform duration-150 ease-out ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`}\r\n                      style={{\r\n                        position: 'absolute',\r\n                        left: '50%',\r\n                        top: '50%',\r\n                        transform: `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px)`,\r\n                        maxWidth: 'none',\r\n                        maxHeight: 'none',\r\n                        width: `${computeDisplaySize()?.dispW || 0}px`,\r\n                        height: `${computeDisplaySize()?.dispH || 0}px`,\r\n                        filter: cssFilter,\r\n                      }}\r\n                      onLoad={(e) => {\r\n                        const img = e.currentTarget;\r\n                        setImgNatural({ w: img.naturalWidth || img.width, h: img.naturalHeight || img.height });\r\n                      }}\r\n                    />\r\n                  ) : (\r\n                    <video\r\n                      src={previewUrl}\r\n                      controls\r\n                      className=\"max-w-full max-h-full object-contain\"\r\n                    />\r\n                  )}\r\n                  {/* Grid overlay */}\r\n                  <div className=\"absolute inset-0 pointer-events-none\" style={{ backgroundImage: 'linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px)', backgroundSize: '33.333% 33.333%' }} />\r\n                </div>\r\n              </div>\r\n\r\n              {/* Controls on the right */}\r\n              <div className=\"w-full md:w-80 border-t md:border-t-0 md:border-l border-gray-100 p-4 overflow-y-auto\">\r\n                {selectedMedia?.type.startsWith('image/') ? (\r\n                  <>\r\n                    {/* Tabs */}\r\n                    <div className=\"flex items-center justify-center mb-4\">\r\n                      <div className=\"inline-flex rounded-full bg-gray-100 p-1\">\r\n                        <button onClick={() => setEditTab('filters')} className={`px-4 py-1.5 rounded-full text-sm font-medium transition ${editTab === 'filters' ? 'bg-white shadow text-gray-900' : 'text-gray-600 hover:text-gray-900'}`}>Filters</button>\r\n                        <button onClick={() => setEditTab('adjust')} className={`px-4 py-1.5 rounded-full text-sm font-medium transition ${editTab === 'adjust' ? 'bg-white shadow text-gray-900' : 'text-gray-600 hover:text-gray-900'}`}>Adjust</button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Panels */}\r\n\r\n                    {editTab === 'filters' && (\r\n                      <div className=\"grid grid-cols-3 gap-3\">\r\n                        {filterPresets.map((preset) => (\r\n                          <button\r\n                            key={preset.name}\r\n                            onClick={() => applyPreset(preset)}\r\n                            className={`border rounded-lg p-2 text-xs text-gray-700 hover:bg-gray-50 ${activePreset === preset.name ? 'ring-2 ring-[#FFAF50]' : ''}`}\r\n                          >\r\n                            <div className=\"h-20 w-full bg-gray-200 rounded mb-2 overflow-hidden flex items-center justify-center\">\r\n                              <Image src={previewUrl} alt={preset.name} className=\"h-full w-full object-cover\" style={{ filter: preset.css }} />\r\n                            </div>\r\n                            {preset.name}\r\n                          </button>\r\n                        ))}\r\n                      </div>\r\n                    )}\r\n\r\n                    {editTab === 'adjust' && (\r\n                      <div className=\"space-y-4\">\r\n                        <div>\r\n                          <div className=\"flex justify-between text-sm text-gray-700 mb-2\">\r\n                            <span className=\"font-medium\">Brightness</span>\r\n                            <span className=\"text-gray-500\">{brightness.toFixed(2)}</span>\r\n                          </div>\r\n                          <input\r\n                            type=\"range\"\r\n                            min={0.5}\r\n                            max={1.5}\r\n                            step={0.01}\r\n                            value={brightness}\r\n                            onChange={(e) => setBrightness(parseFloat(e.target.value))}\r\n                            className=\"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#FFAF50]\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <div className=\"flex justify-between text-sm text-gray-700 mb-2\">\r\n                            <span className=\"font-medium\">Contrast</span>\r\n                            <span className=\"text-gray-500\">{contrast.toFixed(2)}</span>\r\n                          </div>\r\n                          <input\r\n                            type=\"range\"\r\n                            min={0.5}\r\n                            max={1.5}\r\n                            step={0.01}\r\n                            value={contrast}\r\n                            onChange={(e) => setContrast(parseFloat(e.target.value))}\r\n                            className=\"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#FFAF50]\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <div className=\"flex justify-between text-sm text-gray-700 mb-2\">\r\n                            <span className=\"font-medium\">Saturation</span>\r\n                            <span className=\"text-gray-500\">{saturation.toFixed(2)}</span>\r\n                          </div>\r\n                          <input\r\n                            type=\"range\"\r\n                            min={0}\r\n                            max={2}\r\n                            step={0.01}\r\n                            value={saturation}\r\n                            onChange={(e) => setSaturation(parseFloat(e.target.value))}\r\n                            className=\"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#FFAF50]\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <div className=\"flex justify-between text-sm text-gray-700 mb-2\">\r\n                            <span className=\"font-medium\">Hue</span>\r\n                            <span className=\"text-gray-500\">{hue.toFixed(0)}┬░</span>\r\n                          </div>\r\n                          <input\r\n                            type=\"range\"\r\n                            min={-180}\r\n                            max={180}\r\n                            step={1}\r\n                            value={hue}\r\n                            onChange={(e) => setHue(parseFloat(e.target.value))}\r\n                            className=\"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#FFAF50]\"\r\n                          />\r\n                        </div>\r\n                        <div>\r\n                          <div className=\"flex justify-between text-sm text-gray-700 mb-2\">\r\n                            <span className=\"font-medium\">Blur</span>\r\n                            <span className=\"text-gray-500\">{blur.toFixed(1)}px</span>\r\n                          </div>\r\n                          <input\r\n                            type=\"range\"\r\n                            min={0}\r\n                            max={5}\r\n                            step={0.1}\r\n                            value={blur}\r\n                            onChange={(e) => setBlur(parseFloat(e.target.value))}\r\n                            className=\"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#FFAF50]\"\r\n                          />\r\n                        </div>\r\n                        <div className=\"pt-3 border-t border-gray-100\">\r\n                          <button\r\n                            onClick={resetEdits}\r\n                            className=\"w-full px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors\"\r\n                          >\r\n                            Reset All\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n                  </>\r\n                ) : (\r\n                  <div className=\"text-sm text-gray-500\">Video editing is not supported yet. You can still share this video.</div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {step === 'share' && (\r\n            <div className=\"flex flex-col md:flex-row\">\r\n              {/* Preview */}\r\n              <div className=\"aspect-square md:w-1/2 bg-black flex items-center justify-center rounded-2xl shadow-lg overflow-hidden\">\r\n                {selectedMedia?.type.startsWith('image/') ? (\r\n                  <Image\r\n                    src={editedPreviewUrl || previewUrl}\r\n                    alt=\"Preview\"\r\n                    className=\"max-w-full max-h-full object-contain\"\r\n                  />\r\n                ) : (\r\n                  <video\r\n                    src={previewUrl}\r\n                    controls\r\n                    className=\"max-w-full max-h-full object-contain\"\r\n                  />\r\n                )}\r\n              </div>\r\n\r\n              {/* Caption */}\r\n              <div className=\"flex-1 p-4 md:pl-6\">\r\n                <div className=\"flex items-center gap-3 mb-4\">\r\n                  <div className=\"w-8 h-8 bg-gradient-to-br from-[#FFAF50] to-orange-400 rounded-full flex items-center justify-center text-white font-bold text-sm\">\r\n                    U\r\n                  </div>\r\n                  <span className=\"font-semibold text-gray-900\">{user?.name || 'Your Username'}</span>\r\n                </div>\r\n\r\n                <textarea\r\n                  value={caption}\r\n                  onChange={(e) => setCaption(e.target.value)}\r\n                  onBlur={() => setCaptionTouched(true)}\r\n                  placeholder=\"Write a caption...\"\r\n                  className=\"w-full h-32 md:h-40 resize-none border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-[#FFAF50] text-sm text-gray-500 placeholder-gray-500\"\r\n                  maxLength={1000}\r\n                />\r\n\r\n                <div className=\"text-xs text-gray-400 text-right mb-4\">\r\n                  {caption.length}/2,200\r\n                </div>\r\n                {captionTouched && !caption.trim() && (\r\n                  <div className=\"text-xs text-red-600 mb-3\">Caption is required.</div>\r\n                )}\r\n\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex items-center justify-between py-2\">\r\n                    <span className=\"text-sm text-gray-900\">Category</span>\r\n                    <select\r\n                      value={category}\r\n                      onChange={(e) => setCategory(e.target.value)}\r\n                      className=\"text-sm border border-gray-200 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-[#FFAF50]\"\r\n                    >\r\n                      <option value=\"general\">General</option>\r\n                      <option value=\"academic\">Academic</option>\r\n                      <option value=\"events\">Events</option>\r\n                      <option value=\"clubs\">Clubs</option>\r\n                      <option value=\"sports\">Sports</option>\r\n                      <option value=\"social\">Social</option>\r\n                    </select>\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center justify-between py-2 opacity-50\">\r\n                    <span className=\"text-sm text-gray-900\">Add location</span>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span className=\"text-xs text-gray-400\">Coming soon</span>\r\n                      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"text-gray-400\">\r\n                        <path d=\"M9 12L11 14L15 10M21 12C21 16.418 16.97 20 12 20C7.03 20 3 16.418 3 12C3 7.582 7.03 4 12 4C16.97 4 21 7.582 21 12Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                      </svg>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center justify-between py-2\">\r\n                    <span className=\"text-sm text-gray-900\">Tag people</span>\r\n                    <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"text-gray-400\">\r\n                      <path d=\"M9 12L11 14L15 10M21 12C21 16.418 16.97 20 12 20C7.03 20 3 16.418 3 12C3 7.582 7.03 4 12 4C16.97 4 21 7.582 21 12Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                    </svg>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {showDiscardConfirm && (\r\n        <div className=\"fixed inset-0 flex items-center justify-center z-popover\" onClick={(e) => { if (e.target === e.currentTarget) setShowDiscardConfirm(false); }}>\r\n          <div className=\"absolute inset-0 bg-black/50\" />\r\n          <div className=\"relative bg-white rounded-2xl shadow-xl w-full max-w-sm mx-4 p-5\">\r\n            <h3 className=\"text-lg font-semibold mb-1\">Discard post?</h3>\r\n            <p className=\"text-sm text-gray-600 mb-4\">If you leave, your edits wonΓÇÖt be saved.</p>\r\n            <div className=\"flex items-center justify-end gap-2\">\r\n              <button\r\n                onClick={() => setShowDiscardConfirm(false)}\r\n                className=\"px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100\"\r\n              >\r\n                Cancel\r\n              </button>\r\n              <button\r\n                onClick={() => { reset(); setShowDiscardConfirm(false); onClose(); }}\r\n                className=\"px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600\"\r\n              >\r\n                Discard\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CreatePostModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\FollowButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1333,1336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1333,1336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":74,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2253,2256],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2253,2256],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'requestState' and 'requested'. Either include them or remove the dependency array. If 'setRequestState' needs the current value of 'requested', you can also switch to useReducer instead of useState and read 'requested' in the reducer.","line":86,"column":6,"nodeType":"ArrayExpression","endLine":86,"endColumn":59,"suggestions":[{"desc":"Update the dependencies array to be: [loading, token, followState, requestState, userId, onFollowChange, requested]","fix":{"range":[2701,2754],"text":"[loading, token, followState, requestState, userId, onFollowChange, requested]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useCallback, useMemo } from 'react'\r\nimport { useAuth } from '../contexts/AuthContext'\r\nimport { fetchAPI, dataFetcher } from '../lib/dataFetcher'\r\n\r\ninterface FollowButtonProps {\r\n  userId: number\r\n  isFollowing: boolean\r\n  requested?: boolean\r\n  onFollowChange?: (isFollowing: boolean, followerCount: number) => void\r\n  className?: string\r\n  size?: 'sm' | 'md' | 'lg'\r\n}\r\n\r\nexport default function FollowButton({ \r\n  userId, \r\n  isFollowing, \r\n  requested = false,\r\n  onFollowChange, \r\n  className = '',\r\n  size = 'md'\r\n}: FollowButtonProps) {\r\n  const { token } = useAuth()\r\n  const [loading, setLoading] = useState(false)\r\n  const [followState, setFollowState] = useState(isFollowing)\r\n  const [requestState, setRequestState] = useState(requested)\r\n\r\n  const handleFollowToggle = useCallback(async () => {\r\n    if (loading || !token) return\r\n\r\n    setLoading(true)\r\n    const previousState = followState\r\n\r\n    // Optimistic update\r\n    if (followState) {\r\n      setFollowState(false)\r\n    } else if (requestState) {\r\n      setRequestState(false)\r\n    } else {\r\n      // We don't know if target is private; optimistic assume public follow\r\n      setFollowState(true)\r\n    }\r\n\r\n    try {\r\n      const method = (followState || requestState) ? 'DELETE' : 'POST'\r\n      const data = await fetchAPI<any>(\r\n        `/api/users/${userId}/follow`,\r\n        {\r\n          method,\r\n          token,\r\n          skipCache: true\r\n        }\r\n      )\r\n\r\n      // Clear relevant caches after follow/unfollow\r\n      dataFetcher.clearCache('/api/users/suggestions')\r\n      dataFetcher.clearCache('/api/users/me/following')\r\n      dataFetcher.clearCache(`/api/users/${userId}`)\r\n\r\n      // Private account case returns requested: true\r\n      if (data.requested) {\r\n        setFollowState(false)\r\n        setRequestState(true)\r\n        if (onFollowChange) onFollowChange(false, data.follower_count ?? 0)\r\n      } else {\r\n        if (typeof data.is_following !== 'boolean') {\r\n          throw new Error('Invalid response format');\r\n        }\r\n        setRequestState(false)\r\n        setFollowState(data.is_following)\r\n        if (onFollowChange) onFollowChange(data.is_following, data.follower_count ?? 0)\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Follow/unfollow error:', error)\r\n      // Revert optimistic update on error\r\n      setFollowState(previousState)\r\n      setRequestState(requested)\r\n      \r\n      // Show user-friendly error message\r\n      const errorMessage = error instanceof Error ? error.message : 'Failed to update follow status';\r\n      console.warn('Follow operation failed:', errorMessage);\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [loading, token, followState, userId, onFollowChange]);\r\n\r\n  const sizeClasses = useMemo(() => ({\r\n    sm: 'btn-sm',\r\n    md: '',\r\n    lg: 'btn-lg'\r\n  }), []);\r\n\r\n  const baseClasses = useMemo(() => `\r\n    font-semibold rounded-lg transition-all duration-200 \r\n    disabled:opacity-50 disabled:cursor-not-allowed\r\n    focus:outline-none focus:ring-2 focus:ring-offset-2\r\n    active:scale-95\r\n    ${sizeClasses[size]}\r\n  `, [sizeClasses, size]);\r\n\r\n  if (followState) {\r\n    return (\r\n      <button\r\n        onClick={handleFollowToggle}\r\n        disabled={loading}\r\n        className={`\r\n          ${baseClasses}\r\n          ${sizeClasses[size] || 'px-6 py-2.5'}\r\n          bg-gray-100 text-text border border-border\r\n          hover:bg-gray-200 focus:ring-gray-300\r\n          ${className}\r\n        `}\r\n      >\r\n        {loading ? (\r\n          <div className=\"flex items-center gap-2\">\r\n            <div className=\"w-4 h-4 border-2 border-text border-t-transparent rounded-full animate-spin\"></div>\r\n            <span>Following</span>\r\n          </div>\r\n        ) : (\r\n          'Following'\r\n        )}\r\n      </button>\r\n    )\r\n  }\r\n\r\n  if (requestState) {\r\n    return (\r\n      <button\r\n        onClick={handleFollowToggle}\r\n        disabled={loading}\r\n        className={`\r\n          ${baseClasses}\r\n          ${sizeClasses[size] || 'px-6 py-2.5'}\r\n          bg-warning/10 text-warning border border-warning/30\r\n          hover:bg-warning/20 focus:ring-warning\r\n          ${className}\r\n        `}\r\n      >\r\n        {loading ? (\r\n          <div className=\"flex items-center gap-2\">\r\n            <div className=\"w-4 h-4 border-2 border-warning border-t-transparent rounded-full animate-spin\"></div>\r\n            <span>Requested</span>\r\n          </div>\r\n        ) : (\r\n          'Requested'\r\n        )}\r\n      </button>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <button\r\n      onClick={handleFollowToggle}\r\n      disabled={loading}\r\n      className={`\r\n        ${baseClasses}\r\n        ${sizeClasses[size] || 'px-6 py-2.5'}\r\n        bg-info text-white border border-info\r\n        hover:bg-info/90 focus:ring-info\r\n        ${className}\r\n      `}\r\n    >\r\n      {loading ? (\r\n        <div className=\"flex items-center gap-2\">\r\n          <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\"></div>\r\n          <span>Follow</span>\r\n        </div>\r\n      ) : (\r\n        'Follow'\r\n      )}\r\n    </button>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\FollowersListModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":109,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3781,3784],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3781,3784],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'hasMore', 'loading', and 'offset'. Either include them or remove the dependency array.","line":117,"column":6,"nodeType":"ArrayExpression","endLine":117,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [hasMore, loading, offset, token, type, userId]","fix":{"range":[4074,4095],"text":"[hasMore, loading, offset, token, type, userId]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":137,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5040,5043],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5040,5043],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchPage' and 'resetState'. Either include them or remove the dependency array.","line":162,"column":6,"nodeType":"ArrayExpression","endLine":162,"endColumn":28,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, userId, type, resetState, fetchPage]","fix":{"range":[5827,5849],"text":"[isOpen, userId, type, resetState, fetchPage]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useEffect, useState, useCallback } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport Image from 'next/image'\r\n\r\ninterface FollowersListModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  userId: number | 'me';\r\n  type: 'followers' | 'following';\r\n}\r\n\r\ninterface LiteUser {\r\n  id: number;\r\n  name: string;\r\n  username?: string;\r\n  department?: string;\r\n  year?: number;\r\n  profile_image?: string | null;\r\n  is_following: boolean;\r\n}\r\n\r\nconst PAGE_SIZE = 20;\r\n\r\nconst FollowersListModal: React.FC<FollowersListModalProps> = ({ isOpen, onClose, userId, type }) => {\r\n  const { token } = useAuth();\r\n  const router = useRouter();\r\n  const [users, setUsers] = useState<LiteUser[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [initialLoading, setInitialLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [offset, setOffset] = useState(0);\r\n  const [hasMore, setHasMore] = useState(true);\r\n  const [isActing, setIsActing] = useState<number | null>(null);\r\n  const sentinelRef = React.useRef<HTMLDivElement | null>(null);\r\n\r\n  // Use refs to avoid dependency issues\r\n  const loadingRef = React.useRef(loading);\r\n  const hasMoreRef = React.useRef(hasMore);\r\n  const offsetRef = React.useRef(offset);\r\n\r\n  // Keep refs in sync with state\r\n  React.useEffect(() => {\r\n    loadingRef.current = loading;\r\n    hasMoreRef.current = hasMore;\r\n    offsetRef.current = offset;\r\n  }, [loading, hasMore, offset]);\r\n\r\n  const resetState = useCallback(() => {\r\n    setUsers([]);\r\n    setOffset(0);\r\n    setHasMore(true);\r\n    setError(null);\r\n    setInitialLoading(true);\r\n  }, []);\r\n\r\n  const fetchPage = useCallback(async (append: boolean) => {\r\n    if (!token) return;\r\n    if (loading) return;\r\n    if (!hasMore && append) return;\r\n\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    const currentOffset = append ? offset : 0;\r\n    console.log(`[FollowersListModal] Fetching ${type} for userId ${userId}, append=${append}, offset=${currentOffset}`);\r\n\r\n    try {\r\n      const params = new URLSearchParams({ limit: String(PAGE_SIZE), offset: String(currentOffset) });\r\n      const endpoint = type === 'followers' ? 'followers' : 'following';\r\n      const url = `/api/users/${userId}/${endpoint}?${params.toString()}`;\r\n\r\n      console.log(`[FollowersListModal] Fetching: ${url}`);\r\n\r\n      const resp = await fetch(url, {\r\n        headers: { Authorization: `Bearer ${token}` }\r\n      });\r\n\r\n      console.log(`[FollowersListModal] Response status: ${resp.status}`);\r\n\r\n      if (!resp.ok) {\r\n        const data = await resp.json().catch(() => ({}));\r\n        console.error(`[FollowersListModal] Error response:`, data);\r\n        throw new Error(data.error || 'Failed to load users');\r\n      }\r\n      const data = await resp.json();\r\n      const newUsers: LiteUser[] = data.users || [];\r\n\r\n      console.log(`[FollowersListModal] Received ${newUsers.length} users`);\r\n\r\n      setUsers(prev => {\r\n        if (append) {\r\n          // When appending, filter out any duplicates to prevent duplicate keys\r\n          const existingIds = new Set(prev.map(u => u.id));\r\n          const uniqueNewUsers = newUsers.filter(u => !existingIds.has(u.id));\r\n          return [...prev, ...uniqueNewUsers];\r\n        } else {\r\n          // When not appending (fresh load), remove any potential duplicates\r\n          const uniqueUsers = newUsers.filter((user, index, arr) =>\r\n            arr.findIndex(u => u.id === user.id) === index\r\n          );\r\n          return uniqueUsers;\r\n        }\r\n      });\r\n\r\n      setHasMore(newUsers.length === PAGE_SIZE);\r\n      setOffset(prev => append ? prev + newUsers.length : newUsers.length);\r\n    } catch (e: any) {\r\n      console.error(`[FollowersListModal] Fetch error:`, e);\r\n      setError(e.message || 'Failed to load users');\r\n    } finally {\r\n      setLoading(false);\r\n      setInitialLoading(false);\r\n      console.log(`[FollowersListModal] Fetch complete, loading set to false`);\r\n    }\r\n  }, [token, type, userId]);\r\n\r\n  const toggleFollow = useCallback(async (targetId: number) => {\r\n    if (!token || isActing === targetId) return;\r\n    setIsActing(targetId);\r\n    try {\r\n      const resp = await fetch('/api/users/follow', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },\r\n        body: JSON.stringify({ userId: targetId })\r\n      });\r\n      if (!resp.ok) {\r\n        const data = await resp.json().catch(() => ({}));\r\n        throw new Error(data.error || 'Failed to update follow');\r\n      }\r\n      const data = await resp.json();\r\n      const action = data.action as 'followed' | 'unfollowed';\r\n      setUsers(prev => prev.map(u => (u.id === targetId ? { ...u, is_following: action === 'followed' } : u)));\r\n      // Let profile header update counts if listening\r\n      window.dispatchEvent(new CustomEvent('followCountsChanged', { detail: { targetId, action } }));\r\n    } catch (e: any) {\r\n      alert(e.message || 'Failed to update follow');\r\n    } finally {\r\n      setIsActing(null);\r\n    }\r\n  }, [token, isActing]);\r\n\r\n  const handleUserClick = useCallback((targetUserId: number) => {\r\n    onClose(); // Close the modal first\r\n    router.push(`/profile/${targetUserId}`);\r\n  }, [onClose, router]);\r\n\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      console.log(`[FollowersListModal] Modal opened for ${type}, userId: ${userId}`);\r\n      resetState();\r\n      // Use a small delay to prevent flickering\r\n      const timer = setTimeout(() => {\r\n        fetchPage(false);\r\n      }, 0);\r\n      return () => clearTimeout(timer);\r\n    } else {\r\n      console.log(`[FollowersListModal] Modal closed`);\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [isOpen, userId, type]);\r\n\r\n  // Infinite scroll\r\n  useEffect(() => {\r\n    if (!isOpen) return;\r\n    const el = sentinelRef.current;\r\n    if (!el) return;\r\n    const observer = new IntersectionObserver((entries) => {\r\n      const first = entries[0];\r\n      if (first.isIntersecting && hasMoreRef.current && !loadingRef.current) {\r\n        fetchPage(true);\r\n      }\r\n    }, { root: null, rootMargin: '300px', threshold: 0 });\r\n    observer.observe(el);\r\n    return () => observer.disconnect();\r\n  }, [isOpen, fetchPage]);\r\n\r\n  return (\r\n    <div className=\"modal-overlay\" onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}>\r\n      <div className=\"modal-container max-w-md\">\r\n        <div className=\"modal-header\">\r\n          <h3 className=\"font-semibold text-text text-base\">{type === 'followers' ? 'Followers' : 'Following'}</h3>\r\n          <button onClick={onClose} className=\"btn-icon text-text-secondary hover:text-text\">├ù</button>\r\n        </div>\r\n\r\n        {error && (\r\n          <div className=\"px-6 py-3 text-sm text-error bg-error/10 border-b border-border-light\">{error}</div>\r\n        )}\r\n\r\n        <div className=\"overflow-y-auto scrollbar-thin\" style={{ maxHeight: '60vh' }}>\r\n          {initialLoading ? (\r\n            <div className=\"flex items-center justify-center py-8\">\r\n              <div className=\"w-8 h-8 border-4 border-accent border-t-transparent rounded-full animate-spin\"></div>\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {users.map((u, index) => (\r\n                <div key={`user-${u.id}-${index}`} className=\"flex items-center justify-between px-4 py-3 hover:bg-gray-50\">\r\n                  <div\r\n                    className=\"flex items-center gap-3 flex-1 cursor-pointer\"\r\n                    onClick={() => handleUserClick(u.id)}\r\n                  >\r\n                    <div className=\"w-10 h-10 rounded-full overflow-hidden bg-gradient-to-br from-gray-200 to-gray-300\">\r\n                      <Image\r\n                        src={u.profile_image || '/uploads/DefaultProfile.jpg'}\r\n                        alt={u.name}\r\n                        className=\"w-full h-full object-cover\"\r\n                        onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n                      />\r\n                    </div>\r\n                    <div>\r\n                      <div className=\"text-sm font-semibold text-gray-900 hover:underline\">{u.username || u.name}</div>\r\n                      <div className=\"text-xs text-gray-500\">{u.name}</div>\r\n                      {(u.department || u.year) && (\r\n                        <div className=\"text-xs text-gray-400\">{u.department}{u.year ? ` ΓÇó ${u.year}rd Year` : ''}</div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                  <button\r\n                    onClick={(e) => {\r\n                      e.stopPropagation();\r\n                      toggleFollow(u.id);\r\n                    }}\r\n                    disabled={isActing === u.id}\r\n                    className={`px-3 py-1.5 rounded-full text-sm font-medium border transition-colors ${u.is_following ? 'border-gray-300 text-gray-700 hover:bg-gray-50' : 'border-[#FFAF50] text-black bg-[#FFAF50] hover:bg-orange-500'\r\n                      } disabled:opacity-50`}\r\n                  >\r\n                    {u.is_following ? 'Following' : 'Follow'}\r\n                  </button>\r\n                </div>\r\n              ))}\r\n\r\n              {loading && !initialLoading && (\r\n                <div className=\"px-4 py-3 text-sm text-gray-500\">LoadingΓÇª</div>\r\n              )}\r\n\r\n              {!loading && !initialLoading && users.length === 0 && (\r\n                <div className=\"px-4 py-6 text-center text-sm text-gray-500\">No users to show</div>\r\n              )}\r\n\r\n              {/* Sentinel for infinite scroll */}\r\n              <div ref={sentinelRef} />\r\n            </>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"px-4 py-3 border-t border-gray-100 flex items-center justify-between\">\r\n          <div className=\"text-xs text-gray-500\">{users.length} loaded</div>\r\n          <button\r\n            onClick={() => fetchPage(true)}\r\n            disabled={loading || !hasMore}\r\n            className=\"text-sm font-medium text-[#FFAF50] disabled:opacity-50\"\r\n          >\r\n            {hasMore ? (loading ? 'LoadingΓÇª' : 'Load more') : 'No more'}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default FollowersListModal;\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\MainContainer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\MasonryTile.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useMemo' is defined but never used.","line":2,"column":59,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":66},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1307,1310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1307,1310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1350,1353],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1350,1353],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useEffect, useRef, useState, useCallback, useMemo, memo } from 'react';\r\nimport Image from 'next/image'\r\n\r\ninterface MasonryTileProps {\r\n  id: number;\r\n  mediaUrl: string;\r\n  mediaType?: 'image' | 'video';\r\n  title?: string;\r\n  onClick?: () => void;\r\n}\r\n\r\nconst MENU_WIDTH_PX = 176; // 11rem\r\nconst MENU_HEIGHT_PX = 160; // approx height incl. padding\r\n\r\nconst MasonryTile: React.FC<MasonryTileProps> = ({ id, mediaUrl, mediaType = 'image', title, onClick }) => {\r\n  const [menuOpen, setMenuOpen] = useState(false);\r\n  const [imgLoaded, setImgLoaded] = useState(false);\r\n  const [imgError, setImgError] = useState(false);\r\n  const [videoError, setVideoError] = useState(false);\r\n  const [videoLoaded, setVideoLoaded] = useState(false);\r\n  const [isVideoHovered, setIsVideoHovered] = useState(false);\r\n  const [videoDuration, setVideoDuration] = useState<number | null>(null);\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const menuBtnRef = useRef<HTMLButtonElement | null>(null);\r\n  const [menuPos, setMenuPos] = useState<{ top: number; left: number }>({ top: 0, left: 0 });\r\n\r\n  const share = useCallback(async () => {\r\n    const url = `${window.location.origin}/post/${id}`;\r\n    const text = title || 'Check this out on UNIX';\r\n    try {\r\n      if ((navigator as any).share) {\r\n        await (navigator as any).share({ title: 'UNIX', text, url });\r\n      } else {\r\n        await navigator.clipboard.writeText(url);\r\n        alert('Post link copied');\r\n      }\r\n    } catch { }\r\n    setMenuOpen(false);\r\n  }, [id, title]);\r\n\r\n  const bookmark = useCallback(async () => {\r\n    const existing = JSON.parse(localStorage.getItem('bookmarks') || '[]');\r\n    if (!existing.includes(id)) existing.push(id);\r\n    localStorage.setItem('bookmarks', JSON.stringify(existing));\r\n    alert('Saved locally');\r\n    setMenuOpen(false);\r\n  }, [id]);\r\n\r\n  const report = useCallback(async () => {\r\n    alert('Thanks for the report. We will review this content.');\r\n    setMenuOpen(false);\r\n  }, []);\r\n\r\n  const formatDuration = useCallback((seconds: number): string => {\r\n    const mins = Math.floor(seconds / 60);\r\n    const secs = Math.floor(seconds % 60);\r\n    if (mins > 0) {\r\n      return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n    }\r\n    return `0:${secs.toString().padStart(2, '0')}`;\r\n  }, []);\r\n\r\n  const handleVideoLoadedMetadata = useCallback(() => {\r\n    if (videoRef.current) {\r\n      setVideoDuration(videoRef.current.duration);\r\n      setVideoLoaded(true);\r\n      console.log('Video loaded successfully:', mediaUrl);\r\n    }\r\n  }, [mediaUrl]);\r\n\r\n  const handleVideoCanPlay = useCallback(() => {\r\n    setVideoLoaded(true);\r\n    console.log('Video can play:', mediaUrl);\r\n  }, [mediaUrl]);\r\n\r\n  // Add timeout for video loading\r\n  useEffect(() => {\r\n    if (mediaType === 'video' && !videoLoaded && !videoError) {\r\n      const timeout = setTimeout(() => {\r\n        if (!videoLoaded) {\r\n          console.warn('Video loading timeout:', mediaUrl);\r\n          setVideoError(true);\r\n        }\r\n      }, 10000); // 10 second timeout\r\n\r\n      return () => clearTimeout(timeout);\r\n    }\r\n  }, [mediaType, videoLoaded, videoError, mediaUrl]);\r\n\r\n  const handleVideoMouseEnter = useCallback(() => {\r\n    setIsVideoHovered(true);\r\n    if (videoRef.current) {\r\n      videoRef.current.currentTime = 0; // Reset to start\r\n      videoRef.current.play().catch(() => { });\r\n    }\r\n  }, []);\r\n\r\n  const handleVideoMouseLeave = useCallback(() => {\r\n    setIsVideoHovered(false);\r\n    if (videoRef.current) {\r\n      videoRef.current.pause();\r\n      videoRef.current.currentTime = 0; // Reset to start\r\n    }\r\n  }, []);\r\n\r\n  const computeMenuPosition = useCallback(() => {\r\n    const btn = menuBtnRef.current;\r\n    if (!btn) return { top: 0, left: 0 };\r\n    const rect = btn.getBoundingClientRect();\r\n    const viewportWidth = window.innerWidth;\r\n    const viewportHeight = window.innerHeight;\r\n\r\n    // Horizontal position (align right edge, keep within viewport)\r\n    const left = Math.max(8, Math.min(rect.right - MENU_WIDTH_PX, viewportWidth - MENU_WIDTH_PX - 8));\r\n\r\n    // Decide to open up or down based on available space\r\n    const spaceBelow = viewportHeight - rect.bottom - 8;\r\n    const openUp = spaceBelow < MENU_HEIGHT_PX;\r\n    const desiredTop = openUp ? rect.top - MENU_HEIGHT_PX - 8 : rect.bottom + 8;\r\n    const top = Math.max(8, Math.min(desiredTop, viewportHeight - MENU_HEIGHT_PX - 8));\r\n\r\n    return { top, left };\r\n  }, []);\r\n\r\n  const openMenu = useCallback((e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    setMenuPos(computeMenuPosition());\r\n    setMenuOpen((v) => !v);\r\n  }, [computeMenuPosition]);\r\n\r\n  useEffect(() => {\r\n    if (!menuOpen) return;\r\n    const handleClose = () => setMenuOpen(false);\r\n    const handleRecalc = () => setMenuPos(computeMenuPosition());\r\n    window.addEventListener('scroll', handleClose, true);\r\n    window.addEventListener('resize', handleRecalc);\r\n    return () => {\r\n      window.removeEventListener('scroll', handleClose, true);\r\n      window.removeEventListener('resize', handleRecalc);\r\n    };\r\n  }, [menuOpen, computeMenuPosition]);\r\n\r\n  return (\r\n    <div className=\"bg-white transition-shadow relative\">\r\n      <button onClick={onClick} className=\"block w-full text-left\">\r\n        {mediaType === 'video' ? (\r\n          !videoError ? (\r\n            <div\r\n              className=\"relative rounded-2xl overflow-hidden\"\r\n              onMouseEnter={handleVideoMouseEnter}\r\n              onMouseLeave={handleVideoMouseLeave}\r\n            >\r\n              {!videoLoaded && (\r\n                <div className=\"absolute inset-0 bg-gray-100 rounded-2xl flex items-center justify-center z-10\">\r\n                  <div className=\"text-center\">\r\n                    <div className=\"text-2xl mb-2\">≡ƒÄÑ</div>\r\n                    <div className=\"text-sm text-gray-500\">Loading video...</div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n              <video\r\n                ref={videoRef}\r\n                src={mediaUrl}\r\n                className=\"w-full h-auto rounded-2xl block\"\r\n                muted\r\n                playsInline\r\n                preload=\"metadata\"\r\n                style={{ maxHeight: '80vh' }}\r\n                onLoadedMetadata={handleVideoLoadedMetadata}\r\n                onCanPlay={handleVideoCanPlay}\r\n                onError={() => {\r\n                  console.error('Video failed to load:', mediaUrl);\r\n                  setVideoError(true);\r\n                }}\r\n                onLoadStart={() => {\r\n                  console.log('Video loading started:', mediaUrl);\r\n                }}\r\n              />\r\n              {videoDuration && !isVideoHovered && videoLoaded && (\r\n                <div className=\"absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded\">\r\n                  {formatDuration(videoDuration)}\r\n                </div>\r\n              )}\r\n            </div>\r\n          ) : (\r\n            <div className=\"w-full h-48 flex items-center justify-center text-gray-400 rounded-2xl bg-gray-100\">\r\n              <div className=\"text-center\">\r\n                <div className=\"text-2xl mb-2\">≡ƒÄÑ</div>\r\n                <div className=\"text-sm\">Video unavailable</div>\r\n              </div>\r\n            </div>\r\n          )\r\n        ) : (\r\n          <div className={`bg-gray-100 rounded-2xl ${imgLoaded ? '' : 'animate-pulse'}`}>\r\n            {!imgError ? (\r\n              <Image\r\n                src={mediaUrl}\r\n                alt={title || 'post image'}\r\n                className=\"w-full h-auto object-cover rounded-2xl\"\r\n                onLoad={() => setImgLoaded(true)}\r\n                onError={() => setImgError(true)}\r\n              />\r\n            ) : (\r\n              <div className=\"w-full h-48 flex items-center justify-center text-gray-400 rounded-2xl bg-gray-100\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"text-2xl mb-2\">≡ƒû╝∩╕Å</div>\r\n                  <div className=\"text-sm\">Image unavailable</div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n      </button>\r\n\r\n      <div className=\"p-3 flex items-center justify-between\">\r\n        <div className=\"text-sm text-gray-900 truncate max-w-[85%]\">\r\n          {title || ''}\r\n        </div>\r\n        <div>\r\n          <button\r\n            ref={menuBtnRef}\r\n            onClick={openMenu}\r\n            className=\"w-8 h-8 rounded-full hover:bg-gray-200 flex items-center justify-center\"\r\n            aria-label=\"More options\"\r\n          >\r\n            <span className=\"text-xl text-zinc-500 leading-none\">Γï«</span>\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {menuOpen && (\r\n        <>\r\n          {/* click-away overlay */}\r\n          <button\r\n            aria-hidden\r\n            className=\"fixed inset-0 z-[95] cursor-default\"\r\n            onClick={(e) => { e.preventDefault(); e.stopPropagation(); setMenuOpen(false); }}\r\n          />\r\n          <div\r\n            className=\"fixed w-44 bg-white border border-gray-100 rounded-xl shadow-lg z-[100]\"\r\n            style={{ top: menuPos.top, left: menuPos.left }}\r\n            onClick={(e) => e.stopPropagation()}\r\n          >\r\n            <button onClick={share} className=\"w-full text-zinc-900 text-left px-4 py-2 text-sm hover:bg-gray-50\">Share</button>\r\n            <button onClick={bookmark} className=\"w-full text-zinc-900 text-left px-4 py-2 text-sm hover:bg-gray-50\">Bookmark</button>\r\n            <button onClick={report} className=\"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50\">Report</button>\r\n          </div>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default memo(MasonryTile);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\Messages.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'conversationId' is assigned a value but never used.","line":60,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":60,"endColumn":24},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'joinConversation', 'leaveConversation', and 'loadInitialMessages'. Either include them or remove the dependency array.","line":78,"column":6,"nodeType":"ArrayExpression","endLine":78,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [otherUserId, user, token, joinConversation, loadInitialMessages, leaveConversation]","fix":{"range":[2069,2095],"text":"[otherUserId, user, token, joinConversation, loadInitialMessages, leaveConversation]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":103,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2974,2977],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2974,2977],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":110,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3239,3242],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3239,3242],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":110,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3262,3265],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3262,3265],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3698,3701],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3698,3701],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":155,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":155,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":156,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":156,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":157,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":157,"endColumn":34},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'confirmMessageReceived', 'onNewMessage', 'onStoppedTyping', 'onTyping', and 'user'. Either include them or remove the dependency array.","line":159,"column":6,"nodeType":"ArrayExpression","endLine":159,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [confirmMessageReceived, onNewMessage, onStoppedTyping, onTyping, socket, user]","fix":{"range":[5122,5130],"text":"[confirmMessageReceived, onNewMessage, onStoppedTyping, onTyping, socket, user]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":168,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5403,5406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5403,5406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":178,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5749,5752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5749,5752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":196,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":196,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":197,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":197,"endColumn":38},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":198,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":198,"endColumn":28},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'scrollToBottom'. Either include it or remove the dependency array.","line":205,"column":6,"nodeType":"ArrayExpression","endLine":205,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [messages, scrollToBottom]","fix":{"range":[6451,6461],"text":"[messages, scrollToBottom]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":229,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7119,7122],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7119,7122],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":232,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7269,7272],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7269,7272],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":233,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":233,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7309,7312],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7309,7312],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":234,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":234,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7338,7341],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7338,7341],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":234,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":234,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7374,7377],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7374,7377],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":236,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":236,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7440,7443],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7440,7443],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":237,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":237,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7480,7483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7480,7483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":242,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":242,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7722,7725],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7722,7725],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":246,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":246,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7964,7967],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7964,7967],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":270,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":270,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9026,9029],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9026,9029],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":288,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9536,9539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9536,9539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":306,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":306,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10108,10111],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10108,10111],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":323,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":323,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10815,10818],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10815,10818],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":335,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":335,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11270,11273],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11270,11273],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":454,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":454,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15387,15390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15387,15390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":457,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":457,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15549,15552],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15549,15552],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":460,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":460,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15708,15711],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15708,15711],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":463,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":463,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15870,15873],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15870,15873],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":467,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":467,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16107,16110],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16107,16110],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":25,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useSocket } from '../contexts/SocketContext';\nimport Image from 'next/image'\n\ninterface Message {\n  id: number;\n  senderId: number;\n  receiverId: number;\n  messageText: string;\n  mediaUrl: string | null;\n  createdAt: string;\n  sender: {\n    id: number;\n    name: string;\n    profile_image: string | null;\n  };\n  receiver: {\n    id: number;\n    name: string;\n    profile_image: string | null;\n  };\n  clientId?: string;\n  // Message status: 'sending' | 'sent' | 'delivered' | 'read'\n  status?: 'sending' | 'sent' | 'delivered' | 'read';\n}\n\ninterface MessagesProps {\n  otherUserId: number;\n  otherUserName: string;\n  onClose: () => void;\n}\n\nconst Messages: React.FC<MessagesProps> = ({ otherUserId, otherUserName, onClose }) => {\n  const { user, token } = useAuth();\n  const {\n    socket,\n    isConnected,\n    joinConversation,\n    leaveConversation,\n    startTyping,\n    stopTyping,\n    onNewMessage,\n    onTyping,\n    onStoppedTyping,\n    sendMessage,\n    onMessageAck,\n    onMessageDelivered,\n    onMessagesRead,\n    markMessagesRead,\n    confirmMessageReceived\n  } = useSocket();\n\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [newMessage, setNewMessage] = useState('');\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSending, setIsSending] = useState(false);\n  const [typingUsers, setTypingUsers] = useState<{ userId: number; userName: string }[]>([]);\n  const [conversationId, setConversationId] = useState<string>('');\n\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    if (user && token) {\n      const convId = [user.id, otherUserId].sort().join('-');\n      setConversationId(convId);\n\n      // Join conversation room via other user's ID\n      joinConversation(otherUserId);\n      loadInitialMessages();\n\n      return () => {\n        leaveConversation(otherUserId);\n      };\n    }\n  }, [otherUserId, user, token]);\n\n  // Mark messages as read when viewing the conversation\n  useEffect(() => {\n    if (!user || !isConnected || messages.length === 0) return;\n\n    // Find unread messages from the other user\n    const unreadFromOther = messages.filter(\n      m => m.senderId === otherUserId && m.id > 0\n    );\n\n    if (unreadFromOther.length > 0) {\n      const messageIds = unreadFromOther.map(m => m.id);\n      // Mark as read after a short delay (ensures user actually sees messages)\n      const timer = setTimeout(() => {\n        markMessagesRead(otherUserId, messageIds, otherUserId);\n      }, 500);\n      return () => clearTimeout(timer);\n    }\n  }, [messages, user, otherUserId, isConnected, markMessagesRead]);\n\n  useEffect(() => {\n    if (!socket) return;\n\n    // Use context helpers to handle both snake_case and kebab-case events\n    const offNewMessage = onNewMessage((messageData: any) => {\n      setMessages(prev => {\n        // 1) exact id dedupe\n        if (prev.some(m => m.id === messageData.id)) return prev;\n\n        // 2) clientId reconciliation\n        if (messageData.clientId) {\n          const idxByClient = prev.findIndex(m => (m as any).clientId && (m as any).clientId === messageData.clientId);\n          if (idxByClient !== -1) {\n            const copy = [...prev];\n            copy[idxByClient] = { ...messageData };\n            return copy;\n          }\n        }\n\n        // 3) fallback: if this is my own echo and last optimistic matches content/time, replace it\n        if (user && messageData.senderId === user.id && prev.length > 0) {\n          const last = prev[prev.length - 1] as any;\n          const sameContent = last?.messageText === messageData.messageText && last?.receiverId === messageData.receiverId;\n          const recent = Math.abs(new Date(messageData.createdAt).getTime() - new Date(last?.createdAt || 0).getTime()) < 5000;\n          const looksOptimistic = !!last?.clientId || (typeof last?.id === 'number' && last.id < 0);\n          if (sameContent && recent && looksOptimistic) {\n            const copy = [...prev];\n            copy[copy.length - 1] = { ...messageData };\n            return copy;\n          }\n        }\n\n        // 4) Confirm receipt for incoming messages (for delivery status)\n        if (user && messageData.senderId !== user.id && messageData.id > 0) {\n          confirmMessageReceived(messageData.id, messageData.senderId);\n        }\n\n        return [...prev, messageData];\n      });\n    });\n\n    const offTyping = onTyping((data: { userId: number; userName: string }) => {\n      setTypingUsers(prev => {\n        const exists = prev.find(u => u.userId === data.userId);\n        if (!exists) {\n          return [...prev, data];\n        }\n        return prev;\n      });\n    });\n\n    const offStopped = onStoppedTyping((data: { userId: number }) => {\n      setTypingUsers(prev => prev.filter(u => u.userId !== data.userId));\n    });\n\n    return () => {\n      offNewMessage && offNewMessage();\n      offTyping && offTyping();\n      offStopped && offStopped();\n    };\n  }, [socket]);\n\n  // Handle message status updates\n  useEffect(() => {\n    if (!socket) return;\n\n    // Message acknowledged (saved on server) - update from 'sending' to 'sent'\n    const offAck = onMessageAck((data) => {\n      setMessages(prev => prev.map(msg => {\n        if ((msg as any).clientId === data.clientId) {\n          return { ...msg, id: data.messageId, status: 'sent' as const };\n        }\n        return msg;\n      }));\n    });\n\n    // Message delivered to recipient\n    const offDelivered = onMessageDelivered((data) => {\n      setMessages(prev => prev.map(msg => {\n        if (msg.id === data.messageId || (msg as any).clientId === data.clientId) {\n          return { ...msg, status: 'delivered' as const };\n        }\n        return msg;\n      }));\n    });\n\n    // Messages read by recipient\n    const offRead = onMessagesRead((data) => {\n      setMessages(prev => prev.map(msg => {\n        if (data.messageIds.includes(msg.id)) {\n          return { ...msg, status: 'read' as const };\n        }\n        return msg;\n      }));\n    });\n\n    return () => {\n      offAck && offAck();\n      offDelivered && offDelivered();\n      offRead && offRead();\n    };\n  }, [socket, onMessageAck, onMessageDelivered, onMessagesRead]);\n\n  useEffect(() => {\n    // Scroll to bottom when new messages arrive\n    scrollToBottom();\n  }, [messages]);\n\n  const loadInitialMessages = async () => {\n    if (!token) return;\n\n    setIsLoading(true);\n    try {\n      const response = await fetch(`/api/messages/conversation/${otherUserId}`, {\n        headers: {\n          'Authorization': `Bearer ${token}`\n        }\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({ error: 'Failed to load messages' }));\n        throw new Error(errorData.error || `HTTP ${response.status}`);\n      }\n\n      const data = await response.json();\n\n      if (!data || !Array.isArray(data.messages)) {\n        throw new Error('Invalid response format');\n      }\n\n      const fetched: any[] = data.messages;\n      setMessages(prev => {\n        if (!prev || prev.length === 0) return fetched;\n        const byClientId = new Map<string, any>();\n        for (const m of prev as any[]) {\n          if ((m as any).clientId) byClientId.set((m as any).clientId, m);\n        }\n        const byId = new Map<number, any>();\n        for (const m of prev as any[]) byId.set(m.id, m);\n        const merged = [...prev];\n        for (const fm of fetched) {\n          if (byId.has(fm.id)) continue;\n          if (fm.clientId && byClientId.has(fm.clientId)) {\n            const idx = merged.findIndex((m: any) => m.clientId === fm.clientId);\n            if (idx !== -1) { merged[idx] = fm; continue; }\n          }\n          // Fallback: replace last optimistic if it looks like the same message\n          const last = merged[merged.length - 1] as any;\n          const sameContent = last?.messageText === fm.messageText && last?.receiverId === fm.receiverId;\n          const looksOptimistic = !!last?.clientId || (typeof last?.id === 'number' && last.id < 0);\n          const recent = Math.abs(new Date(fm.createdAt).getTime() - new Date(last?.createdAt || 0).getTime()) < 5000;\n          if (sameContent && looksOptimistic && recent) {\n            merged[merged.length - 1] = fm;\n          } else {\n            merged.push(fm);\n          }\n        }\n        return merged;\n      });\n    } catch (error) {\n      console.error('Error loading messages:', error);\n      // Show user-friendly error message  \n      setMessages(prev => [...(prev || []), {\n        id: -Date.now(),\n        senderId: 0,\n        receiverId: otherUserId,\n        messageText: 'Failed to load messages. Please try again.',\n        mediaUrl: null,\n        createdAt: new Date().toISOString(),\n        sender: { id: 0, name: 'System', profile_image: null },\n        receiver: { id: otherUserId, name: '', profile_image: null }\n      } as any]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const scrollToBottom = useCallback(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, []);\n\n  const handleSendMessage = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newMessage.trim() || !user || isSending) return;\n\n    setIsSending(true);\n    const messageText = newMessage.trim();\n\n    const clientId = `${user.id}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;\n    const optimistic: any = {\n      id: -Date.now(),\n      senderId: user.id,\n      receiverId: otherUserId,\n      messageText: messageText,\n      mediaUrl: null,\n      createdAt: new Date().toISOString(),\n      sender: { id: user.id, name: user.name, profile_image: null },\n      receiver: { id: otherUserId, name: '', profile_image: null },\n      clientId,\n      status: 'sending', // Initial status before server acknowledgment\n    };\n\n    // Clear input immediately\n    setNewMessage('');\n\n    setMessages(prev => {\n      const now = Date.now();\n      const last = prev[prev.length - 1] as any;\n      const sameContent = last?.messageText === optimistic.messageText && last?.receiverId === optimistic.receiverId && last?.senderId === optimistic.senderId;\n      const recent = Math.abs(now - new Date(last?.createdAt || 0).getTime()) < 2000;\n      if (sameContent && recent) {\n        setIsSending(false);\n        return prev;\n      }\n      return [...prev, optimistic];\n    });\n\n    try {\n      sendMessage({ receiverId: otherUserId, messageText: optimistic.messageText, clientId });\n      stopTyping(otherUserId, user.id);\n    } catch (error) {\n      console.error('Failed to send message:', error);\n\n      // Remove optimistic message on failure\n      setMessages(prev => prev.filter(m => (m as any).clientId !== clientId));\n\n      // Show error message\n      setMessages(prev => [...prev, {\n        id: -Date.now(),\n        senderId: 0,\n        receiverId: otherUserId,\n        messageText: 'Failed to send message. Please try again.',\n        mediaUrl: null,\n        createdAt: new Date().toISOString(),\n        sender: { id: 0, name: 'System', profile_image: null },\n        receiver: { id: otherUserId, name: '', profile_image: null }\n      } as any]);\n    } finally {\n      setIsSending(false);\n    }\n  };\n\n  const handleTyping = (value: string) => {\n    setNewMessage(value);\n\n    if (!user) return;\n\n    // Clear existing timeout\n    if (typingTimeoutRef.current) {\n      clearTimeout(typingTimeoutRef.current);\n    }\n\n    // Start typing indicator\n    if (value.trim()) {\n      startTyping(otherUserId, user.id, user.name);\n\n      // Stop typing after 2 seconds of inactivity\n      typingTimeoutRef.current = setTimeout(() => {\n        stopTyping(otherUserId, user.id);\n      }, 2000);\n    } else {\n      stopTyping(otherUserId, user.id);\n    }\n  };\n\n  const formatTime = useCallback((dateString: string) => {\n    const date = new Date(dateString);\n    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n  }, []);\n\n  const isTyping = typingUsers.some(u => u.userId === otherUserId);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-96\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-[#FFAF50]\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col h-screen max-h-[600px] bg-white rounded-lg shadow-lg\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between p-4 border-b border-gray-200 bg-gradient-to-r from-[#FFAF50] to-orange-400\">\n        <div className=\"flex items-center space-x-3\">\n          <div className=\"w-10 h-10 bg-white rounded-full flex items-center justify-center text-[#FFAF50] font-bold\">\n            {otherUserName.charAt(0)}\n          </div>\n          <div>\n            <h3 className=\"font-semibold text-white\">{otherUserName}</h3>\n            <p className=\"text-xs text-white/80\">\n              {isConnected ? 'Online' : 'Offline'}\n            </p>\n          </div>\n        </div>\n        <button\n          onClick={onClose}\n          className=\"text-white hover:text-white/80 text-xl\"\n        >\n          ├ù\n        </button>\n      </div>\n\n      {/* Messages */}\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n        {messages.length === 0 ? (\n          <div className=\"text-center text-gray-500 mt-8\">\n            <div className=\"text-4xl mb-2\">≡ƒÆ¼</div>\n            <p>Start a conversation with {otherUserName}</p>\n          </div>\n        ) : (\n          messages.map((message) => {\n            const isOwn = user ? message.senderId === user.id : false;\n\n            return (\n              <div\n                key={message.id}\n                className={`flex ${isOwn ? 'justify-end' : 'justify-start'}`}\n              >\n                <div\n                  className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isOwn\n                    ? 'bg-[#FFAF50] text-white'\n                    : 'bg-gray-100 text-gray-900'\n                    }`}\n                >\n                  {message.mediaUrl && (\n                    <div className=\"mb-2\">\n                      {message.mediaUrl.includes('image') ? (\n                        <Image\n                          src={message.mediaUrl}\n                          alt=\"Shared image\"\n                          className=\"rounded max-w-full h-auto\"\n                        />\n                      ) : (\n                        <video\n                          src={message.mediaUrl}\n                          controls\n                          className=\"rounded max-w-full h-auto\"\n                        />\n                      )}\n                    </div>\n                  )}\n                  {message.messageText && (\n                    <p className=\"text-sm\">{message.messageText}</p>\n                  )}\n                  <div className={`flex items-center justify-end gap-1 mt-1`}>\n                    <span\n                      className={`text-xs ${isOwn ? 'text-white/80' : 'text-gray-500'\n                        }`}\n                    >\n                      {formatTime(message.createdAt)}\n                    </span>\n                    {/* Message status indicator for own messages */}\n                    {isOwn && (\n                      <span className=\"text-xs ml-1\">\n                        {(message as any).status === 'sending' && (\n                          <span className=\"text-white/60\">ΓÅ│</span>\n                        )}\n                        {(message as any).status === 'sent' && (\n                          <span className=\"text-white/80\">Γ£ô</span>\n                        )}\n                        {(message as any).status === 'delivered' && (\n                          <span className=\"text-white\">Γ£ôΓ£ô</span>\n                        )}\n                        {(message as any).status === 'read' && (\n                          <span className=\"text-blue-200\">Γ£ôΓ£ô</span>\n                        )}\n                        {/* Default for messages from DB without status */}\n                        {!(message as any).status && message.id > 0 && (\n                          <span className=\"text-white\">Γ£ôΓ£ô</span>\n                        )}\n                      </span>\n                    )}\n                  </div>\n                </div>\n              </div>\n            );\n          })\n        )}\n\n        {/* Typing indicator */}\n        {isTyping && (\n          <div className=\"flex justify-start\">\n            <div className=\"bg-gray-100 px-4 py-2 rounded-lg\">\n              <div className=\"flex space-x-1\">\n                <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-pulse\"></div>\n                <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-100\"></div>\n                <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-pulse delay-200\"></div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        <div ref={messagesEndRef} />\n      </div>\n\n      {/* Message Input */}\n      <form onSubmit={handleSendMessage} className=\"p-4 border-t border-gray-200\">\n        <div className=\"flex space-x-2\">\n          <input\n            type=\"text\"\n            value={newMessage}\n            onChange={(e) => handleTyping(e.target.value)}\n            placeholder={`Message ${otherUserName}...`}\n            className=\"flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent\"\n            disabled={!isConnected}\n          />\n          <button\n            type=\"submit\"\n            disabled={!newMessage.trim() || !isConnected || isSending}\n            className=\"bg-[#FFAF50] text-white px-6 py-2 rounded-full hover:bg-orange-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n          >\n            {isSending ? 'Sending...' : 'Send'}\n          </button>\n        </div>\n        {!isConnected && (\n          <p className=\"text-xs text-red-500 mt-1\">\n            Connection lost. Trying to reconnect...\n          </p>\n        )}\n      </form>\n    </div>\n  );\n};\n\nexport default Messages;","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\MessagesSimple.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'otherUserId' is defined but never used.","line":11,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":57},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":12,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\nimport React, { useState } from 'react';\nimport { useAuth } from '../contexts/AuthContext';\n\ninterface MessagesProps {\n  otherUserId: number;\n  otherUserName: string;\n  onClose: () => void;\n}\n\nconst Messages: React.FC<MessagesProps> = ({ otherUserId, otherUserName, onClose }) => {\n  const { user } = useAuth();\n  const [newMessage, setNewMessage] = useState('');\n\n  const handleSendMessage = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newMessage.trim()) return;\n    // TODO: Implement actual message sending\n    console.log('Sending message:', newMessage);\n    setNewMessage('');\n  };\n\n  return (\n    <div className=\"flex flex-col h-screen max-h-[600px] bg-white rounded-lg shadow-lg\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between p-4 border-b border-gray-200 bg-gradient-to-r from-[#FFAF50] to-orange-400\">\n        <div className=\"flex items-center space-x-3\">\n          <div className=\"w-10 h-10 bg-white rounded-full flex items-center justify-center text-[#FFAF50] font-bold\">\n            {otherUserName.charAt(0)}\n          </div>\n          <div>\n            <h3 className=\"font-semibold text-white\">{otherUserName}</h3>\n            <p className=\"text-xs text-white/80\">Online</p>\n          </div>\n        </div>\n        <button\n          onClick={onClose}\n          className=\"text-white hover:text-white/80 text-xl\"\n        >\n          ├ù\n        </button>\n      </div>\n\n      {/* Messages */}\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n        <div className=\"text-center text-gray-500 mt-8\">\n          <div className=\"text-4xl mb-2\">≡ƒÆ¼</div>\n          <p>Start a conversation with {otherUserName}</p>\n        </div>\n      </div>\n\n      {/* Message Input */}\n      <form onSubmit={handleSendMessage} className=\"p-4 border-t border-gray-200\">\n        <div className=\"flex space-x-2\">\n          <input\n            type=\"text\"\n            value={newMessage}\n            onChange={(e) => setNewMessage(e.target.value)}\n            placeholder={`Message ${otherUserName}...`}\n            className=\"flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent\"\n          />\n          <button\n            type=\"submit\"\n            disabled={!newMessage.trim()}\n            className=\"bg-[#FFAF50] text-white px-6 py-2 rounded-full hover:bg-orange-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n          >\n            Send\n          </button>\n        </div>\n      </form>\n    </div>\n  );\n};\n\nexport default Messages;","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\MetaChatbot.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\MiniChatWindow.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1951,1954],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1951,1954],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":71,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2116,2119],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2116,2119],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2159,2162],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2159,2162],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2191,2194],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2191,2194],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2227,2230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2227,2230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2299,2302],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2299,2302],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":76,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2342,2345],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2342,2345],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":81,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2599,2602],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2599,2602],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":84,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2769,2772],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2769,2772],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4358,4361],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4358,4361],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4381,4384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4381,4384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4724,4727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4724,4727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":1,"message":"Expected an assignment or function call and instead saw an expression.","line":148,"column":20,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":148,"endColumn":33},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":160,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5874,5877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5874,5877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":171,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6227,6230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6227,6230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":14,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport Image from 'next/image'\r\nimport React, { useState, useRef, useEffect, useCallback } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport { useSocket } from '../contexts/SocketContext';\r\n\r\ninterface MiniChatWindowProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  otherUser: {\r\n    id: number;\r\n    name: string;\r\n    profile_image?: string | null;\r\n    department?: string;\r\n    year?: number;\r\n  };\r\n}\r\n\r\ninterface Message {\r\n  id: number;\r\n  senderId: number;\r\n  receiverId: number;\r\n  messageText: string;\r\n  createdAt: string;\r\n  sender: {\r\n    id: number;\r\n    name: string;\r\n    profile_image: string | null;\r\n  };\r\n  clientId?: string;\r\n}\r\n\r\nconst MiniChatWindow: React.FC<MiniChatWindowProps> = ({ isOpen, onClose, otherUser }) => {\r\n  const { user, token } = useAuth();\r\n  const { socket, joinConversation, leaveConversation, onNewMessage, sendMessage } = useSocket();\r\n  const router = useRouter();\r\n\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [input, setInput] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n  const [conversationId, setConversationId] = useState<string>('');\r\n  const [isMinimized, setIsMinimized] = useState(false);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Create conversation ID\r\n  useEffect(() => {\r\n    if (user && otherUser) {\r\n      const convId = [user.id, otherUser.id].sort().join('-');\r\n      setConversationId(convId);\r\n    }\r\n  }, [user, otherUser]);\r\n\r\n  const loadMessages = useCallback(async () => {\r\n    if (!token || !otherUser) return;\r\n\r\n    setLoading(true);\r\n    try {\r\n      const response = await fetch(`/api/messages/conversation/${otherUser.id}`, {\r\n        headers: {\r\n          'Authorization': `Bearer ${token}`\r\n        }\r\n      });\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        const fetched: any[] = data.messages || [];\r\n        setMessages(prev => {\r\n          if (!prev || prev.length === 0) return fetched;\r\n          const byClientId = new Map<string, any>();\r\n          for (const m of prev as any[]) {\r\n            if ((m as any).clientId) byClientId.set((m as any).clientId, m);\r\n          }\r\n          const byId = new Map<number, any>();\r\n          for (const m of prev as any[]) byId.set(m.id, m);\r\n          const merged = [...prev];\r\n          for (const fm of fetched) {\r\n            if (byId.has(fm.id)) continue;\r\n            if (fm.clientId && byClientId.has(fm.clientId)) {\r\n              const idx = merged.findIndex((m: any) => m.clientId === fm.clientId);\r\n              if (idx !== -1) { merged[idx] = fm; continue; }\r\n            }\r\n            const last = merged[merged.length - 1] as any;\r\n            const sameContent = last?.messageText === fm.messageText && last?.receiverId === fm.receiverId;\r\n            const looksOptimistic = !!last?.clientId || (typeof last?.id === 'number' && last.id < 0);\r\n            const recent = Math.abs(new Date(fm.createdAt).getTime() - new Date(last?.createdAt || 0).getTime()) < 5000;\r\n            if (sameContent && looksOptimistic && recent) {\r\n              merged[merged.length - 1] = fm;\r\n            } else {\r\n              merged.push(fm);\r\n            }\r\n          }\r\n          return merged;\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading messages:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [token, otherUser]);\r\n\r\n  // Load messages when window opens\r\n  useEffect(() => {\r\n    if (isOpen && conversationId && token && otherUser) {\r\n      loadMessages();\r\n      joinConversation(otherUser.id);\r\n    }\r\n\r\n    return () => {\r\n      if (otherUser) {\r\n        leaveConversation(otherUser.id);\r\n      }\r\n    };\r\n  }, [isOpen, conversationId, token, otherUser, loadMessages, joinConversation, leaveConversation]);\r\n\r\n  // Socket listeners for real-time messages\r\n  useEffect(() => {\r\n    if (!socket || !conversationId) return;\r\n    const off = onNewMessage((messageData: Message) => {\r\n      if ([messageData.senderId, messageData.receiverId].sort().join('-') === conversationId) {\r\n        setMessages(prev => {\r\n          if (prev.some(m => m.id === messageData.id)) return prev;\r\n          if (messageData.clientId) {\r\n            const idx = prev.findIndex(m => (m as any).clientId && (m as any).clientId === messageData.clientId);\r\n            if (idx !== -1) {\r\n              const copy = [...prev];\r\n              copy[idx] = { ...messageData };\r\n              return copy;\r\n            }\r\n          }\r\n          if (user && messageData.senderId === user.id && prev.length > 0) {\r\n            const last = prev[prev.length - 1] as any;\r\n            const sameContent = last?.messageText === messageData.messageText && last?.receiverId === messageData.receiverId;\r\n            const recent = Math.abs(new Date(messageData.createdAt).getTime() - new Date(last?.createdAt || 0).getTime()) < 5000;\r\n            const looksOptimistic = !!last?.clientId || (typeof last?.id === 'number' && last.id < 0);\r\n            if (sameContent && recent && looksOptimistic) {\r\n              const copy = [...prev];\r\n              copy[copy.length - 1] = { ...messageData };\r\n              return copy;\r\n            }\r\n          }\r\n          return [...prev, messageData];\r\n        });\r\n      }\r\n    });\r\n    return () => { off && off(); };\r\n  }, [socket, conversationId, onNewMessage, user]);\r\n\r\n  // Auto scroll to bottom\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  const handleSendMessage = useCallback(async () => {\r\n    if (!input.trim() || !otherUser || !user) return;\r\n    const messageText = input.trim();\r\n    const clientId = `${user.id}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;\r\n    const optimistic: any = {\r\n      id: -Date.now(),\r\n      senderId: user.id,\r\n      receiverId: otherUser.id,\r\n      messageText,\r\n      createdAt: new Date().toISOString(),\r\n      sender: { id: user.id, name: user.name, profile_image: null },\r\n      clientId,\r\n    };\r\n    setMessages(prev => {\r\n      const now = Date.now();\r\n      const last = prev[prev.length - 1] as any;\r\n      const sameContent = last?.messageText === optimistic.messageText && last?.receiverId === optimistic.receiverId && last?.senderId === optimistic.senderId;\r\n      const recent = Math.abs(now - new Date(last?.createdAt || 0).getTime()) < 2000;\r\n      if (sameContent && recent) return prev;\r\n      return [...prev, optimistic];\r\n    });\r\n    setInput('');\r\n    sendMessage({ receiverId: otherUser.id, messageText, clientId });\r\n  }, [input, otherUser, user, sendMessage]);\r\n\r\n  const handleKeyPress = useCallback((e: React.KeyboardEvent) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSendMessage();\r\n    }\r\n  }, [handleSendMessage]);\r\n\r\n  const expandToFullChat = useCallback(() => {\r\n    onClose();\r\n    // Use userId in URL to ensure it works even without previous conversation\r\n    router.push(`/messages?userId=${otherUser.id}`);\r\n  }, [onClose, router, otherUser.id]);\r\n\r\n  const formatTimestamp = useCallback((timestamp: string) => {\r\n    if (!timestamp) return '';\r\n\r\n    const date = new Date(timestamp);\r\n    if (isNaN(date.getTime())) return '';\r\n\r\n    const now = new Date();\r\n    const diffInHours = (now.getTime() - date.getTime()) / (1000 * 60 * 60);\r\n\r\n    if (diffInHours < 24) {\r\n      return date.toLocaleTimeString('en-US', {\r\n        hour: 'numeric',\r\n        minute: '2-digit',\r\n        hour12: true\r\n      });\r\n    } else {\r\n      return date.toLocaleDateString('en-US', {\r\n        month: 'short',\r\n        day: 'numeric'\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  const toggleMinimized = useCallback(() => {\r\n    setIsMinimized(!isMinimized);\r\n  }, [isMinimized]);\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <>\r\n      {/* Backdrop */}\r\n      <div\r\n        className=\"fixed inset-0 bg-transparent bg-opacity-50 z-40\"\r\n        onClick={onClose}\r\n      />\r\n\r\n      {/* Mini Chat Window */}\r\n      <div className={`fixed bottom-4 right-4 bg-white rounded-lg shadow-xl z-50 flex flex-col border border-gray-200 animate-in slide-in-from-bottom-2 duration-300 ${isMinimized ? 'w-80 h-12' : 'w-80 h-96'\r\n        }`}>\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between p-3 border-b border-gray-200 bg-gray-50 rounded-t-lg\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"w-8 h-8 bg-gradient-to-br from-[#FFAF50] to-orange-400 rounded-full overflow-hidden ring-2 ring-white shadow-sm\">\r\n              <Image\r\n                src={otherUser.profile_image || '/uploads/DefaultProfile.jpg'}\r\n                alt={otherUser.name}\r\n                className=\"w-full h-full object-cover rounded-full\"\r\n                onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n              />\r\n            </div>\r\n            <div>\r\n              <h3 className=\"font-semibold text-sm text-gray-900\">{otherUser.name}</h3>\r\n              {otherUser.department && !isMinimized && (\r\n                <p className=\"text-xs text-gray-500\">{otherUser.department} ΓÇó {otherUser.year}rd Year</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-1\">\r\n            {/* Minimize/Maximize Button */}\r\n            <button\r\n              onClick={toggleMinimized}\r\n              className=\"p-1.5 text-gray-600 hover:text-[#FFAF50] hover:bg-orange-50 rounded-md transition-colors\"\r\n              title={isMinimized ? \"Expand chat\" : \"Minimize chat\"}\r\n            >\r\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                {isMinimized ? (\r\n                  <path d=\"M18 15L12 9L6 15\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                ) : (\r\n                  <path d=\"M6 9L12 15L18 9\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                )}\r\n              </svg>\r\n            </button>\r\n\r\n            {/* Expand Button */}\r\n            {!isMinimized && (\r\n              <button\r\n                onClick={expandToFullChat}\r\n                className=\"p-1.5 text-gray-600 hover:text-[#FFAF50] hover:bg-orange-50 rounded-md transition-colors\"\r\n                title=\"Open full chat\"\r\n              >\r\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                  <path d=\"M8 3H5C3.89543 3 3 3.89543 3 5V8M21 8V5C21 3.89543 20.1046 3 19 3H16M16 21H19C20.1046 21 21 20.1046 21 19V16M3 16V19C3 20.1046 3.89543 21 5 21H8\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                </svg>\r\n              </button>\r\n            )}\r\n\r\n            {/* Close Button */}\r\n            <button\r\n              onClick={onClose}\r\n              className=\"p-1.5 text-gray-600 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors\"\r\n            >\r\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                <path d=\"M18 6L6 18M6 6L18 18\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n              </svg>\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Messages Area - only show when not minimized */}\r\n        {!isMinimized && (\r\n          <>\r\n            <div className=\"flex-1 overflow-y-auto p-3 space-y-2 bg-white\">\r\n              {loading ? (\r\n                <div className=\"flex items-center justify-center h-full\">\r\n                  <div className=\"w-6 h-6 border-2 border-[#FFAF50] border-t-transparent rounded-full animate-spin\"></div>\r\n                </div>\r\n              ) : messages.length === 0 ? (\r\n                <div className=\"flex items-center justify-center h-full text-center\">\r\n                  <div>\r\n                    <div className=\"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2\">\r\n                      <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                        <path d=\"M8.5 19H8C4 19 2 17 2 13V8C2 4 4 2 8 2H16C20 2 22 4 22 8V13C22 17 20 19 16 19H15.5C15.19 19 14.89 19.15 14.7 19.4L13.2 21.4C12.54 22.28 11.46 22.28 10.8 21.4L9.3 19.4C9.14 19.18 8.77 19 8.5 19Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" strokeMiterlimit=\"10\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                      </svg>\r\n                    </div>\r\n                    <p className=\"text-sm text-gray-500\">Start a conversation!</p>\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                messages.map((message) => {\r\n                  const isFromMe = message.senderId === user?.id;\r\n                  return (\r\n                    <div\r\n                      key={message.id}\r\n                      className={`flex ${isFromMe ? 'justify-end' : 'justify-start'}`}\r\n                    >\r\n                      <div\r\n                        className={`max-w-[80%] rounded-2xl px-3 py-2 ${isFromMe\r\n                          ? 'bg-[#FFAF50] text-black'\r\n                          : 'bg-gray-100 text-gray-900'\r\n                          }`}\r\n                      >\r\n                        <p className=\"text-sm leading-relaxed\">{message.messageText}</p>\r\n                        <p className=\"text-xs mt-1 opacity-70\">\r\n                          {formatTimestamp(message.createdAt)}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  );\r\n                })\r\n              )}\r\n              <div ref={messagesEndRef} />\r\n            </div>\r\n\r\n            {/* Input Area - only show when not minimized */}\r\n            <div className=\"p-3 border-t border-gray-200 bg-gray-50 rounded-b-lg\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <input\r\n                  type=\"text\"\r\n                  value={input}\r\n                  onChange={(e) => setInput(e.target.value)}\r\n                  onKeyPress={handleKeyPress}\r\n                  placeholder={`Message ${otherUser.name}...`}\r\n                  className=\"flex-1 px-3 py-2 text-sm border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[#FFAF50] focus:border-transparent\"\r\n                />\r\n                <button\r\n                  onClick={handleSendMessage}\r\n                  disabled={!input.trim()}\r\n                  className=\"w-8 h-8 bg-[#FFAF50] hover:bg-orange-400 disabled:bg-gray-300 disabled:cursor-not-allowed rounded-full flex items-center justify-center transition-colors\"\r\n                >\r\n                  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                  </svg>\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default MiniChatWindow;","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\MobileProfileList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\Navbar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\PostCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showOptions' is assigned a value but never used.","line":60,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":60,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":76,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2391,2394],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2391,2394],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":158,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":158,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4981,4984],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4981,4984],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'authorName'. Either include it or remove the dependency array.","line":230,"column":6,"nodeType":"ArrayExpression","endLine":230,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [authorName, content, id]","fix":{"range":[7219,7232],"text":"[authorName, content, id]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":297,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":297,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9182,9185],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9182,9185],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleDelete' is assigned a value but never used.","line":305,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":305,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":323,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":323,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10012,10015],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10012,10015],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'isDeleting'. Either include it or remove the dependency array.","line":330,"column":6,"nodeType":"ArrayExpression","endLine":330,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [token, isDeleting, id]","fix":{"range":[10215,10226],"text":"[token, isDeleting, id]"}}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useState, useEffect, useCallback, useMemo, memo } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport { useToast } from '../contexts/ToastContext';\r\nimport { useIsMobile } from '../hooks/useIsMobile';\r\nimport { fetchAPI, dataFetcher } from '../lib/dataFetcher';\r\nimport Image from 'next/image'\r\n\r\ninterface PostCardProps {\r\n  id: number;\r\n  authorId?: number;\r\n  authorName: string;\r\n  authorDept: string;\r\n  authorYear: number;\r\n  content: string;\r\n  category?: string;\r\n  auraCount: number;\r\n  commentCount: number;\r\n  timestamp: string;\r\n  profilePic?: string;\r\n  mediaUrl?: string;\r\n  mediaType?: 'image' | 'video';\r\n  userLiked?: boolean;\r\n  onPostClick?: (post: PostCardProps) => void;\r\n  edgeToEdge?: boolean;\r\n  masonry?: boolean;\r\n}\r\n\r\nconst PostCard: React.FC<PostCardProps> = memo(({\r\n  id,\r\n  authorId,\r\n  authorName,\r\n  authorDept,\r\n  authorYear,\r\n  content,\r\n  category,\r\n  auraCount: initialAuraCount,\r\n  commentCount,\r\n  timestamp,\r\n  profilePic,\r\n  mediaUrl,\r\n  mediaType,\r\n  userLiked,\r\n  onPostClick,\r\n  edgeToEdge,\r\n  masonry,\r\n}) => {\r\n  const { token, user } = useAuth();\r\n  const { showToast } = useToast();\r\n  const isMobile = useIsMobile();\r\n  const router = useRouter();\r\n  const [auraCount, setAuraCount] = useState(initialAuraCount);\r\n  const [hasAura, setHasAura] = useState(userLiked || false);\r\n  const [isExpanded, setIsExpanded] = useState(false);\r\n  const [isLiking, setIsLiking] = useState(false);\r\n  const [showShareModal, setShowShareModal] = useState(false);\r\n  const [mediaError, setMediaError] = useState(false);\r\n  const [mediaLoaded, setMediaLoaded] = useState(false);\r\n  const [showOptions, setShowOptions] = useState(false);\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [editText, setEditText] = useState(content || '');\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [isDeleting, setIsDeleting] = useState(false);\r\n  const [isDeleted, setIsDeleted] = useState(false);\r\n  const [isMuted, setIsMuted] = useState(true);\r\n\r\n  // Sync aura state when props change (after refresh)\r\n  useEffect(() => {\r\n    setAuraCount(initialAuraCount);\r\n    setHasAura(userLiked || false);\r\n  }, [initialAuraCount, userLiked]);\r\n\r\n  // Listen for aura updates from PostModal\r\n  useEffect(() => {\r\n    const handleAuraUpdated = (event: any) => {\r\n      if (event.detail.postId === id) {\r\n        setAuraCount(event.detail.auraCount);\r\n        setHasAura(event.detail.hasAura);\r\n      }\r\n    };\r\n\r\n    window.addEventListener('auraUpdated', handleAuraUpdated);\r\n    return () => window.removeEventListener('auraUpdated', handleAuraUpdated);\r\n  }, [id]);\r\n\r\n  const inferMediaType = useCallback((\r\n    url?: string,\r\n    declared?: 'image' | 'video'\r\n  ): 'image' | 'video' | undefined => {\r\n    if (!url) return undefined;\r\n    if (declared === 'image' || declared === 'video') return declared;\r\n    const lower = url.toLowerCase();\r\n    if (lower.includes('/video/') || /(\\.mp4|\\.webm|\\.mov|\\.avi|\\.wmv)$/i.test(lower)) {\r\n      return 'video';\r\n    }\r\n    return 'image';\r\n  }, []);\r\n\r\n  const handleAuraClick = useCallback(async () => {\r\n    // Prevent multiple clicks while processing\r\n    if (!token || isLiking) return;\r\n\r\n    // OPTIMISTIC UPDATE - Update UI immediately for instant feedback\r\n    const previousHasAura = hasAura;\r\n    const previousAuraCount = auraCount;\r\n\r\n    // Update UI instantly (before API call)\r\n    const newHasAura = !hasAura;\r\n    const newAuraCount = hasAura ? auraCount - 1 : auraCount + 1;\r\n\r\n    setHasAura(newHasAura);\r\n    setAuraCount(newAuraCount);\r\n\r\n    // Visual feedback - immediate scale and color change\r\n    const button = document.getElementById(`aura-btn-${id}`);\r\n    if (button) {\r\n      button.style.transform = 'scale(1.2)';\r\n      setTimeout(() => {\r\n        button.style.transform = 'scale(1)';\r\n      }, 150);\r\n    }\r\n\r\n    setIsLiking(true);\r\n\r\n    try {\r\n      const data = await fetchAPI<{ post: { aura_count: number; user_liked: boolean } }>(\r\n        '/api/posts/aura',\r\n        {\r\n          method: 'POST',\r\n          token: token || '',\r\n          body: JSON.stringify({ postId: id }),\r\n          skipCache: true\r\n        }\r\n      );\r\n\r\n      // Validate response format\r\n      if (!data?.post || typeof data.post.aura_count !== 'number') {\r\n        throw new Error('Invalid response format');\r\n      }\r\n\r\n      // Sync with server response (in case there's a discrepancy)\r\n      setAuraCount(data.post.aura_count);\r\n      setHasAura(data.post.user_liked);\r\n\r\n      // Clear post cache\r\n      dataFetcher.clearCache('/api/posts');\r\n      dataFetcher.clearCache(`/api/posts/${id}`);\r\n\r\n      // Broadcast aura change to PostModal\r\n      window.dispatchEvent(new CustomEvent('auraUpdated', {\r\n        detail: {\r\n          postId: id,\r\n          auraCount: data.post.aura_count,\r\n          hasAura: data.post.user_liked\r\n        }\r\n      }));\r\n    } catch (error: any) {\r\n      console.error('Error updating aura:', error);\r\n      // Revert optimistic update if API fails\r\n      setHasAura(previousHasAura);\r\n      setAuraCount(previousAuraCount);\r\n\r\n      const errorMessage = error instanceof Error ? error.message : 'Failed to update like. Please try again.';\r\n      showToast(errorMessage, 'error', 2000);\r\n\r\n      // Show error feedback\r\n      if (button) {\r\n        button.style.filter = 'brightness(0.5)';\r\n        setTimeout(() => {\r\n          button.style.filter = 'brightness(1)';\r\n        }, 200);\r\n      }\r\n    } finally {\r\n      setIsLiking(false);\r\n    }\r\n  }, [token, id, hasAura, auraCount, isLiking, showToast]);\r\n\r\n  const handleMuteToggle = useCallback((e: React.MouseEvent) => {\r\n    e.stopPropagation(); // Prevent triggering modal\r\n    setIsMuted(!isMuted);\r\n  }, [isMuted]);\r\n\r\n  const handleCommentClick = useCallback(() => {\r\n    if (onPostClick) {\r\n      onPostClick({\r\n        id,\r\n        authorId,\r\n        authorName,\r\n        authorDept,\r\n        authorYear,\r\n        content: editText,\r\n        category,\r\n        auraCount,\r\n        commentCount,\r\n        timestamp,\r\n        profilePic,\r\n        mediaUrl,\r\n        mediaType,\r\n        userLiked: hasAura, // Pass current aura status\r\n        onPostClick,\r\n        edgeToEdge,\r\n        masonry,\r\n      });\r\n    } else {\r\n      alert('Comments feature is coming soon! ≡ƒÆ¼');\r\n    }\r\n  }, [onPostClick, id, authorId, authorName, authorDept, authorYear, editText, category, auraCount, commentCount, timestamp, profilePic, mediaUrl, mediaType, hasAura, edgeToEdge, masonry]);\r\n\r\n  const handleShareClick = useCallback(async () => {\r\n    const shareUrl = `${window.location.origin}/post/${id}`;\r\n    const shareText = content?.slice(0, 120) || 'Check out this post';\r\n    const shareData: ShareData = {\r\n      title: `${authorName} on UNIX`,\r\n      text: shareText,\r\n      url: shareUrl,\r\n    };\r\n\r\n    try {\r\n      if (navigator.share && typeof navigator.share === 'function') {\r\n        await navigator.share(shareData);\r\n        return;\r\n      }\r\n    } catch (err) {\r\n      // If Web Share fails, fall back to modal\r\n      console.warn('Web Share failed, falling back:', err);\r\n    }\r\n\r\n    setShowShareModal(true);\r\n  }, [content, id]);\r\n\r\n  const copyToClipboard = useCallback(() => {\r\n    const url = `${window.location.origin}/post/${id}`;\r\n    navigator.clipboard.writeText(url).then(() => {\r\n      alert('Post link copied to clipboard! ≡ƒôï');\r\n      setShowShareModal(false);\r\n    });\r\n  }, [id]);\r\n\r\n  const handlePostClick = useCallback(() => {\r\n    if (onPostClick) {\r\n      onPostClick({\r\n        id,\r\n        authorId,\r\n        authorName,\r\n        authorDept,\r\n        authorYear,\r\n        content: editText,\r\n        category,\r\n        auraCount,\r\n        commentCount,\r\n        timestamp,\r\n        profilePic,\r\n        mediaUrl,\r\n        mediaType,\r\n        userLiked: hasAura, // Pass current aura status\r\n        onPostClick,\r\n        edgeToEdge,\r\n        masonry,\r\n      });\r\n    }\r\n  }, [onPostClick, id, authorId, authorName, authorDept, authorYear, editText, category, auraCount, commentCount, timestamp, profilePic, mediaUrl, mediaType, hasAura, edgeToEdge, masonry]);\r\n\r\n  const handleEditSave = useCallback(async () => {\r\n    if (!token) return;\r\n    const trimmed = (editText || '').trim();\r\n\r\n    // Validate caption is not empty\r\n    if (!trimmed) {\r\n      alert('Caption cannot be empty');\r\n      return;\r\n    }\r\n\r\n    setIsSaving(true);\r\n    try {\r\n      const data = await fetchAPI<{ post: { caption: string } }>(\r\n        `/api/posts/${id}`,\r\n        {\r\n          method: 'PUT',\r\n          token: token || '',\r\n          body: JSON.stringify({ caption: trimmed }),\r\n          skipCache: true\r\n        }\r\n      );\r\n\r\n      const newContent = data.post?.caption ?? trimmed;\r\n      setEditText(newContent);\r\n      setIsEditing(false);\r\n      setShowOptions(false);\r\n\r\n      // Clear caches\r\n      dataFetcher.clearCache('/api/posts');\r\n      dataFetcher.clearCache(`/api/posts/${id}`);\r\n      dataFetcher.clearCache('/api/users/me');\r\n\r\n      window.dispatchEvent(new CustomEvent('postUpdated', { detail: { id, content: newContent } }));\r\n    } catch (error: any) {\r\n      console.error('Update post failed', error);\r\n      alert(error.message || 'Failed to update post');\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  }, [token, id, editText]);\r\n\r\n  const handleDelete = useCallback(async () => {\r\n    if (!token || isDeleting) return;\r\n    if (!confirm('Delete this post? This cannot be undone.')) return;\r\n    setIsDeleting(true);\r\n    try {\r\n      await fetchAPI(`/api/posts/${id}`, {\r\n        method: 'DELETE',\r\n        token: token || '',\r\n        skipCache: true\r\n      });\r\n\r\n      // Clear caches\r\n      dataFetcher.clearCache('/api/posts');\r\n      dataFetcher.clearCache(`/api/posts/${id}`);\r\n      dataFetcher.clearCache('/api/users/me');\r\n\r\n      window.dispatchEvent(new CustomEvent('postDeleted', { detail: { id } }));\r\n      setIsDeleted(true);\r\n    } catch (error: any) {\r\n      console.error('Delete post failed', error);\r\n      alert(error.message || 'Failed to delete post');\r\n    } finally {\r\n      setIsDeleting(false);\r\n      setShowOptions(false);\r\n    }\r\n  }, [token, id]);\r\n\r\n  const handleAuthorClick = useCallback((e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    if (authorId) {\r\n      if (user && user.id === authorId) {\r\n        router.push('/profile/me');\r\n      } else {\r\n        router.push(`/profile/${authorId}`);\r\n      }\r\n    }\r\n  }, [authorId, user, router]);\r\n\r\n  const getCategoryColor = useMemo(() => (cat?: string) => {\r\n    switch (cat?.toLowerCase()) {\r\n      case 'event':\r\n      case 'events':\r\n        return 'badge-error';\r\n      case 'internship':\r\n      case 'academic':\r\n        return 'badge-primary';\r\n      case 'workshop':\r\n        return 'badge-success';\r\n      case 'library':\r\n        return 'badge-warning';\r\n      case 'clubs':\r\n      case 'sports':\r\n        return 'badge-success';\r\n      case 'social':\r\n        return 'badge-gray';\r\n      default:\r\n        return 'badge-primary';\r\n    }\r\n  }, []);\r\n\r\n  if (isDeleted) return null;\r\n\r\n  return (\r\n    <div className={`${edgeToEdge ? 'bg-white rounded-none border-0 shadow-none' : 'card-interactive'} overflow-hidden`}>\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between p-4 pb-2 relative\">\r\n        <div className=\"flex items-center space-x-3\">\r\n          <div\r\n            className=\"relative cursor-pointer\"\r\n            onClick={handleAuthorClick}\r\n          >\r\n            <div className=\"avatar avatar-lg avatar-ring\">\r\n              <Image\r\n                src={profilePic || '/uploads/DefaultProfile.jpg'}\r\n                alt={authorName}\r\n                className=\"w-full h-full object-cover\"\r\n                onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n              />\r\n            </div>\r\n            <div className=\"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-success rounded-full border-2 border-white\"></div>\r\n          </div>\r\n          <div\r\n            className=\"cursor-pointer hover:opacity-80 transition-opacity\"\r\n            onClick={handleAuthorClick}\r\n          >\r\n            <p className=\"font-semibold text-text text-sm hover:underline\">{authorName}</p>\r\n            <p className=\"text-xs text-text-secondary\">{authorDept} ΓÇó {authorYear}rd Year</p>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-2\">\r\n          {category && (\r\n            <span className={`badge ${getCategoryColor(category)}`}>\r\n              {category}\r\n            </span>\r\n          )}\r\n          <span className=\"text-xs text-text-tertiary\">{timestamp}</span>\r\n          {/* In-feed edit/delete disabled: manage via profile modal only */}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Media - variable height for masonry, square otherwise */}\r\n      {mediaUrl && (\r\n        <div\r\n          className={`${!isMobile ? 'cursor-pointer' : ''}`}\r\n          onClick={!isMobile && inferMediaType(mediaUrl, mediaType) !== 'video' ? handlePostClick : undefined}\r\n        >\r\n          {inferMediaType(mediaUrl, mediaType) === 'image' ? (\r\n            <div className={`overflow-hidden bg-gray-100 ${mediaLoaded ? '' : 'animate-pulse'}`}>\r\n              <div className={`${masonry ? '' : 'relative w-full aspect-square'} bg-gray-100`}>\r\n                {!mediaError ? (\r\n                  <Image\r\n                    src={mediaUrl}\r\n                    alt=\"Post media\"\r\n                    className={`${masonry ? 'w-full h-auto object-cover' : 'absolute inset-0 w-full h-full object-cover'}`}\r\n                    onLoad={() => setMediaLoaded(true)}\r\n                    onError={() => setMediaError(true)}\r\n                  />\r\n                ) : (\r\n                  <div className=\"absolute inset-0 flex items-center justify-center text-gray-400 bg-white\">\r\n                    <span>Media unavailable</span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          ) : inferMediaType(mediaUrl, mediaType) === 'video' ? (\r\n            <div className=\"bg-black relative\">\r\n              <div className={`${masonry ? '' : 'relative w-full aspect-square'} bg-black`}>\r\n                {!mediaError ? (\r\n                  <div className=\"relative w-full h-full\">\r\n                    <video\r\n                      src={mediaUrl}\r\n                      autoPlay\r\n                      muted={isMuted}\r\n                      loop\r\n                      playsInline\r\n                      preload=\"metadata\"\r\n                      className={`${masonry ? 'w-full h-auto' : 'absolute inset-0 w-full h-full object-cover'}`}\r\n                      onCanPlay={() => setMediaLoaded(true)}\r\n                      onError={() => setMediaError(true)}\r\n                      onClick={handlePostClick}\r\n                    />\r\n\r\n                    {/* Mute/Unmute button - only control allowed */}\r\n                    <button\r\n                      onClick={handleMuteToggle}\r\n                      className=\"absolute top-3 right-3 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-all z-10\"\r\n                      title={isMuted ? 'Unmute' : 'Mute'}\r\n                    >\r\n                      {isMuted ? (\r\n                        <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                          <path d=\"M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z\" />\r\n                        </svg>\r\n                      ) : (\r\n                        <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                          <path d=\"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z\" />\r\n                        </svg>\r\n                      )}\r\n                    </button>\r\n\r\n                    {/* Click to view modal hint */}\r\n                    <div className=\"absolute top-3 left-3 bg-black/70 text-white text-xs px-2 py-1 rounded\">\r\n                      Tap to view\r\n                    </div>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"absolute inset-0 flex items-center justify-center text-gray-400 bg-white\">\r\n                    <span>Video unavailable</span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          ) : null}\r\n        </div>\r\n      )}\r\n\r\n      {/* Caption - Instagram Style: Caption comes after media */}\r\n      <div\r\n        className={`px-4 pb-3 ${!isMobile ? 'cursor-pointer' : ''}`}\r\n        onClick={!isMobile ? handlePostClick : undefined}\r\n      >\r\n        {!isEditing ? (\r\n          <>\r\n            <p className={`text-sm text-text leading-relaxed ${!isExpanded && editText && editText.length > 150 ? 'line-clamp-3' : ''}`}>\r\n              <span className=\"font-semibold text-text mr-1\">{authorName}</span>\r\n              {editText}\r\n            </p>\r\n            {editText && editText.length > 150 && (\r\n              <button\r\n                onClick={(e) => {\r\n                  e.stopPropagation();\r\n                  setIsExpanded(!isExpanded);\r\n                }}\r\n                className=\"text-text-secondary text-xs font-medium mt-1 hover:text-text transition-colors\"\r\n              >\r\n                {isExpanded ? 'Show less' : 'more'}\r\n              </button>\r\n            )}\r\n          </>\r\n        ) : (\r\n          <div className=\"space-y-3\" onClick={(e) => e.stopPropagation()}>\r\n            <textarea\r\n              className=\"textarea text-sm\"\r\n              rows={3}\r\n              maxLength={2200}\r\n              value={editText}\r\n              onChange={(e) => setEditText(e.target.value)}\r\n            />\r\n            <div className=\"flex items-center gap-2\">\r\n              <button\r\n                onClick={handleEditSave}\r\n                disabled={isSaving || !editText.trim()}\r\n                className=\"btn-primary btn-sm\"\r\n              >\r\n                {isSaving ? 'Saving...' : 'Save'}\r\n              </button>\r\n              <button\r\n                onClick={() => { setIsEditing(false); setEditText(content); }}\r\n                className=\"btn-secondary btn-sm\"\r\n              >\r\n                Cancel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Actions */}\r\n      <div className=\"flex items-center justify-between px-4 py-3 border-t border-border-light\">\r\n        <div className=\"flex items-center gap-4\">\r\n          {/* Aura/Like Button */}\r\n          <button\r\n            id={`aura-btn-${id}`}\r\n            onClick={handleAuraClick}\r\n            data-aura-button\r\n            className=\"flex items-center space-x-2 group hover:opacity-75 active:opacity-60 cursor-pointer\"\r\n            style={{ transition: 'transform 0.2s ease-out' }}\r\n          >\r\n            <svg\r\n              width={20}\r\n              height={20}\r\n              viewBox=\"0 0 100 100\"\r\n              style={{\r\n                fill: hasAura ? '#FFAF50' : 'transparent',\r\n                stroke: hasAura ? '#FFAF50' : '#000000',\r\n                strokeWidth: '2',\r\n              }}\r\n            >\r\n              <polygon\r\n                points=\"77.333,33.31 55.438,33.31 75.43,1.829 47.808,1.829 23.198,51.05 41.882,51.05 21.334,99.808\"\r\n              />\r\n            </svg>\r\n            {auraCount > 0 && (\r\n              <span className={`text-sm font-medium ${hasAura ? 'text-accent' : 'text-text'\r\n                }`}>\r\n                {auraCount}\r\n              </span>\r\n            )}\r\n          </button>\r\n\r\n          {/* Comment Button */}\r\n          <button\r\n            onClick={handleCommentClick}\r\n            className=\"flex items-center space-x-2 group transition-all duration-200 hover:scale-105\"\r\n          >\r\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"group-hover:scale-110 transition-transform\">\r\n              <path d=\"M8.5 12H8.51M12 12H12.01M15.5 12H15.51M21 12C21 16.418 16.97 20 12 20C10.89 20 9.84 19.79 8.88 19.42L3 21L4.58 15.12C4.21 14.16 4 13.11 4 12C4 7.582 8.03 4 12 4C16.97 4 21 7.582 21 12Z\"\r\n                stroke=\"currentColor\"\r\n                strokeWidth=\"1.5\"\r\n                strokeLinecap=\"round\"\r\n                strokeLinejoin=\"round\"\r\n                className=\"text-black\"\r\n              />\r\n            </svg>\r\n            {commentCount > 0 && (\r\n              <span className=\"text-sm font-medium text-text\">{commentCount}</span>\r\n            )}\r\n          </button>\r\n\r\n          {/* Share Button */}\r\n          <button\r\n            onClick={handleShareClick}\r\n            className=\"group transition-all duration-200 hover:scale-105\"\r\n          >\r\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"group-hover:scale-110 transition-transform\">\r\n              <path d=\"M7 13L10.5 9.5L13.5 12.5L17 9M21 12C21 16.418 16.97 20 12 20C7.03 20 3 16.418 3 12C3 7.582 7.03 4 12 4C16.97 4 21 7.582 21 12Z\"\r\n                stroke=\"currentColor\"\r\n                strokeWidth=\"1.5\"\r\n                strokeLinecap=\"round\"\r\n                strokeLinejoin=\"round\"\r\n                className=\"text-black\"\r\n              />\r\n            </svg>\r\n          </button>\r\n        </div>\r\n\r\n        {/* Bookmark Button */}\r\n        <button className=\"group transition-all duration-200 hover:scale-105\">\r\n          <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" className=\"group-hover:scale-110 transition-transform\">\r\n            <path d=\"M5 7.8C5 6.11984 5 5.27976 5.32698 4.63803C5.6146 4.07354 6.07354 3.6146 6.63803 3.32698C7.27976 3 8.11984 3 9.8 3H14.2C15.8802 3 16.7202 3 17.362 3.32698C17.9265 3.6146 18.3854 4.07354 18.673 4.63803C19 5.27976 19 6.11984 19 7.8V21L12 17L5 21V7.8Z\"\r\n              stroke=\"currentColor\"\r\n              strokeWidth=\"1.5\"\r\n              strokeLinecap=\"round\"\r\n              strokeLinejoin=\"round\"\r\n              className=\"text-black\"\r\n            />\r\n          </svg>\r\n        </button>\r\n      </div>\r\n\r\n      {/* Share Modal */}\r\n      {showShareModal && (\r\n        <div className=\"modal-overlay\">\r\n          <div className=\"modal-container max-w-md\">\r\n            <div className=\"modal-header\">\r\n              <h3 className=\"text-lg font-semibold\">Share Post</h3>\r\n            </div>\r\n            <div className=\"modal-body space-y-2\">\r\n              <button\r\n                onClick={() => {\r\n                  const url = `${window.location.origin}/post/${id}`;\r\n                  window.open(`https://wa.me/?text=${encodeURIComponent(url)}`, '_blank');\r\n                }}\r\n                className=\"w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 rounded-lg transition-colors text-left\"\r\n              >\r\n                <span>Share to WhatsApp</span>\r\n              </button>\r\n              <button\r\n                onClick={copyToClipboard}\r\n                className=\"w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 rounded-lg transition-colors text-left\"\r\n              >\r\n                <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                  <path d=\"M8 2V5L12 9L16 5V2H8Z\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                  <path d=\"M16 4H20V20H4V4H8\" stroke=\"currentColor\" strokeWidth=\"1.5\" />\r\n                </svg>\r\n                <span>Copy Link</span>\r\n              </button>\r\n              <div className=\"text-xs text-text-secondary px-4 py-2\">Tip: You can also use your device share menu.</div>\r\n            </div>\r\n            <div className=\"modal-footer\">\r\n              <button\r\n                onClick={() => setShowShareModal(false)}\r\n                className=\"btn-secondary flex-1\"\r\n              >\r\n                Cancel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n});\r\n\r\nPostCard.displayName = 'PostCard';\r\n\r\nexport default PostCard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\PostModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'videoDuration' is assigned a value but never used.","line":73,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":73,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":110,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3724,3727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3724,3727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":364,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":364,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12196,12199],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12196,12199],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":373,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":373,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12526,12529],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12526,12529],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":374,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":374,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12569,12572],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12569,12572],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":379,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":379,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":408,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":408,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13725,13728],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13725,13728],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'mediaUrl' is defined but never used.","line":493,"column":48,"nodeType":null,"messageId":"unusedVar","endLine":493,"endColumn":56},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getAspectRatio' is assigned a value but never used.","line":505,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":505,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":737,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":737,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28469,28472],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28469,28472],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":740,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":740,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":954,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":954,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39886,39889],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39886,39889],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":955,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":955,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39949,39952],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39949,39952],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1157,"column":99,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[50859,50896],"text":"Click an emoji to add it: (Current: &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[50859,50896],"text":"Click an emoji to add it: (Current: &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[50859,50896],"text":"Click an emoji to add it: (Current: &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[50859,50896],"text":"Click an emoji to add it: (Current: &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1157,"column":112,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[50908,50910],"text":"&quot;)"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[50908,50910],"text":"&ldquo;)"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[50908,50910],"text":"&#34;)"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[50908,50910],"text":"&rdquo;)"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadComments'. Either include it or remove the dependency array.","line":163,"column":6,"nodeType":"ArrayExpression","endLine":163,"endColumn":30,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, loadComments, post.id, token]","fix":{"range":[5533,5557],"text":"[isOpen, loadComments, post.id, token]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":10,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { useIsMobile } from '../hooks/useIsMobile';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport { useToast } from '../contexts/ToastContext';\r\nimport Image from 'next/image'\r\n\r\ninterface PostModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  post: {\r\n    id: number;\r\n    authorName: string;\r\n    authorDept: string;\r\n    authorYear: number;\r\n    content: string;\r\n    category?: string;\r\n    auraCount: number;\r\n    commentCount: number;\r\n    timestamp: string;\r\n    profilePic?: string;\r\n    mediaUrl?: string;\r\n    mediaType?: 'image' | 'video';\r\n    location?: string;\r\n    userLiked?: boolean;\r\n    mediaCarousel?: Array<{\r\n      url: string;\r\n      type: 'image' | 'video';\r\n    }>;\r\n  };\r\n  canManage?: boolean;\r\n}\r\n\r\ninterface Comment {\r\n  id: number;\r\n  user: {\r\n    id?: number;\r\n    name: string;\r\n    department?: string;\r\n    year?: number;\r\n    profile_image?: string | null;\r\n  };\r\n  text: string;\r\n  timestamp: string;\r\n  likes: number;\r\n  userLiked: boolean;\r\n}\r\n\r\nconst PostModal: React.FC<PostModalProps> = ({ isOpen, onClose, post, canManage }) => {\r\n  const { user, token } = useAuth();\r\n  const { showToast } = useToast();\r\n  const isMobile = useIsMobile();\r\n  const [auraCount, setAuraCount] = useState(post.auraCount);\r\n  const [hasAura, setHasAura] = useState(post.userLiked || false);\r\n  const [isLiking, setIsLiking] = useState(false);\r\n  const [comments, setComments] = useState<Comment[]>([]);\r\n  const [newComment, setNewComment] = useState('');\r\n  const [isPosting, setIsPosting] = useState(false);\r\n  const [currentMediaIndex, setCurrentMediaIndex] = useState(0);\r\n  const [showEmojiPicker, setShowEmojiPicker] = useState(false);\r\n  const [replyingTo, setReplyingTo] = useState<number | null>(null);\r\n  const [isEditingCaption, setIsEditingCaption] = useState(false);\r\n  const [editCaption, setEditCaption] = useState(post.content);\r\n  const [isSavingCaption, setIsSavingCaption] = useState(false);\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const [showOptions, setShowOptions] = useState(false);\r\n  const commentInputRef = useRef<HTMLInputElement>(null);\r\n  const [showFullCaption, setShowFullCaption] = useState(false);\r\n\r\n  // Video progress and playback state for Instagram-like experience\r\n  const [videoProgress, setVideoProgress] = useState(0);\r\n  const [isVideoPlaying, setIsVideoPlaying] = useState(true);\r\n  const [videoDuration, setVideoDuration] = useState(0);\r\n\r\n  // Comments pagination state\r\n  const [isLoadingComments, setIsLoadingComments] = useState(false);\r\n  const [commentsOffset, setCommentsOffset] = useState(0);\r\n  const [hasMoreComments, setHasMoreComments] = useState(true);\r\n  const COMMENTS_PAGE_SIZE = 20;\r\n\r\n  // Helper function to convert enum category to readable format\r\n  const formatCategory = (category?: string) => {\r\n    if (!category) return '';\r\n\r\n    const categoryMap: { [key: string]: string } = {\r\n      'GENERAL': 'general',\r\n      'ACADEMIC': 'academic',\r\n      'EVENT': 'events',    // Singular form\r\n      'EVENTS': 'events',   // Plural form\r\n      'CLUBS': 'clubs',\r\n      'SPORTS': 'sports',\r\n      'SOCIAL': 'social',\r\n      // Legacy values\r\n      'INTERNSHIP': 'internship',\r\n      'WORKSHOP': 'academic',\r\n      'LIBRARY_MEMORY': 'library'\r\n    };\r\n\r\n    return categoryMap[category] || category.toLowerCase();\r\n  };\r\n\r\n  // Sync aura status when post data changes\r\n  useEffect(() => {\r\n    setAuraCount(post.auraCount);\r\n    setHasAura(post.userLiked || false);\r\n  }, [post.auraCount, post.userLiked]);\r\n\r\n  // Listen for aura updates from PostCard\r\n  useEffect(() => {\r\n    const handleAuraUpdated = (event: any) => {\r\n      if (event.detail.postId === post.id) {\r\n        setAuraCount(event.detail.auraCount);\r\n        setHasAura(event.detail.hasAura);\r\n      }\r\n    };\r\n\r\n    window.addEventListener('auraUpdated', handleAuraUpdated);\r\n    return () => window.removeEventListener('auraUpdated', handleAuraUpdated);\r\n  }, [post.id]);\r\n\r\n  // Get media items (either single media or carousel)\r\n  const inferType = (url?: string, declared?: 'image' | 'video'): 'image' | 'video' | undefined => {\r\n    if (!url) return undefined;\r\n    if (declared === 'image' || declared === 'video') return declared;\r\n    const lower = url.toLowerCase();\r\n    if (lower.includes('/video/') || /(\\.mp4|\\.webm|\\.mov|\\.avi|\\.wmv)$/i.test(lower)) {\r\n      return 'video';\r\n    }\r\n    return 'image';\r\n  };\r\n\r\n  // Get media items (either single media or carousel)\r\n  const mediaItems = post.mediaCarousel || (post.mediaUrl ? [{\r\n    url: post.mediaUrl,\r\n    type: inferType(post.mediaUrl, post.mediaType) || 'image'\r\n  }] : []);\r\n\r\n  const hasMultipleMedia = mediaItems.length > 1;\r\n\r\n  // Auto-play video when modal opens (Instagram-like behavior)\r\n  useEffect(() => {\r\n    if (isOpen && videoRef.current) {\r\n      // Small delay to ensure video is loaded\r\n      const timer = setTimeout(() => {\r\n        if (videoRef.current) {\r\n          videoRef.current.play().catch(e => console.log('Auto-play failed:', e));\r\n        }\r\n      }, 100);\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [isOpen, currentMediaIndex]);\r\n\r\n  // Load comments from API\r\n  useEffect(() => {\r\n    if (isOpen && post.id) {\r\n      // Reset pagination when opening\r\n      setComments([]);\r\n      setCommentsOffset(0);\r\n      setHasMoreComments(true);\r\n      loadComments(0, false);\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [isOpen, post.id, token]);\r\n\r\n  // Video progress tracking for Instagram-like progress chunks\r\n  useEffect(() => {\r\n    const video = videoRef.current;\r\n    if (!video) return;\r\n\r\n    const updateProgress = () => {\r\n      if (video.duration) {\r\n        const progress = (video.currentTime / video.duration) * 100;\r\n        setVideoProgress(progress);\r\n      }\r\n    };\r\n\r\n    const handleLoadedMetadata = () => {\r\n      setVideoDuration(video.duration);\r\n    };\r\n\r\n    const handlePlay = () => setIsVideoPlaying(true);\r\n    const handlePause = () => setIsVideoPlaying(false);\r\n\r\n    video.addEventListener('timeupdate', updateProgress);\r\n    video.addEventListener('loadedmetadata', handleLoadedMetadata);\r\n    video.addEventListener('play', handlePlay);\r\n    video.addEventListener('pause', handlePause);\r\n\r\n    return () => {\r\n      video.removeEventListener('timeupdate', updateProgress);\r\n      video.removeEventListener('loadedmetadata', handleLoadedMetadata);\r\n      video.removeEventListener('play', handlePlay);\r\n      video.removeEventListener('pause', handlePause);\r\n    };\r\n  }, [currentMediaIndex]);\r\n\r\n  // Handle video tap to pause/play (Instagram-like)\r\n  const handleVideoTap = () => {\r\n    if (videoRef.current) {\r\n      if (isVideoPlaying) {\r\n        videoRef.current.pause();\r\n      } else {\r\n        videoRef.current.play().catch(e => console.log('Play failed:', e));\r\n      }\r\n    }\r\n  };\r\n\r\n  // Reset video progress when changing media\r\n  useEffect(() => {\r\n    setVideoProgress(0);\r\n    setIsVideoPlaying(true);\r\n  }, [currentMediaIndex]);\r\n\r\n  const loadComments = async (offset: number, append: boolean) => {\r\n    if (isLoadingComments) return;\r\n    setIsLoadingComments(true);\r\n    try {\r\n      const headers: HeadersInit = {};\r\n      if (token) headers['Authorization'] = `Bearer ${token}`;\r\n\r\n      const response = await fetch(`/api/comments?postId=${post.id}&limit=${COMMENTS_PAGE_SIZE}&offset=${offset}`, {\r\n        headers\r\n      });\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        const fetched: Comment[] = data.comments || [];\r\n        setHasMoreComments(fetched.length === COMMENTS_PAGE_SIZE);\r\n        if (append) {\r\n          setComments(prev => [...prev, ...fetched]);\r\n        } else {\r\n          setComments(fetched);\r\n        }\r\n        setCommentsOffset(offset);\r\n      } else {\r\n        const text = await response.text().catch(() => '');\r\n        console.error('Failed to load comments:', response.status, text);\r\n        // Fallback to empty array if API fails\r\n        if (!append) setComments([]);\r\n        setHasMoreComments(false);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading comments:', error);\r\n      if (!append) setComments([]);\r\n      setHasMoreComments(false);\r\n    } finally {\r\n      setIsLoadingComments(false);\r\n    }\r\n  };\r\n\r\n  const handleAuraClick = async () => {\r\n    // Prevent multiple clicks while processing\r\n    if (!token || isLiking) return;\r\n\r\n    // Store the previous state for potential rollback\r\n    const previousHasAura = hasAura;\r\n    const previousAuraCount = auraCount;\r\n\r\n    // Optimistic update - instant UI feedback\r\n    const newHasAura = !hasAura;\r\n    const newAuraCount = hasAura ? auraCount - 1 : auraCount + 1;\r\n\r\n    setHasAura(newHasAura);\r\n    setAuraCount(newAuraCount);\r\n    setIsLiking(true);\r\n\r\n    // Add visual feedback immediately\r\n    const button = document.querySelector('[data-aura-button]') as HTMLElement;\r\n    if (button) {\r\n      button.style.transform = 'scale(1.15)';\r\n      setTimeout(() => {\r\n        if (button.style.transform === 'scale(1.15)') {\r\n          button.style.transform = 'scale(1)';\r\n        }\r\n      }, 100);\r\n    }\r\n\r\n    try {\r\n      const response = await fetch('/api/posts/aura', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`,\r\n        },\r\n        body: JSON.stringify({ postId: post.id }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        // Sync with server response (in case there's a discrepancy)\r\n        setAuraCount(data.post.aura_count);\r\n        setHasAura(data.post.user_liked);\r\n\r\n        // Broadcast aura change to PostCard component\r\n        window.dispatchEvent(new CustomEvent('auraUpdated', {\r\n          detail: {\r\n            postId: post.id,\r\n            auraCount: data.post.aura_count,\r\n            hasAura: data.post.user_liked\r\n          }\r\n        }));\r\n      } else {\r\n        console.error('Failed to update aura');\r\n        // Revert optimistic update if API fails\r\n        setHasAura(previousHasAura);\r\n        setAuraCount(previousAuraCount);\r\n        showToast('Failed to update aura. Please try again.', 'error', 2000);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error updating aura:', error);\r\n      // Revert optimistic update if API fails\r\n      setHasAura(previousHasAura);\r\n      setAuraCount(previousAuraCount);\r\n      showToast('Network error. Please check your connection.', 'error', 2000);\r\n    } finally {\r\n      setIsLiking(false);\r\n    }\r\n  };\r\n\r\n  const handleCaptionSave = async () => {\r\n    if (!token) return;\r\n    const trimmed = editCaption.trim();\r\n\r\n    // Validate caption is not empty\r\n    if (!trimmed) {\r\n      alert('Caption cannot be empty');\r\n      return;\r\n    }\r\n\r\n    setIsSavingCaption(true);\r\n    try {\r\n      const response = await fetch(`/api/posts/${post.id}`, {\r\n        method: 'PUT',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`,\r\n        },\r\n        body: JSON.stringify({ caption: trimmed })\r\n      });\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        const newContent = data.post?.caption ?? trimmed;\r\n        // Update the post content in the modal\r\n        post.content = newContent;\r\n        setEditCaption(newContent);\r\n        setIsEditingCaption(false);\r\n        // Dispatch event to update other components\r\n        window.dispatchEvent(new CustomEvent('postUpdated', { detail: { id: post.id, content: newContent } }));\r\n      } else {\r\n        const err = await response.json().catch(() => ({}));\r\n        alert(err.error || 'Failed to update caption');\r\n      }\r\n    } catch (error) {\r\n      console.error('Update caption failed', error);\r\n      alert('Failed to update caption');\r\n    } finally {\r\n      setIsSavingCaption(false);\r\n    }\r\n  };\r\n\r\n  const handleCommentButtonClick = useCallback(() => {\r\n    try {\r\n      commentInputRef.current?.focus();\r\n      commentInputRef.current?.scrollIntoView({ behavior: 'smooth', block: 'center' } as any);\r\n    } catch { }\r\n  }, []);\r\n\r\n  const handleShareClick = useCallback(async () => {\r\n    try {\r\n      const url = typeof window !== 'undefined' ? window.location.origin : '';\r\n      const shareUrl = `${url}/post/${post.id}`;\r\n      const shareText = post.content?.slice(0, 120) || 'Check this out';\r\n      if ((navigator as any).share) {\r\n        await (navigator as any).share({ title: `${post.authorName || 'User'} on UNIX`, text: shareText, url: shareUrl });\r\n      } else {\r\n        await navigator.clipboard.writeText(shareUrl);\r\n        alert('Link copied to clipboard');\r\n      }\r\n    } catch (e) {\r\n      try {\r\n        const shareUrl = `${window.location.origin}/post/${post.id}`;\r\n        await navigator.clipboard.writeText(shareUrl);\r\n        alert('Link copied to clipboard');\r\n      } catch { }\r\n    }\r\n  }, [post.id, post.content, post.authorName]);\r\n\r\n  const handleCommentSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!newComment.trim() || isPosting || !user || !token) return;\r\n\r\n    const commentText = newComment.trim();\r\n    const tempId = Date.now(); // Temporary ID for optimistic update\r\n\r\n    // Optimistic update - add comment immediately\r\n    const optimisticComment = {\r\n      id: tempId,\r\n      text: commentText,\r\n      timestamp: 'Just now',\r\n      likes: 0,\r\n      userLiked: false,\r\n      user: {\r\n        id: user.id,\r\n        name: user.name,\r\n        avatar: null, // No avatar in User interface yet\r\n      },\r\n      parent_id: replyingTo || null,\r\n    } as any;\r\n\r\n    setComments(prev => [optimisticComment, ...prev]);\r\n    setNewComment('');\r\n    setReplyingTo(null);\r\n    setIsPosting(true);\r\n\r\n    try {\r\n      const response = await fetch('/api/comments', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`,\r\n        },\r\n        body: JSON.stringify({\r\n          postId: post.id,\r\n          comment_text: commentText,\r\n          parent_id: replyingTo || undefined\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        // Replace optimistic comment with real one\r\n        setComments(prev => prev.map(c =>\r\n          c.id === tempId ? data.comment : c\r\n        ));\r\n      } else {\r\n        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\r\n        console.error('Error creating comment:', errorData.error);\r\n        // Remove optimistic comment and restore input\r\n        setComments(prev => prev.filter(c => c.id !== tempId));\r\n        setNewComment(commentText);\r\n        showToast(errorData.error || 'Failed to post comment', 'error');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error submitting comment:', error);\r\n      // Remove optimistic comment and restore input\r\n      setComments(prev => prev.filter(c => c.id !== tempId));\r\n      setNewComment(commentText);\r\n      showToast('Failed to post comment. Please try again.', 'error');\r\n    } finally {\r\n      setIsPosting(false);\r\n    }\r\n  };\r\n\r\n  // Handle emoji selection\r\n  const handleEmojiSelect = (emoji: string) => {\r\n    console.log('Emoji selected:', emoji); // Debug log\r\n    const currentValue = newComment;\r\n    const newValue = currentValue + emoji;\r\n    console.log('Current value:', currentValue);\r\n    console.log('New value:', newValue);\r\n    setNewComment(newValue);\r\n    setShowEmojiPicker(false);\r\n  };\r\n\r\n  // Close emoji picker when clicking outside\r\n  useEffect(() => {\r\n    const handleClickOutside = (event: MouseEvent) => {\r\n      if (showEmojiPicker) {\r\n        const target = event.target as Element;\r\n        // Check if click is inside emoji picker or emoji button\r\n        const emojiButton = target.closest('.emoji-picker-container');\r\n        const emojiPicker = target.closest('.emoji-picker-dropdown');\r\n\r\n        if (!emojiButton && !emojiPicker) {\r\n          console.log('Clicking outside emoji picker, closing...');\r\n          setShowEmojiPicker(false);\r\n        }\r\n      }\r\n    };\r\n\r\n    if (showEmojiPicker) {\r\n      document.addEventListener('mousedown', handleClickOutside);\r\n    }\r\n\r\n    return () => {\r\n      document.removeEventListener('mousedown', handleClickOutside);\r\n    };\r\n  }, [showEmojiPicker]);\r\n\r\n  if (!isOpen) return null;\r\n\r\n  // Determine aspect ratio for media display based on Instagram specs\r\n  const getMediaClasses = (mediaType?: string, mediaUrl?: string): string => {\r\n    // For videos, check if it's Reels format (9:16) or feed format\r\n    if (mediaType === 'video') {\r\n      return 'w-full h-full object-contain'; // Let video maintain its natural ratio\r\n    }\r\n\r\n    // For images, default to Instagram's supported ratios\r\n    // 1:1 (square), 4:5 (portrait), 1.91:1 (landscape)\r\n    return 'w-full h-full object-contain';\r\n  };\r\n\r\n  // Helper function to get aspect ratio classes\r\n  const getAspectRatio = (mediaType?: string) => {\r\n    if (mediaType === 'image') {\r\n      // Example: return square aspect ratio for images\r\n      return 'aspect-square';\r\n    }\r\n    if (mediaType === 'video') {\r\n      // Example: return portrait aspect ratio for videos\r\n      return 'aspect-video';\r\n    }\r\n    return '';\r\n  };\r\n\r\n  // Parse caption for hashtags and mentions\r\n  const parseCaption = (text: string) => {\r\n    return text.replace(\r\n      /(#[\\w]+)|(@[\\w]+)/g,\r\n      (match) => {\r\n        if (match.startsWith('#')) {\r\n          return `<span class=\"text-blue-600 hover:underline cursor-pointer\">${match}</span>`;\r\n        } else {\r\n          return `<span class=\"text-blue-600 hover:underline cursor-pointer font-semibold\">${match}</span>`;\r\n        }\r\n      }\r\n    );\r\n  };\r\n\r\n  // Truncate caption if longer than 125 characters\r\n  const contentText = typeof post?.content === 'string' ? post.content : '';\r\n  const shouldTruncate = contentText.length > 125;\r\n  const displayContent = shouldTruncate && !showFullCaption\r\n    ? contentText.substring(0, 125) + '...'\r\n    : contentText;\r\n\r\n  // Common emojis for picker\r\n  const commonEmojis = [\r\n    '≡ƒÿÇ', '≡ƒÿâ', '≡ƒÿä', '≡ƒÿü', '≡ƒÿå', '≡ƒÿà', '≡ƒÿé', '≡ƒñú', '≡ƒÿè', '≡ƒÿç',\r\n    '≡ƒÖé', '≡ƒÖâ', '≡ƒÿë', '≡ƒÿî', '≡ƒÿì', '≡ƒÑ░', '≡ƒÿÿ', '≡ƒÿù', '≡ƒÿÖ', '≡ƒÿÜ',\r\n    '≡ƒÿï', '≡ƒÿ¢', '≡ƒÿ¥', '≡ƒÿ£', '≡ƒñ¬', '≡ƒñ¿', '≡ƒºÉ', '≡ƒñô', '≡ƒÿÄ', '≡ƒñ⌐',\r\n    '≡ƒÑ│', '≡ƒÿÅ', '≡ƒÿÆ', '≡ƒÿ₧', '≡ƒÿö', '≡ƒÿƒ', '≡ƒÿò', '≡ƒÖü', 'Γÿ╣∩╕Å', '≡ƒÿú',\r\n    '≡ƒÿû', '≡ƒÿ½', '≡ƒÿ⌐', '≡ƒÑ║', '≡ƒÿó', '≡ƒÿ¡', '≡ƒÿñ', '≡ƒÿá', '≡ƒÿí', '≡ƒñ¼',\r\n    '≡ƒñ»', '≡ƒÿ│', '≡ƒÑ╡', '≡ƒÑ╢', '≡ƒÿ▒', '≡ƒÿ¿', '≡ƒÿ░', '≡ƒÿÑ', '≡ƒÿô', '≡ƒñù',\r\n    '≡ƒñö', '≡ƒñ¡', '≡ƒñ½', '≡ƒñÑ', '≡ƒÿ╢', '≡ƒÿÉ', '≡ƒÿæ', '≡ƒÿ¼', '≡ƒÖä', '≡ƒÿ»',\r\n    '≡ƒÿª', '≡ƒÿº', '≡ƒÿ«', '≡ƒÿ▓', '≡ƒÑ▒', '≡ƒÿ┤', '≡ƒññ', '≡ƒÿ¬', '≡ƒÿ╡', '≡ƒñÉ',\r\n    '≡ƒÑ┤', '≡ƒñó', '≡ƒñ«', '≡ƒñº', '≡ƒÿ╖', '≡ƒñÆ', '≡ƒñò', '≡ƒñæ', '≡ƒñá', '≡ƒÿê',\r\n    '≡ƒæ┐', '≡ƒæ╣', '≡ƒæ║', '≡ƒñí', '≡ƒÆ⌐', '≡ƒæ╗', '≡ƒÆÇ', 'Γÿá∩╕Å', '≡ƒæ╜', '≡ƒæ╛',\r\n    '≡ƒñû', '≡ƒÄâ', '≡ƒÿ║', '≡ƒÿ╕', '≡ƒÿ╣', '≡ƒÿ╗', '≡ƒÿ╝', '≡ƒÿ╜', '≡ƒÖÇ', '≡ƒÿ┐',\r\n    '≡ƒÿ╛', 'Γ¥ñ∩╕Å', '≡ƒºí', '≡ƒÆ¢', '≡ƒÆÜ', '≡ƒÆÖ', '≡ƒÆ£', '≡ƒñÄ', '≡ƒûñ', '≡ƒñì',\r\n    '≡ƒÆ»', '≡ƒÆ½', 'Γ¡É', '≡ƒîƒ', 'Γ£¿', 'ΓÜí', '≡ƒöÑ', '≡ƒÆÑ', '≡ƒÆó', '≡ƒÆ¿',\r\n    '≡ƒæÅ', '≡ƒÖî', '≡ƒæÉ', '≡ƒñ▓', '≡ƒñ¥', '≡ƒæì', '≡ƒæÄ', '≡ƒæè', 'Γ£è', '≡ƒñ¢',\r\n    '≡ƒñ£', '≡ƒñ₧', 'Γ£î∩╕Å', '≡ƒñƒ', '≡ƒñÿ', '≡ƒæî', '≡ƒñÅ', '≡ƒæê', '≡ƒæë', '≡ƒæå',\r\n    '≡ƒûò', '≡ƒæç', 'Γÿ¥∩╕Å', '≡ƒæï', '≡ƒñÜ', '≡ƒûÉ∩╕Å', 'Γ£ï', '≡ƒûû', '≡ƒÆ¬', '≡ƒª╛'\r\n  ];\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/75 backdrop-blur-sm flex items-center justify-center z-modal p-4\">\r\n      <div className=\"bg-white rounded-2xl max-w-6xl w-full h-[90vh] flex overflow-hidden shadow-2xl\">\r\n        {/* Left Side - Media */}\r\n        <div className=\"flex-1 bg-black flex items-center justify-center relative\">\r\n          {mediaItems.length > 0 ? (\r\n            <div className=\"w-full h-full flex items-center justify-center relative\">\r\n              {/* Current Media */}\r\n              {mediaItems[currentMediaIndex].type === 'image' ? (\r\n                <Image\r\n                  src={mediaItems[currentMediaIndex].url}\r\n                  alt=\"Post media\"\r\n                  className={getMediaClasses(mediaItems[currentMediaIndex].type, mediaItems[currentMediaIndex].url)}\r\n                  onError={(e) => ((e.target as HTMLImageElement).style.display = 'none')}\r\n                />\r\n              ) : (\r\n                <div className=\"relative w-full h-full\">\r\n                  {/* Instagram-style progress chunks at the top */}\r\n                  <div className=\"absolute top-2 left-2 right-2 z-10 flex space-x-1\">\r\n                    {mediaItems.length > 1 ? (\r\n                      // Multiple chunks for carousel\r\n                      mediaItems.map((_, index) => (\r\n                        <div\r\n                          key={index}\r\n                          className=\"flex-1 h-0.5 bg-white/30 rounded-full overflow-hidden\"\r\n                        >\r\n                          <div\r\n                            className=\"h-full bg-white transition-all duration-100 ease-linear\"\r\n                            style={{\r\n                              width: index === currentMediaIndex ? `${videoProgress}%` :\r\n                                index < currentMediaIndex ? '100%' : '0%'\r\n                            }}\r\n                          />\r\n                        </div>\r\n                      ))\r\n                    ) : (\r\n                      // Single progress bar for single video\r\n                      <div className=\"flex-1 h-0.5 bg-white/30 rounded-full overflow-hidden\">\r\n                        <div\r\n                          className=\"h-full bg-white transition-all duration-100 ease-linear\"\r\n                          style={{ width: `${videoProgress}%` }}\r\n                        />\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  {/* Video element with tap-to-pause */}\r\n                  <video\r\n                    ref={videoRef}\r\n                    src={mediaItems[currentMediaIndex].url}\r\n                    autoPlay\r\n                    muted={false}\r\n                    loop\r\n                    playsInline\r\n                    className={`${getMediaClasses(mediaItems[currentMediaIndex].type, mediaItems[currentMediaIndex].url)} cursor-pointer`}\r\n                    onError={(e) => ((e.target as HTMLVideoElement).style.display = 'none')}\r\n                    onLoadStart={() => console.log('Video loading started')}\r\n                    onClick={handleVideoTap}\r\n                    onCanPlay={() => {\r\n                      console.log('Video ready to play');\r\n                      // Ensure video plays on load like Instagram\r\n                      if (videoRef.current) {\r\n                        videoRef.current.play().catch(e => console.log('Auto-play failed:', e));\r\n                      }\r\n                    }}\r\n                  >\r\n                    <source src={mediaItems[currentMediaIndex].url} type=\"video/mp4\" />\r\n                    <track kind=\"captions\" />\r\n                    Your browser does not support the video tag.\r\n                  </video>\r\n\r\n                  {/* Play/Pause indicator (Instagram-like) */}\r\n                  {!isVideoPlaying && (\r\n                    <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\r\n                      <div className=\"bg-black/50 rounded-full p-4\">\r\n                        <svg className=\"w-12 h-12 text-white\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                          <path d=\"M8 5v14l11-7z\" />\r\n                        </svg>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              )}\r\n\r\n              {/* Carousel Navigation */}\r\n              {hasMultipleMedia && (\r\n                <>\r\n                  {/* Previous Button */}\r\n                  {currentMediaIndex > 0 && (\r\n                    <button\r\n                      onClick={() => setCurrentMediaIndex(currentMediaIndex - 1)}\r\n                      className=\"absolute left-4 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition-colors\"\r\n                    >\r\n                      ΓÇ╣\r\n                    </button>\r\n                  )}\r\n\r\n                  {/* Next Button */}\r\n                  {currentMediaIndex < mediaItems.length - 1 && (\r\n                    <button\r\n                      onClick={() => setCurrentMediaIndex(currentMediaIndex + 1)}\r\n                      className=\"absolute right-4 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition-colors\"\r\n                    >\r\n                      ΓÇ║\r\n                    </button>\r\n                  )}\r\n\r\n                  {/* Dots Indicator */}\r\n                  <div className=\"absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-1\">\r\n                    {mediaItems.map((_, index) => (\r\n                      <button\r\n                        key={index}\r\n                        onClick={() => setCurrentMediaIndex(index)}\r\n                        className={`w-2 h-2 rounded-full transition-colors ${index === currentMediaIndex ? 'bg-white' : 'bg-white/50'\r\n                          }`}\r\n                      />\r\n                    ))}\r\n                  </div>\r\n                </>\r\n              )}\r\n            </div>\r\n          ) : (\r\n            <div className=\"text-white text-center p-8 flex flex-col items-center justify-center h-full\">\r\n              <div className=\"text-6xl mb-6\">≡ƒô¥</div>\r\n              <div className=\"max-w-md\">\r\n                <p\r\n                  className=\"text-xl leading-relaxed\"\r\n                  dangerouslySetInnerHTML={{ __html: parseCaption(contentText) }}\r\n                />\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Right Side - Details & Comments */}\r\n        <div className=\"w-96 flex flex-col\">\r\n          {/* Header */}\r\n          <div className=\"flex items-center justify-between p-4 border-b border-gray-100\">\r\n            <div className=\"flex items-center space-x-3\">\r\n              <div className=\"w-10 h-10 bg-gradient-to-br from-[#FFAF50] to-orange-400 rounded-full overflow-hidden\">\r\n                <Image\r\n                  src={post.profilePic || '/uploads/DefaultProfile.jpg'}\r\n                  alt={post.authorName || 'User'}\r\n                  className=\"w-full h-full object-cover rounded-full\"\r\n                  onError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n                />\r\n              </div>\r\n              <div>\r\n                <p className=\"font-semibold text-sm\">{post.authorName || 'Unknown User'}</p>\r\n                <p className=\"text-xs text-gray-500\">{post.authorDept} ΓÇó {post.authorYear}rd Year</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              {canManage && !isMobile && (\r\n                <div className=\"relative\">\r\n                  <button\r\n                    onClick={() => setShowOptions((v) => !v)}\r\n                    className=\"w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center\"\r\n                    title=\"Options\"\r\n                  >\r\n                    <span className=\"text-xl leading-none\">Γï«</span>\r\n                  </button>\r\n                  {showOptions && (\r\n                    <div className=\"absolute right-0 mt-2 w-40 bg-white border border-gray-100 rounded-xl shadow-lg z-20\">\r\n                      <button\r\n                        onClick={() => { setIsEditingCaption(true); setShowOptions(false); }}\r\n                        className=\"w-full text-left px-4 py-2 text-sm hover:bg-gray-50\"\r\n                      >\r\n                        Edit caption\r\n                      </button>\r\n                      <button\r\n                        onClick={async () => {\r\n                          if (!token) return;\r\n                          try {\r\n                            const resp = await fetch(`/api/posts/${post.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });\r\n                            if (resp.status === 204) {\r\n                              window.dispatchEvent(new CustomEvent('postDeleted', { detail: { id: post.id } }));\r\n                              onClose();\r\n                            } else {\r\n                              const err = await resp.json().catch(() => ({} as any));\r\n                              alert(err.error || 'Failed to delete post');\r\n                            }\r\n                          } catch (e) {\r\n                            alert('Failed to delete post');\r\n                          } finally {\r\n                            setShowOptions(false);\r\n                          }\r\n                        }}\r\n                        className=\"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50\"\r\n                      >\r\n                        Delete post\r\n                      </button>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              )}\r\n              <button\r\n                onClick={onClose}\r\n                className=\"text-gray-400 hover:text-gray-600 text-2xl\"\r\n              >\r\n                ├ù\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Content */}\r\n          {mediaItems.length > 0 && (\r\n            <div className=\"p-4 border-b border-gray-100\">\r\n              <div className=\"flex items-start space-x-3 mb-2\">\r\n                <div className=\"w-8 h-8 bg-gradient-to-br from-[#FFAF50] to-orange-400 rounded-full flex items-center justify-center text-white font-bold text-xs flex-shrink-0\">\r\n                  {post.authorName?.charAt(0) || 'U'}\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                  <div className=\"flex items-start\">\r\n                    <span className=\"font-semibold text-sm mr-2\">{post.authorName || 'Unknown User'}</span>\r\n                    <div className=\"flex-1\">\r\n                      {!isEditingCaption ? (\r\n                        <>\r\n                          <span\r\n                            className=\"text-sm text-gray-900 leading-relaxed\"\r\n                            dangerouslySetInnerHTML={{ __html: parseCaption(displayContent) }}\r\n                          />\r\n                          {shouldTruncate && (\r\n                            <button\r\n                              onClick={() => setShowFullCaption(!showFullCaption)}\r\n                              className=\"text-gray-500 text-sm ml-1 hover:text-gray-700\"\r\n                            >\r\n                              {showFullCaption ? ' less' : ' more'}\r\n                            </button>\r\n                          )}\r\n                          {canManage && !isMobile && (\r\n                            <button\r\n                              onClick={() => setIsEditingCaption(true)}\r\n                              className=\"text-gray-400 hover:text-gray-600 text-xs ml-2\"\r\n                              title=\"Edit caption\"\r\n                            >\r\n                              Γ£Å∩╕Å\r\n                            </button>\r\n                          )}\r\n                        </>\r\n                      ) : (\r\n                        <div className=\"w-full\">\r\n                          <textarea\r\n                            className=\"w-full border border-gray-200 rounded-lg p-2 text-sm text-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-300\"\r\n                            rows={3}\r\n                            maxLength={2200}\r\n                            value={editCaption}\r\n                            onChange={(e) => setEditCaption(e.target.value)}\r\n                          />\r\n                          <div className=\"flex items-center space-x-2 mt-2\">\r\n                            <button\r\n                              onClick={handleCaptionSave}\r\n                              disabled={isSavingCaption || !editCaption.trim()}\r\n                              className=\"px-3 py-1 rounded-md bg-[#FFAF50] text-white text-sm disabled:opacity-60\"\r\n                            >\r\n                              {isSavingCaption ? 'Saving...' : 'Save'}\r\n                            </button>\r\n                            <button\r\n                              onClick={() => { setIsEditingCaption(false); setEditCaption(post.content); }}\r\n                              className=\"px-3 py-1 rounded-md bg-gray-100 text-gray-700 text-sm\"\r\n                            >\r\n                              Cancel\r\n                            </button>\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                  {/* Location */}\r\n                  {post.location && (\r\n                    <div className=\"mt-1 ml-0\">\r\n                      <span className=\"text-xs text-gray-600\">\r\n                        ≡ƒôì {post.location}\r\n                      </span>\r\n                    </div>\r\n                  )}\r\n                  {/* Category/Hashtag */}\r\n                  {post.category && (\r\n                    <div className=\"mt-2\">\r\n                      <span className=\"text-blue-600 text-sm hover:underline cursor-pointer\">\r\n                        #{formatCategory(post.category)}\r\n                      </span>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              <p className=\"text-xs text-gray-400 ml-11\">{post.timestamp}</p>\r\n            </div>\r\n          )}\r\n\r\n          {/* Comments */}\r\n          <div className=\"flex-1 overflow-y-auto p-4 space-y-4\">\r\n            {isLoadingComments && comments.length === 0 && (\r\n              <div className=\"text-center text-gray-400 text-sm\">Loading comments...</div>\r\n            )}\r\n            {comments.map((comment) => (\r\n              <div key={comment.id} className=\"flex space-x-3\">\r\n                <div className=\"w-8 h-8 rounded-full flex items-center justify-center text-gray-600 font-bold text-xs flex-shrink-0 overflow-hidden bg-gray-200\">\r\n                  {comment.user.profile_image ? (\r\n                    <Image src={comment.user.profile_image} alt={comment.user.name} className=\"w-full h-full object-cover\" />\r\n                  ) : (\r\n                    comment.user.name.charAt(0)\r\n                  )}\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                  <div className=\"flex items-start mb-1\">\r\n                    <span className=\"font-semibold text-sm mr-2\">{comment.user.name}</span>\r\n                    <span\r\n                      className=\"text-sm text-gray-900 leading-relaxed flex-1\"\r\n                      dangerouslySetInnerHTML={{ __html: parseCaption(comment.text) }}\r\n                    />\r\n                  </div>\r\n                  <div className=\"flex items-center space-x-4 text-xs text-gray-400\">\r\n                    <span>{comment.timestamp}</span>\r\n                    <button\r\n                      onClick={async () => {\r\n                        if (!token) return;\r\n\r\n                        // Optimistic update - instant UI feedback\r\n                        const currentLiked = comment.userLiked;\r\n                        const currentLikes = comment.likes;\r\n                        const newLiked = !currentLiked;\r\n                        const newLikes = currentLiked ? currentLikes - 1 : currentLikes + 1;\r\n\r\n                        // Update UI immediately\r\n                        setComments(prev => prev.map(c => c.id === comment.id ? {\r\n                          ...c,\r\n                          likes: newLikes,\r\n                          userLiked: newLiked\r\n                        } : c));\r\n\r\n                        try {\r\n                          const resp = await fetch('/api/comments/like', {\r\n                            method: 'POST',\r\n                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },\r\n                            body: JSON.stringify({ commentId: comment.id })\r\n                          });\r\n\r\n                          if (resp.ok) {\r\n                            const data = await resp.json();\r\n                            // Update with server response (in case of discrepancy)\r\n                            setComments(prev => prev.map(c => c.id === comment.id ? {\r\n                              ...c,\r\n                              likes: data.likes,\r\n                              userLiked: data.liked\r\n                            } : c));\r\n                          } else {\r\n                            // Rollback on error\r\n                            setComments(prev => prev.map(c => c.id === comment.id ? {\r\n                              ...c,\r\n                              likes: currentLikes,\r\n                              userLiked: currentLiked\r\n                            } : c));\r\n                            showToast('Failed to update comment like. Please try again.', 'error', 2000);\r\n                            console.error('Like failed, rolled back');\r\n                          }\r\n                        } catch (e) {\r\n                          // Rollback on error\r\n                          setComments(prev => prev.map(c => c.id === comment.id ? {\r\n                            ...c,\r\n                            likes: currentLikes,\r\n                            userLiked: currentLiked\r\n                          } : c));\r\n                          showToast('Network error. Please check your connection.', 'error', 2000);\r\n                          console.error('Toggle like failed, rolled back', e);\r\n                        }\r\n                      }}\r\n                      className={`flex items-center space-x-1 hover:scale-110 active:scale-95 transition-all duration-200 font-medium ${comment.userLiked ? 'text-red-500' : 'text-gray-400 hover:text-red-400'\r\n                        }`}\r\n                    >\r\n                      <svg\r\n                        width=\"12\"\r\n                        height=\"12\"\r\n                        viewBox=\"0 0 24 24\"\r\n                        fill={comment.userLiked ? \"currentColor\" : \"none\"}\r\n                        stroke=\"currentColor\"\r\n                        strokeWidth=\"2\"\r\n                      >\r\n                        <path d=\"M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z\" />\r\n                      </svg>\r\n                      <span>\r\n                        {comment.likes > 0 && `${comment.likes} `}\r\n                        {comment.likes === 1 ? 'like' : comment.likes > 1 ? 'likes' : 'Like'}\r\n                      </span>\r\n                    </button>\r\n                    <button\r\n                      onClick={() => { setReplyingTo(comment.id); setNewComment(`@${comment.user.name} `); }}\r\n                      className=\"hover:text-gray-600 font-medium\"\r\n                    >\r\n                      Reply\r\n                    </button>\r\n                    <button\r\n                      onClick={async () => {\r\n                        try {\r\n                          const shareText = `${comment.user.name}: ${comment.text}`;\r\n                          const shareUrl = window.location.href;\r\n                          if ((navigator as any).share) {\r\n                            await (navigator as any).share({ title: 'Comment', text: shareText, url: shareUrl });\r\n                          } else {\r\n                            await navigator.clipboard.writeText(`${shareText}\\n${shareUrl}`);\r\n                            alert('Comment link copied');\r\n                          }\r\n                        } catch { }\r\n                      }}\r\n                      className=\"hover:text-gray-600 font-medium\"\r\n                    >\r\n                      Share\r\n                    </button>\r\n                    {user && comment.user.id === user.id && (\r\n                      <button\r\n                        onClick={async () => {\r\n                          if (!token) return;\r\n\r\n                          // Optimistic update - remove comment immediately\r\n                          setComments(prev => prev.filter(c => c.id !== comment.id));\r\n\r\n                          try {\r\n                            const resp = await fetch(`/api/comments?id=${comment.id}`, {\r\n                              method: 'DELETE',\r\n                              headers: { 'Authorization': `Bearer ${token}` }\r\n                            });\r\n\r\n                            if (resp.status !== 204) {\r\n                              // Rollback if deletion failed\r\n                              setComments(prev => {\r\n                                // Re-add the comment back in its original position\r\n                                const commentIndex = comments.findIndex(c => c.id === comment.id);\r\n                                const newComments = [...prev];\r\n                                newComments.splice(commentIndex, 0, comment);\r\n                                return newComments;\r\n                              });\r\n                              showToast('Failed to delete comment', 'error');\r\n                            }\r\n                          } catch (e) {\r\n                            console.error('Delete comment failed', e);\r\n                            // Rollback on error\r\n                            setComments(prev => {\r\n                              const commentIndex = comments.findIndex(c => c.id === comment.id);\r\n                              const newComments = [...prev];\r\n                              newComments.splice(commentIndex, 0, comment);\r\n                              return newComments;\r\n                            });\r\n                            showToast('Network error. Failed to delete comment.', 'error');\r\n                          }\r\n                        }}\r\n                        className=\"text-red-500 hover:text-red-600 font-medium transition-colors\"\r\n                      >\r\n                        Delete\r\n                      </button>\r\n                    )}\r\n                    <button className=\"text-gray-300 hover:text-red-500\">\r\n                      <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                        <path d=\"M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.5487 7.04097 1.5487 8.5C1.5487 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39467C21.7563 5.72723 21.351 5.1208 20.84 4.61V4.61Z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                      </svg>\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ))}\r\n            {!isLoadingComments && comments.length === 0 && (\r\n              <div className=\"text-center text-gray-400 text-sm\">No comments yet</div>\r\n            )}\r\n            {hasMoreComments && (\r\n              <div className=\"pt-2\">\r\n                <button\r\n                  onClick={() => loadComments(commentsOffset + COMMENTS_PAGE_SIZE, true)}\r\n                  disabled={isLoadingComments}\r\n                  className=\"w-full text-sm text-gray-600 hover:text-gray-800 py-2 border border-gray-200 rounded-md disabled:opacity-50\"\r\n                >\r\n                  {isLoadingComments ? 'Loading...' : 'Load more'}\r\n                </button>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Actions */}\r\n          <div className=\"border-t border-gray-100 p-4\">\r\n            {!isMobile && (\r\n              <div className=\"flex items-center justify-between mb-3\">\r\n                <div className=\"flex items-center space-x-4\">\r\n                  <button\r\n                    onClick={handleAuraClick}\r\n                    data-aura-button\r\n                    className=\"flex items-center space-x-2 group hover:opacity-75 active:opacity-60 cursor-pointer\"\r\n                    style={{ transition: 'transform 0.2s ease-out' }}\r\n                  >\r\n                    <svg\r\n                      width={24}\r\n                      height={24}\r\n                      viewBox=\"0 0 100 100\"\r\n                      style={{\r\n                        fill: hasAura ? '#FFAF50' : 'transparent',\r\n                        stroke: hasAura ? '#FFAF50' : '#000000',\r\n                        strokeWidth: '2',\r\n                      }}\r\n                    >\r\n                      <polygon\r\n                        points=\"77.333,33.31 55.438,33.31 75.43,1.829 47.808,1.829 23.198,51.05 41.882,51.05 21.334,99.808\"\r\n                      />\r\n                    </svg>\r\n                  </button>\r\n\r\n                  <button onClick={handleCommentButtonClick} className=\"group transition-all duration-200 hover:scale-105\" aria-label=\"Comment\">\r\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                      <path d=\"M8.5 12H8.51M12 12H12.01M15.5 12H15.51M21 12C21 16.418 16.97 20 12 20C10.89 20 9.84 19.79 8.88 19.42L3 21L4.58 15.12C4.21 14.16 4 13.11 4 12C4 7.582 8.03 4 12 4C16.97 4 21 7.582 21 12Z\"\r\n                        stroke=\"currentColor\"\r\n                        strokeWidth=\"1.5\"\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                      />\r\n                    </svg>\r\n                  </button>\r\n\r\n                  <button onClick={handleShareClick} className=\"group transition-all duration-200 hover:scale-105\" aria-label=\"Share\">\r\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                      <path d=\"M7 13L10.5 9.5L13.5 12.5L17 9M21 12C21 16.418 16.97 20 12 20C7.03 20 3 16.418 3 12C3 7.582 7.03 4 12 4C16.97 4 21 7.582 21 12Z\"\r\n                        stroke=\"currentColor\"\r\n                        strokeWidth=\"1.5\"\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                      />\r\n                    </svg>\r\n                  </button>\r\n                </div>\r\n\r\n                <button className=\"group transition-all duration-200 hover:scale-105\" aria-label=\"Bookmark\">\r\n                  <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M5 7.8C5 6.11984 5 5.27976 5.32698 4.63803C5.6146 4.07354 6.07354 3.6146 6.63803 3.32698C7.27976 3 8.11984 3 9.8 3H14.2C15.8802 3 16.7202 3 17.362 3.32698C17.9265 3.6146 18.3854 4.07354 18.673 4.63803C19 5.27976 19 6.11984 19 7.8V21L12 17L5 21V7.8Z\"\r\n                      stroke=\"currentColor\"\r\n                      strokeWidth=\"1.5\"\r\n                      strokeLinecap=\"round\"\r\n                      strokeLinejoin=\"round\"\r\n                    />\r\n                  </svg>\r\n                </button>\r\n              </div>\r\n            )}\r\n\r\n            <div className=\"text-sm font-semibold mb-1\">\r\n              {auraCount} {auraCount === 1 ? 'aura' : 'auras'}\r\n            </div>\r\n\r\n            <p className=\"text-xs text-gray-400 mb-3\">\r\n              {post.timestamp}\r\n              {/* Add location if available */}\r\n              {post.category && (\r\n                <>\r\n                  {' ΓÇó '}\r\n                  <span className=\"text-gray-600\">#{formatCategory(post.category)}</span>\r\n                </>\r\n              )}\r\n            </p>\r\n\r\n            {/* Comment Input */}\r\n            <div className=\"border-t border-gray-100 pt-3 relative\">\r\n              <form onSubmit={handleCommentSubmit} className=\"flex items-center space-x-3\">\r\n                <div className=\"w-8 h-8 bg-gradient-to-br from-[#FFAF50] to-orange-400 rounded-full flex items-center justify-center text-white font-bold text-xs\">\r\n                  {user?.name.charAt(0)}\r\n                </div>\r\n                <input\r\n                  type=\"text\"\r\n                  value={newComment}\r\n                  onChange={(e) => setNewComment(e.target.value)}\r\n                  placeholder=\"Add a comment...\"\r\n                  maxLength={2200}\r\n                  className=\"flex-1 border-none outline-none text-sm placeholder-gray-400\"\r\n                  disabled={isPosting}\r\n                  ref={commentInputRef}\r\n                />\r\n                <div className=\"flex items-center space-x-2 emoji-picker-container\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={(e) => {\r\n                      e.preventDefault();\r\n                      e.stopPropagation();\r\n                      console.log('≡ƒÄ» Emoji button clicked! Current state:', showEmojiPicker);\r\n                      setShowEmojiPicker(!showEmojiPicker);\r\n                      console.log('≡ƒÄ» Set showEmojiPicker to:', !showEmojiPicker);\r\n                    }}\r\n                    className=\"text-gray-400 hover:text-gray-600 relative text-lg\"\r\n                    title=\"Add emoji\"\r\n                  >\r\n                    ≡ƒÿè\r\n                  </button>\r\n                  {newComment.trim() && (\r\n                    <button\r\n                      type=\"submit\"\r\n                      disabled={isPosting}\r\n                      className=\"text-[#FFAF50] font-semibold text-sm hover:text-orange-600 disabled:opacity-50\"\r\n                    >\r\n                      {isPosting ? 'Posting...' : 'Post'}\r\n                    </button>\r\n                  )}\r\n                </div>\r\n              </form>\r\n\r\n              {/* Emoji Picker - Outside the form */}\r\n              {showEmojiPicker && (\r\n                <div className=\"absolute bottom-full right-0 mb-2 bg-white border-2 border-orange-100 rounded-lg shadow-xl p-3 w-80 h-48 overflow-y-auto emoji-picker-dropdown\" style={{ zIndex: 10000 }}>\r\n                  <div className=\"text-xs text-gray-500 mb-2\">Click an emoji to add it: (Current: \"{newComment}\")</div>\r\n                  <div className=\"grid grid-cols-8 gap-1\">\r\n                    {commonEmojis.map((emoji, index) => (\r\n                      <div\r\n                        key={index}\r\n                        onClick={() => {\r\n                          console.log('Emoji div clicked:', emoji);\r\n                          handleEmojiSelect(emoji);\r\n                        }}\r\n                        className=\"w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-lg transition-colors cursor-pointer border border-transparent hover:border-gray-300\"\r\n                        title={`Add ${emoji}`}\r\n                      >\r\n                        {emoji}\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* Character count for comments */}\r\n              {newComment.length > 0 && (\r\n                <div className=\"text-xs text-gray-400 mt-1 text-right\">\r\n                  {newComment.length}/2200\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default PostModal;","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\SafeImage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\SearchModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\SocketStatus.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\SuggestedUsers.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used.","line":26,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":14},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1099,1102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1099,1102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1333,1336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1333,1336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":63,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1726,1729],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1726,1729],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport React from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport FollowButton from './FollowButton'\r\nimport { useAuth } from '../contexts/AuthContext'\r\nimport { fetchAPI } from '../lib/dataFetcher'\r\nimport Image from 'next/image'\r\n\r\ninterface SuggestedUser {\r\n\tid: number\r\n\tname: string\r\n\tusername?: string\r\n\tdepartment?: string\r\n\tyear?: number\r\n\tprofile_image?: string\r\n\tmutualFriends?: number\r\n\tmutualFriendNames?: string[]\r\n\treason?: string\r\n\tfollower_count?: number\r\n}\r\n\r\nexport default function SuggestedUsers() {\r\n\tconst { token, user } = useAuth()\r\n\tconst [loading, setLoading] = React.useState(true)\r\n\tconst [error, setError] = React.useState<string>('')\r\n\tconst [suggestions, setSuggestions] = React.useState<SuggestedUser[]>([])\r\n\tconst router = useRouter()\r\n\r\n\tReact.useEffect(() => {\r\n\t\tlet isCancelled = false\r\n\t\tconst load = async () => {\r\n\t\t\tif (!token) {\r\n\t\t\t\tsetLoading(false)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\tsetLoading(true)\r\n\t\t\tsetError('')\r\n\t\t\ttry {\r\n\t\t\t\t// Use the new intelligent suggestions API with caching\r\n\t\t\t\tconst data = await fetchAPI<{ suggestions: any[] }>(\r\n\t\t\t\t\t'/api/users/suggestions?limit=10&algorithm=advanced',\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ttoken,\r\n\t\t\t\t\t\tcacheTTL: 300000 // Cache for 5 minutes\r\n\t\t\t\t\t}\r\n\t\t\t\t)\r\n\r\n\t\t\t\tconst suggestedUsers: SuggestedUser[] = (data.suggestions || []).map((s: any) => ({\r\n\t\t\t\t\tid: s.id,\r\n\t\t\t\t\tname: s.name,\r\n\t\t\t\t\tusername: s.username,\r\n\t\t\t\t\tdepartment: s.department,\r\n\t\t\t\t\tyear: s.year,\r\n\t\t\t\t\tprofile_image: s.profile_image,\r\n\t\t\t\t\tmutualFriends: s.mutualFriends,\r\n\t\t\t\t\tmutualFriendNames: s.mutualFriendNames,\r\n\t\t\t\t\treason: s.reason,\r\n\t\t\t\t\tfollower_count: s.follower_count\r\n\t\t\t\t}))\r\n\r\n\t\t\t\tif (!isCancelled) setSuggestions(suggestedUsers)\r\n\t\t\t} catch (e: any) {\r\n\t\t\t\tconsole.error('Failed to load suggestions:', e)\r\n\t\t\t\tif (!isCancelled) setError(e.message || 'Failed to load suggestions')\r\n\t\t\t} finally {\r\n\t\t\t\tif (!isCancelled) setLoading(false)\r\n\t\t\t}\r\n\t\t}\r\n\t\tload()\r\n\t\treturn () => {\r\n\t\t\tisCancelled = true\r\n\t\t}\r\n\t}, [token, user?.id])\r\n\r\n\tconst removeOnFollow = (userId: number) => {\r\n\t\tsetSuggestions(prev => prev.filter(u => u.id !== userId))\r\n\t}\r\n\r\n\tconst visible = suggestions.slice(0, 4)\r\n\r\n\treturn (\r\n\t\t<div className=\"sticky top-20 lg:top-20\">\r\n\t\t\t<div className=\"card overflow-hidden\">\r\n\t\t\t\t<div className=\"px-4 py-3 flex items-center justify-between border-b border-border-light\">\r\n\t\t\t\t\t<h3 className=\"text-sm font-semibold text-text\">Suggested for you</h3>\r\n\t\t\t\t\t{suggestions.length > 4 && (\r\n\t\t\t\t\t\t<button onClick={() => router.push('/suggestions')} className=\"link-muted text-xs font-semibold\">\r\n\t\t\t\t\t\t\tSee all\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t)}\r\n\t\t\t\t</div>\r\n\t\t\t\t<div className=\"divide-y divide-border-light\">\r\n\t\t\t\t\t{loading && (\r\n\t\t\t\t\t\t<div className=\"p-4 space-y-4\">\r\n\t\t\t\t\t\t\t{[...Array(5)].map((_, i) => (\r\n\t\t\t\t\t\t\t\t<div key={i} className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center gap-3\">\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"avatar avatar-md bg-gray-200 animate-pulse\" />\r\n\t\t\t\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"h-3 w-32 bg-gray-200 rounded mb-2 animate-pulse\" />\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"h-3 w-20 bg-gray-100 rounded animate-pulse\" />\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div className=\"h-8 w-20 bg-gray-200 rounded-lg animate-pulse\" />\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t)}\r\n\t\t\t\t\t{!loading && suggestions.length === 0 && (\r\n\t\t\t\t\t\t<div className=\"p-4 text-sm text-text-secondary\">No suggestions right now.</div>\r\n\t\t\t\t\t)}\r\n\t\t\t\t\t{!loading && visible.map(u => (\r\n\t\t\t\t\t\t<div key={u.id} className=\"px-4 py-3 flex items-center justify-between hover:bg-gray-50 cursor-pointer transition-colors\" onClick={() => router.push(`/profile/${u.id}`)}>\r\n\t\t\t\t\t\t\t<div className=\"flex items-center gap-3 min-w-0\">\r\n\t\t\t\t\t\t\t\t<Image\r\n\t\t\t\t\t\t\t\t\tsrc={u.profile_image || '/uploads/DefaultProfile.jpg'}\r\n\t\t\t\t\t\t\t\t\talt={u.name}\r\n\t\t\t\t\t\t\t\t\tclassName=\"avatar avatar-md object-cover\"\r\n\t\t\t\t\t\t\t\t\tonError={(e) => { (e.currentTarget as HTMLImageElement).src = '/uploads/DefaultProfile.jpg'; }}\r\n\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t<div className=\"min-w-0\">\r\n\t\t\t\t\t\t\t\t\t<p className=\"text-sm font-semibold text-text truncate\">{u.name}</p>\r\n\t\t\t\t\t\t\t\t\t<p className=\"text-xs text-text-secondary truncate\">\r\n\t\t\t\t\t\t\t\t\t\t{u.reason || (u.department ? `${u.department}${u.year ? ` ┬╖ Year ${u.year}` : ''}` : 'New to UNIX')}\r\n\t\t\t\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div onClick={(e) => e.stopPropagation()}>\r\n\t\t\t\t\t\t\t\t<FollowButton\r\n\t\t\t\t\t\t\t\t\tuserId={u.id}\r\n\t\t\t\t\t\t\t\t\tisFollowing={false}\r\n\t\t\t\t\t\t\t\t\tsize=\"sm\"\r\n\t\t\t\t\t\t\t\t\tonFollowChange={(isFollowing) => { if (isFollowing) removeOnFollow(u.id) }}\r\n\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t))}\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\r\n\t\t\t{/* Footer - Desktop only */}\r\n\t\t\t<div className=\"hidden lg:block mt-6 text-xxs text-text-tertiary space-y-2\">\r\n\t\t\t\t<p>About ┬╖ Help ┬╖ Press ┬╖ API  ┬╖ Privacy ┬╖ Terms ┬╖ Locations ┬╖ Language</p>\r\n\t\t\t\t<p>┬⌐ 2026 UNI-X</p>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t)\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\SuggestionsSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\SwipeButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\components\\Toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\contexts\\AuthContext.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'logout' and 'user'. Either include them or remove the dependency array.","line":165,"column":6,"nodeType":"ArrayExpression","endLine":165,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [isTokenValid, logout, user]","fix":{"range":[4565,4579],"text":"[isTokenValid, logout, user]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":228,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":228,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { createContext, useContext, useState, useEffect, ReactNode, useCallback } from 'react';\nimport { useRouter } from 'next/navigation';\n\ninterface User {\n  id: number;\n  name: string;\n  college_id: string;\n  username?: string;\n  department: string;\n  year: number;\n  role: string;\n  created_at: string;\n}\n\ninterface AuthContextType {\n  user: User | null;\n  token: string | null;\n  login: (college_id: string, password: string) => Promise<boolean>;\n  register: (data: RegisterData) => Promise<{ success: boolean; message?: string }>;\n  logout: () => void;\n  isLoading: boolean;\n  setSocketDisconnect?: (disconnectFn: () => void) => void;\n}\n\ninterface RegisterData {\n  name: string;\n  username: string;\n  email: string;\n  college_id: string;\n  password: string;\n  department: string;\n  year: number;\n  role?: string;\n  bio?: string;\n  profile_image?: string;\n}\n\ninterface LoginResponse {\n  success: boolean;\n  user: User;\n  token: string;\n}\n\ninterface ErrorResponse {\n  message: string;\n  error?: string;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const [user, setUser] = useState<User | null>(null);\n  const [token, setToken] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [socketDisconnect, setSocketDisconnectFn] = useState<(() => void) | null>(null);\n  const router = useRouter();\n\n  const setSocketDisconnect = useCallback((disconnectFn: () => void) => {\n    setSocketDisconnectFn(() => disconnectFn);\n  }, []);\n\n  // Helper function to validate token format\n  const isTokenValid = useCallback((token: string | null): boolean => {\n    if (!token || token.length < 20) return false;\n    \n    // Basic JWT format check (should have 3 parts separated by dots)\n    const parts = token.split('.');\n    if (parts.length !== 3) return false;\n    \n    try {\n      // Decode the payload (middle part) to check expiration\n      const payload = JSON.parse(atob(parts[1]));\n      \n      // Check if token has expired\n      if (payload.exp && payload.exp * 1000 < Date.now()) {\n        console.warn('ΓÜá∩╕Å Token has expired');\n        return false;\n      }\n      \n      return true;\n    } catch (e) {\n      console.error('Γ¥î Invalid token format:', e);\n      return false;\n    }\n  }, []);\n\n  const logout = useCallback(() => {\n    try {\n      // Disconnect socket first\n      if (socketDisconnect) {\n        socketDisconnect();\n      }\n      \n      // Clear user state immediately for instant UI update\n      setUser(null);\n      setToken(null);\n      \n      // Clear localStorage\n      localStorage.removeItem('token');\n      localStorage.removeItem('user');\n      \n      // Clear any other cached data that might exist\n      localStorage.removeItem('conversations');\n      localStorage.removeItem('posts');\n      localStorage.removeItem('notifications');\n      \n      // Clear session storage as well\n      sessionStorage.clear();\n      \n      // Force redirect to landing page\n      router.push('/landing');\n      \n      // Force page reload to clear any remaining state\n      setTimeout(() => {\n        window.location.href = '/landing';\n      }, 100);\n      \n    } catch (error) {\n      console.error('Logout error:', error);\n      // Even if there's an error, still try to clear state and redirect\n      setUser(null);\n      setToken(null);\n      window.location.href = '/landing';\n    }\n  }, [socketDisconnect, router]);\n\n  useEffect(() => {\n    // Check for stored token on mount\n    const storedToken = localStorage.getItem('token');\n    const storedUser = localStorage.getItem('user');\n    \n    if (storedToken && storedUser) {\n      // Validate token before setting it\n      if (isTokenValid(storedToken)) {\n        setToken(storedToken);\n        setUser(JSON.parse(storedUser));\n      } else {\n        console.warn('ΓÜá∩╕Å Stored token is invalid or expired - clearing');\n        localStorage.removeItem('token');\n        localStorage.removeItem('user');\n      }\n    }\n    \n    setIsLoading(false);\n\n    // Listen for unauthorized events from dataFetcher\n    const handleUnauthorized = () => {\n      console.warn('ΓÜá∩╕Å Unauthorized event received - session expired');\n      \n      // Show alert to user\n      if (user) {\n        alert('Your session has expired. Please log in again.');\n      }\n      \n      logout();\n    };\n\n    window.addEventListener('unauthorized', handleUnauthorized);\n\n    return () => {\n      window.removeEventListener('unauthorized', handleUnauthorized);\n    };\n  }, [isTokenValid]);\n\n  const login = useCallback(async (college_id: string, password: string): Promise<boolean> => {\n    try {\n      console.log('Attempting login with:', { college_id, password: '***' });\n      const response = await fetch('/api/auth/login', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ college_id, password }),\n      });\n\n      console.log('Login response status:', response.status);\n      console.log('Login response ok:', response.ok);\n\n      if (response.ok) {\n        const data = await response.json() as LoginResponse;\n        console.log('Login successful, user data:', data.user);\n        setUser(data.user);\n        setToken(data.token);\n        \n        localStorage.setItem('token', data.token);\n        localStorage.setItem('user', JSON.stringify(data.user));\n        \n        return true;\n      } else {\n        const errorData = await response.json() as ErrorResponse;\n        console.log('Login failed with error:', errorData);\n        return false;\n      }\n    } catch (error) {\n      console.error('Login error:', error);\n      return false;\n    }\n  }, []);\n\n  const register = useCallback(async (data: RegisterData): Promise<{ success: boolean; message?: string }> => {\n    try {\n      const response = await fetch('/api/auth/register', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(data),\n      });\n\n      if (response.ok) {\n        const result = await response.json() as LoginResponse;\n        setUser(result.user);\n        setToken(result.token);\n        \n        localStorage.setItem('token', result.token);\n        localStorage.setItem('user', JSON.stringify(result.user));\n        \n        return { success: true };\n      }\n\n      // Try to extract a helpful message from the backend\n      let message = 'Registration failed. Please try again.';\n      try {\n        const err = (await response.json()) as { error?: string; message?: string };\n        message = err?.message || err?.error || message;\n      } catch (_) {\n        // ignore JSON parse errors; keep default message\n      }\n      return { success: false, message };\n    } catch (error) {\n      console.error('Register error:', error);\n      return { success: false, message: 'Network error. Please check your connection.' };\n    }\n  }, []);\n\n  return (\n    <AuthContext.Provider value={{ user, token, login, register, logout, isLoading, setSocketDisconnect }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\contexts\\SocketContext.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[599,602],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[599,602],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[679,682],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[679,682],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[752,755],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[752,755],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1771,1774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1771,1774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1837,1840],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1837,1840],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":159,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":159,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5876,5879],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5876,5879],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'user'. Either include it or remove the dependency array.","line":223,"column":6,"nodeType":"ArrayExpression","endLine":223,"endColumn":65,"suggestions":[{"desc":"Update the dependencies array to be: [user.id, token, socket, disconnect, isTokenValid, logout, user]","fix":{"range":[7950,8009],"text":"[user.id, token, socket, disconnect, isTokenValid, logout, user]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":281,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":281,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10144,10147],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10144,10147],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":283,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":283,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10225,10228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10225,10228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":288,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10405,10408],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10405,10408],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":290,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":290,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10484,10487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10484,10487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":295,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":295,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10673,10676],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10673,10676],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":329,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":329,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11997,12000],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11997,12000],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":331,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":331,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12076,12079],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12076,12079],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":336,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":336,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12240,12243],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12240,12243],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":338,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":338,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12319,12322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12319,12322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":346,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":346,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12720,12723],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12720,12723],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":354,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":354,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13120,13123],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13120,13123],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":362,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":362,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13495,13498],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13495,13498],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":18,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport React, { createContext, useContext, useEffect, useState, useCallback } from 'react'\r\nimport { io, Socket } from 'socket.io-client'\r\nimport { useAuth } from './AuthContext'\r\n\r\ninterface SocketContextType {\r\n  socket: Socket | null\r\n  isConnected: boolean\r\n  isConnecting: boolean\r\n  joinConversation: (otherUserId: number) => void\r\n  leaveConversation: (otherUserId: number) => void\r\n  sendMessage: (messageData: { receiverId: number; messageText?: string; mediaUrl?: string | null; clientId?: string; replyToId?: number | null }) => void\r\n  onNewMessage: (callback: (message: any) => void) => () => void\r\n  onMessageNotification: (callback: (notification: any) => void) => () => void\r\n  onNotification: (callback: (notification: any) => void) => () => void\r\n  onMessageUnsent: (callback: (data: { messageId: number }) => void) => () => void\r\n  onMessageDeleted: (callback: (data: { messageId: number }) => void) => () => void\r\n  // New: Message status acknowledgment handlers\r\n  onMessageAck: (callback: (data: { clientId: string; messageId: number; status: string; sentAt: string }) => void) => () => void\r\n  onMessageDelivered: (callback: (data: { messageId: number; clientId?: string; deliveredTo: number; deliveredAt: string }) => void) => () => void\r\n  onMessagesRead: (callback: (data: { messageIds: number[]; readBy: number; readAt: string }) => void) => () => void\r\n  // New: Methods for acknowledgment\r\n  markMessagesRead: (otherUserId: number, messageIds: number[], senderId?: number) => void\r\n  confirmMessageReceived: (messageId: number, senderId: number) => void\r\n  startTyping: (otherUserId: number, userId: number, userName: string) => void\r\n  stopTyping: (otherUserId: number, userId: number) => void\r\n  onTyping: (callback: (data: any) => void) => () => void\r\n  onStoppedTyping: (callback: (data: any) => void) => () => void\r\n  disconnect: () => void\r\n}\r\n\r\nconst SocketContext = createContext<SocketContextType | undefined>(undefined)\r\n\r\ninterface SocketProviderProps {\r\n  children: React.ReactNode\r\n}\r\n\r\nexport const SocketProvider: React.FC<SocketProviderProps> = ({ children }) => {\r\n  const [socket, setSocket] = useState<Socket | null>(null)\r\n  const [isConnected, setIsConnected] = useState(false)\r\n  const [isConnecting, setIsConnecting] = useState(false)\r\n  const { user, token, setSocketDisconnect, logout } = useAuth()\r\n\r\n  // Helper function to validate token format and expiration\r\n  const isTokenValid = useCallback((token: string | null): boolean => {\r\n    if (!token || token.length < 20) return false;\r\n\r\n    // Basic JWT format check (should have 3 parts separated by dots)\r\n    const parts = token.split('.');\r\n    if (parts.length !== 3) return false;\r\n\r\n    try {\r\n      // Decode the payload (middle part) to check expiration\r\n      const payload = JSON.parse(atob(parts[1]));\r\n\r\n      // Check if token has expired\r\n      if (payload.exp && payload.exp * 1000 < Date.now()) {\r\n        console.warn('ΓÜá∩╕Å Socket token has expired');\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (e) {\r\n      console.error('Γ¥î Invalid socket token format:', e);\r\n      return false;\r\n    }\r\n  }, []);\r\n\r\n  const disconnect = useCallback(() => {\r\n    if (socket) {\r\n      socket.emit('user-offline', user?.id)\r\n      socket.disconnect()\r\n      setSocket(null)\r\n      setIsConnected(false)\r\n    }\r\n  }, [socket, user?.id])\r\n\r\n  // Register disconnect function with AuthContext\r\n  useEffect(() => {\r\n    if (setSocketDisconnect) {\r\n      setSocketDisconnect(disconnect);\r\n    }\r\n  }, [setSocketDisconnect, disconnect]);\r\n\r\n  useEffect(() => {\r\n    if (!user || !token) {\r\n      // Clear socket if user is not authenticated\r\n      if (socket) {\r\n        disconnect();\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Validate token before attempting connection\r\n    if (!isTokenValid(token)) {\r\n      console.error('Γ¥î Cannot connect socket: Token is invalid or expired');\r\n      console.error('≡ƒÆí Triggering logout to clear invalid token');\r\n\r\n      // Clear socket if it exists\r\n      if (socket) {\r\n        disconnect();\r\n      }\r\n\r\n      // Trigger logout to clear invalid token\r\n      if (typeof window !== 'undefined') {\r\n        alert('Your session has expired. Please log in again.');\r\n        logout();\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    // Prevent multiple connections\r\n    if (socket) {\r\n      console.log('Socket already exists, skipping initialization');\r\n      return;\r\n    }\r\n\r\n    console.log('Initializing new socket connection...');\r\n    setIsConnecting(true);\r\n\r\n    // Initialize single Socket.IO connection to Node.js server\r\n    let newSocket: Socket | null = null\r\n\r\n    const baseUrl = (typeof window !== 'undefined' && window.location.origin) || ''\r\n    const url = process.env.NEXT_PUBLIC_SOCKET_URL || baseUrl\r\n\r\n    try {\r\n      newSocket = io(url, {\r\n        forceNew: true,\r\n        timeout: 60000, // 60 seconds for Render cold starts\r\n        reconnection: true,\r\n        reconnectionAttempts: 10, // More attempts for sleeping servers\r\n        reconnectionDelay: 2000,\r\n        reconnectionDelayMax: 10000,\r\n        transports: ['polling', 'websocket'], // Start with polling for better Render compatibility\r\n        upgrade: true, // Upgrade to WebSocket after initial connection\r\n        auth: { token },\r\n        withCredentials: true,\r\n      })\r\n\r\n      newSocket.on('connect', () => {\r\n        console.log('Γ£à Connected to Socket.io server')\r\n        console.log('≡ƒöù Socket ID:', newSocket!.id)\r\n        setIsConnected(true)\r\n        setIsConnecting(false)\r\n\r\n        // Announce online status\r\n        newSocket!.emit('user-online')\r\n      })\r\n\r\n      newSocket.on('disconnect', (reason) => {\r\n        console.log('≡ƒöî Disconnected from Socket.io server:', reason)\r\n        setIsConnected(false)\r\n        setIsConnecting(false)\r\n      })\r\n\r\n      newSocket.on('connect_error', (error: any) => {\r\n        setIsConnecting(false)\r\n        setIsConnected(false)\r\n\r\n        // Handle authentication errors\r\n        const isAuthError = error.message?.includes('No token') ||\r\n          error.message?.includes('Authentication') ||\r\n          error.message?.includes('Token expired') ||\r\n          error.message?.includes('Invalid token');\r\n\r\n        if (isAuthError) {\r\n          console.error('≡ƒöÉ Socket authentication failed - Session expired')\r\n\r\n          // Disconnect socket\r\n          if (newSocket) {\r\n            newSocket.close();\r\n          }\r\n\r\n          // Clear socket state\r\n          setSocket(null);\r\n\r\n          // Trigger logout\r\n          if (typeof window !== 'undefined') {\r\n            setTimeout(() => {\r\n              alert('Your session has expired. Please log in again.');\r\n              logout();\r\n            }, 100);\r\n          }\r\n        } else if (error.message?.includes('xhr poll error')) {\r\n          console.warn('≡ƒöî Socket server unreachable at:', url)\r\n          console.warn('≡ƒÆí Start local socket server with: node socket-server.js')\r\n        } else {\r\n          console.warn('≡ƒöî Socket connection failed:', error.message || 'Unknown error')\r\n        }\r\n      })\r\n\r\n      // Handle socket errors\r\n      newSocket.on('error', (error) => {\r\n        console.error('Γ¥î Socket error:', error?.message || error || 'Unknown error')\r\n        if (error) {\r\n          console.error('Error details:', JSON.stringify(error, null, 2))\r\n        }\r\n      })\r\n\r\n      // Handle message-specific errors\r\n      newSocket.on('message-error', (error) => {\r\n        console.error('Γ¥î Message send failed:', error.message || 'Unknown error')\r\n        if (error.clientId) {\r\n          console.error('Failed message clientId:', error.clientId)\r\n        }\r\n      })\r\n\r\n      setSocket(newSocket)\r\n    } catch (error) {\r\n      console.error('Failed to initialize socket:', error);\r\n    }\r\n\r\n    return () => {\r\n      try {\r\n        newSocket?.close()\r\n      } catch (error) {\r\n        console.warn('Error closing socket:', error);\r\n      }\r\n    }\r\n  }, [user?.id, token, socket, disconnect, isTokenValid, logout])\r\n\r\n  const joinConversation = useCallback((otherUserId: number) => {\r\n    if (socket && user?.id) {\r\n      const conversationId = [user.id, otherUserId].sort((a, b) => a - b).join('-')\r\n      socket.emit('join-conversation', conversationId)\r\n      console.log(`Joined conversation: ${conversationId}`)\r\n    }\r\n  }, [socket, user?.id])\r\n\r\n  const leaveConversation = useCallback((otherUserId: number) => {\r\n    if (socket && user?.id) {\r\n      const conversationId = [user.id, otherUserId].sort((a, b) => a - b).join('-')\r\n      socket.emit('leave-conversation', conversationId)\r\n      console.log(`Left conversation: ${conversationId}`)\r\n    }\r\n  }, [socket, user?.id])\r\n\r\n  const sendMessage = useCallback((messageData: { receiverId: number; messageText?: string; mediaUrl?: string | null; clientId?: string; replyToId?: number | null }) => {\r\n    if (!socket || !socket.connected) {\r\n      console.warn('ΓÜá∩╕Å Cannot send message: socket not connected. Please wait for connection to be established.');\r\n      // Don't throw - let the UI handle this gracefully with optimistic updates\r\n      return false;\r\n    }\r\n\r\n    if (!user?.id) {\r\n      console.warn('ΓÜá∩╕Å Cannot send message: user not authenticated');\r\n      return false;\r\n    }\r\n\r\n    // Validate message data\r\n    if (!messageData.receiverId) {\r\n      console.error('Γ¥î Receiver ID is required');\r\n      return false;\r\n    }\r\n\r\n    if (!messageData.messageText?.trim() && !messageData.mediaUrl) {\r\n      console.error('Γ¥î Message content is required');\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const conversationId = [user.id, messageData.receiverId].sort((a, b) => a - b).join('-')\r\n      socket.emit('send-message', {\r\n        ...messageData,\r\n        conversationId,\r\n        senderId: user.id,\r\n        senderName: user.name,\r\n        createdAt: new Date().toISOString(),\r\n      })\r\n      console.log(`≡ƒôñ Sending message to conversation: ${conversationId}`)\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Γ¥î Failed to send message via socket:', error);\r\n      return false;\r\n    }\r\n  }, [socket, user])\r\n\r\n  const onNewMessage = (callback: (message: any) => void) => {\r\n    if (!socket) return () => { }\r\n    const handler = (msg: any) => callback(msg)\r\n    socket.on('new-message', handler)\r\n    return () => socket.off('new-message', handler)\r\n  }\r\n\r\n  const onMessageNotification = (callback: (notification: any) => void) => {\r\n    if (!socket) return () => { }\r\n    const handler = (n: any) => callback(n)\r\n    socket.on('message-notification', handler)\r\n    return () => socket.off('message-notification', handler)\r\n  }\r\n\r\n  const onNotification = (callback: (notification: any) => void) => {\r\n    if (!socket) return () => { }\r\n    socket.on('notification', callback)\r\n    return () => socket.off('notification', callback)\r\n  }\r\n\r\n  const onMessageUnsent = (callback: (data: { messageId: number }) => void) => {\r\n    if (!socket) return () => { }\r\n    const handler = (data: { messageId: number }) => callback(data)\r\n    socket.on('message-unsent', handler)\r\n    return () => socket.off('message-unsent', handler)\r\n  }\r\n\r\n  const onMessageDeleted = (callback: (data: { messageId: number }) => void) => {\r\n    if (!socket) return () => { }\r\n    const handler = (data: { messageId: number }) => callback(data)\r\n    socket.on('message-deleted', handler)\r\n    return () => socket.off('message-deleted', handler)\r\n  }\r\n\r\n  const startTyping = (otherUserId: number, userId: number, userName: string) => {\r\n    if (socket && user?.id) {\r\n      const conversationId = [user.id, otherUserId].sort((a, b) => a - b).join('-')\r\n      socket.emit('typing-start', { conversationId, userId, userName })\r\n    }\r\n  }\r\n\r\n  const stopTyping = (otherUserId: number, userId: number) => {\r\n    if (socket && user?.id) {\r\n      const conversationId = [user.id, otherUserId].sort((a, b) => a - b).join('-')\r\n      socket.emit('typing-stop', { conversationId, userId })\r\n    }\r\n  }\r\n\r\n  const onTyping = (callback: (data: any) => void) => {\r\n    if (!socket) return () => { }\r\n    const handler = (d: any) => callback(d)\r\n    socket.on('user-typing', handler)\r\n    return () => socket.off('user-typing', handler)\r\n  }\r\n\r\n  const onStoppedTyping = (callback: (data: any) => void) => {\r\n    if (!socket) return () => { }\r\n    const handler = (d: any) => callback(d)\r\n    socket.on('user-stopped-typing', handler)\r\n    return () => socket.off('user-stopped-typing', handler)\r\n  }\r\n\r\n  // New: Message acknowledgment handler (confirms message saved on server)\r\n  const onMessageAck = (callback: (data: { clientId: string; messageId: number; status: string; sentAt: string }) => void) => {\r\n    if (!socket) return () => { }\r\n    const handler = (d: any) => callback(d)\r\n    socket.on('message-ack', handler)\r\n    return () => socket.off('message-ack', handler)\r\n  }\r\n\r\n  // New: Message delivered handler (confirms recipient received message)\r\n  const onMessageDelivered = (callback: (data: { messageId: number; clientId?: string; deliveredTo: number; deliveredAt: string }) => void) => {\r\n    if (!socket) return () => { }\r\n    const handler = (d: any) => callback(d)\r\n    socket.on('message-delivered', handler)\r\n    return () => socket.off('message-delivered', handler)\r\n  }\r\n\r\n  // New: Messages read handler (confirms recipient read messages)\r\n  const onMessagesRead = (callback: (data: { messageIds: number[]; readBy: number; readAt: string }) => void) => {\r\n    if (!socket) return () => { }\r\n    const handler = (d: any) => callback(d)\r\n    socket.on('messages-read', handler)\r\n    return () => socket.off('messages-read', handler)\r\n  }\r\n\r\n  // New: Mark messages as read\r\n  const markMessagesRead = useCallback((otherUserId: number, messageIds: number[], senderId?: number) => {\r\n    if (socket && user?.id) {\r\n      const conversationId = [user.id, otherUserId].sort((a, b) => a - b).join('-')\r\n      socket.emit('mark-messages-read', { conversationId, messageIds, senderId })\r\n    }\r\n  }, [socket, user?.id])\r\n\r\n  // New: Confirm message was received (for delivery status)\r\n  const confirmMessageReceived = useCallback((messageId: number, senderId: number) => {\r\n    if (socket) {\r\n      socket.emit('message-received', { messageId, senderId })\r\n    }\r\n  }, [socket])\r\n\r\n  const value: SocketContextType = {\r\n    socket,\r\n    isConnected,\r\n    isConnecting,\r\n    joinConversation,\r\n    leaveConversation,\r\n    sendMessage,\r\n    onNewMessage,\r\n    onMessageNotification,\r\n    onNotification,\r\n    onMessageUnsent,\r\n    onMessageDeleted,\r\n    onMessageAck,\r\n    onMessageDelivered,\r\n    onMessagesRead,\r\n    markMessagesRead,\r\n    confirmMessageReceived,\r\n    startTyping,\r\n    stopTyping,\r\n    onTyping,\r\n    onStoppedTyping,\r\n    disconnect\r\n  }\r\n\r\n  return (\r\n    <SocketContext.Provider value={value}>\r\n      {children}\r\n    </SocketContext.Provider>\r\n  )\r\n}\r\n\r\nexport const useSocket = (): SocketContextType => {\r\n  const context = useContext(SocketContext)\r\n  if (context === undefined) {\r\n    throw new Error('useSocket must be used within a SocketProvider')\r\n  }\r\n  return context\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\contexts\\ToastContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\diagnose-mongo.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":25,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":43},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":4,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":4,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":5,"column":13,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":5,"endColumn":27}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Comprehensive MongoDB Connection Diagnostics\r\nconst { MongoClient } = require('mongodb')\r\nconst fs = require('fs')\r\nconst path = require('path')\r\nconst dns = require('dns').promises\r\n\r\n// Read .env.local file\r\nconst envPath = path.join(__dirname, '.env.local')\r\nconst envContent = fs.readFileSync(envPath, 'utf8')\r\nconst envLines = envContent.split('\\n')\r\n\r\nenvLines.forEach(line => {\r\n  const match = line.match(/^([^#][^=]*)=(.*)$/)\r\n  if (match) {\r\n    const key = match[1].trim()\r\n    const value = match[2].trim().replace(/^[\"']|[\"']$/g, '')\r\n    process.env[key] = value\r\n  }\r\n})\r\n\r\nconst uri = process.env.MONGODB_URI\r\n\r\nconsole.log('≡ƒöì MongoDB Connection Diagnostics\\n')\r\nconsole.log('=' .repeat(60))\r\n\r\nasync function diagnose() {\r\n  // 1. Check URI\r\n  console.log('\\nΓ£ô Connection URI is set')\r\n  const maskedUri = uri?.replace(/:[^:@]*@/, ':****@')\r\n  console.log('  URI:', maskedUri)\r\n  \r\n  // 2. Extract hostname\r\n  const hostMatch = uri.match(/@([^/]+)/)\r\n  if (!hostMatch) {\r\n    console.error('Γ¥î Cannot extract hostname from URI')\r\n    process.exit(1)\r\n  }\r\n  \r\n  const hostname = hostMatch[1].split('/')[0].split('?')[0]\r\n  console.log('\\nΓ£ô Extracted hostname:', hostname)\r\n  \r\n  // 3. Test DNS resolution\r\n  console.log('\\nΓÅ│ Testing DNS resolution...')\r\n  try {\r\n    const addresses = await dns.resolve(hostname)\r\n    console.log('Γ£ô DNS resolved successfully!')\r\n    console.log('  IP addresses:', addresses.join(', '))\r\n  } catch (dnsError) {\r\n    console.error('Γ¥î DNS resolution failed:', dnsError.message)\r\n    console.error('≡ƒÆí Try:')\r\n    console.error('   1. Check internet connection')\r\n    console.error('   2. Flush DNS: ipconfig /flushdns')\r\n    console.error('   3. Use Google DNS (8.8.8.8)')\r\n    process.exit(1)\r\n  }\r\n  \r\n  // 4. Try different connection options\r\n  const connectionOptions = [\r\n    {\r\n      name: 'Option 1: Standard with TLS',\r\n      options: {\r\n        serverSelectionTimeoutMS: 5000,\r\n        connectTimeoutMS: 5000,\r\n        tls: true,\r\n      }\r\n    },\r\n    {\r\n      name: 'Option 2: With tlsAllowInvalidCertificates',\r\n      options: {\r\n        serverSelectionTimeoutMS: 5000,\r\n        connectTimeoutMS: 5000,\r\n        tls: true,\r\n        tlsAllowInvalidCertificates: true,\r\n      }\r\n    },\r\n    {\r\n      name: 'Option 3: With tlsAllowInvalidHostnames',\r\n      options: {\r\n        serverSelectionTimeoutMS: 5000,\r\n        connectTimeoutMS: 5000,\r\n        tls: true,\r\n        tlsAllowInvalidCertificates: true,\r\n        tlsAllowInvalidHostnames: true,\r\n      }\r\n    },\r\n    {\r\n      name: 'Option 4: Force IPv4',\r\n      options: {\r\n        serverSelectionTimeoutMS: 5000,\r\n        connectTimeoutMS: 5000,\r\n        tls: true,\r\n        tlsAllowInvalidCertificates: true,\r\n        tlsAllowInvalidHostnames: true,\r\n        family: 4,\r\n      }\r\n    },\r\n  ]\r\n  \r\n  let connected = false\r\n  \r\n  for (const config of connectionOptions) {\r\n    console.log(`\\nΓÅ│ Trying ${config.name}...`)\r\n    try {\r\n      const client = await MongoClient.connect(uri, config.options)\r\n      console.log(`Γ£à SUCCESS with ${config.name}!`)\r\n      \r\n      // Test database access\r\n      const db = client.db('unix')\r\n      await db.admin().ping()\r\n      console.log('Γ£à Database ping successful!')\r\n      \r\n      // List collections\r\n      const collections = await db.listCollections().toArray()\r\n      console.log(`Γ£à Found ${collections.length} collections`)\r\n      \r\n      await client.close()\r\n      connected = true\r\n      \r\n      console.log('\\n' + '='.repeat(60))\r\n      console.log('Γ£à CONNECTION SUCCESSFUL!')\r\n      console.log('='.repeat(60))\r\n      console.log('\\nRecommended configuration:')\r\n      console.log(JSON.stringify(config.options, null, 2))\r\n      break\r\n      \r\n    } catch (error) {\r\n      console.log(`Γ¥î Failed: ${error.message.split('\\n')[0]}`)\r\n    }\r\n  }\r\n  \r\n  if (!connected) {\r\n    console.log('\\n' + '='.repeat(60))\r\n    console.error('Γ¥î ALL CONNECTION ATTEMPTS FAILED')\r\n    console.log('='.repeat(60))\r\n    console.error('\\n≡ƒÆí Possible causes:')\r\n    console.error('   1. IP not whitelisted in MongoDB Atlas')\r\n    console.error('   2. Cluster is paused or stopped')\r\n    console.error('   3. Invalid credentials (username/password)')\r\n    console.error('   4. Windows Firewall blocking connection')\r\n    console.error('   5. Network/VPN interference')\r\n    console.error('\\n≡ƒôï Action items:')\r\n    console.error('   1. Go to MongoDB Atlas ΓåÆ Network Access')\r\n    console.error('   2. Add IP: 152.58.63.178 OR Allow 0.0.0.0/0')\r\n    console.error('   3. Go to Database ΓåÆ Clusters')\r\n    console.error('   4. Verify cluster is ACTIVE (not paused)')\r\n    console.error('   5. Verify credentials: eclyn / eclyn8888')\r\n    process.exit(1)\r\n  }\r\n}\r\n\r\ndiagnose().catch(err => {\r\n  console.error('\\nΓ¥î Diagnostic failed:', err.message)\r\n  process.exit(1)\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\hooks\\useInfiniteScroll.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback received a function whose dependencies are unknown. Pass an inline function instead.","line":25,"column":24,"nodeType":"Identifier","endLine":25,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react';\r\nimport { throttle } from '../lib/dataFetcher';\r\n\r\ninterface UseInfiniteScrollOptions {\r\n  threshold?: number; // Distance from bottom to trigger load (in pixels)\r\n  enabled?: boolean;\r\n}\r\n\r\ninterface UseInfiniteScrollReturn {\r\n  containerRef: React.RefObject<HTMLDivElement | null>;\r\n  isNearBottom: boolean;\r\n}\r\n\r\nexport function useInfiniteScroll(\r\n  onLoadMore: () => void,\r\n  options: UseInfiniteScrollOptions = {}\r\n): UseInfiniteScrollReturn {\r\n  const { threshold = 500, enabled = true } = options;\r\n  const [isNearBottom, setIsNearBottom] = useState(false);\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const loadingRef = useRef(false);\r\n\r\n  const handleScroll = useCallback(\r\n    throttle(() => {\r\n      if (!enabled || loadingRef.current || !containerRef.current) return;\r\n\r\n      const container = containerRef.current;\r\n      const scrollTop = container.scrollTop;\r\n      const scrollHeight = container.scrollHeight;\r\n      const clientHeight = container.clientHeight;\r\n\r\n      const distanceFromBottom = scrollHeight - (scrollTop + clientHeight);\r\n      const nearBottom = distanceFromBottom < threshold;\r\n\r\n      setIsNearBottom(nearBottom);\r\n\r\n      if (nearBottom) {\r\n        loadingRef.current = true;\r\n        onLoadMore();\r\n        // Reset loading flag after a delay\r\n        setTimeout(() => {\r\n          loadingRef.current = false;\r\n        }, 1000);\r\n      }\r\n    }, 200),\r\n    [enabled, threshold, onLoadMore]\r\n  );\r\n\r\n  useEffect(() => {\r\n    const container = containerRef.current;\r\n    if (!container) return;\r\n\r\n    container.addEventListener('scroll', handleScroll);\r\n    return () => container.removeEventListener('scroll', handleScroll);\r\n  }, [handleScroll]);\r\n\r\n  return { containerRef, isNearBottom };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\hooks\\useIsMobile.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\hooks\\usePosts.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":81,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2155,2158],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2155,2158],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchPosts'. Either include it or remove the dependency array.","line":108,"column":6,"nodeType":"ArrayExpression","endLine":108,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [category, limit, token, authLoading, fetchPosts]","fix":{"range":[2798,2835],"text":"[category, limit, token, authLoading, fetchPosts]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { useAuth } from '../contexts/AuthContext';\nimport { fetchAPI } from '../lib/dataFetcher';\n\ninterface Post {\n  id: number;\n  content: string;\n  category: string;\n  media_url?: string;\n  media_type?: string;\n  aura_count: number;\n  user_liked: boolean;\n  created_at: string;\n  author: {\n    id: number;\n    name: string;\n    department: string;\n    year: number;\n  };\n}\n\ninterface UsePostsReturn {\n  posts: Post[];\n  loading: boolean;\n  error: string | null;\n  refetch: () => void;\n  loadMore: () => void;\n  hasMore: boolean;\n}\n\nexport function usePosts(category?: string, limit: number = 20): UsePostsReturn {\n  const [posts, setPosts] = useState<Post[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const { token, isLoading: authLoading } = useAuth();\n  const [offset, setOffset] = useState(0);\n  const [hasMore, setHasMore] = useState(true);\n\n  const fetchPosts = useCallback(async (append: boolean = false) => {\n    try {\n      setLoading(true);\n      setError(null);\n      \n      // Don't fetch if auth is still loading\n      if (authLoading) {\n        setLoading(false);\n        return;\n      }\n      \n      // Don't fetch if not authenticated\n      if (!token) {\n        setError('Authentication required');\n        setLoading(false);\n        return;\n      }\n\n      const params = new URLSearchParams();\n      if (category) params.append('category', category);\n      params.append('limit', limit.toString());\n      params.append('offset', append ? String(offset) : '0');\n\n      const data = await fetchAPI<{ posts: Post[] }>(\n        `/api/posts?${params.toString()}`,\n        { \n          token,\n          cacheTTL: 15000, // Reduced to 15 seconds for faster initial load\n        }\n      );\n        \n      if (append) {\n        setPosts(prev => [...prev, ...data.posts]);\n      } else {\n        setPosts(data.posts);\n      }\n      \n      setHasMore(data.posts.length === limit);\n      setOffset(prev => append ? prev + data.posts.length : data.posts.length);\n      setError(null);\n    } catch (err: any) {\n      setError(err.message || 'Failed to fetch posts');\n      console.error('Error fetching posts:', err);\n    } finally {\n      setLoading(false);\n    }\n  }, [category, limit, token, authLoading, offset]);\n\n  const loadMore = useCallback(() => {\n    if (!loading && hasMore) {\n      fetchPosts(true);\n    }\n  }, [loading, hasMore, fetchPosts]);\n\n  const refetch = useCallback(() => {\n    setOffset(0);\n    setHasMore(true);\n    fetchPosts(false);\n  }, [fetchPosts]);\n\n  useEffect(() => {\n    // Only fetch when auth is not loading\n    if (!authLoading) {\n      setOffset(0);\n      setHasMore(true);\n      fetchPosts(false);\n    }\n  }, [category, limit, token, authLoading]);\n\n  // Listen for new posts\n  useEffect(() => {\n    const handleNewPost = (event: CustomEvent) => {\n      const newPost = event.detail;\n      setPosts(prevPosts => [newPost, ...prevPosts]);\n    };\n\n    const handlePostUpdated = (event: CustomEvent) => {\n      const { id, content } = event.detail;\n      setPosts(prevPosts => \n        prevPosts.map(post => \n          post.id === id ? { ...post, content } : post\n        )\n      );\n    };\n\n    const handlePostDeleted = (event: CustomEvent) => {\n      const { id } = event.detail;\n      setPosts(prevPosts => prevPosts.filter(post => post.id !== id));\n    };\n\n    window.addEventListener('postCreated', handleNewPost as EventListener);\n    window.addEventListener('postUpdated', handlePostUpdated as EventListener);\n    window.addEventListener('postDeleted', handlePostDeleted as EventListener);\n    \n    return () => {\n      window.removeEventListener('postCreated', handleNewPost as EventListener);\n      window.removeEventListener('postUpdated', handlePostUpdated as EventListener);\n      window.removeEventListener('postDeleted', handlePostDeleted as EventListener);\n    };\n  }, []);\n\n  return { \n    posts, \n    loading, \n    error, \n    refetch,\n    loadMore,\n    hasMore\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\hooks\\useSearch.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1750,1753],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1750,1753],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback received a function whose dependencies are unknown. Pass an inline function instead.","line":76,"column":27,"nodeType":"Identifier","endLine":76,"endColumn":38}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react';\r\nimport { useAuth } from '../contexts/AuthContext';\r\nimport { fetchAPI, debounce } from '../lib/dataFetcher';\r\n\r\ninterface SearchUser {\r\n  id: number;\r\n  name: string;\r\n  username?: string;\r\n  department: string;\r\n  year: number;\r\n  profile_image?: string;\r\n}\r\n\r\ninterface UseSearchReturn {\r\n  results: SearchUser[];\r\n  loading: boolean;\r\n  error: string | null;\r\n  search: (query: string) => void;\r\n  clearResults: () => void;\r\n}\r\n\r\nexport function useSearch(debounceMs: number = 300): UseSearchReturn {\r\n  const [results, setResults] = useState<SearchUser[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const { token } = useAuth();\r\n  const abortControllerRef = useRef<AbortController | null>(null);\r\n\r\n  const performSearch = useCallback(async (query: string) => {\r\n    if (!query.trim()) {\r\n      setResults([]);\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    if (!token) {\r\n      setError('Authentication required');\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Cancel previous request\r\n      if (abortControllerRef.current) {\r\n        abortControllerRef.current.abort();\r\n      }\r\n\r\n      abortControllerRef.current = new AbortController();\r\n      setLoading(true);\r\n      setError(null);\r\n\r\n      const data = await fetchAPI<{ users: SearchUser[] }>(\r\n        `/api/search?q=${encodeURIComponent(query)}`,\r\n        {\r\n          token,\r\n          cacheTTL: 120000, // Cache search results for 2 minutes\r\n          signal: abortControllerRef.current.signal,\r\n        }\r\n      );\r\n\r\n      setResults(data.users);\r\n      setError(null);\r\n    } catch (err: any) {\r\n      if (err.message !== 'Request cancelled') {\r\n        setError(err.message || 'Search failed');\r\n        console.error('Error searching:', err);\r\n      }\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [token]);\r\n\r\n  // Create debounced search function\r\n  const debouncedSearch = useCallback(\r\n    debounce((query: string) => performSearch(query), debounceMs),\r\n    [performSearch, debounceMs]\r\n  );\r\n\r\n  const search = useCallback((query: string) => {\r\n    setLoading(true);\r\n    debouncedSearch(query);\r\n  }, [debouncedSearch]);\r\n\r\n  const clearResults = useCallback(() => {\r\n    setResults([]);\r\n    setError(null);\r\n    setLoading(false);\r\n  }, []);\r\n\r\n  // Cleanup on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      if (abortControllerRef.current) {\r\n        abortControllerRef.current.abort();\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  return { results, loading, error, search, clearResults };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\hooks\\useUserProfile.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1509,1512],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1509,1512],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { useAuth } from '../contexts/AuthContext';\nimport { fetchAPI } from '../lib/dataFetcher';\n\ninterface Post {\n  id: number;\n  content: string;\n  category: string;\n  media_url?: string;\n  media_type?: string;\n  aura_count: number;\n  created_at: string;\n}\n\ninterface UserProfile {\n  id: number;\n  name: string;\n  email: string;\n  department: string;\n  year: number;\n  role: string;\n  created_at: string;\n  posts: Post[];\n  _count: {\n    posts: number;\n    followers: number;\n    following: number;\n  };\n}\n\ninterface UseUserProfileReturn {\n  profile: UserProfile | null;\n  loading: boolean;\n  error: string | null;\n  refetch: () => void;\n}\n\nexport function useUserProfile(userId: string): UseUserProfileReturn {\n  const [profile, setProfile] = useState<UserProfile | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const { token } = useAuth();\n\n  const fetchProfile = useCallback(async () => {\n    if (!token && userId === 'me') {\n      setError('Authentication required');\n      setLoading(false);\n      return;\n    }\n\n    try {\n      setLoading(true);\n      setError(null);\n\n      const data = await fetchAPI<{ user: UserProfile }>(\n        `/api/users/${userId}`,\n        { \n          token: token || undefined,\n          cacheTTL: 60000, // Cache for 1 minute\n        }\n      );\n      \n      setProfile(data.user);\n      setError(null);\n    } catch (err: any) {\n      setError(err.message || 'Failed to fetch profile');\n      console.error('Error fetching profile:', err);\n    } finally {\n      setLoading(false);\n    }\n  }, [userId, token]);\n\n  useEffect(() => {\n    fetchProfile();\n  }, [fetchProfile]);\n\n  return { profile, loading, error, refetch: fetchProfile };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\jest.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\jest.setup.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":37}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"require('@testing-library/jest-dom')\r\n\r\n// Mock environment variables for tests\r\nprocess.env.JWT_SECRET = 'test-secret-key-at-least-32-characters-long'\r\nprocess.env.MONGODB_URI = 'mongodb://localhost:27017/test'\r\nprocess.env.MONGODB_DB_NAME = 'test'\r\nprocess.env.NODE_ENV = 'test'\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\lib\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\lib\\dataFetcher.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[577,580],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[577,580],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[639,642],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[639,642],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":207,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":207,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6291,6294],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6291,6294],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":325,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":325,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9672,9675],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9672,9675],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":325,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":325,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9682,9685],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9682,9685],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":339,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10027,10030],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10027,10030],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":339,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10037,10040],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10037,10040],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Advanced Data Fetching Utilities for UNI-X\r\n * \r\n * Features:\r\n * - Request caching with TTL\r\n * - Request deduplication\r\n * - Automatic retry on failure\r\n * - Request cancellation\r\n * - Type-safe responses\r\n */\r\n\r\ninterface CacheEntry<T> {\r\n  data: T;\r\n  timestamp: number;\r\n  expiresAt: number;\r\n}\r\n\r\ninterface FetchOptions extends RequestInit {\r\n  cacheTTL?: number; // Time to live in milliseconds\r\n  skipCache?: boolean;\r\n  retries?: number;\r\n  retryDelay?: number;\r\n  timeout?: number;\r\n}\r\n\r\nclass DataFetchManager {\r\n  private cache = new Map<string, CacheEntry<any>>();\r\n  private pendingRequests = new Map<string, Promise<any>>();\r\n  private abortControllers = new Map<string, AbortController>();\r\n\r\n  /**\r\n   * Generate a cache key from URL and options\r\n   */\r\n  private getCacheKey(url: string, options?: FetchOptions): string {\r\n    const method = options?.method || 'GET';\r\n    const body = options?.body ? JSON.stringify(options.body) : '';\r\n    return `${method}:${url}:${body}`;\r\n  }\r\n\r\n  /**\r\n   * Check if cached data is still valid\r\n   */\r\n  private isCacheValid<T>(entry: CacheEntry<T>): boolean {\r\n    return Date.now() < entry.expiresAt;\r\n  }\r\n\r\n  /**\r\n   * Get data from cache if valid\r\n   */\r\n  private getFromCache<T>(key: string): T | null {\r\n    const entry = this.cache.get(key);\r\n    if (entry && this.isCacheValid(entry)) {\r\n      return entry.data;\r\n    }\r\n    if (entry) {\r\n      this.cache.delete(key);\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Store data in cache\r\n   */\r\n  private setCache<T>(key: string, data: T, ttl: number): void {\r\n    this.cache.set(key, {\r\n      data,\r\n      timestamp: Date.now(),\r\n      expiresAt: Date.now() + ttl,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear specific cache entry or all cache\r\n   */\r\n  clearCache(url?: string): void {\r\n    if (url) {\r\n      const keysToDelete = Array.from(this.cache.keys()).filter(key => key.includes(url));\r\n      keysToDelete.forEach(key => this.cache.delete(key));\r\n    } else {\r\n      this.cache.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cancel pending request\r\n   */\r\n  cancelRequest(url: string): void {\r\n    const controller = this.abortControllers.get(url);\r\n    if (controller) {\r\n      controller.abort();\r\n      this.abortControllers.delete(url);\r\n      this.pendingRequests.delete(url);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Main fetch method with caching and deduplication\r\n   */\r\n  async fetch<T>(url: string, options: FetchOptions = {}): Promise<T> {\r\n    const {\r\n      cacheTTL = 60000, // 1 minute default\r\n      skipCache = false,\r\n      retries = 2,\r\n      retryDelay = 1000,\r\n      timeout = 30000,\r\n      ...fetchOptions\r\n    } = options;\r\n\r\n    const cacheKey = this.getCacheKey(url, fetchOptions);\r\n\r\n    // Return cached data if valid\r\n    if (!skipCache && fetchOptions.method !== 'POST' && fetchOptions.method !== 'PUT' && fetchOptions.method !== 'DELETE') {\r\n      const cached = this.getFromCache<T>(cacheKey);\r\n      if (cached !== null) {\r\n        return cached;\r\n      }\r\n    }\r\n\r\n    // Return pending request if exists (deduplication)\r\n    if (this.pendingRequests.has(cacheKey)) {\r\n      return this.pendingRequests.get(cacheKey);\r\n    }\r\n\r\n    // Create new request with abort controller\r\n    const controller = new AbortController();\r\n    this.abortControllers.set(cacheKey, controller);\r\n\r\n    // Add timeout\r\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n\r\n    const requestPromise = this.performFetch<T>(\r\n      url,\r\n      { ...fetchOptions, signal: controller.signal },\r\n      retries,\r\n      retryDelay\r\n    )\r\n      .then((data) => {\r\n        // Cache successful GET requests\r\n        if (!skipCache && (!fetchOptions.method || fetchOptions.method === 'GET')) {\r\n          this.setCache(cacheKey, data, cacheTTL);\r\n        }\r\n        return data;\r\n      })\r\n      .finally(() => {\r\n        clearTimeout(timeoutId);\r\n        this.pendingRequests.delete(cacheKey);\r\n        this.abortControllers.delete(cacheKey);\r\n      });\r\n\r\n    this.pendingRequests.set(cacheKey, requestPromise);\r\n    return requestPromise;\r\n  }\r\n\r\n  /**\r\n   * Perform the actual fetch with retry logic\r\n   */\r\n  private async performFetch<T>(\r\n    url: string,\r\n    options: RequestInit,\r\n    retries: number,\r\n    retryDelay: number\r\n  ): Promise<T> {\r\n    let lastError: Error | null = null;\r\n\r\n    for (let attempt = 0; attempt <= retries; attempt++) {\r\n      try {\r\n        const response = await fetch(url, options);\r\n\r\n        if (!response.ok) {\r\n          // Don't retry on client errors (4xx)\r\n          if (response.status >= 400 && response.status < 500) {\r\n            const error = await response.json().catch(() => ({ error: 'Request failed' }));\r\n\r\n            // Special handling for 401 Unauthorized - clear invalid token\r\n            if (response.status === 401) {\r\n              console.error('≡ƒöÆ Unauthorized request to:', url);\r\n              console.error('Auth header present:', !!options.headers?.['Authorization' as keyof typeof options.headers]);\r\n\r\n              // Only trigger logout for critical auth endpoints (not all 401s)\r\n              // This prevents premature logout on temporary issues\r\n              const criticalAuthEndpoints = ['/api/auth/validate', '/api/users/me'];\r\n              const isCriticalEndpoint = criticalAuthEndpoints.some(endpoint => url.includes(endpoint));\r\n\r\n              if (isCriticalEndpoint && typeof window !== 'undefined') {\r\n                const token = localStorage.getItem('token');\r\n                if (token) {\r\n                  console.warn('ΓÜá∩╕Å Session expired on critical endpoint - logging out');\r\n                  localStorage.removeItem('token');\r\n                  localStorage.removeItem('user');\r\n                  // Dispatch custom event to trigger logout\r\n                  window.dispatchEvent(new CustomEvent('unauthorized'));\r\n                }\r\n              } else {\r\n                console.warn('ΓÜá∩╕Å 401 on non-critical endpoint, not logging out:', url);\r\n              }\r\n            }\r\n\r\n            throw new Error(error.error || `HTTP ${response.status}`);\r\n          }\r\n\r\n          // Retry on server errors (5xx)\r\n          throw new Error(`HTTP ${response.status}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        return data;\r\n      } catch (error: any) {\r\n        lastError = error;\r\n\r\n        // Don't retry if aborted\r\n        if (error.name === 'AbortError') {\r\n          throw new Error('Request cancelled');\r\n        }\r\n\r\n        // Don't retry on last attempt\r\n        if (attempt === retries) {\r\n          break;\r\n        }\r\n\r\n        // Wait before retrying with exponential backoff\r\n        await new Promise(resolve => setTimeout(resolve, retryDelay * Math.pow(2, attempt)));\r\n      }\r\n    }\r\n\r\n    throw lastError || new Error('Request failed');\r\n  }\r\n\r\n  /**\r\n   * Batch multiple requests with token support\r\n   */\r\n  async fetchBatch<T>(requests: Array<{ url: string; options?: FetchOptions & { token?: string } }>): Promise<T[]> {\r\n    return Promise.all(requests.map(req => {\r\n      const { token, ...fetchOptions } = req.options || {};\r\n\r\n      // Add Authorization header if token is provided\r\n      const headers: Record<string, string> = {\r\n        'Content-Type': 'application/json',\r\n        ...(fetchOptions.headers as Record<string, string> || {}),\r\n      };\r\n\r\n      if (token) {\r\n        if (token.length < 20) {\r\n          console.error('≡ƒöÆ Invalid token format in batch request (too short)');\r\n          throw new Error('Invalid authentication token');\r\n        }\r\n        headers['Authorization'] = `Bearer ${token}`;\r\n      } else {\r\n        console.warn('ΓÜá∩╕Å No token provided for batch request to:', req.url);\r\n      }\r\n\r\n      return this.fetch<T>(req.url, {\r\n        ...fetchOptions,\r\n        headers,\r\n      });\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Prefetch data for future use\r\n   */\r\n  prefetch(url: string, options?: FetchOptions): void {\r\n    this.fetch(url, options).catch(() => {\r\n      // Silently fail prefetch requests\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get cache statistics\r\n   */\r\n  getCacheStats() {\r\n    return {\r\n      size: this.cache.size,\r\n      pendingRequests: this.pendingRequests.size,\r\n      entries: Array.from(this.cache.entries()).map(([key, value]) => ({\r\n        key,\r\n        age: Date.now() - value.timestamp,\r\n        ttl: value.expiresAt - Date.now(),\r\n      })),\r\n    };\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const dataFetcher = new DataFetchManager();\r\n\r\n/**\r\n * Convenience wrapper for authenticated requests\r\n */\r\nexport async function fetchAPI<T>(\r\n  endpoint: string,\r\n  options: FetchOptions & { token?: string } = {}\r\n): Promise<T> {\r\n  const { token, ...fetchOptions } = options;\r\n\r\n  // Check if body is FormData (file upload)\r\n  const isFormData = fetchOptions.body instanceof FormData;\r\n\r\n  const headers: Record<string, string> = {\r\n    // Only set Content-Type for non-FormData requests\r\n    // For FormData, browser will set correct multipart/form-data with boundary\r\n    ...(isFormData ? {} : { 'Content-Type': 'application/json' }),\r\n    ...(fetchOptions.headers as Record<string, string>),\r\n  };\r\n\r\n  if (token) {\r\n    // Validate token format before sending\r\n    if (token.length < 20) {\r\n      console.error('≡ƒöÆ Invalid token format (too short)');\r\n      throw new Error('Invalid authentication token');\r\n    }\r\n    headers['Authorization'] = `Bearer ${token}`;\r\n  } else {\r\n    console.warn('ΓÜá∩╕Å No token provided for request to:', endpoint);\r\n  }\r\n\r\n  return dataFetcher.fetch<T>(endpoint, {\r\n    ...fetchOptions,\r\n    headers,\r\n  });\r\n}\r\n\r\n/**\r\n * Debounce function for search/filter operations\r\n */\r\nexport function debounce<T extends (...args: any[]) => any>(\r\n  func: T,\r\n  wait: number\r\n): (...args: Parameters<T>) => void {\r\n  let timeout: NodeJS.Timeout;\r\n  return (...args: Parameters<T>) => {\r\n    clearTimeout(timeout);\r\n    timeout = setTimeout(() => func(...args), wait);\r\n  };\r\n}\r\n\r\n/**\r\n * Throttle function for scroll/resize operations\r\n */\r\nexport function throttle<T extends (...args: any[]) => any>(\r\n  func: T,\r\n  limit: number\r\n): (...args: Parameters<T>) => void {\r\n  let inThrottle: boolean;\r\n  return (...args: Parameters<T>) => {\r\n    if (!inThrottle) {\r\n      func(...args);\r\n      inThrottle = true;\r\n      setTimeout(() => (inThrottle = false), limit);\r\n    }\r\n  };\r\n}\r\n\r\nexport default dataFetcher;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\lib\\mongodb.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":30,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":30,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1971,1974],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1971,1974],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":103,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3482,3485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3482,3485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":285,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":285,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9155,9158],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9155,9158],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":295,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":295,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9472,9475],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9472,9475],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":300,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":300,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9586,9589],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9586,9589],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":419,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":419,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14198,14201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14198,14201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":422,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":422,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14254,14257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14254,14257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":439,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":439,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14780,14783],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14780,14783],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MongoClient, Db, Collection, ObjectId, WithId, Document } from 'mongodb'\r\n\r\n// MongoDB Connection URI - Validate format\r\nconst MONGODB_URI = process.env.MONGODB_URI || process.env.DATABASE_URL || ''\r\nconst DB_NAME = process.env.MONGODB_DB_NAME || 'unix'\r\n\r\nif (!MONGODB_URI) {\r\n  throw new Error('Please define MONGODB_URI or DATABASE_URL environment variable')\r\n}\r\n\r\n// Validate MongoDB URI format for security\r\nif (!MONGODB_URI.startsWith('mongodb://') && !MONGODB_URI.startsWith('mongodb+srv://')) {\r\n  throw new Error('Invalid MongoDB URI format. Must start with mongodb:// or mongodb+srv://')\r\n}\r\n\r\n// Global cached connection with connection pooling\r\nlet cachedClient: MongoClient | null = null\r\nlet cachedDb: Db | null = null\r\nlet connectionAttempts = 0\r\nconst MAX_RETRY_ATTEMPTS = 3\r\nlet isConnecting = false\r\n\r\n// Connect to MongoDB with enhanced security and performance\r\nexport async function connectToDatabase(): Promise<{ client: MongoClient; db: Db }> {\r\n  // Return cached connection if available\r\n  if (cachedClient && cachedDb && !isConnecting) {\r\n    try {\r\n      // Quick check - just return cached connection\r\n      return { client: cachedClient, db: cachedDb }\r\n    } catch (error) {\r\n      console.warn('ΓÜá∩╕Å Cached MongoDB connection error, reconnecting...')\r\n      cachedClient = null\r\n      cachedDb = null\r\n    }\r\n  }\r\n\r\n  // Prevent multiple simultaneous connection attempts\r\n  if (isConnecting) {\r\n    await new Promise(resolve => setTimeout(resolve, 1000))\r\n    if (cachedClient && cachedDb) {\r\n      return { client: cachedClient, db: cachedDb }\r\n    }\r\n  }\r\n\r\n  isConnecting = true\r\n\r\n  // Retry logic for connection\r\n  while (connectionAttempts < MAX_RETRY_ATTEMPTS) {\r\n    try {\r\n      connectionAttempts++\r\n      \r\n      // Check if using local MongoDB\r\n      const isLocalMongo = MONGODB_URI.includes('127.0.0.1') || MONGODB_URI.includes('localhost')\r\n      \r\n      // Enhanced connection options\r\n      const connectionOptions: any = {\r\n        // Connection pool settings\r\n        maxPoolSize: process.env.NODE_ENV === 'production' ? 10 : 5,\r\n        minPoolSize: 1,\r\n        maxIdleTimeMS: 30000,\r\n        \r\n        // Timeout settings - more lenient for Atlas with better DNS handling\r\n        serverSelectionTimeoutMS: 30000, // Increased from 10s to 30s for better Atlas compatibility\r\n        socketTimeoutMS: 45000,\r\n        connectTimeoutMS: 30000, // Increased from 10s to 30s\r\n        \r\n        // Reliability\r\n        retryWrites: true,\r\n        retryReads: true,\r\n        \r\n        // Compression for better performance\r\n        compressors: ['zlib'],\r\n      }\r\n      \r\n      // SSL/TLS options for Atlas\r\n      if (!isLocalMongo) {\r\n        Object.assign(connectionOptions, {\r\n          tls: true,\r\n          // For production, enforce strict TLS validation\r\n          tlsAllowInvalidCertificates: false,\r\n          tlsAllowInvalidHostnames: false,\r\n        })\r\n      } else {\r\n        connectionOptions.directConnection = true\r\n      }\r\n      \r\n      const client = await MongoClient.connect(MONGODB_URI, connectionOptions)\r\n      const db = client.db(DB_NAME)\r\n\r\n      // Verify connection with ping\r\n      await db.admin().ping()\r\n\r\n      // Cache the connection\r\n      cachedClient = client\r\n      cachedDb = db\r\n      connectionAttempts = 0 // Reset on success\r\n      isConnecting = false\r\n\r\n      console.log('Γ£à Connected to MongoDB database:', DB_NAME)\r\n      \r\n      return { client, db }\r\n      \r\n    } catch (error: any) {\r\n      console.error(`Γ¥î MongoDB connection attempt ${connectionAttempts} failed:`, error.message)\r\n      \r\n      if (connectionAttempts >= MAX_RETRY_ATTEMPTS) {\r\n        connectionAttempts = 0 // Reset for next attempt\r\n        isConnecting = false\r\n        \r\n        // Provide helpful error messages\r\n        if (error.message?.includes('ENOTFOUND') || error.message?.includes('ECONNREFUSED') || error.message?.includes('querySrv')) {\r\n          console.error('≡ƒÆí DNS resolution failed. Possible solutions:')\r\n          console.error('   1. Check your internet connection')\r\n          console.error('   2. Try using Google DNS (8.8.8.8) or Cloudflare DNS (1.1.1.1)')\r\n          console.error('   3. Check if VPN/proxy is blocking MongoDB Atlas')\r\n          console.error('   4. Verify MongoDB URI is correct')\r\n          console.error('   5. Try flushing DNS cache: ipconfig /flushdns')\r\n        } else if (error.message?.includes('ETIMEDOUT')) {\r\n          console.error('≡ƒÆí Connection timed out. Check if your IP is whitelisted in MongoDB Atlas.')\r\n        } else if (error.message?.includes('SSL') || error.message?.includes('TLS')) {\r\n          console.error('≡ƒÆí SSL/TLS error. Try:')\r\n          console.error('   1. Check if MongoDB Atlas cluster is running')\r\n          console.error('   2. Verify your IP is whitelisted (or use 0.0.0.0/0 for testing)')\r\n          console.error('   3. Check your network firewall settings')\r\n        } else if (error.message?.includes('Authentication failed')) {\r\n          console.error('≡ƒÆí Authentication failed. Check your MongoDB username and password.')\r\n        }\r\n        \r\n        throw error\r\n      }\r\n      \r\n      // Wait before retry (exponential backoff)\r\n      await new Promise(resolve => setTimeout(resolve, Math.pow(2, connectionAttempts) * 1000))\r\n    }\r\n  }\r\n  \r\n  throw new Error('Failed to connect to MongoDB after maximum retry attempts')\r\n}\r\n\r\n// Get database instance\r\nexport async function getDb(): Promise<Db> {\r\n  const { db } = await connectToDatabase()\r\n  return db\r\n}\r\n\r\n// Collection helpers\r\nexport async function getCollection<T extends Document = Document>(name: string): Promise<Collection<T>> {\r\n  const db = await getDb()\r\n  return db.collection<T>(name)\r\n}\r\n\r\n// Type definitions for collections\r\nexport interface User {\r\n  _id?: ObjectId\r\n  id?: number\r\n  college_id: string\r\n  username?: string\r\n  username_changed_at?: Date\r\n  email?: string\r\n  password_hash: string\r\n  name: string\r\n  department: string\r\n  year: number\r\n  bio?: string\r\n  profile_image?: string\r\n  is_private: boolean\r\n  is_deactivated?: boolean\r\n  deactivated_at?: Date\r\n  followers_count: number\r\n  following_count: number\r\n  created_at: Date\r\n  // Privacy settings\r\n  show_online_status?: boolean\r\n  show_read_receipts?: boolean\r\n  who_can_message?: 'everyone' | 'followers'\r\n  who_can_comment?: 'everyone' | 'followers'\r\n}\r\n\r\nexport interface Post {\r\n  _id?: ObjectId\r\n  id?: number\r\n  user_id: number | ObjectId\r\n  caption?: string\r\n  media_url: string\r\n  media_type: 'IMAGE' | 'VIDEO' | 'NONE'\r\n  category: 'INTERNSHIP' | 'WORKSHOP' | 'LIBRARY_MEMORY' | 'ACADEMIC' | 'EVENT' | 'EVENTS' | 'CLUBS' | 'SPORTS' | 'SOCIAL' | 'GENERAL'\r\n  created_at: Date\r\n}\r\n\r\nexport interface Aura {\r\n  _id?: ObjectId\r\n  id?: number\r\n  user_id: number | ObjectId\r\n  post_id: number | ObjectId\r\n  created_at: Date\r\n}\r\n\r\nexport interface Comment {\r\n  _id?: ObjectId\r\n  id?: number\r\n  post_id: number | ObjectId\r\n  user_id: number | ObjectId\r\n  comment_text: string\r\n  created_at: Date\r\n  parent_id?: number | ObjectId\r\n}\r\n\r\nexport interface CommentLike {\r\n  _id?: ObjectId\r\n  id?: number\r\n  user_id: number | ObjectId\r\n  comment_id: number | ObjectId\r\n  created_at: Date\r\n}\r\n\r\nexport interface Follower {\r\n  _id?: ObjectId\r\n  id?: number\r\n  follower_id: number | ObjectId\r\n  following_id: number | ObjectId\r\n  created_at: Date\r\n}\r\n\r\nexport interface FollowRequest {\r\n  _id?: ObjectId\r\n  id?: number\r\n  requester_id: number | ObjectId\r\n  target_id: number | ObjectId\r\n  created_at: Date\r\n}\r\n\r\nexport interface Message {\r\n  _id?: ObjectId\r\n  id?: number\r\n  sender_id: number | ObjectId\r\n  receiver_id: number | ObjectId\r\n  message_text: string\r\n  media_url?: string\r\n  reaction?: string | null\r\n  reply_to_id?: number | null\r\n  deleted_for?: number[] // Array of user IDs who deleted this message\r\n  created_at: Date\r\n}\r\n\r\nexport interface PasswordReset {\r\n  _id?: ObjectId\r\n  id?: number\r\n  user_id: number | ObjectId\r\n  token: string\r\n  expires_at: Date\r\n  used: boolean\r\n  created_at: Date\r\n}\r\n\r\n// Collection names\r\nexport const Collections = {\r\n  USERS: 'users',\r\n  POSTS: 'posts',\r\n  AURAS: 'auras',\r\n  COMMENTS: 'comments',\r\n  COMMENT_LIKES: 'comment_likes',\r\n  FOLLOWERS: 'followers',\r\n  FOLLOW_REQUESTS: 'follow_requests',\r\n  MESSAGES: 'messages',\r\n  PASSWORD_RESETS: 'password_resets',\r\n  CLUBS: 'clubs',\r\n  CLUB_MEMBERS: 'club_members',\r\n  CLUB_DISCUSSIONS: 'club_discussions',\r\n  CLUB_COMMENTS: 'club_comments',\r\n  BLOCKS: 'blocks',\r\n}\r\n\r\n// Helper function to get next sequential ID\r\nexport async function getNextSequenceValue(sequenceName: string): Promise<number> {\r\n  const db = await getDb()\r\n  const counters = db.collection<{ _id: string; sequence_value: number }>('counters')\r\n  \r\n  const result = await counters.findOneAndUpdate(\r\n    { _id: sequenceName },\r\n    { $inc: { sequence_value: 1 } },\r\n    { upsert: true, returnDocument: 'after' }\r\n  ) as WithId<{ _id: string; sequence_value: number }> | { value?: WithId<{ _id: string; sequence_value: number }> } | null\r\n  \r\n  // Support both typings: some driver versions return the document directly, others return { value: document }.\r\n  const doc = (result as any)?.value ?? result\r\n  return (doc as { sequence_value: number } )?.sequence_value ?? 1\r\n}\r\n\r\n// Retry logic for operations (similar to Prisma's withRetry)\r\nexport async function withRetry<T>(\r\n  operation: () => Promise<T>,\r\n  maxRetries: number = 3,\r\n  baseDelay: number = 1000\r\n): Promise<T> {\r\n  let lastError: any\r\n  \r\n  for (let i = 0; i < maxRetries; i++) {\r\n    try {\r\n      return await operation()\r\n    } catch (error: any) {\r\n      lastError = error\r\n      console.error(`MongoDB operation failed (attempt ${i + 1}/${maxRetries}):`, error.message)\r\n      \r\n      const shouldRetry = (\r\n        error.code === 'ETIMEDOUT' ||\r\n        error.code === 'ECONNRESET' ||\r\n        error.code === 'ECONNREFUSED' ||\r\n        error.message?.includes('timeout') ||\r\n        error.message?.includes('connection') ||\r\n        error.message?.includes('SSL') ||\r\n        error.message?.includes('TLS') ||\r\n        error.message?.includes('EHOSTUNREACH') ||\r\n        error.message?.includes('ENOTFOUND')\r\n      ) && i < maxRetries - 1\r\n      \r\n      if (shouldRetry) {\r\n        // Clear cached connection on connection errors\r\n        if (error.message?.includes('connection') || error.message?.includes('SSL') || error.message?.includes('TLS')) {\r\n          cachedClient = null\r\n          cachedDb = null\r\n          console.log('≡ƒöä Cleared cached MongoDB connection')\r\n        }\r\n        \r\n        const delay = baseDelay * Math.pow(2, i) + Math.random() * 1000\r\n        console.log(`ΓÅ│ Retrying MongoDB operation in ${Math.round(delay)}ms...`)\r\n        await new Promise(resolve => setTimeout(resolve, delay))\r\n        continue\r\n      }\r\n      \r\n      throw error\r\n    }\r\n  }\r\n  \r\n  throw lastError\r\n}\r\n\r\n// Ensure database connection\r\nexport async function ensureDatabaseConnection(): Promise<boolean> {\r\n  try {\r\n    const db = await getDb()\r\n    await db.admin().ping()\r\n    return true\r\n  } catch (error) {\r\n    console.error('Database connection check failed:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n// Initialize indexes for better performance\r\nexport async function initializeIndexes(): Promise<void> {\r\n  try {\r\n    const db = await getDb()\r\n    \r\n    // Users indexes\r\n    const users = db.collection(Collections.USERS)\r\n    await users.createIndex({ college_id: 1 }, { unique: true })\r\n    await users.createIndex({ username: 1 }, { unique: true, sparse: true })\r\n    await users.createIndex({ email: 1 }, { unique: true, sparse: true })\r\n    await users.createIndex({ name: 'text', username: 'text' })\r\n    \r\n    // Posts indexes\r\n    const posts = db.collection(Collections.POSTS)\r\n    await posts.createIndex({ user_id: 1 })\r\n    await posts.createIndex({ category: 1 })\r\n    await posts.createIndex({ created_at: -1 })\r\n    \r\n    // Auras indexes\r\n    const auras = db.collection(Collections.AURAS)\r\n    await auras.createIndex({ user_id: 1, post_id: 1 }, { unique: true })\r\n    await auras.createIndex({ post_id: 1 })\r\n    \r\n    // Comments indexes\r\n    const comments = db.collection(Collections.COMMENTS)\r\n    await comments.createIndex({ post_id: 1 })\r\n    await comments.createIndex({ user_id: 1 })\r\n    await comments.createIndex({ parent_id: 1 })\r\n    \r\n    // Comment Likes indexes\r\n    const commentLikes = db.collection(Collections.COMMENT_LIKES)\r\n    await commentLikes.createIndex({ user_id: 1, comment_id: 1 }, { unique: true })\r\n    \r\n    // Followers indexes\r\n    const followers = db.collection(Collections.FOLLOWERS)\r\n    await followers.createIndex({ follower_id: 1, following_id: 1 }, { unique: true })\r\n    await followers.createIndex({ follower_id: 1 })\r\n    await followers.createIndex({ following_id: 1 })\r\n    \r\n    // Follow Requests indexes\r\n    const followRequests = db.collection(Collections.FOLLOW_REQUESTS)\r\n    await followRequests.createIndex({ requester_id: 1, target_id: 1 }, { unique: true })\r\n    await followRequests.createIndex({ target_id: 1 })\r\n    \r\n    // Messages indexes\r\n    const messages = db.collection(Collections.MESSAGES)\r\n    await messages.createIndex({ sender_id: 1, receiver_id: 1 })\r\n    await messages.createIndex({ created_at: -1 })\r\n    \r\n    // Password Resets indexes\r\n    const passwordResets = db.collection(Collections.PASSWORD_RESETS)\r\n    await passwordResets.createIndex({ token: 1 }, { unique: true })\r\n    await passwordResets.createIndex({ user_id: 1 })\r\n    await passwordResets.createIndex({ expires_at: 1 })\r\n    \r\n    console.log('Γ£à MongoDB indexes initialized')\r\n  } catch (error) {\r\n    console.error('Error initializing indexes:', error)\r\n  }\r\n}\r\n\r\n// Helper to convert ObjectId to number (for compatibility with existing code)\r\nexport function toNumber(value: ObjectId | number | undefined): number | undefined {\r\n  if (value === undefined) return undefined\r\n  if (typeof value === 'number') return value\r\n  // Use timestamp portion of ObjectId as numeric ID\r\n  return parseInt(value.toString().substring(0, 8), 16)\r\n}\r\n\r\n// Helper to serialize MongoDB documents for API responses\r\nexport function serializeDoc<T extends Document>(doc: WithId<T> | null): any {\r\n  if (!doc) return null\r\n  \r\n  const serialized: any = {}\r\n  for (const [key, value] of Object.entries(doc)) {\r\n    if (key === '_id') {\r\n      // Convert _id to id\r\n      const objId = value as ObjectId\r\n      serialized.id = toNumber(objId) || objId.toString()\r\n    } else if (value instanceof ObjectId) {\r\n      serialized[key] = toNumber(value)\r\n    } else if (value instanceof Date) {\r\n      serialized[key] = value\r\n    } else {\r\n      serialized[key] = value\r\n    }\r\n  }\r\n  return serialized\r\n}\r\n\r\nexport function serializeDocs<T extends Document>(docs: WithId<T>[]): any[] {\r\n  return docs.map(serializeDoc)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\lib\\redis.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":129,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":129,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3368,3371],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3368,3371],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":184,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4856,4859],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4856,4859],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":202,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":202,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5341,5344],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5341,5344],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":218,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":218,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5759,5762],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5759,5762],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":229,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6024,6027],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6024,6027],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from 'redis'\r\n\r\ntype RedisClient = ReturnType<typeof createClient>\r\n\r\n// Redis client instance\r\nlet redisClient: RedisClient | null = null\r\nlet isConnecting = false\r\n\r\n// In-memory fallback for rate limiting when Redis is not available\r\nclass InMemoryStore {\r\n  private store: Map<string, { count: number; resetTime: number }> = new Map()\r\n  \r\n  async get(key: string): Promise<number | null> {\r\n    const entry = this.store.get(key)\r\n    if (!entry) return null\r\n    \r\n    // Check if expired\r\n    if (Date.now() > entry.resetTime) {\r\n      this.store.delete(key)\r\n      return null\r\n    }\r\n    \r\n    return entry.count\r\n  }\r\n  \r\n  async set(key: string, value: number, ttlSeconds: number): Promise<void> {\r\n    this.store.set(key, {\r\n      count: value,\r\n      resetTime: Date.now() + ttlSeconds * 1000\r\n    })\r\n  }\r\n  \r\n  async incr(key: string): Promise<number> {\r\n    const entry = this.store.get(key)\r\n    if (!entry || Date.now() > entry.resetTime) {\r\n      return 1\r\n    }\r\n    entry.count++\r\n    return entry.count\r\n  }\r\n  \r\n  async expire(key: string, seconds: number): Promise<void> {\r\n    const entry = this.store.get(key)\r\n    if (entry) {\r\n      entry.resetTime = Date.now() + seconds * 1000\r\n    }\r\n  }\r\n  \r\n  // Cleanup expired entries periodically\r\n  startCleanup() {\r\n    setInterval(() => {\r\n      const now = Date.now()\r\n      for (const [key, entry] of this.store.entries()) {\r\n        if (now > entry.resetTime) {\r\n          this.store.delete(key)\r\n        }\r\n      }\r\n    }, 60000) // Clean up every minute\r\n  }\r\n}\r\n\r\nconst inMemoryStore = new InMemoryStore()\r\ninMemoryStore.startCleanup()\r\n\r\n// Connect to Redis\r\nexport async function connectToRedis(): Promise<RedisClient | null> {\r\n  const REDIS_URL = process.env.REDIS_URL\r\n  \r\n  // If no Redis URL, use in-memory store\r\n  if (!REDIS_URL) {\r\n    console.log('ΓÜá∩╕Å No REDIS_URL configured, using in-memory rate limiting (not recommended for production)')\r\n    return null\r\n  }\r\n  \r\n  // Return cached connection\r\n  if (redisClient?.isOpen) {\r\n    return redisClient\r\n  }\r\n  \r\n  // Prevent multiple simultaneous connection attempts\r\n  if (isConnecting) {\r\n    await new Promise(resolve => setTimeout(resolve, 1000))\r\n    if (redisClient?.isOpen) {\r\n      return redisClient\r\n    }\r\n    return null\r\n  }\r\n  \r\n  isConnecting = true\r\n  \r\n  try {\r\n    const client = createClient({\r\n      url: REDIS_URL,\r\n      socket: {\r\n        connectTimeout: 10000,\r\n        reconnectStrategy: (retries) => {\r\n          if (retries > 10) {\r\n            console.error('Γ¥î Redis: Too many reconnection attempts, giving up')\r\n            return new Error('Too many reconnection attempts')\r\n          }\r\n          // Exponential backoff: 100ms, 200ms, 400ms, 800ms, etc. (max 5s)\r\n          return Math.min(retries * 100, 5000)\r\n        }\r\n      }\r\n    })\r\n    \r\n    client.on('error', (err) => {\r\n      console.error('Γ¥î Redis Client Error:', err.message)\r\n    })\r\n    \r\n    client.on('connect', () => {\r\n      console.log('≡ƒöä Redis: Connecting...')\r\n    })\r\n    \r\n    client.on('ready', () => {\r\n      console.log('Γ£à Redis: Connected and ready')\r\n    })\r\n    \r\n    client.on('reconnecting', () => {\r\n      console.log('≡ƒöä Redis: Reconnecting...')\r\n    })\r\n    \r\n    await client.connect()\r\n    \r\n    redisClient = client\r\n    isConnecting = false\r\n    \r\n    return client\r\n  } catch (error: any) {\r\n    console.error('Γ¥î Failed to connect to Redis:', error.message)\r\n    console.log('ΓÜá∩╕Å Falling back to in-memory rate limiting')\r\n    isConnecting = false\r\n    return null\r\n  }\r\n}\r\n\r\n// Rate limiting helper\r\nexport async function checkRateLimit(\r\n  key: string,\r\n  limit: number,\r\n  windowSeconds: number\r\n): Promise<{ allowed: boolean; remaining: number; resetTime: number }> {\r\n  try {\r\n    const client = await connectToRedis()\r\n    \r\n    if (client) {\r\n      // Use Redis for distributed rate limiting\r\n      const count = await client.incr(key)\r\n      \r\n      // Set expiry on first request\r\n      if (count === 1) {\r\n        await client.expire(key, windowSeconds)\r\n      }\r\n      \r\n      const ttl = await client.ttl(key)\r\n      const resetTime = Date.now() + ttl * 1000\r\n      \r\n      return {\r\n        allowed: count <= limit,\r\n        remaining: Math.max(0, limit - count),\r\n        resetTime\r\n      }\r\n    } else {\r\n      // Fallback to in-memory store\r\n      let count = await inMemoryStore.get(key)\r\n      \r\n      if (count === null) {\r\n        count = 0\r\n        await inMemoryStore.set(key, 0, windowSeconds)\r\n      }\r\n      \r\n      count = await inMemoryStore.incr(key)\r\n      \r\n      if (count === 1) {\r\n        await inMemoryStore.expire(key, windowSeconds)\r\n      }\r\n      \r\n      return {\r\n        allowed: count <= limit,\r\n        remaining: Math.max(0, limit - count),\r\n        resetTime: Date.now() + windowSeconds * 1000\r\n      }\r\n    }\r\n  } catch (error: any) {\r\n    console.error('Rate limit check error:', error.message)\r\n    // On error, allow the request (fail open)\r\n    return {\r\n      allowed: true,\r\n      remaining: limit,\r\n      resetTime: Date.now() + windowSeconds * 1000\r\n    }\r\n  }\r\n}\r\n\r\n// Cache helper functions\r\nexport async function cacheGet(key: string): Promise<string | null> {\r\n  try {\r\n    const client = await connectToRedis()\r\n    if (!client) return null\r\n    \r\n    return await client.get(key)\r\n  } catch (error: any) {\r\n    console.error('Cache get error:', error.message)\r\n    return null\r\n  }\r\n}\r\n\r\nexport async function cacheSet(key: string, value: string, ttlSeconds?: number): Promise<void> {\r\n  try {\r\n    const client = await connectToRedis()\r\n    if (!client) return\r\n    \r\n    if (ttlSeconds) {\r\n      await client.setEx(key, ttlSeconds, value)\r\n    } else {\r\n      await client.set(key, value)\r\n    }\r\n  } catch (error: any) {\r\n    console.error('Cache set error:', error.message)\r\n  }\r\n}\r\n\r\nexport async function cacheDelete(key: string): Promise<void> {\r\n  try {\r\n    const client = await connectToRedis()\r\n    if (!client) return\r\n    \r\n    await client.del(key)\r\n  } catch (error: any) {\r\n    console.error('Cache delete error:', error.message)\r\n  }\r\n}\r\n\r\n// Disconnect Redis (for graceful shutdown)\r\nexport async function disconnectRedis(): Promise<void> {\r\n  if (redisClient?.isOpen) {\r\n    await redisClient.quit()\r\n    redisClient = null\r\n    console.log('≡ƒæï Redis: Disconnected')\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\lib\\socialGraph.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Document' is defined but never used.","line":15,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'WithId' is defined but never used.","line":15,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Collection' is defined but never used.","line":15,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":48},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getCollection' is defined but never used.","line":16,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'withRetry' is defined but never used.","line":16,"column":51,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":60},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":232,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8911,8914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8911,8914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Social Graph System for College Social Networking Application\r\n * \r\n * This module implements a graph-based social network structure where:\r\n * - Users are represented as nodes with metadata\r\n * - Relationships (follow/unfollow) are directed edges\r\n * - Edge weights are calculated based on interaction frequency\r\n * \r\n * Performance optimizations:\r\n * - Adjacency list structure for O(1) neighbor lookups\r\n * - Indexed MongoDB collections for fast queries\r\n * - Caching layer for frequently accessed data\r\n */\r\n\r\nimport { ObjectId, Document, WithId, Collection } from 'mongodb'\r\nimport { getDb, getCollection, Collections, User, withRetry } from './mongodb'\r\n\r\n// ============================================================================\r\n// TYPE DEFINITIONS\r\n// ============================================================================\r\n\r\n/**\r\n * User role in the college ecosystem\r\n */\r\nexport type UserRole = 'student' | 'faculty' | 'staff' | 'alumni'\r\n\r\n/**\r\n * Interaction types that affect edge weight\r\n */\r\nexport type InteractionType = 'like' | 'comment' | 'message' | 'share' | 'mention'\r\n\r\n/**\r\n * User node metadata stored in the graph\r\n */\r\nexport interface UserNode {\r\n    userId: string | ObjectId          // Unique identifier\r\n    role: UserRole                      // User's role in the college\r\n    department: string                  // Academic department\r\n    year?: number                       // Year/batch (for students)\r\n    college?: string                    // College identifier (for multi-college support)\r\n    name?: string                       // Display name for quick access\r\n    isActive: boolean                   // Whether account is active\r\n    lastActiveAt?: Date                 // Last activity timestamp\r\n}\r\n\r\n/**\r\n * Edge representing a directed relationship between users\r\n * Stored in MongoDB for persistence\r\n */\r\nexport interface GraphEdge {\r\n    _id?: ObjectId\r\n    sourceUserId: string | ObjectId     // User who initiated the follow\r\n    targetUserId: string | ObjectId     // User being followed\r\n    interactionWeight: number           // Normalized weight (0-1) based on interactions\r\n    lastInteractionTimestamp: Date      // When the last interaction occurred\r\n    interactionCounts: {                // Breakdown of interaction types\r\n        likes: number\r\n        comments: number\r\n        messages: number\r\n        shares: number\r\n        mentions: number\r\n    }\r\n    createdAt: Date                     // When the follow relationship was created\r\n    updatedAt: Date                     // Last update to edge data\r\n}\r\n\r\n/**\r\n * User suggestion with relevance score\r\n */\r\nexport interface UserSuggestion {\r\n    userId: string | ObjectId\r\n    name: string\r\n    department: string\r\n    year?: number\r\n    role: UserRole\r\n    mutualConnectionsCount: number      // Number of mutual connections\r\n    relevanceScore: number              // Computed relevance (0-100)\r\n    connectionPath: string[]            // Path from current user to suggested user\r\n    reason: string                      // Human-readable suggestion reason\r\n}\r\n\r\n/**\r\n * Relationship strength analysis result\r\n */\r\nexport interface RelationshipStrength {\r\n    sourceUserId: string | ObjectId\r\n    targetUserId: string | ObjectId\r\n    isFollowing: boolean                // Does source follow target?\r\n    isFollowedBy: boolean               // Does target follow source?\r\n    isMutual: boolean                   // Is it a mutual follow?\r\n    interactionWeight: number           // Edge weight (0-1)\r\n    strengthCategory: 'strong' | 'moderate' | 'weak' | 'none'\r\n    lastInteraction?: Date\r\n}\r\n\r\n// ============================================================================\r\n// COLLECTION NAME CONSTANTS\r\n// ============================================================================\r\n\r\nexport const GraphCollections = {\r\n    GRAPH_EDGES: 'graph_edges',           // Edge data with interaction weights\r\n    USER_GRAPH_CACHE: 'user_graph_cache', // Cached adjacency lists for fast reads\r\n}\r\n\r\n// ============================================================================\r\n// SOCIAL GRAPH CLASS\r\n// ============================================================================\r\n\r\n/**\r\n * Main SocialGraph class implementing all graph operations\r\n * Uses adjacency list internally with MongoDB backing store\r\n */\r\nexport class SocialGraph {\r\n    // In-memory adjacency list cache for fast lookups\r\n    // Key: userId, Value: Set of followed userIds\r\n    private adjacencyList: Map<string, Set<string>> = new Map()\r\n\r\n    // Reverse adjacency list for follower lookups\r\n    // Key: userId, Value: Set of follower userIds\r\n    private reverseAdjacencyList: Map<string, Set<string>> = new Map()\r\n\r\n    // Cache expiry tracking\r\n    private cacheTimestamps: Map<string, number> = new Map()\r\n    private readonly CACHE_TTL_MS = 5 * 60 * 1000 // 5 minutes cache TTL\r\n\r\n    // --------------------------------------------------------------------------\r\n    // INITIALIZATION\r\n    // --------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Initialize the graph indexes for optimal query performance\r\n     */\r\n    async initializeIndexes(): Promise<void> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection(GraphCollections.GRAPH_EDGES)\r\n\r\n        // Compound index for relationship lookups\r\n        await edgesCollection.createIndex(\r\n            { sourceUserId: 1, targetUserId: 1 },\r\n            { unique: true }\r\n        )\r\n\r\n        // Index for fetching all users someone follows\r\n        await edgesCollection.createIndex({ sourceUserId: 1 })\r\n\r\n        // Index for fetching all followers of a user\r\n        await edgesCollection.createIndex({ targetUserId: 1 })\r\n\r\n        // Index for sorting by interaction weight (heavy/active relationships)\r\n        await edgesCollection.createIndex({ sourceUserId: 1, interactionWeight: -1 })\r\n\r\n        // Index for time-based queries\r\n        await edgesCollection.createIndex({ lastInteractionTimestamp: -1 })\r\n\r\n        console.log('Γ£à Social graph indexes initialized')\r\n    }\r\n\r\n    // --------------------------------------------------------------------------\r\n    // CORE OPERATIONS: FOLLOW/UNFOLLOW\r\n    // --------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Follow a user - creates a directed edge from source to target\r\n     * \r\n     * @param sourceUserId - The user initiating the follow\r\n     * @param targetUserId - The user being followed\r\n     * @returns The created edge document\r\n     */\r\n    async followUser(\r\n        sourceUserId: string | ObjectId,\r\n        targetUserId: string | ObjectId\r\n    ): Promise<GraphEdge> {\r\n        // Prevent self-follow\r\n        if (sourceUserId.toString() === targetUserId.toString()) {\r\n            throw new Error('Users cannot follow themselves')\r\n        }\r\n\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        const now = new Date()\r\n        const newEdge: GraphEdge = {\r\n            sourceUserId: new ObjectId(sourceUserId.toString()),\r\n            targetUserId: new ObjectId(targetUserId.toString()),\r\n            interactionWeight: 0.1, // Initial weight for new connections\r\n            lastInteractionTimestamp: now,\r\n            interactionCounts: {\r\n                likes: 0,\r\n                comments: 0,\r\n                messages: 0,\r\n                shares: 0,\r\n                mentions: 0,\r\n            },\r\n            createdAt: now,\r\n            updatedAt: now,\r\n        }\r\n\r\n        // Use upsert to handle duplicate follow attempts gracefully\r\n        const result = await edgesCollection.findOneAndUpdate(\r\n            {\r\n                sourceUserId: newEdge.sourceUserId,\r\n                targetUserId: newEdge.targetUserId,\r\n            },\r\n            { $setOnInsert: newEdge },\r\n            { upsert: true, returnDocument: 'after' }\r\n        )\r\n\r\n        // Also update the standard followers collection for compatibility\r\n        const followersCollection = db.collection(Collections.FOLLOWERS)\r\n        await followersCollection.updateOne(\r\n            {\r\n                follower_id: newEdge.sourceUserId,\r\n                following_id: newEdge.targetUserId,\r\n            },\r\n            {\r\n                $setOnInsert: {\r\n                    follower_id: newEdge.sourceUserId,\r\n                    following_id: newEdge.targetUserId,\r\n                    created_at: now,\r\n                }\r\n            },\r\n            { upsert: true }\r\n        )\r\n\r\n        // Invalidate cache for both users\r\n        this.invalidateCache(sourceUserId.toString())\r\n        this.invalidateCache(targetUserId.toString())\r\n\r\n        // Update user counts\r\n        await this.updateFollowCounts(sourceUserId, targetUserId, 'increment')\r\n\r\n        return (result as any)?.value ?? (result as GraphEdge)\r\n    }\r\n\r\n    /**\r\n     * Unfollow a user - removes the directed edge from source to target\r\n     * \r\n     * @param sourceUserId - The user initiating the unfollow\r\n     * @param targetUserId - The user being unfollowed\r\n     * @returns Whether the edge was successfully removed\r\n     */\r\n    async unfollowUser(\r\n        sourceUserId: string | ObjectId,\r\n        targetUserId: string | ObjectId\r\n    ): Promise<boolean> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        const result = await edgesCollection.deleteOne({\r\n            sourceUserId: new ObjectId(sourceUserId.toString()),\r\n            targetUserId: new ObjectId(targetUserId.toString()),\r\n        })\r\n\r\n        // Also remove from standard followers collection\r\n        const followersCollection = db.collection(Collections.FOLLOWERS)\r\n        await followersCollection.deleteOne({\r\n            follower_id: new ObjectId(sourceUserId.toString()),\r\n            following_id: new ObjectId(targetUserId.toString()),\r\n        })\r\n\r\n        // Invalidate cache for both users\r\n        this.invalidateCache(sourceUserId.toString())\r\n        this.invalidateCache(targetUserId.toString())\r\n\r\n        // Update user counts\r\n        if (result.deletedCount > 0) {\r\n            await this.updateFollowCounts(sourceUserId, targetUserId, 'decrement')\r\n        }\r\n\r\n        return result.deletedCount > 0\r\n    }\r\n\r\n    /**\r\n     * Update follower/following counts on user documents\r\n     */\r\n    private async updateFollowCounts(\r\n        sourceUserId: string | ObjectId,\r\n        targetUserId: string | ObjectId,\r\n        operation: 'increment' | 'decrement'\r\n    ): Promise<void> {\r\n        const db = await getDb()\r\n        const usersCollection = db.collection(Collections.USERS)\r\n        const delta = operation === 'increment' ? 1 : -1\r\n\r\n        // Update following_count for source user\r\n        await usersCollection.updateOne(\r\n            { _id: new ObjectId(sourceUserId.toString()) },\r\n            { $inc: { following_count: delta } }\r\n        )\r\n\r\n        // Update followers_count for target user\r\n        await usersCollection.updateOne(\r\n            { _id: new ObjectId(targetUserId.toString()) },\r\n            { $inc: { followers_count: delta } }\r\n        )\r\n    }\r\n\r\n    // --------------------------------------------------------------------------\r\n    // QUERY OPERATIONS: FOLLOWERS & FOLLOWING\r\n    // --------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Get all followers of a user (users who follow them)\r\n     * \r\n     * @param userId - The user whose followers to retrieve\r\n     * @param limit - Maximum number of followers to return\r\n     * @param offset - Pagination offset\r\n     * @returns Array of follower user nodes with edge data\r\n     */\r\n    async getFollowers(\r\n        userId: string | ObjectId,\r\n        limit: number = 50,\r\n        offset: number = 0\r\n    ): Promise<{ user: UserNode; edge: GraphEdge }[]> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n        const usersCollection = db.collection<User>(Collections.USERS)\r\n\r\n        // Find all edges where this user is the target (being followed)\r\n        const edges = await edgesCollection\r\n            .find({ targetUserId: new ObjectId(userId.toString()) })\r\n            .sort({ interactionWeight: -1, createdAt: -1 }) // Prioritize strong connections\r\n            .skip(offset)\r\n            .limit(limit)\r\n            .toArray()\r\n\r\n        // Fetch user data for each follower\r\n        const followerIds = edges.map(e => new ObjectId(e.sourceUserId.toString()))\r\n        const users = await usersCollection\r\n            .find({ _id: { $in: followerIds } })\r\n            .toArray()\r\n\r\n        // Map users by ID for quick lookup\r\n        const userMap = new Map(users.map(u => [u._id!.toString(), u]))\r\n\r\n        // Combine user data with edge data\r\n        return edges.map(edge => ({\r\n            user: this.userToNode(userMap.get(edge.sourceUserId.toString())!),\r\n            edge,\r\n        })).filter(item => item.user) // Filter out any missing users\r\n    }\r\n\r\n    /**\r\n     * Get all users that a user is following\r\n     * \r\n     * @param userId - The user whose following list to retrieve\r\n     * @param limit - Maximum number of following to return\r\n     * @param offset - Pagination offset\r\n     * @returns Array of followed user nodes with edge data\r\n     */\r\n    async getFollowing(\r\n        userId: string | ObjectId,\r\n        limit: number = 50,\r\n        offset: number = 0\r\n    ): Promise<{ user: UserNode; edge: GraphEdge }[]> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n        const usersCollection = db.collection<User>(Collections.USERS)\r\n\r\n        // Find all edges where this user is the source (following others)\r\n        const edges = await edgesCollection\r\n            .find({ sourceUserId: new ObjectId(userId.toString()) })\r\n            .sort({ interactionWeight: -1, lastInteractionTimestamp: -1 })\r\n            .skip(offset)\r\n            .limit(limit)\r\n            .toArray()\r\n\r\n        // Fetch user data for each followed user\r\n        const followingIds = edges.map(e => new ObjectId(e.targetUserId.toString()))\r\n        const users = await usersCollection\r\n            .find({ _id: { $in: followingIds } })\r\n            .toArray()\r\n\r\n        // Map users by ID for quick lookup\r\n        const userMap = new Map(users.map(u => [u._id!.toString(), u]))\r\n\r\n        // Combine user data with edge data\r\n        return edges.map(edge => ({\r\n            user: this.userToNode(userMap.get(edge.targetUserId.toString())!),\r\n            edge,\r\n        })).filter(item => item.user)\r\n    }\r\n\r\n    /**\r\n     * Check if sourceUser follows targetUser\r\n     */\r\n    async isFollowing(\r\n        sourceUserId: string | ObjectId,\r\n        targetUserId: string | ObjectId\r\n    ): Promise<boolean> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        const edge = await edgesCollection.findOne({\r\n            sourceUserId: new ObjectId(sourceUserId.toString()),\r\n            targetUserId: new ObjectId(targetUserId.toString()),\r\n        })\r\n\r\n        return edge !== null\r\n    }\r\n\r\n    // --------------------------------------------------------------------------\r\n    // RELATIONSHIP STRENGTH\r\n    // --------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Calculate relationship strength between two users\r\n     * Considers: follow direction, interaction weight, and recency\r\n     * \r\n     * @param sourceUserId - First user\r\n     * @param targetUserId - Second user\r\n     * @returns Detailed relationship analysis\r\n     */\r\n    async getRelationshipStrength(\r\n        sourceUserId: string | ObjectId,\r\n        targetUserId: string | ObjectId\r\n    ): Promise<RelationshipStrength> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        // Check both directions of the relationship\r\n        const [outgoingEdge, incomingEdge] = await Promise.all([\r\n            edgesCollection.findOne({\r\n                sourceUserId: new ObjectId(sourceUserId.toString()),\r\n                targetUserId: new ObjectId(targetUserId.toString()),\r\n            }),\r\n            edgesCollection.findOne({\r\n                sourceUserId: new ObjectId(targetUserId.toString()),\r\n                targetUserId: new ObjectId(sourceUserId.toString()),\r\n            }),\r\n        ])\r\n\r\n        const isFollowing = outgoingEdge !== null\r\n        const isFollowedBy = incomingEdge !== null\r\n        const isMutual = isFollowing && isFollowedBy\r\n\r\n        // Calculate combined interaction weight\r\n        let interactionWeight = 0\r\n        let lastInteraction: Date | undefined\r\n\r\n        if (outgoingEdge) {\r\n            interactionWeight += outgoingEdge.interactionWeight\r\n            lastInteraction = outgoingEdge.lastInteractionTimestamp\r\n        }\r\n        if (incomingEdge) {\r\n            interactionWeight += incomingEdge.interactionWeight\r\n            if (!lastInteraction || incomingEdge.lastInteractionTimestamp > lastInteraction) {\r\n                lastInteraction = incomingEdge.lastInteractionTimestamp\r\n            }\r\n        }\r\n\r\n        // Normalize weight (max 1.0 for both directions)\r\n        interactionWeight = Math.min(interactionWeight / 2, 1)\r\n\r\n        // Categorize relationship strength\r\n        let strengthCategory: 'strong' | 'moderate' | 'weak' | 'none'\r\n        if (!isFollowing && !isFollowedBy) {\r\n            strengthCategory = 'none'\r\n        } else if (isMutual && interactionWeight >= 0.7) {\r\n            strengthCategory = 'strong'\r\n        } else if (isMutual || interactionWeight >= 0.4) {\r\n            strengthCategory = 'moderate'\r\n        } else {\r\n            strengthCategory = 'weak'\r\n        }\r\n\r\n        return {\r\n            sourceUserId,\r\n            targetUserId,\r\n            isFollowing,\r\n            isFollowedBy,\r\n            isMutual,\r\n            interactionWeight,\r\n            strengthCategory,\r\n            lastInteraction,\r\n        }\r\n    }\r\n\r\n    // --------------------------------------------------------------------------\r\n    // EDGE WEIGHT UPDATES\r\n    // --------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Update edge weight based on an interaction\r\n     * Uses exponential decay to prioritize recent interactions\r\n     * \r\n     * @param sourceUserId - User who performed the interaction\r\n     * @param targetUserId - User who received the interaction\r\n     * @param interactionType - Type of interaction\r\n     */\r\n    async updateEdgeWeight(\r\n        sourceUserId: string | ObjectId,\r\n        targetUserId: string | ObjectId,\r\n        interactionType: InteractionType\r\n    ): Promise<void> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        // Weight increments for different interaction types\r\n        const weightIncrements: Record<InteractionType, number> = {\r\n            like: 0.02,\r\n            comment: 0.05,\r\n            message: 0.08,\r\n            share: 0.03,\r\n            mention: 0.04,\r\n        }\r\n\r\n        const increment = weightIncrements[interactionType]\r\n        const countField = `interactionCounts.${interactionType}s` as const\r\n\r\n        // Update the edge with new interaction data\r\n        await edgesCollection.updateOne(\r\n            {\r\n                sourceUserId: new ObjectId(sourceUserId.toString()),\r\n                targetUserId: new ObjectId(targetUserId.toString()),\r\n            },\r\n            {\r\n                $inc: {\r\n                    interactionWeight: increment,\r\n                    [countField]: 1,\r\n                },\r\n                $set: {\r\n                    lastInteractionTimestamp: new Date(),\r\n                    updatedAt: new Date(),\r\n                },\r\n                $min: { interactionWeight: 1.0 }, // Cap at 1.0\r\n            }\r\n        )\r\n\r\n        // Invalidate cache\r\n        this.invalidateCache(sourceUserId.toString())\r\n    }\r\n\r\n    /**\r\n     * Apply time-based decay to edge weights\r\n     * Should be run periodically (e.g., daily) to keep weights relevant\r\n     */\r\n    async applyWeightDecay(decayFactor: number = 0.99): Promise<number> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        // Apply decay to all edges, with minimum threshold\r\n        const result = await edgesCollection.updateMany(\r\n            { interactionWeight: { $gt: 0.05 } }, // Only decay edges above threshold\r\n            [\r\n                {\r\n                    $set: {\r\n                        interactionWeight: {\r\n                            $max: [0.05, { $multiply: ['$interactionWeight', decayFactor] }]\r\n                        },\r\n                        updatedAt: new Date(),\r\n                    }\r\n                }\r\n            ]\r\n        )\r\n\r\n        return result.modifiedCount\r\n    }\r\n\r\n    // --------------------------------------------------------------------------\r\n    // GRAPH TRAVERSAL: MUTUAL CONNECTIONS\r\n    // --------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Find mutual connections between two users\r\n     * (Users that both source and target follow)\r\n     * \r\n     * @param userId1 - First user\r\n     * @param userId2 - Second user\r\n     * @returns Array of users that both follow\r\n     */\r\n    async getMutualConnections(\r\n        userId1: string | ObjectId,\r\n        userId2: string | ObjectId\r\n    ): Promise<UserNode[]> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n        const usersCollection = db.collection<User>(Collections.USERS)\r\n\r\n        // Get users that user1 follows\r\n        const user1Following = await edgesCollection\r\n            .find({ sourceUserId: new ObjectId(userId1.toString()) })\r\n            .project({ targetUserId: 1 })\r\n            .toArray()\r\n\r\n        const user1FollowingIds = new Set(\r\n            user1Following.map(e => e.targetUserId.toString())\r\n        )\r\n\r\n        // Get users that user2 follows and check intersection\r\n        const user2Following = await edgesCollection\r\n            .find({ sourceUserId: new ObjectId(userId2.toString()) })\r\n            .project({ targetUserId: 1 })\r\n            .toArray()\r\n\r\n        const mutualIds = user2Following\r\n            .filter(e => user1FollowingIds.has(e.targetUserId.toString()))\r\n            .map(e => new ObjectId(e.targetUserId.toString()))\r\n\r\n        if (mutualIds.length === 0) {\r\n            return []\r\n        }\r\n\r\n        // Fetch user details for mutual connections\r\n        const users = await usersCollection\r\n            .find({ _id: { $in: mutualIds } })\r\n            .toArray()\r\n\r\n        return users.map(u => this.userToNode(u))\r\n    }\r\n\r\n    /**\r\n     * Get mutual followers (users who follow both userId1 and userId2)\r\n     */\r\n    async getMutualFollowers(\r\n        userId1: string | ObjectId,\r\n        userId2: string | ObjectId\r\n    ): Promise<UserNode[]> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n        const usersCollection = db.collection<User>(Collections.USERS)\r\n\r\n        // Get followers of user1\r\n        const user1Followers = await edgesCollection\r\n            .find({ targetUserId: new ObjectId(userId1.toString()) })\r\n            .project({ sourceUserId: 1 })\r\n            .toArray()\r\n\r\n        const user1FollowerIds = new Set(\r\n            user1Followers.map(e => e.sourceUserId.toString())\r\n        )\r\n\r\n        // Get followers of user2 and check intersection\r\n        const user2Followers = await edgesCollection\r\n            .find({ targetUserId: new ObjectId(userId2.toString()) })\r\n            .project({ sourceUserId: 1 })\r\n            .toArray()\r\n\r\n        const mutualIds = user2Followers\r\n            .filter(e => user1FollowerIds.has(e.sourceUserId.toString()))\r\n            .map(e => new ObjectId(e.sourceUserId.toString()))\r\n\r\n        if (mutualIds.length === 0) {\r\n            return []\r\n        }\r\n\r\n        // Fetch user details\r\n        const users = await usersCollection\r\n            .find({ _id: { $in: mutualIds } })\r\n            .toArray()\r\n\r\n        return users.map(u => this.userToNode(u))\r\n    }\r\n\r\n    // --------------------------------------------------------------------------\r\n    // USER SUGGESTIONS\r\n    // --------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Suggest users based on second-degree connections\r\n     * Prioritizes users from the same department/college\r\n     * \r\n     * @param userId - User to generate suggestions for\r\n     * @param filters - Optional filters (department, college, role)\r\n     * @param limit - Maximum suggestions to return\r\n     * @returns Ranked list of user suggestions\r\n     */\r\n    async getSuggestions(\r\n        userId: string | ObjectId,\r\n        filters: {\r\n            sameDepartment?: boolean\r\n            sameCollege?: boolean\r\n            sameYear?: boolean\r\n            role?: UserRole\r\n        } = {},\r\n        limit: number = 20\r\n    ): Promise<UserSuggestion[]> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n        const usersCollection = db.collection<User>(Collections.USERS)\r\n\r\n        // Get current user's data for filtering\r\n        const currentUser = await usersCollection.findOne({\r\n            _id: new ObjectId(userId.toString())\r\n        })\r\n\r\n        if (!currentUser) {\r\n            throw new Error('User not found')\r\n        }\r\n\r\n        // Get users the current user already follows\r\n        const alreadyFollowing = await edgesCollection\r\n            .find({ sourceUserId: new ObjectId(userId.toString()) })\r\n            .project({ targetUserId: 1 })\r\n            .toArray()\r\n\r\n        const alreadyFollowingSet = new Set(\r\n            alreadyFollowing.map(e => e.targetUserId.toString())\r\n        )\r\n        alreadyFollowingSet.add(userId.toString()) // Exclude self\r\n\r\n        // Get first-degree connections (users the current user follows)\r\n        const firstDegree = await edgesCollection\r\n            .find({ sourceUserId: new ObjectId(userId.toString()) })\r\n            .sort({ interactionWeight: -1 })\r\n            .limit(100) // Limit to top connections\r\n            .toArray()\r\n\r\n        // Get second-degree connections (friends of friends)\r\n        const secondDegreeMap = new Map<string, {\r\n            count: number\r\n            connectors: string[]\r\n        }>()\r\n\r\n        for (const edge of firstDegree) {\r\n            // Get who this first-degree connection follows\r\n            const friendsOfFriend = await edgesCollection\r\n                .find({ sourceUserId: edge.targetUserId })\r\n                .project({ targetUserId: 1 })\r\n                .limit(50)\r\n                .toArray()\r\n\r\n            for (const fof of friendsOfFriend) {\r\n                const fofId = fof.targetUserId.toString()\r\n\r\n                // Skip if already following or is self\r\n                if (alreadyFollowingSet.has(fofId)) continue\r\n\r\n                // Track mutual connection count\r\n                const existing = secondDegreeMap.get(fofId) || { count: 0, connectors: [] }\r\n                existing.count++\r\n                existing.connectors.push(edge.targetUserId.toString())\r\n                secondDegreeMap.set(fofId, existing)\r\n            }\r\n        }\r\n\r\n        // Fetch user data for potential suggestions\r\n        const potentialSuggestionIds = Array.from(secondDegreeMap.keys())\r\n            .map(id => new ObjectId(id))\r\n\r\n        if (potentialSuggestionIds.length === 0) {\r\n            // Fall back to users from same department if no second-degree connections\r\n            return this.getFallbackSuggestions(currentUser, alreadyFollowingSet, limit)\r\n        }\r\n\r\n        const potentialUsers = await usersCollection\r\n            .find({ _id: { $in: potentialSuggestionIds } })\r\n            .toArray()\r\n\r\n        // Score and filter suggestions\r\n        const suggestions: UserSuggestion[] = []\r\n\r\n        for (const user of potentialUsers) {\r\n            const connectionData = secondDegreeMap.get(user._id!.toString())!\r\n\r\n            // Apply filters\r\n            if (filters.sameDepartment && user.department !== currentUser.department) continue\r\n            if (filters.sameYear && user.year !== currentUser.year) continue\r\n\r\n            // Calculate relevance score\r\n            let score = 0\r\n\r\n            // Mutual connections (most important factor)\r\n            score += connectionData.count * 15\r\n\r\n            // Same department bonus\r\n            if (user.department === currentUser.department) {\r\n                score += 25\r\n            }\r\n\r\n            // Same year bonus (for students)\r\n            if (user.year && currentUser.year && user.year === currentUser.year) {\r\n                score += 15\r\n            }\r\n\r\n            // Active user bonus\r\n            if (user.followers_count > 10) {\r\n                score += Math.min(user.followers_count / 10, 10)\r\n            }\r\n\r\n            // Generate suggestion reason\r\n            let reason = ''\r\n            if (connectionData.count >= 3) {\r\n                reason = `${connectionData.count} mutual connections`\r\n            } else if (user.department === currentUser.department) {\r\n                reason = `From your department (${user.department})`\r\n            } else if (connectionData.count > 0) {\r\n                reason = 'Suggested based on your network'\r\n            }\r\n\r\n            suggestions.push({\r\n                userId: user._id!,\r\n                name: user.name,\r\n                department: user.department,\r\n                year: user.year,\r\n                role: this.inferRole(user),\r\n                mutualConnectionsCount: connectionData.count,\r\n                relevanceScore: Math.min(score, 100),\r\n                connectionPath: connectionData.connectors.slice(0, 3),\r\n                reason,\r\n            })\r\n        }\r\n\r\n        // Sort by relevance score and return top results\r\n        return suggestions\r\n            .sort((a, b) => b.relevanceScore - a.relevanceScore)\r\n            .slice(0, limit)\r\n    }\r\n\r\n    /**\r\n     * Fallback suggestions when no second-degree connections exist\r\n     * Suggests users from the same department/college\r\n     */\r\n    private async getFallbackSuggestions(\r\n        currentUser: User,\r\n        alreadyFollowingSet: Set<string>,\r\n        limit: number\r\n    ): Promise<UserSuggestion[]> {\r\n        const db = await getDb()\r\n        const usersCollection = db.collection<User>(Collections.USERS)\r\n\r\n        // Find users from same department\r\n        const sameDeptUsers = await usersCollection\r\n            .find({\r\n                department: currentUser.department,\r\n                is_deactivated: { $ne: true },\r\n            })\r\n            .sort({ followers_count: -1 })\r\n            .limit(limit * 2)\r\n            .toArray()\r\n\r\n        const suggestions: UserSuggestion[] = []\r\n\r\n        for (const user of sameDeptUsers) {\r\n            if (alreadyFollowingSet.has(user._id!.toString())) continue\r\n\r\n            suggestions.push({\r\n                userId: user._id!,\r\n                name: user.name,\r\n                department: user.department,\r\n                year: user.year,\r\n                role: this.inferRole(user),\r\n                mutualConnectionsCount: 0,\r\n                relevanceScore: user.department === currentUser.department ? 50 : 30,\r\n                connectionPath: [],\r\n                reason: `Popular in ${user.department}`,\r\n            })\r\n        }\r\n\r\n        return suggestions.slice(0, limit)\r\n    }\r\n\r\n    // --------------------------------------------------------------------------\r\n    // HELPER METHODS\r\n    // --------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Convert MongoDB User document to UserNode\r\n     */\r\n    private userToNode(user: User | null): UserNode {\r\n        if (!user) {\r\n            return {\r\n                userId: '',\r\n                role: 'student',\r\n                department: '',\r\n                isActive: false,\r\n            }\r\n        }\r\n\r\n        return {\r\n            userId: user._id!,\r\n            role: this.inferRole(user),\r\n            department: user.department,\r\n            year: user.year,\r\n            name: user.name,\r\n            isActive: !user.is_deactivated,\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Infer user role from user document\r\n     */\r\n    private inferRole(user: User): UserRole {\r\n        // This could be enhanced based on your user schema\r\n        // Currently inferring from year field\r\n        if (!user.year || user.year === 0) {\r\n            return 'faculty'\r\n        }\r\n        if (user.year < new Date().getFullYear() - 4) {\r\n            return 'alumni'\r\n        }\r\n        return 'student'\r\n    }\r\n\r\n    /**\r\n     * Invalidate cache for a user\r\n     */\r\n    private invalidateCache(userId: string): void {\r\n        this.adjacencyList.delete(userId)\r\n        this.reverseAdjacencyList.delete(userId)\r\n        this.cacheTimestamps.delete(userId)\r\n    }\r\n\r\n    /**\r\n     * Get followers count for a user (optimized)\r\n     */\r\n    async getFollowersCount(userId: string | ObjectId): Promise<number> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        return edgesCollection.countDocuments({\r\n            targetUserId: new ObjectId(userId.toString()),\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Get following count for a user (optimized)\r\n     */\r\n    async getFollowingCount(userId: string | ObjectId): Promise<number> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        return edgesCollection.countDocuments({\r\n            sourceUserId: new ObjectId(userId.toString()),\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Bulk check follow status for multiple users\r\n     * Optimized for feed/list views\r\n     */\r\n    async bulkCheckFollowing(\r\n        sourceUserId: string | ObjectId,\r\n        targetUserIds: (string | ObjectId)[]\r\n    ): Promise<Map<string, boolean>> {\r\n        const db = await getDb()\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        const edges = await edgesCollection\r\n            .find({\r\n                sourceUserId: new ObjectId(sourceUserId.toString()),\r\n                targetUserId: {\r\n                    $in: targetUserIds.map(id => new ObjectId(id.toString()))\r\n                },\r\n            })\r\n            .project({ targetUserId: 1 })\r\n            .toArray()\r\n\r\n        const followingSet = new Set(edges.map(e => e.targetUserId.toString()))\r\n\r\n        const result = new Map<string, boolean>()\r\n        for (const targetId of targetUserIds) {\r\n            result.set(targetId.toString(), followingSet.has(targetId.toString()))\r\n        }\r\n\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * Get graph statistics for analytics\r\n     */\r\n    async getGraphStats(): Promise<{\r\n        totalNodes: number\r\n        totalEdges: number\r\n        avgFollowersPerUser: number\r\n        avgFollowingPerUser: number\r\n    }> {\r\n        const db = await getDb()\r\n        const usersCollection = db.collection<User>(Collections.USERS)\r\n        const edgesCollection = db.collection<GraphEdge>(GraphCollections.GRAPH_EDGES)\r\n\r\n        const [totalNodes, totalEdges] = await Promise.all([\r\n            usersCollection.countDocuments({ is_deactivated: { $ne: true } }),\r\n            edgesCollection.countDocuments(),\r\n        ])\r\n\r\n        return {\r\n            totalNodes,\r\n            totalEdges,\r\n            avgFollowersPerUser: totalNodes > 0 ? totalEdges / totalNodes : 0,\r\n            avgFollowingPerUser: totalNodes > 0 ? totalEdges / totalNodes : 0,\r\n        }\r\n    }\r\n}\r\n\r\n// ============================================================================\r\n// SINGLETON INSTANCE\r\n// ============================================================================\r\n\r\n// Export singleton instance for consistent usage across the application\r\nexport const socialGraph = new SocialGraph()\r\n\r\n// Initialize indexes on module load (in production)\r\nif (process.env.NODE_ENV === 'production') {\r\n    socialGraph.initializeIndexes().catch(console.error)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\lib\\upload.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2629,2632],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2629,2632],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2662,2665],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2662,2665],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":143,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5444,5447],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5444,5447],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":164,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6025,6028],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6025,6028],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":178,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6737,6740],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6737,6740],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":226,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":226,"endColumn":13}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { v2 as cloudinary } from 'cloudinary'\nimport formidable from 'formidable'\nimport { NextApiRequest } from 'next'\nimport fs from 'fs'\nimport path from 'path'\nimport os from 'os'\n\n// Configure Cloudinary (you'll need to set these environment variables)\ncloudinary.config({\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\n  api_key: process.env.CLOUDINARY_API_KEY,\n  api_secret: process.env.CLOUDINARY_API_SECRET,\n  secure: true,\n})\n\nexport interface UploadResult {\n  url: string\n  publicId: string\n  type: 'image' | 'video'\n}\n\n// Allowed file types for security\nconst ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']\nconst ALLOWED_VIDEO_TYPES = ['video/mp4', 'video/quicktime', 'video/webm']\nconst ALLOWED_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.mp4', '.mov', '.webm']\n\nexport async function parseForm(req: NextApiRequest): Promise<{\n  fields: formidable.Fields\n  files: formidable.Files\n}> {\n  // Validate content-type header - must be multipart/form-data\n  const contentType = req.headers['content-type'] || ''\n  if (!contentType.includes('multipart/form-data')) {\n    throw new Error(`Invalid content type. Expected multipart/form-data, got: ${contentType}`)\n  }\n\n  // On Vercel and other serverless platforms, the project filesystem is read-only.\n  // Use the OS temporary directory for uploads.\n  const uploadDir = path.join(os.tmpdir(), 'unix-uploads')\n\n  try {\n    if (!fs.existsSync(uploadDir)) {\n      fs.mkdirSync(uploadDir, { recursive: true })\n    }\n  } catch (e) {\n    // As a final fallback, use the bare tmp dir\n    console.warn('Failed to create upload subdirectory, falling back to os.tmpdir():', e)\n  }\n\n  const form = formidable({\n    uploadDir: fs.existsSync(uploadDir) ? uploadDir : os.tmpdir(),\n    keepExtensions: true,\n    maxFileSize: 10 * 1024 * 1024, // 10MB limit\n    maxFiles: 1, // Only allow single file uploads\n    multiples: false,\n    allowEmptyFiles: false,\n    // Explicitly disable JSON parsing - we only want multipart form data\n    hashAlgorithm: false,\n    filter: function ({ mimetype, originalFilename }) {\n      // Validate file type and extension\n      const isValidMime = mimetype && (\n        ALLOWED_IMAGE_TYPES.includes(mimetype) ||\n        ALLOWED_VIDEO_TYPES.includes(mimetype)\n      )\n\n      const ext = originalFilename ? path.extname(originalFilename).toLowerCase() : ''\n      const isValidExt = ALLOWED_EXTENSIONS.includes(ext)\n\n      return !!(isValidMime && isValidExt)\n    },\n  })\n\n  return new Promise((resolve, reject) => {\n    // Check if request body was already consumed (common issue with Next.js)\n    if ((req as any).body && Object.keys((req as any).body).length > 0) {\n      console.warn('Request body appears to have been pre-parsed. This may cause issues.')\n    }\n\n    form.parse(req, (err, fields, files) => {\n      if (err) {\n        console.error('Form parse error:', err)\n\n        // Provide more helpful error messages\n        if (err.message?.includes('JSON')) {\n          reject(new Error('File upload failed: Request was incorrectly parsed as JSON. Ensure Content-Type is multipart/form-data and bodyParser is disabled for this route.'))\n        } else if (err.message?.includes('maxFileSize')) {\n          reject(new Error('File upload failed: File size exceeds 10MB limit'))\n        } else if (err.message?.includes('maxFiles')) {\n          reject(new Error('File upload failed: Only one file upload is allowed'))\n        } else {\n          reject(new Error('File upload failed: ' + err.message))\n        }\n      } else {\n        resolve({ fields, files })\n      }\n    })\n  })\n}\n\n\n\nexport async function uploadToCloudinary(filePath: string, resourceType: 'image' | 'video' = 'image'): Promise<UploadResult> {\n  // Fast-path fallback in development to avoid Cloudinary latency\n  const devFallbackEnabled = process.env.NODE_ENV !== 'production' && process.env.CLOUDINARY_DEV_FALLBACK === 'true'\n  if (devFallbackEnabled) {\n    try {\n      const result = saveToLocalUploads(filePath, resourceType)\n      cleanupFile(filePath)\n      return result\n    } catch {\n      // If local fallback fails, proceed to Cloudinary attempt below\n    }\n  }\n\n  try {\n    // Check if Cloudinary is properly configured\n    if (!process.env.CLOUDINARY_CLOUD_NAME || !process.env.CLOUDINARY_API_KEY || !process.env.CLOUDINARY_API_SECRET) {\n      console.error('Cloudinary not configured - missing environment variables')\n      cleanupFile(filePath)\n      throw new Error('Cloudinary configuration missing. Please configure CLOUDINARY_CLOUD_NAME, CLOUDINARY_API_KEY, and CLOUDINARY_API_SECRET environment variables.')\n    }\n\n    console.log(`Uploading ${resourceType} to Cloudinary:`, filePath)\n\n    // Optional timeout for uploads to prevent long hangs in poor networks\n    const timeoutMs = (() => {\n      const raw = process.env.CLOUDINARY_UPLOAD_TIMEOUT_MS\n      const parsed = raw ? parseInt(raw, 10) : NaN\n      // Default: shorter timeout in dev, longer in prod\n      return Number.isFinite(parsed) ? parsed : (process.env.NODE_ENV !== 'production' ? 8000 : 30000)\n    })()\n\n    const uploadPromise = cloudinary.uploader.upload(filePath, {\n      resource_type: resourceType,\n      folder: 'unix-social',\n      quality: 'auto',\n      fetch_format: 'auto',\n    })\n\n    const result = await Promise.race([\n      uploadPromise,\n      new Promise((_, reject) => setTimeout(() => reject(new Error('Upload timeout')), timeoutMs))\n    ]) as any\n\n    // Clean up local file after successful upload\n    cleanupFile(filePath)\n\n    // Validate result\n    if (!result || !result.secure_url) {\n      throw new Error('Invalid upload result from Cloudinary')\n    }\n\n    console.log(`Γ£à Successfully uploaded to Cloudinary:`, result.secure_url)\n\n    return {\n      url: result.secure_url,\n      publicId: result.public_id,\n      type: resourceType,\n    }\n  } catch (error) {\n    console.error('Cloudinary upload failed:', error)\n\n    // Normalize Cloudinary error objects (which may not be real Error instances)\n    const anyError: any = error\n    const message: string | undefined =\n      (anyError && (anyError.message || anyError.error?.message || anyError.error?.error || anyError.error?.error_message)) ||\n      (error instanceof Error ? error.message : undefined)\n\n    const isStale = !!(message && message.includes('Stale request'))\n\n    // DEV fallback: if clock skew causes Cloudinary failure, save to /public/uploads for local use\n    if (isStale && process.env.NODE_ENV !== 'production') {\n      try {\n        const fallback = saveToLocalUploads(filePath, resourceType)\n        cleanupFile(filePath)\n        console.warn('Using local uploads fallback (dev mode):', fallback.url)\n        return fallback\n      } catch (fallbackError: any) {\n        console.error('Local uploads fallback failed:', fallbackError)\n        // Continue to throw the normalized error below\n      }\n    }\n\n    // Clean up tmp file if still present\n    cleanupFile(filePath)\n\n    const normalizedMessage = (() => {\n      if (isStale) {\n        return 'Upload failed due to system time mismatch. Please sync your device clock and try again.'\n      }\n      if (message && message.includes('Invalid API key')) {\n        return 'Invalid Cloudinary API credentials. Please check your environment variables.'\n      }\n      if (message) {\n        return `Upload failed: ${message}`\n      }\n      try {\n        return `Upload failed: ${JSON.stringify(anyError)}`\n      } catch {\n        return 'Upload failed: Unknown error'\n      }\n    })()\n\n    throw new Error(normalizedMessage)\n  }\n}\n\n// Helper function to safely clean up files\nfunction cleanupFile(filePath: string): void {\n  try {\n    if (fs.existsSync(filePath)) {\n      fs.unlinkSync(filePath)\n    }\n  } catch (error) {\n    console.warn('Failed to cleanup file:', filePath, error)\n  }\n}\n\n// Save the uploaded tmp file into public/uploads (dev-only fallback)\nfunction saveToLocalUploads(filePath: string, resourceType: 'image' | 'video'): UploadResult {\n  const uploadsDir = path.join(process.cwd(), 'public', 'uploads')\n  try {\n    if (!fs.existsSync(uploadsDir)) {\n      fs.mkdirSync(uploadsDir, { recursive: true })\n    }\n  } catch (e) {\n    throw new Error('Failed to create local uploads directory')\n  }\n\n  const extFromPath = path.extname(filePath)\n  const defaultExt = resourceType === 'image' ? '.jpg' : '.mp4'\n  const ext = extFromPath && extFromPath.length <= 6 ? extFromPath : defaultExt\n  const filename = `local-${Date.now()}-${Math.random().toString(36).slice(2)}${ext}`\n  const destPath = path.join(uploadsDir, filename)\n\n  fs.copyFileSync(filePath, destPath)\n\n  return {\n    url: `/uploads/${filename}`,\n    publicId: filename,\n    type: resourceType,\n  }\n}\n\n// Cache for file extensions to avoid repeated array operations\nconst imageExts = new Set(['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'])\nconst videoExts = new Set(['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'])\n\nexport function getFileType(filename: string): 'image' | 'video' | 'unknown' {\n  const ext = filename.toLowerCase().split('.').pop()\n\n  if (!ext) return 'unknown'\n  if (imageExts.has(ext)) return 'image'\n  if (videoExts.has(ext)) return 'video'\n  return 'unknown'\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\lib\\validation.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":94,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3181,3184],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3181,3184],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":113,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3763,3766],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3763,3766],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":113,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3769,3772],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3769,3772],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4218,4221],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4218,4221],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":222,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":222,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6785,6788],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6785,6788],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":238,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7176,7179],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7176,7179],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Input validation and sanitization utilities\r\n * Prevents XSS, injection attacks, and validates data types\r\n */\r\n\r\n// Email validation (RFC 5322 compliant)\r\nexport function isValidEmail(email: string): boolean {\r\n  if (!email || typeof email !== 'string') return false\r\n  \r\n  const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/\r\n  return emailRegex.test(email) && email.length <= 254\r\n}\r\n\r\n// Password strength validation\r\nexport function isStrongPassword(password: string): { valid: boolean; message?: string } {\r\n  if (!password || typeof password !== 'string') {\r\n    return { valid: false, message: 'Password is required' }\r\n  }\r\n  \r\n  if (password.length < 8) {\r\n    return { valid: false, message: 'Password must be at least 8 characters' }\r\n  }\r\n  \r\n  if (password.length > 128) {\r\n    return { valid: false, message: 'Password is too long' }\r\n  }\r\n  \r\n  if (!/[a-z]/.test(password)) {\r\n    return { valid: false, message: 'Password must contain lowercase letters' }\r\n  }\r\n  \r\n  if (!/[A-Z]/.test(password)) {\r\n    return { valid: false, message: 'Password must contain uppercase letters' }\r\n  }\r\n  \r\n  if (!/[0-9]/.test(password)) {\r\n    return { valid: false, message: 'Password must contain numbers' }\r\n  }\r\n  \r\n  return { valid: true }\r\n}\r\n\r\n// Sanitize string input to prevent XSS\r\nexport function sanitizeString(input: string, maxLength: number = 1000): string {\r\n  if (!input || typeof input !== 'string') return ''\r\n  \r\n  return input\r\n    .trim()\r\n    .slice(0, maxLength)\r\n    .replace(/[<>]/g, '') // Remove HTML tags\r\n    .replace(/javascript:/gi, '') // Remove javascript: protocol\r\n    .replace(/on\\w+=/gi, '') // Remove event handlers\r\n}\r\n\r\n// Sanitize HTML content (more permissive for rich text)\r\nexport function sanitizeHtml(html: string, maxLength: number = 10000): string {\r\n  if (!html || typeof html !== 'string') return ''\r\n  \r\n  const cleaned = html\r\n    .trim()\r\n    .slice(0, maxLength)\r\n    .replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '') // Remove scripts\r\n    .replace(/<iframe\\b[^<]*(?:(?!<\\/iframe>)<[^<]*)*<\\/iframe>/gi, '') // Remove iframes\r\n    .replace(/javascript:/gi, '') // Remove javascript: protocol\r\n    .replace(/on\\w+\\s*=/gi, '') // Remove event handlers\r\n  \r\n  return cleaned\r\n}\r\n\r\n// Validate and sanitize username\r\nexport function validateUsername(username: string): { valid: boolean; sanitized?: string; message?: string } {\r\n  if (!username || typeof username !== 'string') {\r\n    return { valid: false, message: 'Username is required' }\r\n  }\r\n  \r\n  const sanitized = username.trim().toLowerCase()\r\n  \r\n  if (sanitized.length < 3) {\r\n    return { valid: false, message: 'Username must be at least 3 characters' }\r\n  }\r\n  \r\n  if (sanitized.length > 30) {\r\n    return { valid: false, message: 'Username is too long' }\r\n  }\r\n  \r\n  if (!/^[a-z0-9_-]+$/.test(sanitized)) {\r\n    return { valid: false, message: 'Username can only contain letters, numbers, underscores, and hyphens' }\r\n  }\r\n  \r\n  return { valid: true, sanitized }\r\n}\r\n\r\n// Validate integer input\r\nexport function validateInteger(value: any, min?: number, max?: number): { valid: boolean; value?: number; message?: string } {\r\n  const num = parseInt(value)\r\n  \r\n  if (isNaN(num)) {\r\n    return { valid: false, message: 'Invalid number' }\r\n  }\r\n  \r\n  if (min !== undefined && num < min) {\r\n    return { valid: false, message: `Value must be at least ${min}` }\r\n  }\r\n  \r\n  if (max !== undefined && num > max) {\r\n    return { valid: false, message: `Value must be at most ${max}` }\r\n  }\r\n  \r\n  return { valid: true, value: num }\r\n}\r\n\r\n// Prevent NoSQL injection in MongoDB queries\r\nexport function sanitizeMongoQuery(obj: any): any {\r\n  if (obj === null || obj === undefined) return obj\r\n  \r\n  if (typeof obj === 'string') {\r\n    // Prevent injection operators\r\n    if (obj.startsWith('$')) {\r\n      return obj.substring(1)\r\n    }\r\n    return obj\r\n  }\r\n  \r\n  if (typeof obj === 'number' || typeof obj === 'boolean') {\r\n    return obj\r\n  }\r\n  \r\n  if (Array.isArray(obj)) {\r\n    return obj.map(sanitizeMongoQuery)\r\n  }\r\n  \r\n  if (typeof obj === 'object') {\r\n    const sanitized: any = {}\r\n    for (const [key, value] of Object.entries(obj)) {\r\n      // Remove MongoDB operators from user input\r\n      if (!key.startsWith('$') && !key.includes('.')) {\r\n        sanitized[key] = sanitizeMongoQuery(value)\r\n      }\r\n    }\r\n    return sanitized\r\n  }\r\n  \r\n  return obj\r\n}\r\n\r\n// Validate URL\r\nexport function isValidUrl(url: string, allowedProtocols: string[] = ['http', 'https']): boolean {\r\n  if (!url || typeof url !== 'string') return false\r\n  \r\n  try {\r\n    const parsed = new URL(url)\r\n    return allowedProtocols.includes(parsed.protocol.replace(':', ''))\r\n  } catch {\r\n    return false\r\n  }\r\n}\r\n\r\n// Rate limit helper (returns true if allowed)\r\nexport function checkRateLimit(\r\n  identifier: string,\r\n  limit: number,\r\n  windowMs: number,\r\n  store: Map<string, { count: number; resetTime: number }>\r\n): { allowed: boolean; retryAfter?: number } {\r\n  const now = Date.now()\r\n  const record = store.get(identifier)\r\n  \r\n  if (!record || now > record.resetTime) {\r\n    store.set(identifier, { count: 1, resetTime: now + windowMs })\r\n    return { allowed: true }\r\n  }\r\n  \r\n  if (record.count >= limit) {\r\n    return { \r\n      allowed: false, \r\n      retryAfter: Math.ceil((record.resetTime - now) / 1000) \r\n    }\r\n  }\r\n  \r\n  record.count++\r\n  return { allowed: true }\r\n}\r\n\r\n// Validate file upload\r\nexport function validateFileUpload(\r\n  file: { size: number; mimetype?: string; originalFilename?: string },\r\n  options: {\r\n    maxSize?: number\r\n    allowedTypes?: string[]\r\n    allowedExtensions?: string[]\r\n  } = {}\r\n): { valid: boolean; message?: string } {\r\n  const {\r\n    maxSize = 10 * 1024 * 1024, // 10MB default\r\n    allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],\r\n    allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp']\r\n  } = options\r\n  \r\n  if (!file) {\r\n    return { valid: false, message: 'No file provided' }\r\n  }\r\n  \r\n  if (file.size > maxSize) {\r\n    return { valid: false, message: `File size exceeds ${Math.floor(maxSize / 1024 / 1024)}MB limit` }\r\n  }\r\n  \r\n  if (file.mimetype && !allowedTypes.includes(file.mimetype)) {\r\n    return { valid: false, message: 'File type not allowed' }\r\n  }\r\n  \r\n  if (file.originalFilename) {\r\n    const ext = file.originalFilename.toLowerCase().match(/\\.[^.]+$/)?.[0]\r\n    if (ext && !allowedExtensions.includes(ext)) {\r\n      return { valid: false, message: 'File extension not allowed' }\r\n    }\r\n  }\r\n  \r\n  return { valid: true }\r\n}\r\n\r\n// Sanitize object for API response (remove sensitive fields)\r\nexport function sanitizeApiResponse<T extends Record<string, any>>(\r\n  obj: T,\r\n  sensitiveFields: string[] = ['password', 'passwordHash', 'token', 'secret']\r\n): Partial<T> {\r\n  if (!obj || typeof obj !== 'object') return obj\r\n  \r\n  const sanitized = { ...obj }\r\n  \r\n  for (const field of sensitiveFields) {\r\n    delete sanitized[field]\r\n  }\r\n  \r\n  return sanitized\r\n}\r\n\r\n// Validate privacy settings\r\nexport function validatePrivacySettings(settings: any): { valid: boolean; error?: string } {\r\n  if (!settings || typeof settings !== 'object') {\r\n    return { valid: false, error: 'Invalid privacy settings' }\r\n  }\r\n  \r\n  // Validate is_private\r\n  if (settings.is_private !== undefined && typeof settings.is_private !== 'boolean') {\r\n    return { valid: false, error: 'is_private must be a boolean' }\r\n  }\r\n  \r\n  // Validate show_online_status\r\n  if (settings.show_online_status !== undefined && typeof settings.show_online_status !== 'boolean') {\r\n    return { valid: false, error: 'show_online_status must be a boolean' }\r\n  }\r\n  \r\n  // Validate show_read_receipts\r\n  if (settings.show_read_receipts !== undefined && typeof settings.show_read_receipts !== 'boolean') {\r\n    return { valid: false, error: 'show_read_receipts must be a boolean' }\r\n  }\r\n  \r\n  // Validate who_can_message\r\n  if (settings.who_can_message !== undefined) {\r\n    if (!['everyone', 'followers'].includes(settings.who_can_message)) {\r\n      return { valid: false, error: 'who_can_message must be \"everyone\" or \"followers\"' }\r\n    }\r\n  }\r\n  \r\n  // Validate who_can_comment\r\n  if (settings.who_can_comment !== undefined) {\r\n    if (!['everyone', 'followers'].includes(settings.who_can_comment)) {\r\n      return { valid: false, error: 'who_can_comment must be \"everyone\" or \"followers\"' }\r\n    }\r\n  }\r\n  \r\n  return { valid: true }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\next.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\_app.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\_document.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\auth\\forgot-password.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1701,1704],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1701,1704],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next';\r\nimport { getCollection, withRetry, Collections, User, PasswordReset, getNextSequenceValue } from '../../../lib/mongodb';\r\nimport crypto from 'crypto';\r\nimport nodemailer from 'nodemailer';\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' });\r\n  }\r\n\r\n  try {\r\n    const { email } = req.body;\r\n\r\n    if (!email) {\r\n      return res.status(400).json({ error: 'Email is required' });\r\n    }\r\n\r\n    // Find user by email\r\n    const users = await getCollection<User>(Collections.USERS);\r\n    const user = await withRetry(async () => {\r\n      return users.findOne({ \r\n        email: email.toLowerCase()\r\n      })\r\n    });\r\n\r\n    if (!user) {\r\n      // Don't reveal if email exists or not for security\r\n      return res.status(200).json({ \r\n        message: 'If this email exists in our system, you will receive a password reset link.' \r\n      });\r\n    }\r\n\r\n    // Generate reset token\r\n    const resetToken = crypto.randomBytes(32).toString('hex');\r\n    const expiresAt = new Date();\r\n    expiresAt.setHours(expiresAt.getHours() + 1); // Token expires in 1 hour\r\n\r\n    // Save reset token to database\r\n    const passwordResets = await getCollection<PasswordReset>(Collections.PASSWORD_RESETS);\r\n    const resetId = await getNextSequenceValue('password_resets');\r\n    \r\n    await withRetry(async () => {\r\n      return passwordResets.insertOne({\r\n        id: resetId,\r\n        user_id: user.id,\r\n        token: resetToken,\r\n        expires_at: expiresAt,\r\n        used: false,\r\n        created_at: new Date()\r\n      } as any)\r\n    });\r\n\r\n    // Create reset URL\r\n    const resetUrl = `${process.env.NEXTAUTH_URL || 'http://localhost:3000'}/reset-password?token=${resetToken}`;\r\n\r\n    // Configure email transporter (you'll need to set up your email service)\r\n    const transporter = nodemailer.createTransport({\r\n      // For development, you can use a service like Ethereal Email or Gmail\r\n      host: process.env.SMTP_HOST || 'smtp.gmail.com',\r\n      port: 587,\r\n      secure: false,\r\n      auth: {\r\n        user: process.env.SMTP_USER,\r\n        pass: process.env.SMTP_PASS\r\n      }\r\n    });\r\n\r\n    // Email content\r\n    const mailOptions = {\r\n      from: process.env.FROM_EMAIL || 'noreply@university.edu',\r\n      to: email,\r\n      subject: 'Password Reset Request - UNIX Social Network',\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n          <h2 style=\"color: #FFAF50;\">Password Reset Request</h2>\r\n          <p>Hello ${user.name},</p>\r\n          <p>We received a request to reset your password for your UNIX account.</p>\r\n          <p>Click the button below to reset your password:</p>\r\n          <a href=\"${resetUrl}\" style=\"display: inline-block; background-color: #FFAF50; color: black; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 16px 0;\">Reset Password</a>\r\n          <p>Or copy and paste this link into your browser:</p>\r\n          <p style=\"word-break: break-all; color: #666;\">${resetUrl}</p>\r\n          <p><strong>This link will expire in 1 hour.</strong></p>\r\n          <p>If you didn't request this password reset, please ignore this email.</p>\r\n          <hr style=\"margin: 24px 0; border: 1px solid #eee;\">\r\n          <p style=\"color: #666; font-size: 12px;\">UNIX - College Social Network</p>\r\n        </div>\r\n      `\r\n    };\r\n\r\n    // Send email (in development, you might want to just log the reset URL)\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('=== PASSWORD RESET EMAIL ===');\r\n      console.log(`To: ${email}`);\r\n      console.log(`Reset URL: ${resetUrl}`);\r\n      console.log('===========================');\r\n    } else {\r\n      await transporter.sendMail(mailOptions);\r\n    }\r\n\r\n    return res.status(200).json({ \r\n      message: 'If this email exists in our system, you will receive a password reset link.',\r\n      // In development, include the reset URL for testing\r\n      ...(process.env.NODE_ENV === 'development' && { resetUrl })\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Forgot password error:', error);\r\n    return res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\auth\\login.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1212,1215],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1212,1215],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":38,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":29}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, withRetry, Collections, User, serializeDoc } from '../../../lib/mongodb'\r\nimport { verifyPassword, generateToken } from '../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const { college_id, password } = req.body\r\n\r\n    if (!college_id || !password) {\r\n      return res.status(400).json({ error: 'College ID and password are required' })\r\n    }\r\n\r\n    // Find user\r\n    const user = await withRetry(async () => {\r\n      const users = await getCollection<User>(Collections.USERS)\r\n      return users.findOne({ college_id })\r\n    })\r\n\r\n    if (!user) {\r\n      return res.status(401).json({ error: 'Invalid credentials' })\r\n    }\r\n\r\n    // Verify password\r\n    const isValidPassword = await verifyPassword(password, user.password_hash)\r\n    if (!isValidPassword) {\r\n      return res.status(401).json({ error: 'Invalid credentials' })\r\n    }\r\n\r\n    // Generate token\r\n    const userId = user.id || user._id?.toString()\r\n    const token = generateToken(userId as any)\r\n\r\n    // Return user data without password\r\n    const { password_hash: _, ...userWithoutPassword } = serializeDoc(user)\r\n\r\n    res.status(200).json({\r\n      user: userWithoutPassword,\r\n      token,\r\n      message: 'Login successful'\r\n    })\r\n  } catch (error) {\r\n    console.error('Login error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\auth\\register.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":92,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3351,3354],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3351,3354],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, withRetry, Collections, User, getNextSequenceValue, serializeDoc } from '../../../lib/mongodb'\r\nimport { hashPassword, generateToken } from '../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  console.log('≡ƒöä Registration attempt started at:', new Date().toISOString())\r\n  console.log('≡ƒôè Environment check:', {\r\n    MONGODB_URI: !!process.env.MONGODB_URI ? 'SET' : 'MISSING',\r\n    JWT_SECRET: !!process.env.JWT_SECRET ? 'SET' : 'MISSING',\r\n    NODE_ENV: process.env.NODE_ENV\r\n  })\r\n\r\n  try {\r\n    const { name, username, email, college_id, password, department, year, bio, profile_image } = req.body\r\n    console.log('≡ƒô¥ Registration data received:', { name, username, email, college_id, department, year })\r\n\r\n    // Validate required fields\r\n    if (!name || !username || !email || !college_id || !password || !department || !year) {\r\n      console.log('Γ¥î Validation failed: Missing required fields')\r\n      return res.status(400).json({ error: 'All fields are required' })\r\n    }\r\n\r\n    console.log('≡ƒöì Checking for existing user with college_id:', college_id)\r\n    \r\n    const users = await getCollection<User>(Collections.USERS)\r\n    \r\n    // Check if user already exists\r\n    const existingUser = await withRetry(async () => {\r\n      return users.findOne({ college_id })\r\n    })\r\n\r\n    if (existingUser) {\r\n      console.log('Γ¥î User already exists with college_id:', college_id)\r\n      return res.status(400).json({ error: 'User already exists with this college ID' })\r\n    }\r\n\r\n    console.log('≡ƒöì Checking username uniqueness:', username)\r\n    // Check username uniqueness\r\n    if (username) {\r\n      const existingUsername = await withRetry(async () => {\r\n        return users.findOne({ username })\r\n      })\r\n      if (existingUsername) {\r\n        console.log('Γ¥î Username already taken:', username)\r\n        return res.status(400).json({ error: 'Username is already taken' })\r\n      }\r\n    }\r\n\r\n    console.log('≡ƒöì Checking email uniqueness:', email)\r\n    // Check email uniqueness\r\n    if (email) {\r\n      const existingEmail = await withRetry(async () => {\r\n        return users.findOne({ email })\r\n      })\r\n      if (existingEmail) {\r\n        console.log('Γ¥î Email already registered:', email)\r\n        return res.status(400).json({ error: 'Email is already registered' })\r\n      }\r\n    }\r\n\r\n    console.log('≡ƒöÉ Hashing password...')\r\n    // Hash password\r\n    const hashedPassword = await hashPassword(password)\r\n\r\n    console.log('≡ƒæñ Creating user in database...')\r\n    // Get next sequential ID\r\n    const userId = await getNextSequenceValue('users')\r\n    \r\n    // Create user\r\n    const newUser: User = {\r\n      id: userId,\r\n      name,\r\n      username,\r\n      email,\r\n      college_id,\r\n      password_hash: hashedPassword,\r\n      department,\r\n      year: parseInt(year),\r\n      bio: bio || undefined,\r\n      profile_image: String(profile_image || '/uploads/DefaultProfile.jpg'),\r\n      is_private: false,\r\n      followers_count: 0,\r\n      following_count: 0,\r\n      created_at: new Date(),\r\n    }\r\n\r\n    const result = await withRetry(async () => {\r\n      return users.insertOne(newUser as any)\r\n    })\r\n\r\n    const createdUser = await users.findOne({ _id: result.insertedId })\r\n    \r\n    if (!createdUser) {\r\n      throw new Error('Failed to retrieve created user')\r\n    }\r\n\r\n    console.log('≡ƒÄ½ Generating JWT token...')\r\n    // Generate token\r\n    const token = generateToken(userId)\r\n\r\n    const userResponse = serializeDoc(createdUser)\r\n    delete userResponse.password_hash\r\n\r\n    console.log('Γ£à Registration successful for user:', userId)\r\n    res.status(201).json({\r\n      user: userResponse,\r\n      token,\r\n      message: 'User created successfully'\r\n    })\r\n  } catch (error) {\r\n    console.error('Γ¥î Registration error details:', {\r\n      message: error instanceof Error ? error.message : 'Unknown error',\r\n      stack: error instanceof Error ? error.stack : undefined,\r\n      timestamp: new Date().toISOString(),\r\n      environment: process.env.NODE_ENV\r\n    })\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\comments.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'serializeDoc' is defined but never used.","line":2,"column":94,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":106},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1801,1804],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1801,1804],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2134,2137],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2134,2137],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2496,2499],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2496,2499],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2745,2748],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2745,2748],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":86,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3626,3629],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3626,3629],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":157,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6144,6147],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6144,6147],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":179,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":179,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6819,6822],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6819,6822],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":180,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6853,6856],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6853,6856],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, Comment, CommentLike, Post, User, getNextSequenceValue, serializeDoc } from '../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method === 'GET') {\r\n    // Get comments for a specific post\r\n    try {\r\n      const { postId, limit = '20', offset = '0' } = req.query\r\n\r\n      if (!postId) {\r\n        return res.status(400).json({ error: 'Post ID is required' })\r\n      }\r\n\r\n      console.log('≡ƒô¥ Fetching comments for post:', postId)\r\n\r\n      // Get current user for like status\r\n      const auth = getUserFromRequest(req)\r\n      const currentUserId = auth?.userId\r\n      console.log('≡ƒæñ Current user:', currentUserId)\r\n\r\n      const comments = await getCollection<Comment>(Collections.COMMENTS)\r\n      const commentLikes = await getCollection<CommentLike>(Collections.COMMENT_LIKES)\r\n      const users = await getCollection<User>(Collections.USERS)\r\n\r\n      // Get top-level comments\r\n      const topComments = await comments.find({\r\n        post_id: parseInt(postId as string),\r\n        parent_id: { $exists: false }\r\n      })\r\n        .sort({ created_at: 1 })\r\n        .limit(parseInt(limit as string))\r\n        .skip(parseInt(offset as string))\r\n        .toArray()\r\n\r\n      console.log('≡ƒÆ¼ Found', topComments.length, 'top-level comments')\r\n\r\n      // Get all comment IDs for replies and likes\r\n      const commentIds = topComments.map(c => c.id).filter(Boolean) as number[]\r\n      console.log('≡ƒöó Comment IDs:', commentIds)\r\n      \r\n      // Get replies for these comments\r\n      const replies = commentIds.length > 0 \r\n        ? await comments.find({ parent_id: { $in: commentIds } } as any).sort({ created_at: 1 }).toArray()\r\n        : []\r\n      \r\n      // Get all likes for comments and replies\r\n      const allCommentIds = [...commentIds, ...replies.map(r => r.id).filter(Boolean)] as number[]\r\n      const likes = allCommentIds.length > 0\r\n        ? await commentLikes.find({ comment_id: { $in: allCommentIds } } as any).toArray()\r\n        : []\r\n\r\n      \r\n      // Get all unique user IDs\r\n      const userIds = [...new Set([\r\n        ...topComments.map(c => c.user_id),\r\n        ...replies.map(r => r.user_id)\r\n      ])].filter(Boolean) as number[]\r\n      \r\n      console.log('≡ƒæÑ Fetching users:', userIds)\r\n      const usersData = await users.find({ id: { $in: userIds } } as any).toArray()\r\n      console.log('Γ£à Found', usersData.length, 'users')\r\n      const userMap = new Map(usersData.map(u => [u.id, u]))      // Transform data to match frontend expectations\r\n      const transformedComments = topComments.map((comment: any) => {\r\n        const user = userMap.get(comment.user_id)\r\n        const commentLikesData = likes.filter(l => l.comment_id === comment.id)\r\n        const userLiked = currentUserId ? \r\n          commentLikesData.some(like => like.user_id === currentUserId) : false\r\n        \r\n        const commentReplies = replies.filter(r => r.parent_id === comment.id)\r\n        \r\n        return {\r\n          id: comment.id,\r\n          user: {\r\n            id: user?.id,\r\n            name: user?.name,\r\n            department: user?.department,\r\n            year: user?.year,\r\n            profile_image: user?.profile_image,\r\n          },\r\n          text: comment.comment_text,\r\n          timestamp: getTimeAgo(comment.created_at),\r\n          created_at: comment.created_at,\r\n          likes: commentLikesData.length,\r\n          userLiked: userLiked,\r\n          replies: commentReplies.map((r: any) => {\r\n            const replyUser = userMap.get(r.user_id)\r\n            const replyLikes = likes.filter(l => l.comment_id === r.id)\r\n            return {\r\n              id: r.id,\r\n              text: r.comment_text,\r\n              user: { \r\n                id: replyUser?.id, \r\n                name: replyUser?.name, \r\n                profile_image: replyUser?.profile_image \r\n              },\r\n              created_at: r.created_at,\r\n              timestamp: getTimeAgo(r.created_at),\r\n              likes: replyLikes.length,\r\n              userLiked: currentUserId ? \r\n                replyLikes.some(like => like.user_id === currentUserId) : false\r\n            }\r\n          })\r\n        }\r\n      })\r\n\r\n      console.log('≡ƒôñ Returning', transformedComments.length, 'comments')\r\n      res.status(200).json({ comments: transformedComments })\r\n    } catch (error) {\r\n      console.error('Γ¥î Error fetching comments:', error)\r\n      res.status(500).json({ error: 'Failed to fetch comments' })\r\n    }\r\n  } else if (req.method === 'POST') {\r\n    // Create a new comment\r\n    try {\r\n      const auth = getUserFromRequest(req)\r\n      if (!auth) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n      }\r\n\r\n      const { postId, comment_text, parent_id } = req.body\r\n\r\n      if (!postId || !comment_text) {\r\n        return res.status(400).json({ error: 'Post ID and comment text are required' })\r\n      }\r\n\r\n      if (comment_text.trim().length === 0) {\r\n        return res.status(400).json({ error: 'Comment cannot be empty' })\r\n      }\r\n\r\n      if (comment_text.length > 2200) {\r\n        return res.status(400).json({ error: 'Comment too long (max 2200 characters)' })\r\n      }\r\n\r\n      const posts = await getCollection<Post>(Collections.POSTS)\r\n      const comments = await getCollection<Comment>(Collections.COMMENTS)\r\n      const users = await getCollection<User>(Collections.USERS)\r\n\r\n      // Check if post exists\r\n      const post = await posts.findOne({ id: parseInt(postId) })\r\n\r\n      if (!post) {\r\n        return res.status(404).json({ error: 'Post not found' })\r\n      }\r\n\r\n      // Create the comment\r\n      const commentId = await getNextSequenceValue('comments')\r\n      const newComment: Comment = {\r\n        id: commentId,\r\n        post_id: parseInt(postId),\r\n        user_id: auth.userId,\r\n        comment_text: comment_text.trim(),\r\n        created_at: new Date(),\r\n        ...(parent_id && { parent_id: parseInt(parent_id) })\r\n      }\r\n\r\n      await comments.insertOne(newComment as any)\r\n\r\n      // Get user data\r\n      const user = await users.findOne({ id: auth.userId })\r\n\r\n      // Transform data to match frontend expectations\r\n      const transformedComment = {\r\n        id: commentId,\r\n        user: {\r\n          id: user?.id,\r\n          name: user?.name,\r\n          department: user?.department,\r\n          year: user?.year,\r\n          profile_image: user?.profile_image,\r\n        },\r\n        text: newComment.comment_text,\r\n        timestamp: 'now',\r\n        created_at: newComment.created_at,\r\n      }\r\n\r\n      // Notify post owner if commenter is not the owner\r\n      try {\r\n        if (post.user_id && post.user_id !== auth.userId && (global as any).io) {\r\n          ;(global as any).io.to(`user-${post.user_id}`).emit('notification', {\r\n            id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\r\n            type: 'comment',\r\n            message: 'Someone commented on your post',\r\n            time: new Date().toISOString(),\r\n            read: false,\r\n            meta: { postId: parseInt(postId), actorId: auth.userId, commentId: commentId }\r\n          })\r\n        }\r\n      } catch {}\r\n\r\n      res.status(201).json({ comment: transformedComment })\r\n    } catch (error) {\r\n      console.error('Error creating comment:', error)\r\n      res.status(500).json({ error: 'Failed to create comment' })\r\n    }\r\n  } else if (req.method === 'DELETE') {\r\n    try {\r\n      const auth = getUserFromRequest(req)\r\n      if (!auth) return res.status(401).json({ error: 'Unauthorized' })\r\n\r\n      const { id } = req.query\r\n      if (!id) return res.status(400).json({ error: 'Comment ID required' })\r\n\r\n      const comments = await getCollection<Comment>(Collections.COMMENTS)\r\n      const comment = await comments.findOne({ id: parseInt(id as string) })\r\n      \r\n      if (!comment) return res.status(404).json({ error: 'Comment not found' })\r\n      if (comment.user_id !== auth.userId) return res.status(403).json({ error: 'Forbidden' })\r\n\r\n      await comments.deleteOne({ id: comment.id })\r\n      return res.status(204).end()\r\n    } catch (error) {\r\n      console.error('Delete comment error:', error)\r\n      res.status(500).json({ error: 'Failed to delete comment' })\r\n    }\r\n  } else {\r\n    res.setHeader('Allow', ['GET', 'POST', 'DELETE'])\r\n    res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n  }\r\n}\r\n\r\n// Helper function to calculate time ago\r\nfunction getTimeAgo(date: Date): string {\r\n  const now = new Date()\r\n  const commentDate = new Date(date)\r\n  const diffInMinutes = Math.floor((now.getTime() - commentDate.getTime()) / (1000 * 60))\r\n\r\n  if (diffInMinutes < 1) return 'now'\r\n  if (diffInMinutes < 60) return `${diffInMinutes}m`\r\n  \r\n  const diffInHours = Math.floor(diffInMinutes / 60)\r\n  if (diffInHours < 24) return `${diffInHours}h`\r\n  \r\n  const diffInDays = Math.floor(diffInHours / 24)\r\n  if (diffInDays < 7) return `${diffInDays}d`\r\n  \r\n  const diffInWeeks = Math.floor(diffInDays / 7)\r\n  return `${diffInWeeks}w`\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\comments\\like.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1560,1563],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1560,1563],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, Comment, CommentLike, getNextSequenceValue } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) return res.status(401).json({ error: 'Unauthorized' })\r\n\r\n    const { commentId } = req.body || {}\r\n    const id = parseInt(commentId)\r\n    if (!id || Number.isNaN(id)) return res.status(400).json({ error: 'Comment ID is required' })\r\n\r\n    const comments = await getCollection<Comment>(Collections.COMMENTS)\r\n    const commentLikes = await getCollection<CommentLike>(Collections.COMMENT_LIKES)\r\n\r\n    // Check comment exists and current like status\r\n    const [comment, existing] = await Promise.all([\r\n      comments.findOne({ id }),\r\n      commentLikes.findOne({ user_id: auth.userId, comment_id: id })\r\n    ])\r\n\r\n    if (!comment) return res.status(404).json({ error: 'Comment not found' })\r\n\r\n    // Toggle like\r\n    if (existing) {\r\n      await commentLikes.deleteOne({\r\n        user_id: auth.userId,\r\n        comment_id: id\r\n      })\r\n    } else {\r\n      const likeId = await getNextSequenceValue('comment_likes')\r\n      await commentLikes.insertOne({\r\n        id: likeId,\r\n        user_id: auth.userId,\r\n        comment_id: id,\r\n        created_at: new Date()\r\n      } as any)\r\n    }\r\n\r\n    const newCount = await commentLikes.countDocuments({ comment_id: id })\r\n    const liked = !existing\r\n\r\n    return res.status(200).json({ likes: newCount, liked })\r\n  } catch (error) {\r\n    console.error('Toggle comment like error:', error)\r\n    return res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\db\\test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":7,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[332,335],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[332,335],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1068,1071],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1068,1071],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, connectToDatabase } from '../../../lib/mongodb'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  try {\r\n    const maskedUrl = process.env.MONGODB_URI?.replace(/:[^:@]*@/, ':***@')\r\n    const status: any = {\r\n      env: {\r\n        MONGODB_URI: process.env.MONGODB_URI ? 'SET' : 'MISSING',\r\n        NODE_ENV: process.env.NODE_ENV,\r\n      },\r\n      maskedUrl,\r\n      diagnostics: {},\r\n    }\r\n\r\n    // Try connection\r\n    const { db, client } = await connectToDatabase()\r\n    status.diagnostics.connected = !!db\r\n\r\n    // Count users as a simple query\r\n    const users = await getCollection(Collections.USERS)\r\n    const userCount = await users.countDocuments()\r\n    status.diagnostics.userCount = userCount\r\n\r\n    // Simple ping command\r\n    const admin = client.db('admin')\r\n    const ping = await admin.command({ ping: 1 })\r\n    status.diagnostics.ping = ping\r\n\r\n    return res.status(200).json({ ok: true, status })\r\n  } catch (error: any) {\r\n    return res.status(200).json({ ok: false, error: error?.message, code: error?.code })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\debug\\test-post.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'userCount' is assigned a value but never used.","line":41,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":41,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\nimport { parseForm, uploadToCloudinary, getFileType } from '../../../lib/upload'\r\n\r\nexport const config = {\r\n  api: {\r\n    bodyParser: false,\r\n  },\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    // Environment check\r\n    const envCheck = {\r\n      MONGODB_URI: !!process.env.MONGODB_URI ? 'SET' : 'MISSING',\r\n      JWT_SECRET: !!process.env.JWT_SECRET ? 'SET' : 'MISSING',\r\n      CLOUDINARY_CLOUD_NAME: !!process.env.CLOUDINARY_CLOUD_NAME ? 'SET' : 'MISSING',\r\n      CLOUDINARY_API_KEY: !!process.env.CLOUDINARY_API_KEY ? 'SET' : 'MISSING',\r\n      CLOUDINARY_API_SECRET: !!process.env.CLOUDINARY_API_SECRET ? 'SET' : 'MISSING',\r\n      NODE_ENV: process.env.NODE_ENV,\r\n    }\r\n\r\n    // Authentication test\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(200).json({\r\n        success: false,\r\n        step: 'authentication',\r\n        error: 'No authentication provided - add Authorization header',\r\n        environment: envCheck,\r\n      })\r\n    }\r\n\r\n    // Database connection test\r\n    const users = await getCollection(Collections.USERS)\r\n    const userCount = await users.countDocuments()\r\n\r\n    // User validation\r\n    const user = await users.findOne({ id: auth.userId })\r\n    \r\n    if (!user) {\r\n      return res.status(200).json({\r\n        success: false,\r\n        step: 'user_validation',\r\n        error: 'User not found',\r\n        userId: auth.userId,\r\n        environment: envCheck\r\n      })\r\n    }\r\n\r\n    // Form parsing test\r\n    let fields, files\r\n    try {\r\n      const parsed = await parseForm(req)\r\n      fields = parsed.fields\r\n      files = parsed.files\r\n    } catch (parseError) {\r\n      return res.status(200).json({\r\n        success: false,\r\n        step: 'form_parsing',\r\n        error: parseError instanceof Error ? parseError.message : 'Form parsing failed',\r\n        environment: envCheck\r\n      })\r\n    }\r\n\r\n    // Cloudinary upload test (if file provided)\r\n    let uploadResult = null\r\n    if (files.media) {\r\n      try {\r\n        const file = Array.isArray(files.media) ? files.media[0] : files.media\r\n        if (file?.filepath) {\r\n          const fileType = getFileType(file.originalFilename || '')\r\n          if (fileType !== 'unknown') {\r\n            uploadResult = await uploadToCloudinary(file.filepath, fileType)\r\n          }\r\n        }\r\n      } catch (uploadError) {\r\n        return res.status(200).json({\r\n          success: false,\r\n          step: 'cloudinary_upload',\r\n          error: uploadError instanceof Error ? uploadError.message : 'Upload failed',\r\n          environment: envCheck,\r\n        })\r\n      }\r\n    }\r\n\r\n    const caption = fields.caption ? (Array.isArray(fields.caption) ? fields.caption[0] : fields.caption).toString() : 'Debug test post'\r\n    \r\n    return res.status(200).json({\r\n      success: true,\r\n      message: 'Post debug test successful',\r\n      environment: envCheck,\r\n      user: {\r\n        id: user.id,\r\n        name: user.name,\r\n        department: user.department,\r\n        year: user.year\r\n      },\r\n      uploadResult: uploadResult,\r\n      caption: caption.trim(),\r\n      recommendations: [\r\n        uploadResult ? 'Γ£à File upload working' : 'ΓÜá∩╕Å No file provided for upload test',\r\n        envCheck.CLOUDINARY_CLOUD_NAME === 'SET' ? 'Γ£à Cloudinary configured' : 'Γ¥î Add Cloudinary environment variables',\r\n      ],\r\n      timestamp: new Date().toISOString()\r\n    })\r\n\r\n  } catch (error) {\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Unknown error',\r\n      timestamp: new Date().toISOString()\r\n    })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\debug\\test-registration.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\graph\\follow.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":107,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3374,3377],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3374,3377],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * API Endpoint: Follow/Unfollow User\r\n * \r\n * POST /api/graph/follow - Follow a user\r\n * DELETE /api/graph/follow - Unfollow a user\r\n */\r\n\r\nimport type { NextApiRequest, NextApiResponse } from 'next'\r\nimport { socialGraph } from '../../../lib/socialGraph'\r\nimport { getCollection, Collections, withRetry } from '../../../lib/mongodb'\r\nimport { ObjectId } from 'mongodb'\r\nimport jwt from 'jsonwebtoken'\r\n\r\n// JWT secret for auth verification\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'\r\n\r\n/**\r\n * Extract user ID from authorization header\r\n */\r\nfunction getUserIdFromToken(req: NextApiRequest): string | null {\r\n    const authHeader = req.headers.authorization\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = authHeader.split(' ')[1]\r\n        const decoded = jwt.verify(token, JWT_SECRET) as { userId: string }\r\n        return decoded.userId\r\n    } catch {\r\n        return null\r\n    }\r\n}\r\n\r\nexport default async function handler(\r\n    req: NextApiRequest,\r\n    res: NextApiResponse\r\n) {\r\n    // Authenticate the request\r\n    const userId = getUserIdFromToken(req)\r\n    if (!userId) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { targetUserId } = req.body || req.query\r\n\r\n    if (!targetUserId) {\r\n        return res.status(400).json({ error: 'targetUserId is required' })\r\n    }\r\n\r\n    // Validate targetUserId format\r\n    if (!ObjectId.isValid(targetUserId as string)) {\r\n        return res.status(400).json({ error: 'Invalid targetUserId format' })\r\n    }\r\n\r\n    try {\r\n        // Verify target user exists\r\n        const usersCollection = await getCollection(Collections.USERS)\r\n        const targetUser = await usersCollection.findOne({\r\n            _id: new ObjectId(targetUserId as string)\r\n        })\r\n\r\n        if (!targetUser) {\r\n            return res.status(404).json({ error: 'Target user not found' })\r\n        }\r\n\r\n        switch (req.method) {\r\n            case 'POST': {\r\n                // Follow the user\r\n                const edge = await withRetry(() =>\r\n                    socialGraph.followUser(userId, targetUserId as string)\r\n                )\r\n\r\n                return res.status(200).json({\r\n                    success: true,\r\n                    message: 'Successfully followed user',\r\n                    data: {\r\n                        sourceUserId: userId,\r\n                        targetUserId,\r\n                        createdAt: edge.createdAt,\r\n                    }\r\n                })\r\n            }\r\n\r\n            case 'DELETE': {\r\n                // Unfollow the user\r\n                const unfollowed = await withRetry(() =>\r\n                    socialGraph.unfollowUser(userId, targetUserId as string)\r\n                )\r\n\r\n                if (!unfollowed) {\r\n                    return res.status(400).json({\r\n                        error: 'Not following this user'\r\n                    })\r\n                }\r\n\r\n                return res.status(200).json({\r\n                    success: true,\r\n                    message: 'Successfully unfollowed user',\r\n                })\r\n            }\r\n\r\n            default:\r\n                res.setHeader('Allow', ['POST', 'DELETE'])\r\n                return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n        }\r\n    } catch (error: any) {\r\n        console.error('Follow/Unfollow error:', error)\r\n\r\n        if (error.message === 'Users cannot follow themselves') {\r\n            return res.status(400).json({ error: error.message })\r\n        }\r\n\r\n        return res.status(500).json({\r\n            error: 'Internal server error',\r\n            details: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n        })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\graph\\followers.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":108,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3700,3703],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3700,3703],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * API Endpoint: Get Followers List\r\n * \r\n * GET /api/graph/followers?userId=xxx - Get followers of a user\r\n * GET /api/graph/followers?userId=xxx&limit=20&offset=0 - With pagination\r\n */\r\n\r\nimport type { NextApiRequest, NextApiResponse } from 'next'\r\nimport { socialGraph } from '../../../lib/socialGraph'\r\nimport { withRetry } from '../../../lib/mongodb'\r\nimport { ObjectId } from 'mongodb'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'\r\n\r\n/**\r\n * Extract user ID from authorization header\r\n */\r\nfunction getUserIdFromToken(req: NextApiRequest): string | null {\r\n    const authHeader = req.headers.authorization\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = authHeader.split(' ')[1]\r\n        const decoded = jwt.verify(token, JWT_SECRET) as { userId: string }\r\n        return decoded.userId\r\n    } catch {\r\n        return null\r\n    }\r\n}\r\n\r\nexport default async function handler(\r\n    req: NextApiRequest,\r\n    res: NextApiResponse\r\n) {\r\n    if (req.method !== 'GET') {\r\n        res.setHeader('Allow', ['GET'])\r\n        return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n    }\r\n\r\n    // Authenticate the request\r\n    const currentUserId = getUserIdFromToken(req)\r\n    if (!currentUserId) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    // Get query parameters\r\n    const { userId, limit = '50', offset = '0' } = req.query\r\n\r\n    // Default to current user if no userId specified\r\n    const targetUserId = (userId as string) || currentUserId\r\n\r\n    // Validate userId format\r\n    if (!ObjectId.isValid(targetUserId)) {\r\n        return res.status(400).json({ error: 'Invalid userId format' })\r\n    }\r\n\r\n    // Parse pagination params\r\n    const limitNum = Math.min(Math.max(parseInt(limit as string, 10) || 50, 1), 100)\r\n    const offsetNum = Math.max(parseInt(offset as string, 10) || 0, 0)\r\n\r\n    try {\r\n        // Get followers list with user data and edge info\r\n        const followers = await withRetry(() =>\r\n            socialGraph.getFollowers(targetUserId, limitNum, offsetNum)\r\n        )\r\n\r\n        // Get total followers count for pagination\r\n        const totalCount = await socialGraph.getFollowersCount(targetUserId)\r\n\r\n        // Check if current user follows each follower (for follow back button)\r\n        const followerIds = followers.map(f => f.user.userId)\r\n        const followingStatus = await socialGraph.bulkCheckFollowing(\r\n            currentUserId,\r\n            followerIds\r\n        )\r\n\r\n        // Format response with follow status\r\n        const formattedFollowers = followers.map(({ user, edge }) => ({\r\n            id: user.userId.toString(),\r\n            name: user.name,\r\n            department: user.department,\r\n            year: user.year,\r\n            role: user.role,\r\n            isActive: user.isActive,\r\n            // Relationship info\r\n            followedAt: edge.createdAt,\r\n            interactionWeight: edge.interactionWeight,\r\n            lastInteraction: edge.lastInteractionTimestamp,\r\n            // Whether current user follows this person back\r\n            isFollowedByMe: followingStatus.get(user.userId.toString()) || false,\r\n        }))\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            data: {\r\n                followers: formattedFollowers,\r\n                pagination: {\r\n                    total: totalCount,\r\n                    limit: limitNum,\r\n                    offset: offsetNum,\r\n                    hasMore: offsetNum + followers.length < totalCount,\r\n                }\r\n            }\r\n        })\r\n    } catch (error: any) {\r\n        console.error('Get followers error:', error)\r\n        return res.status(500).json({\r\n            error: 'Internal server error',\r\n            details: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n        })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\graph\\following.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3356,3359],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3356,3359],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * API Endpoint: Get Following List\r\n * \r\n * GET /api/graph/following?userId=xxx - Get users that someone follows\r\n * GET /api/graph/following?userId=xxx&limit=20&offset=0 - With pagination\r\n */\r\n\r\nimport type { NextApiRequest, NextApiResponse } from 'next'\r\nimport { socialGraph } from '../../../lib/socialGraph'\r\nimport { withRetry } from '../../../lib/mongodb'\r\nimport { ObjectId } from 'mongodb'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'\r\n\r\n/**\r\n * Extract user ID from authorization header\r\n */\r\nfunction getUserIdFromToken(req: NextApiRequest): string | null {\r\n    const authHeader = req.headers.authorization\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = authHeader.split(' ')[1]\r\n        const decoded = jwt.verify(token, JWT_SECRET) as { userId: string }\r\n        return decoded.userId\r\n    } catch {\r\n        return null\r\n    }\r\n}\r\n\r\nexport default async function handler(\r\n    req: NextApiRequest,\r\n    res: NextApiResponse\r\n) {\r\n    if (req.method !== 'GET') {\r\n        res.setHeader('Allow', ['GET'])\r\n        return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n    }\r\n\r\n    // Authenticate the request\r\n    const currentUserId = getUserIdFromToken(req)\r\n    if (!currentUserId) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    // Get query parameters\r\n    const { userId, limit = '50', offset = '0' } = req.query\r\n\r\n    // Default to current user if no userId specified\r\n    const targetUserId = (userId as string) || currentUserId\r\n\r\n    // Validate userId format\r\n    if (!ObjectId.isValid(targetUserId)) {\r\n        return res.status(400).json({ error: 'Invalid userId format' })\r\n    }\r\n\r\n    // Parse pagination params\r\n    const limitNum = Math.min(Math.max(parseInt(limit as string, 10) || 50, 1), 100)\r\n    const offsetNum = Math.max(parseInt(offset as string, 10) || 0, 0)\r\n\r\n    try {\r\n        // Get following list with user data and edge info\r\n        const following = await withRetry(() =>\r\n            socialGraph.getFollowing(targetUserId, limitNum, offsetNum)\r\n        )\r\n\r\n        // Get total following count for pagination\r\n        const totalCount = await socialGraph.getFollowingCount(targetUserId)\r\n\r\n        // Format response\r\n        const formattedFollowing = following.map(({ user, edge }) => ({\r\n            id: user.userId.toString(),\r\n            name: user.name,\r\n            department: user.department,\r\n            year: user.year,\r\n            role: user.role,\r\n            isActive: user.isActive,\r\n            // Relationship info\r\n            followedAt: edge.createdAt,\r\n            interactionWeight: edge.interactionWeight,\r\n            lastInteraction: edge.lastInteractionTimestamp,\r\n            // Interaction breakdown\r\n            interactionCounts: edge.interactionCounts,\r\n        }))\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            data: {\r\n                following: formattedFollowing,\r\n                pagination: {\r\n                    total: totalCount,\r\n                    limit: limitNum,\r\n                    offset: offsetNum,\r\n                    hasMore: offsetNum + following.length < totalCount,\r\n                }\r\n            }\r\n        })\r\n    } catch (error: any) {\r\n        console.error('Get following error:', error)\r\n        return res.status(500).json({\r\n            error: 'Internal server error',\r\n            details: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n        })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\graph\\interaction.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":107,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3258,3261],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3258,3261],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * API Endpoint: Record Interaction (Update Edge Weight)\r\n * \r\n * POST /api/graph/interaction - Record an interaction between users\r\n * \r\n * This endpoint is called internally when users like, comment, message, etc.\r\n * It updates the edge weight in the social graph.\r\n */\r\n\r\nimport type { NextApiRequest, NextApiResponse } from 'next'\r\nimport { socialGraph, InteractionType } from '../../../lib/socialGraph'\r\nimport { withRetry } from '../../../lib/mongodb'\r\nimport { ObjectId } from 'mongodb'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'\r\n\r\n// Valid interaction types\r\nconst VALID_INTERACTION_TYPES: InteractionType[] = [\r\n    'like', 'comment', 'message', 'share', 'mention'\r\n]\r\n\r\n/**\r\n * Extract user ID from authorization header\r\n */\r\nfunction getUserIdFromToken(req: NextApiRequest): string | null {\r\n    const authHeader = req.headers.authorization\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = authHeader.split(' ')[1]\r\n        const decoded = jwt.verify(token, JWT_SECRET) as { userId: string }\r\n        return decoded.userId\r\n    } catch {\r\n        return null\r\n    }\r\n}\r\n\r\nexport default async function handler(\r\n    req: NextApiRequest,\r\n    res: NextApiResponse\r\n) {\r\n    if (req.method !== 'POST') {\r\n        res.setHeader('Allow', ['POST'])\r\n        return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n    }\r\n\r\n    // Authenticate the request\r\n    const currentUserId = getUserIdFromToken(req)\r\n    if (!currentUserId) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { targetUserId, interactionType } = req.body\r\n\r\n    // Validate required fields\r\n    if (!targetUserId) {\r\n        return res.status(400).json({ error: 'targetUserId is required' })\r\n    }\r\n\r\n    if (!interactionType) {\r\n        return res.status(400).json({ error: 'interactionType is required' })\r\n    }\r\n\r\n    // Validate targetUserId format\r\n    if (!ObjectId.isValid(targetUserId)) {\r\n        return res.status(400).json({ error: 'Invalid targetUserId format' })\r\n    }\r\n\r\n    // Validate interaction type\r\n    if (!VALID_INTERACTION_TYPES.includes(interactionType)) {\r\n        return res.status(400).json({\r\n            error: `Invalid interactionType. Must be one of: ${VALID_INTERACTION_TYPES.join(', ')}`\r\n        })\r\n    }\r\n\r\n    // Prevent self-interaction tracking (optional)\r\n    if (currentUserId === targetUserId) {\r\n        return res.status(200).json({\r\n            success: true,\r\n            message: 'Self-interactions are not tracked'\r\n        })\r\n    }\r\n\r\n    try {\r\n        // Update edge weight for this interaction\r\n        await withRetry(() =>\r\n            socialGraph.updateEdgeWeight(\r\n                currentUserId,\r\n                targetUserId,\r\n                interactionType as InteractionType\r\n            )\r\n        )\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            message: 'Interaction recorded',\r\n            data: {\r\n                sourceUserId: currentUserId,\r\n                targetUserId,\r\n                interactionType,\r\n                recordedAt: new Date(),\r\n            }\r\n        })\r\n    } catch (error: any) {\r\n        console.error('Record interaction error:', error)\r\n        return res.status(500).json({\r\n            error: 'Internal server error',\r\n            details: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n        })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\graph\\mutual.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":92,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2888,2891],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2888,2891],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * API Endpoint: Get Mutual Connections\r\n * \r\n * GET /api/graph/mutual?userId=xxx - Get mutual connections with another user\r\n */\r\n\r\nimport type { NextApiRequest, NextApiResponse } from 'next'\r\nimport { socialGraph } from '../../../lib/socialGraph'\r\nimport { withRetry } from '../../../lib/mongodb'\r\nimport { ObjectId } from 'mongodb'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'\r\n\r\n/**\r\n * Extract user ID from authorization header\r\n */\r\nfunction getUserIdFromToken(req: NextApiRequest): string | null {\r\n    const authHeader = req.headers.authorization\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = authHeader.split(' ')[1]\r\n        const decoded = jwt.verify(token, JWT_SECRET) as { userId: string }\r\n        return decoded.userId\r\n    } catch {\r\n        return null\r\n    }\r\n}\r\n\r\nexport default async function handler(\r\n    req: NextApiRequest,\r\n    res: NextApiResponse\r\n) {\r\n    if (req.method !== 'GET') {\r\n        res.setHeader('Allow', ['GET'])\r\n        return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n    }\r\n\r\n    // Authenticate the request\r\n    const currentUserId = getUserIdFromToken(req)\r\n    if (!currentUserId) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { userId, type = 'following' } = req.query\r\n\r\n    if (!userId) {\r\n        return res.status(400).json({ error: 'userId is required' })\r\n    }\r\n\r\n    // Validate userId format\r\n    if (!ObjectId.isValid(userId as string)) {\r\n        return res.status(400).json({ error: 'Invalid userId format' })\r\n    }\r\n\r\n    try {\r\n        let mutualConnections\r\n\r\n        if (type === 'followers') {\r\n            // Get users that follow both current user and target user\r\n            mutualConnections = await withRetry(() =>\r\n                socialGraph.getMutualFollowers(currentUserId, userId as string)\r\n            )\r\n        } else {\r\n            // Get users that both current user and target user follow\r\n            mutualConnections = await withRetry(() =>\r\n                socialGraph.getMutualConnections(currentUserId, userId as string)\r\n            )\r\n        }\r\n\r\n        // Format response\r\n        const formattedConnections = mutualConnections.map(user => ({\r\n            id: user.userId.toString(),\r\n            name: user.name,\r\n            department: user.department,\r\n            year: user.year,\r\n            role: user.role,\r\n            isActive: user.isActive,\r\n        }))\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            data: {\r\n                type: type === 'followers' ? 'mutual_followers' : 'mutual_following',\r\n                mutualConnections: formattedConnections,\r\n                count: formattedConnections.length,\r\n            }\r\n        })\r\n    } catch (error: any) {\r\n        console.error('Get mutual connections error:', error)\r\n        return res.status(500).json({\r\n            error: 'Internal server error',\r\n            details: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n        })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\graph\\relationship.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":82,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2728,2731],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2728,2731],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * API Endpoint: Check Relationship Strength\r\n * \r\n * GET /api/graph/relationship?targetUserId=xxx - Get relationship strength with another user\r\n */\r\n\r\nimport type { NextApiRequest, NextApiResponse } from 'next'\r\nimport { socialGraph } from '../../../lib/socialGraph'\r\nimport { withRetry } from '../../../lib/mongodb'\r\nimport { ObjectId } from 'mongodb'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'\r\n\r\n/**\r\n * Extract user ID from authorization header\r\n */\r\nfunction getUserIdFromToken(req: NextApiRequest): string | null {\r\n    const authHeader = req.headers.authorization\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = authHeader.split(' ')[1]\r\n        const decoded = jwt.verify(token, JWT_SECRET) as { userId: string }\r\n        return decoded.userId\r\n    } catch {\r\n        return null\r\n    }\r\n}\r\n\r\nexport default async function handler(\r\n    req: NextApiRequest,\r\n    res: NextApiResponse\r\n) {\r\n    if (req.method !== 'GET') {\r\n        res.setHeader('Allow', ['GET'])\r\n        return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n    }\r\n\r\n    // Authenticate the request\r\n    const currentUserId = getUserIdFromToken(req)\r\n    if (!currentUserId) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { targetUserId } = req.query\r\n\r\n    if (!targetUserId) {\r\n        return res.status(400).json({ error: 'targetUserId is required' })\r\n    }\r\n\r\n    // Validate targetUserId format\r\n    if (!ObjectId.isValid(targetUserId as string)) {\r\n        return res.status(400).json({ error: 'Invalid targetUserId format' })\r\n    }\r\n\r\n    try {\r\n        // Get relationship strength between current user and target\r\n        const relationship = await withRetry(() =>\r\n            socialGraph.getRelationshipStrength(currentUserId, targetUserId as string)\r\n        )\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            data: {\r\n                sourceUserId: currentUserId,\r\n                targetUserId,\r\n                // Follow status\r\n                isFollowing: relationship.isFollowing,\r\n                isFollowedBy: relationship.isFollowedBy,\r\n                isMutual: relationship.isMutual,\r\n                // Strength metrics\r\n                interactionWeight: Math.round(relationship.interactionWeight * 100) / 100,\r\n                strengthCategory: relationship.strengthCategory,\r\n                lastInteraction: relationship.lastInteraction,\r\n                // Human-readable description\r\n                description: getRelationshipDescription(relationship),\r\n            }\r\n        })\r\n    } catch (error: any) {\r\n        console.error('Get relationship error:', error)\r\n        return res.status(500).json({\r\n            error: 'Internal server error',\r\n            details: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n        })\r\n    }\r\n}\r\n\r\n/**\r\n * Generate human-readable relationship description\r\n */\r\nfunction getRelationshipDescription(relationship: {\r\n    isFollowing: boolean\r\n    isFollowedBy: boolean\r\n    isMutual: boolean\r\n    strengthCategory: string\r\n}): string {\r\n    if (!relationship.isFollowing && !relationship.isFollowedBy) {\r\n        return 'No connection'\r\n    }\r\n\r\n    if (relationship.isMutual) {\r\n        switch (relationship.strengthCategory) {\r\n            case 'strong':\r\n                return 'Close mutual connection with frequent interactions'\r\n            case 'moderate':\r\n                return 'Mutual connection with regular interactions'\r\n            default:\r\n                return 'Mutual connection'\r\n        }\r\n    }\r\n\r\n    if (relationship.isFollowing && !relationship.isFollowedBy) {\r\n        return 'You follow them, but they don\\'t follow back'\r\n    }\r\n\r\n    if (!relationship.isFollowing && relationship.isFollowedBy) {\r\n        return 'They follow you, but you don\\'t follow back'\r\n    }\r\n\r\n    return 'Connected'\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\graph\\stats.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":84,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2901,2904],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2901,2904],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * API Endpoint: Graph Statistics\r\n * \r\n * GET /api/graph/stats - Get overall graph statistics\r\n * \r\n * Useful for admin dashboards and analytics\r\n */\r\n\r\nimport type { NextApiRequest, NextApiResponse } from 'next'\r\nimport { socialGraph } from '../../../lib/socialGraph'\r\nimport { withRetry } from '../../../lib/mongodb'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'\r\n\r\n/**\r\n * Extract user ID from authorization header\r\n */\r\nfunction getUserIdFromToken(req: NextApiRequest): string | null {\r\n    const authHeader = req.headers.authorization\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = authHeader.split(' ')[1]\r\n        const decoded = jwt.verify(token, JWT_SECRET) as { userId: string }\r\n        return decoded.userId\r\n    } catch {\r\n        return null\r\n    }\r\n}\r\n\r\nexport default async function handler(\r\n    req: NextApiRequest,\r\n    res: NextApiResponse\r\n) {\r\n    if (req.method !== 'GET') {\r\n        res.setHeader('Allow', ['GET'])\r\n        return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n    }\r\n\r\n    // Authenticate the request\r\n    const currentUserId = getUserIdFromToken(req)\r\n    if (!currentUserId) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    try {\r\n        // Get overall graph statistics\r\n        const stats = await withRetry(() => socialGraph.getGraphStats())\r\n\r\n        // Get current user's specific stats\r\n        const [followersCount, followingCount] = await Promise.all([\r\n            socialGraph.getFollowersCount(currentUserId),\r\n            socialGraph.getFollowingCount(currentUserId),\r\n        ])\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            data: {\r\n                // Global stats\r\n                global: {\r\n                    totalUsers: stats.totalNodes,\r\n                    totalConnections: stats.totalEdges,\r\n                    avgFollowersPerUser: Math.round(stats.avgFollowersPerUser * 100) / 100,\r\n                    avgFollowingPerUser: Math.round(stats.avgFollowingPerUser * 100) / 100,\r\n                    networkDensity: stats.totalNodes > 1\r\n                        ? Math.round((stats.totalEdges / (stats.totalNodes * (stats.totalNodes - 1))) * 10000) / 100\r\n                        : 0,\r\n                },\r\n                // Current user stats\r\n                user: {\r\n                    userId: currentUserId,\r\n                    followers: followersCount,\r\n                    following: followingCount,\r\n                    // Engagement ratio (followers/following)\r\n                    engagementRatio: followingCount > 0\r\n                        ? Math.round((followersCount / followingCount) * 100) / 100\r\n                        : followersCount,\r\n                }\r\n            }\r\n        })\r\n    } catch (error: any) {\r\n        console.error('Get stats error:', error)\r\n        return res.status(500).json({\r\n            error: 'Internal server error',\r\n            details: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n        })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\graph\\suggestions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":106,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3522,3525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3522,3525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * API Endpoint: Get User Suggestions\r\n * \r\n * GET /api/graph/suggestions - Get personalized user suggestions\r\n * \r\n * Query params:\r\n * - sameDepartment: boolean - Limit to same department\r\n * - sameYear: boolean - Limit to same year\r\n * - limit: number - Max suggestions (default 20)\r\n */\r\n\r\nimport type { NextApiRequest, NextApiResponse } from 'next'\r\nimport { socialGraph } from '../../../lib/socialGraph'\r\nimport { withRetry } from '../../../lib/mongodb'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'\r\n\r\n/**\r\n * Extract user ID from authorization header\r\n */\r\nfunction getUserIdFromToken(req: NextApiRequest): string | null {\r\n    const authHeader = req.headers.authorization\r\n    if (!authHeader?.startsWith('Bearer ')) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = authHeader.split(' ')[1]\r\n        const decoded = jwt.verify(token, JWT_SECRET) as { userId: string }\r\n        return decoded.userId\r\n    } catch {\r\n        return null\r\n    }\r\n}\r\n\r\nexport default async function handler(\r\n    req: NextApiRequest,\r\n    res: NextApiResponse\r\n) {\r\n    if (req.method !== 'GET') {\r\n        res.setHeader('Allow', ['GET'])\r\n        return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n    }\r\n\r\n    // Authenticate the request\r\n    const currentUserId = getUserIdFromToken(req)\r\n    if (!currentUserId) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    // Parse query parameters\r\n    const {\r\n        sameDepartment = 'false',\r\n        sameYear = 'false',\r\n        limit = '20'\r\n    } = req.query\r\n\r\n    const filters = {\r\n        sameDepartment: sameDepartment === 'true',\r\n        sameYear: sameYear === 'true',\r\n    }\r\n\r\n    const limitNum = Math.min(Math.max(parseInt(limit as string, 10) || 20, 1), 50)\r\n\r\n    try {\r\n        // Get personalized suggestions\r\n        const suggestions = await withRetry(() =>\r\n            socialGraph.getSuggestions(currentUserId, filters, limitNum)\r\n        )\r\n\r\n        // Format response\r\n        const formattedSuggestions = suggestions.map(suggestion => ({\r\n            id: suggestion.userId.toString(),\r\n            name: suggestion.name,\r\n            department: suggestion.department,\r\n            year: suggestion.year,\r\n            role: suggestion.role,\r\n            // Suggestion metadata\r\n            mutualConnections: suggestion.mutualConnectionsCount,\r\n            relevanceScore: Math.round(suggestion.relevanceScore),\r\n            reason: suggestion.reason,\r\n            // Connection path for \"through X, Y, Z\" display\r\n            connectionPath: suggestion.connectionPath,\r\n        }))\r\n\r\n        // Group suggestions by category for better UX\r\n        const categorizedSuggestions = {\r\n            highRelevance: formattedSuggestions.filter(s => s.relevanceScore >= 70),\r\n            mediumRelevance: formattedSuggestions.filter(s => s.relevanceScore >= 40 && s.relevanceScore < 70),\r\n            lowRelevance: formattedSuggestions.filter(s => s.relevanceScore < 40),\r\n        }\r\n\r\n        return res.status(200).json({\r\n            success: true,\r\n            data: {\r\n                suggestions: formattedSuggestions,\r\n                categorized: categorizedSuggestions,\r\n                total: formattedSuggestions.length,\r\n                filters: {\r\n                    sameDepartment: filters.sameDepartment,\r\n                    sameYear: filters.sameYear,\r\n                }\r\n            }\r\n        })\r\n    } catch (error: any) {\r\n        console.error('Get suggestions error:', error)\r\n        return res.status(500).json({\r\n            error: 'Internal server error',\r\n            details: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n        })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\health.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\[messageId].ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\[messageId]\\react.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\[messageId]\\unsend.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3063,3066],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3063,3066],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next';\r\nimport { verifyToken } from '../../../../lib/auth';\r\nimport { getCollection, Collections } from '../../../../lib/mongodb';\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' });\r\n  }\r\n\r\n  try {\r\n    const token = req.headers.authorization?.replace('Bearer ', '');\r\n    if (!token) {\r\n      return res.status(401).json({ error: 'Unauthorized' });\r\n    }\r\n\r\n    const decoded = verifyToken(token);\r\n    if (!decoded) {\r\n      return res.status(401).json({ error: 'Invalid token' });\r\n    }\r\n\r\n    const { messageId } = req.query;\r\n    const numericMessageId = parseInt(messageId as string);\r\n\r\n    if (isNaN(numericMessageId)) {\r\n      return res.status(400).json({ error: 'Invalid message ID' });\r\n    }\r\n\r\n    const messagesCollection = await getCollection(Collections.MESSAGES);\r\n\r\n    // Find the message\r\n    const message = await messagesCollection.findOne({ id: numericMessageId });\r\n\r\n    console.log(`[UNSEND] Looking for message ID: ${numericMessageId}`);\r\n    \r\n    if (!message) {\r\n      console.log(`[UNSEND] Message ${numericMessageId} not found in database`);\r\n      // Message might have already been deleted - return success anyway\r\n      return res.status(200).json({ success: true, message: 'Message already removed' });\r\n    }\r\n\r\n    console.log(`[UNSEND] Found message from ${message.sender_id} to ${message.receiver_id}`);\r\n\r\n    // Check if the user is the sender (MongoDB uses snake_case)\r\n    if (message.sender_id !== decoded.userId) {\r\n      return res.status(403).json({ error: 'You can only unsend your own messages' });\r\n    }\r\n\r\n    // Delete the message (unsend for everyone)\r\n    const deleteResult = await messagesCollection.deleteOne({ id: numericMessageId });\r\n    console.log(`[UNSEND] Delete result: ${deleteResult.deletedCount} document(s) deleted`);\r\n\r\n    // Get receiver ID for socket event (from message we found earlier)\r\n    const receiverId = message.receiver_id;\r\n\r\n    // Emit socket event to notify both users\r\n    try {\r\n      // Use the internal socket server URL (not the public one)\r\n      let socketUrl = process.env.SOCKET_SERVER_URL || 'http://localhost:3001';\r\n      // Remove trailing slash if present\r\n      socketUrl = socketUrl.replace(/\\/+$/, '');\r\n      \r\n      console.log(`[UNSEND] Emitting socket event to: ${socketUrl}/emit-message-unsend`);\r\n      \r\n      const socketResponse = await fetch(`${socketUrl}/emit-message-unsend`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          messageId: numericMessageId,\r\n          senderId: decoded.userId,\r\n          receiverId: receiverId\r\n        })\r\n      });\r\n      \r\n      if (socketResponse.ok) {\r\n        console.log(`[UNSEND] Socket event emitted successfully`);\r\n      } else {\r\n        console.error(`[UNSEND] Socket event failed: ${socketResponse.status}`);\r\n      }\r\n    } catch (e: any) {\r\n      console.error('Socket notification error:', e.message);\r\n      // Socket notification failed, but message was deleted\r\n    }\r\n\r\n    res.status(200).json({ success: true });\r\n  } catch (error) {\r\n    console.error('Error unsending message:', error);\r\n    res.status(500).json({ error: 'Failed to unsend message' });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\conversation\\[userId].ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2870,2873],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2870,2873],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections } from '../../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../../lib/auth'\r\n\r\ninterface Message {\r\n  id: number\r\n  sender_id: number\r\n  receiver_id: number\r\n  message_text: string\r\n  media_url: string | null\r\n  reply_to_id?: number | null\r\n  reaction?: string | null\r\n  deleted_for?: number[]\r\n  created_at: Date\r\n}\r\n\r\ninterface User {\r\n  id: number\r\n  name: string\r\n  profile_image: string | null\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'GET') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { userId } = req.query\r\n    const { page = '1', limit = '50' } = req.query\r\n\r\n    // Enhanced validation\r\n    if (!userId || Array.isArray(userId)) {\r\n      return res.status(400).json({ error: 'Valid user ID is required' })\r\n    }\r\n\r\n    const otherUserId = parseInt(userId as string, 10)\r\n    if (isNaN(otherUserId) || otherUserId <= 0) {\r\n      return res.status(400).json({ error: 'Invalid user ID format' })\r\n    }\r\n\r\n    // Validate pagination parameters\r\n    const pageNum = Math.max(1, parseInt(page as string, 10) || 1)\r\n    const limitNum = Math.min(100, Math.max(1, parseInt(limit as string, 10) || 50))\r\n    const offset = (pageNum - 1) * limitNum\r\n\r\n    const messages = await getCollection<Message>(Collections.MESSAGES)\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    const blocks = await getCollection(Collections.BLOCKS)\r\n\r\n    // Check if either user has blocked the other\r\n    const blockExists = await blocks.findOne({\r\n      $or: [\r\n        { blocker_id: auth.userId, blocked_user_id: otherUserId },\r\n        { blocker_id: otherUserId, blocked_user_id: auth.userId }\r\n      ]\r\n    })\r\n\r\n    if (blockExists) {\r\n      return res.status(403).json({ \r\n        error: 'Cannot access conversation with this user',\r\n        blocked: true \r\n      })\r\n    }\r\n\r\n    // Get messages between current user and specified user\r\n    const messageList = await messages.find({\r\n      $or: [\r\n        { sender_id: auth.userId, receiver_id: otherUserId },\r\n        { sender_id: otherUserId, receiver_id: auth.userId }\r\n      ]\r\n    }).sort({ created_at: -1 }).skip(offset).limit(limitNum).toArray()\r\n\r\n    // Get total count for pagination\r\n    const totalCount = await messages.countDocuments({\r\n      $or: [\r\n        { sender_id: auth.userId, receiver_id: otherUserId },\r\n        { sender_id: otherUserId, receiver_id: auth.userId }\r\n      ]\r\n    })\r\n\r\n    // Get user details\r\n    const userIds = [auth.userId, otherUserId]\r\n    const messageUsers = await users.find({ id: { $in: userIds } as any }).toArray()\r\n    const userMap = new Map(messageUsers.map(u => [u.id, u]))\r\n\r\n    const otherUser = userMap.get(otherUserId)\r\n\r\n    if (!otherUser) {\r\n      return res.status(404).json({ error: 'User not found' })\r\n    }\r\n\r\n    // Build replyTo data for messages\r\n    const messagesWithReply = await Promise.all(messageList.map(async (msg) => {\r\n      let replyTo = null\r\n      if (msg.reply_to_id) {\r\n        const replyToMsg = await messages.findOne({ id: msg.reply_to_id })\r\n        if (replyToMsg) {\r\n          const replyToSender = userMap.get(replyToMsg.sender_id)\r\n          replyTo = {\r\n            id: replyToMsg.id,\r\n            text: replyToMsg.message_text,\r\n            senderName: replyToSender?.name || 'Unknown'\r\n          }\r\n        }\r\n      }\r\n\r\n      return {\r\n        id: msg.id,\r\n        senderId: msg.sender_id,\r\n        receiverId: msg.receiver_id,\r\n        messageText: msg.message_text,\r\n        mediaUrl: msg.media_url,\r\n        reaction: msg.reaction || null,\r\n        deleted_for: msg.deleted_for || [],\r\n        createdAt: msg.created_at.toISOString(),\r\n        sender: userMap.get(msg.sender_id) || null,\r\n        receiver: userMap.get(msg.receiver_id) || null,\r\n        replyTo\r\n      }\r\n    }))\r\n\r\n    // Create conversation ID\r\n    const conversationId = [auth.userId, otherUserId].sort().join('-')\r\n\r\n    res.status(200).json({\r\n      messages: messagesWithReply.reverse(),\r\n      otherUser: {\r\n        id: otherUser.id,\r\n        name: otherUser.name,\r\n        profile_image: otherUser.profile_image\r\n      },\r\n      conversationId: conversationId,\r\n      pagination: {\r\n        page: pageNum,\r\n        limit: limitNum,\r\n        total: totalCount,\r\n        hasMore: offset + limitNum < totalCount\r\n      }\r\n    })\r\n  } catch (error) {\r\n    console.error('Get conversation error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\conversations.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1396,1399],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1396,1399],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\ninterface Message {\r\n  id: number\r\n  sender_id: number\r\n  receiver_id: number\r\n  message_text: string\r\n  media_url: string | null\r\n  created_at: Date\r\n}\r\n\r\ninterface User {\r\n  id: number\r\n  name: string\r\n  profile_image: string | null\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'GET') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const messages = await getCollection<Message>(Collections.MESSAGES)\r\n    const users = await getCollection<User>(Collections.USERS)\r\n\r\n    // Get all messages where user is sender or receiver\r\n    const conversations = await messages.find({\r\n      $or: [\r\n        { sender_id: auth.userId },\r\n        { receiver_id: auth.userId }\r\n      ]\r\n    }).sort({ created_at: -1 }).toArray()\r\n\r\n    // Get unique user IDs\r\n    const userIds = new Set<number>()\r\n    conversations.forEach(m => {\r\n      userIds.add(m.sender_id)\r\n      userIds.add(m.receiver_id)\r\n    })\r\n\r\n    const messageUsers = await users.find({ id: { $in: Array.from(userIds) } as any }).toArray()\r\n    const userMap = new Map(messageUsers.map(u => [u.id, u]))\r\n\r\n    // Group messages by conversation partner\r\n    const conversationMap = new Map()\r\n\r\n    conversations.forEach(message => {\r\n      const otherUserId = message.sender_id === auth.userId ? message.receiver_id : message.sender_id\r\n      const otherUser = userMap.get(otherUserId)\r\n\r\n      if (!conversationMap.has(otherUserId) && otherUser) {\r\n        const conversationId = [auth.userId, otherUserId].sort().join('-')\r\n        \r\n        conversationMap.set(otherUserId, {\r\n          conversationId: conversationId,\r\n          otherUser: {\r\n            id: otherUser.id,\r\n            name: otherUser.name,\r\n            profile_image: otherUser.profile_image\r\n          },\r\n          lastMessage: {\r\n            id: message.id,\r\n            text: message.message_text || '',\r\n            mediaUrl: message.media_url,\r\n            createdAt: message.created_at.toISOString(),\r\n            senderId: message.sender_id,\r\n            isFromMe: message.sender_id === auth.userId\r\n          },\r\n          unreadCount: 0 // TODO: Implement read status tracking\r\n        })\r\n      }\r\n    })\r\n\r\n    // Convert map to array\r\n    const conversationList = Array.from(conversationMap.values())\r\n\r\n    res.status(200).json({\r\n      conversations: conversationList\r\n    })\r\n  } catch (error) {\r\n    console.error('Get conversations error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\conversations\\[id]\\archive.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getCollection' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Collections' is defined but never used.","line":3,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next';\r\nimport { verify } from 'jsonwebtoken';\r\nimport { getCollection, Collections } from '../../../../../lib/mongodb';\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' });\r\n  }\r\n\r\n  try {\r\n    const { authorization } = req.headers;\r\n    const { id: conversationId } = req.query;\r\n\r\n    if (!authorization) {\r\n      return res.status(401).json({ error: 'Authorization header required' });\r\n    }\r\n\r\n    const token = authorization.split(' ')[1];\r\n    if (!token) {\r\n      return res.status(401).json({ error: 'Token required' });\r\n    }\r\n\r\n    // Verify token\r\n    const decoded = verify(token, process.env.JWT_SECRET!) as { userId: number };\r\n    const userId = decoded.userId;\r\n\r\n    if (!userId) {\r\n      return res.status(401).json({ error: 'Invalid token' });\r\n    }\r\n\r\n    if (!conversationId || typeof conversationId !== 'string') {\r\n      return res.status(400).json({ error: 'Invalid conversation ID' });\r\n    }\r\n\r\n    // Parse conversation ID to get user IDs\r\n    const userIds = conversationId.split('-').map(id => parseInt(id));\r\n    \r\n    if (userIds.length !== 2 || !userIds.includes(userId)) {\r\n      return res.status(403).json({ error: 'You can only archive your own conversations' });\r\n    }\r\n\r\n    // For simplicity, we'll just return success\r\n    // In a real app, you'd want to add an archived_conversations table\r\n    return res.status(200).json({ \r\n      success: true, \r\n      message: 'Conversation archived successfully' \r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Archive conversation error:', error);\r\n    return res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\conversations\\[id]\\block.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\conversations\\[id]\\delete.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\conversations\\[id]\\unread.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1765,1768],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1765,1768],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2574,2577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2574,2577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isMeta' is assigned a value but never used.","line":109,"column":49,"nodeType":null,"messageId":"unusedVar","endLine":109,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4784,4787],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4784,4787],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, getNextSequenceValue } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\ninterface Message {\r\n  id: number\r\n  sender_id: number\r\n  receiver_id: number\r\n  message_text: string\r\n  media_url: string | null\r\n  reply_to_id?: number | null\r\n  created_at: Date\r\n}\r\n\r\ninterface User {\r\n  id: number\r\n  name: string\r\n  department: string\r\n  year: string\r\n  profile_image: string | null\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method === 'GET') {\r\n    return handleGetMessages(req, res)\r\n  }\r\n  \r\n  if (req.method === 'POST') {\r\n    return handleSendMessage(req, res)\r\n  }\r\n  \r\n  return res.status(405).json({ error: 'Method not allowed' })\r\n}\r\n\r\nasync function handleGetMessages(req: NextApiRequest, res: NextApiResponse) {\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { userId } = req.query\r\n    const messages = await getCollection<Message>(Collections.MESSAGES)\r\n    const users = await getCollection<User>(Collections.USERS)\r\n\r\n    if (!userId) {\r\n      // Get all conversations for the user\r\n      const allMessages = await messages.find({\r\n        $or: [\r\n          { sender_id: auth.userId },\r\n          { receiver_id: auth.userId }\r\n        ]\r\n      }).sort({ created_at: -1 }).limit(50).toArray()\r\n\r\n      // Get unique user IDs\r\n      const userIds = new Set<number>()\r\n      allMessages.forEach(m => {\r\n        userIds.add(m.sender_id)\r\n        userIds.add(m.receiver_id)\r\n      })\r\n\r\n      const messageUsers = await users.find({ id: { $in: Array.from(userIds) } as any }).toArray()\r\n      const userMap = new Map(messageUsers.map(u => [u.id, u]))\r\n\r\n      const conversations = allMessages.map(m => ({\r\n        ...m,\r\n        sender: userMap.get(m.sender_id) || null,\r\n        receiver: userMap.get(m.receiver_id) || null,\r\n      }))\r\n\r\n      return res.status(200).json({ conversations })\r\n    }\r\n\r\n    // Get messages between current user and specific user\r\n    const targetUserId = parseInt(userId as string)\r\n    const messageList = await messages.find({\r\n      $or: [\r\n        { sender_id: auth.userId, receiver_id: targetUserId },\r\n        { sender_id: targetUserId, receiver_id: auth.userId }\r\n      ]\r\n    }).sort({ created_at: 1 }).toArray()\r\n\r\n    // Get user details\r\n    const messageUsers = await users.find({\r\n      id: { $in: [auth.userId, targetUserId] } as any\r\n    }).toArray()\r\n    const userMap = new Map(messageUsers.map(u => [u.id, u]))\r\n\r\n    const result = messageList.map(m => ({\r\n      ...m,\r\n      sender: userMap.get(m.sender_id) || null,\r\n      receiver: userMap.get(m.receiver_id) || null,\r\n    }))\r\n\r\n    res.status(200).json({ messages: result })\r\n  } catch (error) {\r\n    console.error('Get messages error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n\r\nasync function handleSendMessage(req: NextApiRequest, res: NextApiResponse) {\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { receiverId, messageText, replyToId, isMeta = false } = req.body\r\n\r\n    if (!receiverId || !messageText) {\r\n      return res.status(400).json({ error: 'Receiver ID and message text are required' })\r\n    }\r\n\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    const messages = await getCollection<Message>(Collections.MESSAGES)\r\n\r\n    // Check if receiver exists\r\n    const receiver = await users.findOne({ id: parseInt(receiverId) })\r\n\r\n    if (!receiver) {\r\n      return res.status(404).json({ error: 'Receiver not found' })\r\n    }\r\n\r\n    // Get sender\r\n    const sender = await users.findOne({ id: auth.userId })\r\n\r\n    // If replying, get the original message\r\n    let replyToMessage = null\r\n    if (replyToId) {\r\n      replyToMessage = await messages.findOne({ id: parseInt(replyToId) })\r\n      if (replyToMessage) {\r\n        const replyToSender = await users.findOne({ id: replyToMessage.sender_id })\r\n        replyToMessage = {\r\n          id: replyToMessage.id,\r\n          text: replyToMessage.message_text,\r\n          senderName: replyToSender?.name || 'Unknown'\r\n        }\r\n      }\r\n    }\r\n\r\n    // Create message\r\n    const messageId = await getNextSequenceValue('messages')\r\n    const newMessage: Message = {\r\n      id: messageId,\r\n      sender_id: auth.userId,\r\n      receiver_id: parseInt(receiverId),\r\n      message_text: messageText,\r\n      media_url: null,\r\n      reply_to_id: replyToId ? parseInt(replyToId) : null,\r\n      created_at: new Date()\r\n    }\r\n\r\n    await messages.insertOne(newMessage as any)\r\n\r\n    const result = {\r\n      ...newMessage,\r\n      sender: sender ? {\r\n        id: sender.id,\r\n        name: sender.name,\r\n        department: sender.department,\r\n        year: sender.year,\r\n        profile_image: sender.profile_image\r\n      } : null,\r\n      receiver: {\r\n        id: receiver.id,\r\n        name: receiver.name,\r\n        department: receiver.department,\r\n        year: receiver.year,\r\n        profile_image: receiver.profile_image\r\n      },\r\n      replyTo: replyToMessage\r\n    }\r\n\r\n    res.status(201).json({ message: result, success: 'Message sent successfully' })\r\n  } catch (error) {\r\n    console.error('Send message error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\messages\\send.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":7,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[263,266],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[263,266],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":84,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2500,2503],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2500,2503],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, getNextSequenceValue } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\n// Extend global to include io\r\ndeclare global {\r\n  var io: any\r\n}\r\n\r\ninterface Message {\r\n  id: number\r\n  sender_id: number\r\n  receiver_id: number\r\n  message_text: string\r\n  media_url: string | null\r\n  created_at: Date\r\n}\r\n\r\ninterface User {\r\n  id: number\r\n  name: string\r\n  profile_image: string | null\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { receiverId, messageText, mediaUrl } = req.body\r\n\r\n    if (!receiverId || (!messageText && !mediaUrl)) {\r\n      return res.status(400).json({ error: 'Receiver ID and message content are required' })\r\n    }\r\n\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    const messages = await getCollection<Message>(Collections.MESSAGES)\r\n    const blocks = await getCollection(Collections.BLOCKS)\r\n\r\n    // Verify receiver exists\r\n    const receiver = await users.findOne({ id: parseInt(receiverId) })\r\n\r\n    if (!receiver) {\r\n      return res.status(404).json({ error: 'Receiver not found' })\r\n    }\r\n\r\n    // Can't message yourself\r\n    if (parseInt(receiverId) === auth.userId) {\r\n      return res.status(400).json({ error: 'Cannot send message to yourself' })\r\n    }\r\n\r\n    // Check if either user has blocked the other\r\n    const blockExists = await blocks.findOne({\r\n      $or: [\r\n        { blocker_id: auth.userId, blocked_user_id: parseInt(receiverId) },\r\n        { blocker_id: parseInt(receiverId), blocked_user_id: auth.userId }\r\n      ]\r\n    })\r\n\r\n    if (blockExists) {\r\n      return res.status(403).json({ error: 'Cannot send message to this user' })\r\n    }\r\n\r\n    // Get sender info\r\n    const sender = await users.findOne({ id: auth.userId })\r\n\r\n    // Create the message\r\n    const messageId = await getNextSequenceValue('messages')\r\n    const newMessage: Message = {\r\n      id: messageId,\r\n      sender_id: auth.userId,\r\n      receiver_id: parseInt(receiverId),\r\n      message_text: messageText || '',\r\n      media_url: mediaUrl || null,\r\n      created_at: new Date()\r\n    }\r\n\r\n    await messages.insertOne(newMessage as any)\r\n\r\n    // Create conversation ID (consistent regardless of who sends first)\r\n    const conversationId = [auth.userId, parseInt(receiverId)].sort().join('-')\r\n\r\n    // Emit real-time message via Socket.io\r\n    if (global.io) {\r\n      const messageData = {\r\n        id: newMessage.id,\r\n        senderId: newMessage.sender_id,\r\n        receiverId: newMessage.receiver_id,\r\n        messageText: newMessage.message_text,\r\n        mediaUrl: newMessage.media_url,\r\n        createdAt: newMessage.created_at.toISOString(),\r\n        sender: sender,\r\n        receiver: receiver,\r\n        conversationId: conversationId\r\n      }\r\n\r\n      // Send to conversation room\r\n      global.io.to(`conversation-${conversationId}`).emit('new-message', messageData)\r\n      \r\n      // Send notification to receiver\r\n      global.io.to(`user-${receiverId}`).emit('message-notification', {\r\n        ...messageData,\r\n        type: 'new-message'\r\n      })\r\n    }\r\n\r\n    res.status(201).json({\r\n      message: 'Message sent successfully',\r\n      data: {\r\n        id: newMessage.id,\r\n        senderId: newMessage.sender_id,\r\n        receiverId: newMessage.receiver_id,\r\n        messageText: newMessage.message_text,\r\n        mediaUrl: newMessage.media_url,\r\n        createdAt: newMessage.created_at.toISOString(),\r\n        sender: sender,\r\n        receiver: receiver,\r\n        conversationId: conversationId\r\n      }\r\n    })\r\n  } catch (error) {\r\n    console.error('Send message error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\posts\\[postId].ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\posts\\aura.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2127,2130],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2127,2130],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":91,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2853,2856],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2853,2856],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":92,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2887,2890],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2887,2890],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, Post, Aura, withRetry, getNextSequenceValue } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { postId } = req.body\r\n\r\n    // Enhanced validation\r\n    if (!postId || (typeof postId !== 'number' && typeof postId !== 'string') || Number(postId) <= 0) {\r\n      return res.status(400).json({ error: 'Valid post ID is required' })\r\n    }\r\n\r\n    const validPostId = typeof postId === 'number' ? postId : parseInt(postId, 10)\r\n    if (isNaN(validPostId)) {\r\n      return res.status(400).json({ error: 'Invalid post ID format' })\r\n    }\r\n\r\n    const posts = await getCollection<Post>(Collections.POSTS)\r\n    const auras = await getCollection<Aura>(Collections.AURAS)\r\n\r\n    // Check if post exists and process aura\r\n    const result = await withRetry(async () => {\r\n      // Check if post exists\r\n      const post = await posts.findOne({ id: validPostId })\r\n\r\n      if (!post) {\r\n        return { error: 'Post not found', status: 404 }\r\n      }\r\n\r\n      // Check if user already gave aura\r\n      const existingAura = await auras.findOne({\r\n        user_id: auth.userId,\r\n        post_id: validPostId\r\n      })\r\n\r\n      let action: 'liked' | 'unliked'\r\n      let isLiked: boolean\r\n\r\n      if (existingAura) {\r\n        // Remove aura  \r\n        await auras.deleteOne({\r\n          user_id: auth.userId,\r\n          post_id: validPostId\r\n        })\r\n        action = 'unliked'\r\n        isLiked = false\r\n      } else {\r\n        // Add aura\r\n        const auraId = await getNextSequenceValue('auras')\r\n        await auras.insertOne({\r\n          id: auraId,\r\n          user_id: auth.userId,\r\n          post_id: validPostId,\r\n          created_at: new Date()\r\n        } as any)\r\n        action = 'liked'\r\n        isLiked = true\r\n      }\r\n\r\n      // Get updated aura count\r\n      const auraCount = await auras.countDocuments({ post_id: validPostId })\r\n\r\n      return {\r\n        post: {\r\n          id: validPostId,\r\n          aura_count: auraCount,\r\n          user_liked: isLiked\r\n        },\r\n        action,\r\n        post_owner_id: post.user_id\r\n      }\r\n    })\r\n\r\n    if ('status' in result && result.status === 404) {\r\n      return res.status(404).json({ error: result.error })\r\n    }\r\n\r\n    // Send notification outside of transaction to avoid blocking\r\n    if ('post_owner_id' in result && result.action === 'liked' && result.post_owner_id !== auth.userId) {\r\n      try {\r\n        if ((global as any).io) {\r\n          ;(global as any).io.to(`user-${result.post_owner_id}`).emit('notification', {\r\n            id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\r\n            type: 'like',\r\n            message: 'Someone liked your post',\r\n            time: new Date().toISOString(),\r\n            read: false,\r\n            meta: { postId: validPostId, actorId: auth.userId }\r\n          })\r\n        }\r\n      } catch (notificationError) {\r\n        console.warn('Failed to send notification:', notificationError)\r\n      }\r\n    }\r\n\r\n    res.status(200).json({ \r\n      post: result.post, \r\n      action: result.action,\r\n      message: `Post ${result.action} successfully` \r\n    })\r\n  } catch (error) {\r\n    console.error('Toggle aura error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\posts\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":54,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1925,1928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1925,1928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2205,2208],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2205,2208],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2242,2245],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2242,2245],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":103,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4027,4030],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4027,4030],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4097,4100],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4097,4100],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":105,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4164,4167],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4164,4167],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":106,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4260,4263],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4260,4263],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":107,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4391,4394],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4391,4394],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":122,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5036,5039],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5036,5039],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":147,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":147,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6041,6044],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6041,6044],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":152,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6266,6269],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6266,6269],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":347,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":347,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13799,13802],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13799,13802],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":349,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":349,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13876,13879],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13876,13879],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":354,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":354,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14005,14008],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14005,14008],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":377,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":377,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14667,14670],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14667,14670],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":15,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, withRetry, User, Post, Aura, Comment, Follower, getNextSequenceValue, serializeDoc } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\nimport { parseForm, uploadToCloudinary, getFileType } from '../../../lib/upload'\r\n\r\nexport const config = {\r\n  api: {\r\n    bodyParser: false,\r\n  },\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method === 'GET') {\r\n    return handleGetPosts(req, res)\r\n  }\r\n\r\n  if (req.method === 'POST') {\r\n    return handleCreatePost(req, res)\r\n  }\r\n\r\n  return res.status(405).json({ error: 'Method not allowed' })\r\n}\r\n\r\nasync function handleGetPosts(req: NextApiRequest, res: NextApiResponse) {\r\n  try {\r\n    // Authentication optional for reading posts\r\n    const auth = getUserFromRequest(req)\r\n\r\n    const { category, limit = '20', offset = '0' } = req.query\r\n\r\n    // Map frontend category values to database enum values\r\n    const categoryMap: { [key: string]: string } = {\r\n      'general': 'GENERAL',\r\n      'academic': 'ACADEMIC',\r\n      'events': 'EVENTS',\r\n      'event': 'EVENT', // Support both singular and plural\r\n      'clubs': 'CLUBS',\r\n      'sports': 'SPORTS',\r\n      'social': 'SOCIAL',\r\n      'internship': 'INTERNSHIP',\r\n      'workshop': 'WORKSHOP',\r\n      'library': 'LIBRARY_MEMORY',\r\n      'library_memory': 'LIBRARY_MEMORY',\r\n      'memory': 'LIBRARY_MEMORY',\r\n    }\r\n\r\n    const posts = await getCollection<Post>(Collections.POSTS)\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    const comments = await getCollection<Comment>(Collections.COMMENTS)\r\n    const auras = await getCollection<Aura>(Collections.AURAS)\r\n    const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n\r\n    // Convert category using mapping instead of just uppercase\r\n    const filter: any = {}\r\n    if (category && category !== 'all') {\r\n      filter.category = categoryMap[(category as string).toLowerCase()] || 'GENERAL'\r\n    }\r\n\r\n    // If viewing another user's posts and they are private and not followed, gate results\r\n    const viewingUserId = (req.query as any).userId ? parseInt((req.query as any).userId) : undefined\r\n    if (viewingUserId && !isNaN(viewingUserId)) {\r\n      const target = await users.findOne({ id: viewingUserId })\r\n      if (target?.is_private) {\r\n        const following = auth ? await followers.findOne({ \r\n          follower_id: auth.userId, \r\n          following_id: viewingUserId \r\n        }) : null\r\n        if (!following && (!auth || auth.userId !== viewingUserId)) {\r\n          // Return empty posts for unauthorized viewers of private profile\r\n          res.setHeader('Cache-Control', 'private, max-age=10, stale-while-revalidate=30')\r\n          return res.status(200).json({ posts: [] })\r\n        }\r\n      }\r\n      filter.user_id = viewingUserId\r\n    }\r\n\r\n    const postList = await withRetry(async () => {\r\n      return posts.find(filter)\r\n        .sort({ created_at: -1 })\r\n        .limit(parseInt(limit as string))\r\n        .skip(parseInt(offset as string))\r\n        .toArray()\r\n    })\r\n\r\n    if (postList.length === 0) {\r\n      res.setHeader('Cache-Control', 'private, max-age=10, stale-while-revalidate=30')\r\n      return res.status(200).json({ posts: [] })\r\n    }\r\n\r\n    // Get all unique user IDs and post IDs\r\n    const userIds = [...new Set(postList.map(p => p.user_id))].filter(Boolean) as number[]\r\n    const postIds = postList.map(p => p.id).filter(Boolean) as number[]\r\n    \r\n    console.log('≡ƒôè Posts data:', {\r\n      totalPosts: postList.length,\r\n      userIds: userIds,\r\n      postIds: postIds,\r\n      samplePost: postList[0] ? { id: postList[0].id, user_id: postList[0].user_id, caption: postList[0].caption?.substring(0, 30) } : null\r\n    })\r\n\r\n    // Fetch related data in parallel\r\n    const [postUsers, postComments, postAuras, likedPosts, followingRelations] = await Promise.all([\r\n      users.find({ id: { $in: userIds } as any }).toArray(),\r\n      comments.find({ post_id: { $in: postIds } as any }).toArray(),\r\n      auras.find({ post_id: { $in: postIds } as any }).toArray(),\r\n      auth ? auras.find({ user_id: auth.userId, post_id: { $in: postIds } as any }).toArray() : Promise.resolve([]),\r\n      auth ? followers.find({ follower_id: auth.userId, following_id: { $in: userIds } as any }).toArray() : Promise.resolve([])\r\n    ])\r\n\r\n    // Create lookup maps\r\n    const userMap = new Map(postUsers.map(u => [u.id, u]))\r\n    const likedPostIdSet = new Set(likedPosts.map(l => l.post_id))\r\n    const followingIdSet = new Set(followingRelations.map(f => f.following_id))\r\n    \r\n    console.log('≡ƒæÑ Users fetched:', {\r\n      totalUsers: postUsers.length,\r\n      userMapKeys: Array.from(userMap.keys()),\r\n      sampleUser: postUsers[0] ? { id: postUsers[0].id, name: postUsers[0].name } : null\r\n    })\r\n\r\n    // Filter out posts from private accounts that the user doesn't follow\r\n    const filteredPostList = postList.filter((post: any) => {\r\n      const author = userMap.get(post.user_id)\r\n      \r\n      // If no author found, include the post (shouldn't happen but safe fallback)\r\n      if (!author) return true\r\n      \r\n      // If author is not private, show the post\r\n      if (!author.is_private) return true\r\n      \r\n      // If viewing own posts, show them\r\n      if (auth && auth.userId === author.id) return true\r\n      \r\n      // If author is private, only show if the viewer follows them\r\n      return auth && author.id !== undefined && followingIdSet.has(author.id)\r\n    })\r\n\r\n    console.log('≡ƒöÆ Privacy filter applied:', {\r\n      originalCount: postList.length,\r\n      filteredCount: filteredPostList.length,\r\n      removedCount: postList.length - filteredPostList.length\r\n    })\r\n\r\n    // Get comment users\r\n    const commentUserIds = [...new Set(postComments.map(c => c.user_id))].filter(Boolean) as number[]\r\n    const commentUsers = commentUserIds.length > 0\r\n      ? await users.find({ id: { $in: commentUserIds } as any }).toArray()\r\n      : []\r\n    const commentUserMap = new Map(commentUsers.map(u => [u.id, u]))\r\n\r\n    // Transform posts with all related data (use filtered list)\r\n    const transformedPosts = filteredPostList.map((post: any) => {\r\n      const author = userMap.get(post.user_id)\r\n      \r\n      // Debug logging for missing authors\r\n      if (!author) {\r\n        console.warn('ΓÜá∩╕Å Missing author for post:', post.id, 'user_id:', post.user_id)\r\n        console.warn('Available users in map:', Array.from(userMap.keys()))\r\n      }\r\n      \r\n      const postCommentsData = postComments\r\n        .filter(c => c.post_id === post.id)\r\n        .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())\r\n        .slice(0, 3)\r\n        .map(c => {\r\n          const commentUser = commentUserMap.get(Number(c.user_id))\r\n          return {\r\n            id: c.id,\r\n            comment_text: c.comment_text,\r\n            created_at: c.created_at,\r\n            user: {\r\n              id: commentUser?.id,\r\n              name: commentUser?.name || 'Unknown User',\r\n              department: commentUser?.department || 'Unknown',\r\n              year: commentUser?.year || 1,\r\n            }\r\n          }\r\n        })\r\n\r\n      const auraCount = postAuras.filter(a => a.post_id === post.id).length\r\n      const commentCount = postComments.filter(c => c.post_id === post.id).length\r\n\r\n      return {\r\n        ...serializeDoc(post),\r\n        content: post.caption || '',\r\n        user: {\r\n          id: author?.id || post.user_id,\r\n          name: author?.name || 'Unknown User',\r\n          department: author?.department || 'Unknown',\r\n          year: author?.year || 1,\r\n          profile_image: author?.profile_image || null,\r\n        },\r\n        author: {\r\n          id: author?.id || post.user_id,\r\n          name: author?.name || 'Unknown User',\r\n          department: author?.department || 'Unknown',\r\n          year: author?.year || 1,\r\n          profile_image: author?.profile_image || null,\r\n        },\r\n        aura_count: auraCount,\r\n        comment_count: commentCount,\r\n        user_liked: auth ? likedPostIdSet.has(post.id) : false,\r\n        recent_comments: postCommentsData,\r\n        comments: postCommentsData,\r\n        _count: {\r\n          comments: commentCount,\r\n          auras: auraCount,\r\n        }\r\n      }\r\n    })\r\n\r\n    // Small cache to improve perceived performance\r\n    res.setHeader('Cache-Control', 'private, max-age=10, stale-while-revalidate=30')\r\n    res.status(200).json({ posts: transformedPosts })\r\n  } catch (error) {\r\n    console.error('Get posts error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n\r\nasync function handleCreatePost(req: NextApiRequest, res: NextApiResponse) {\r\n  console.log('≡ƒöä Post creation started at:', new Date().toISOString())\r\n  console.log('≡ƒôè Environment check:', {\r\n    CLOUDINARY_CLOUD_NAME: !!process.env.CLOUDINARY_CLOUD_NAME ? 'SET' : 'MISSING',\r\n    CLOUDINARY_API_KEY: !!process.env.CLOUDINARY_API_KEY ? 'SET' : 'MISSING',\r\n    CLOUDINARY_API_SECRET: !!process.env.CLOUDINARY_API_SECRET ? 'SET' : 'MISSING',\r\n  })\r\n\r\n  try {\r\n    // Verify authentication\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      console.log('Γ¥î Authentication failed')\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n    console.log('Γ£à Authentication successful for user:', auth.userId)\r\n\r\n    // Parse form data\r\n    console.log('≡ƒô¥ Parsing form data...')\r\n    const { fields, files } = await parseForm(req)\r\n    console.log('Γ£à Form parsed. Fields:', Object.keys(fields), 'Files:', Object.keys(files))\r\n\r\n    // Accept either caption or legacy content field\r\n    const captionField = Array.isArray(fields.caption) ? fields.caption[0] : fields.caption\r\n    const legacyContentField = Array.isArray(fields.content) ? fields.content[0] : fields.content\r\n    const caption = (captionField ?? legacyContentField ?? '').toString()\r\n    const categoryInput = Array.isArray(fields.category) ? fields.category[0] : fields.category || 'general'\r\n\r\n    console.log('≡ƒô¥ Parsed data:', { caption: caption.substring(0, 50) + '...', categoryInput })\r\n\r\n    // Map category to valid enum values\r\n    const categoryMap: { [key: string]: string } = {\r\n      'general': 'GENERAL',\r\n      'academic': 'ACADEMIC',\r\n      'events': 'EVENTS',\r\n      'event': 'EVENT',\r\n      'clubs': 'CLUBS',\r\n      'sports': 'SPORTS',\r\n      'social': 'SOCIAL',\r\n      'internship': 'INTERNSHIP',\r\n      'workshop': 'WORKSHOP',\r\n      'library': 'LIBRARY_MEMORY',\r\n      'library_memory': 'LIBRARY_MEMORY',\r\n      'memory': 'LIBRARY_MEMORY',\r\n    }\r\n\r\n    const category = categoryMap[categoryInput.toLowerCase()] || 'GENERAL'\r\n\r\n    let mediaUrl = null\r\n    let mediaType = 'NONE'\r\n\r\n    // Handle file upload if present\r\n    if (files.media) {\r\n      console.log('≡ƒôü Processing file upload...')\r\n      const file = Array.isArray(files.media) ? files.media[0] : files.media\r\n      if (file && file.filepath) {\r\n        console.log('≡ƒôü File details:', {\r\n          originalFilename: file.originalFilename,\r\n          filepath: file.filepath,\r\n          size: file.size\r\n        })\r\n\r\n        const fileType = getFileType(file.originalFilename || '')\r\n        console.log('≡ƒôü File type detected:', fileType)\r\n\r\n        if (fileType !== 'unknown') {\r\n          try {\r\n            console.log('Γÿü∩╕Å Uploading to Cloudinary...')\r\n            const uploadResult = await uploadToCloudinary(file.filepath, fileType)\r\n\r\n            if (uploadResult && uploadResult.url) {\r\n              mediaUrl = uploadResult.url\r\n              mediaType = fileType === 'image' ? 'IMAGE' : 'VIDEO'\r\n              console.log('Γ£à Upload successful:', mediaUrl)\r\n            } else {\r\n              console.warn('ΓÜá∩╕Å Upload returned invalid result:', uploadResult)\r\n              mediaUrl = null\r\n              mediaType = 'NONE'\r\n            }\r\n          } catch (uploadError) {\r\n            console.error('Γ¥î Upload failed:', uploadError)\r\n            return res.status(500).json({\r\n              error: 'File upload failed',\r\n              details: uploadError instanceof Error ? uploadError.message : 'Unknown upload error',\r\n              cloudinaryConfigured: !!(process.env.CLOUDINARY_CLOUD_NAME && process.env.CLOUDINARY_API_KEY && process.env.CLOUDINARY_API_SECRET)\r\n            })\r\n          }\r\n        } else {\r\n          console.log('Γ¥î Unknown file type')\r\n          return res.status(400).json({ error: 'Unsupported file type' })\r\n        }\r\n      }\r\n    }\r\n\r\n    // Validate required fields\r\n    if (!caption || caption.trim().length === 0) {\r\n      console.log('Γ¥î Validation failed: Caption is required')\r\n      return res.status(400).json({ error: 'Caption is required' })\r\n    }\r\n    if (!mediaUrl) {\r\n      console.log('Γ¥î Validation failed: Media file is required')\r\n      return res.status(400).json({ error: 'Media file is required for posts' })\r\n    }\r\n    if (!auth.userId) {\r\n      console.log('Γ¥î Validation failed: User ID is required')\r\n      return res.status(400).json({ error: 'User ID is required' })\r\n    }\r\n    if (!category) {\r\n      console.log('Γ¥î Validation failed: Category is required')\r\n      return res.status(400).json({ error: 'Category is required' })\r\n    }\r\n\r\n    console.log('Γ£à All validations passed')\r\n\r\n    // Create post in MongoDB\r\n    console.log('≡ƒùä∩╕Å Creating post in database...')\r\n    const posts = await getCollection<Post>(Collections.POSTS)\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    \r\n    let post\r\n    try {\r\n      const postId = await getNextSequenceValue('posts')\r\n      const newPost: Post = {\r\n        id: postId,\r\n        user_id: auth.userId,\r\n        caption: caption.trim(),\r\n        category: category as any,\r\n        media_url: String(mediaUrl),\r\n        media_type: mediaType as any,\r\n        created_at: new Date(),\r\n      }\r\n\r\n      await withRetry(async () => {\r\n        return posts.insertOne(newPost as any)\r\n      })\r\n\r\n      // Fetch the created post with user data\r\n      const createdPost = await posts.findOne({ id: postId })\r\n      const postUser = await users.findOne({ id: auth.userId })\r\n\r\n      post = {\r\n        ...serializeDoc(createdPost),\r\n        user: postUser ? {\r\n          id: postUser.id,\r\n          name: postUser.name,\r\n          department: postUser.department,\r\n          year: postUser.year,\r\n          profile_image: postUser.profile_image,\r\n        } : null,\r\n        _count: {\r\n          auras: 0,\r\n          comments: 0,\r\n        }\r\n      }\r\n\r\n      console.log('Γ£à Post created successfully with ID:', postId)\r\n    } catch (mongoError: any) {\r\n      console.error('Γ¥î MongoDB create error:', mongoError)\r\n      return res.status(400).json({ error: 'Failed to create post', details: mongoError.message })\r\n    }\r\n\r\n    const transformedPost = {\r\n      ...post,\r\n      content: post.caption || '',\r\n      author: post.user,\r\n      aura_count: 0,\r\n      comment_count: 0,\r\n      user_liked: false,\r\n    }\r\n\r\n    console.log('Γ£à Post creation completed successfully')\r\n    res.status(201).json({ post: transformedPost, message: 'Post created successfully' })\r\n  } catch (error) {\r\n    console.error('Γ¥î Create post error:', error)\r\n    res.status(500).json({\r\n      error: 'Internal server error',\r\n      details: error instanceof Error ? error.message : 'Unknown error',\r\n      timestamp: new Date().toISOString()\r\n    })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\search\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2348,2351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2348,2351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2503,2506],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2503,2506],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, User, Post } from '../../../lib/mongodb'\r\n\r\n// Define search results interface\r\ninterface SearchResults {\r\n  users?: Array<{\r\n    id: number;\r\n    name: string;\r\n    department: string;\r\n    year: number;\r\n  }>;\r\n  posts?: Array<{\r\n    id: number;\r\n    content: string;\r\n    category: string;\r\n    author: {\r\n      id: number;\r\n      name: string;\r\n      department: string;\r\n      year: number;\r\n    };\r\n  }>;\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'GET') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const { q, type = 'all' } = req.query\r\n\r\n    if (!q || typeof q !== 'string') {\r\n      return res.status(400).json({ error: 'Search query is required' })\r\n    }\r\n\r\n    const searchTerm = q.toLowerCase()\r\n    const results: SearchResults = {}\r\n\r\n    // Search users\r\n    if (type === 'all' || type === 'users') {\r\n      const users = await getCollection<User>(Collections.USERS)\r\n      const userResults = await users.find({\r\n        $or: [\r\n          { name: { $regex: searchTerm, $options: 'i' } },\r\n          { username: { $regex: searchTerm, $options: 'i' } },\r\n          { department: { $regex: searchTerm, $options: 'i' } },\r\n          { college_id: { $regex: searchTerm, $options: 'i' } },\r\n        ]\r\n      })\r\n        .limit(10)\r\n        .toArray()\r\n      \r\n      results.users = userResults.map(u => ({\r\n        id: u.id!,\r\n        name: u.name,\r\n        username: u.username,\r\n        department: u.department,\r\n        year: u.year,\r\n      }))\r\n    }\r\n\r\n    // Search posts\r\n    if (type === 'all' || type === 'posts') {\r\n      try {\r\n        const posts = await getCollection<Post>(Collections.POSTS)\r\n        const users = await getCollection<User>(Collections.USERS)\r\n        \r\n        const postResults = await posts.find({\r\n          caption: { $regex: searchTerm, $options: 'i' }\r\n        })\r\n          .sort({ created_at: -1 })\r\n          .limit(20)\r\n          .toArray()\r\n        \r\n        // Get user data for posts\r\n        const userIds = [...new Set(postResults.map(p => p.user_id))].filter(Boolean) as number[]\r\n        const postUsers = userIds.length > 0\r\n          ? await users.find({ id: { $in: userIds } as any }).toArray()\r\n          : []\r\n        const userMap = new Map(postUsers.map(u => [u.id, u]))\r\n        \r\n        results.posts = postResults.map((post: any) => {\r\n          const author = userMap.get(post.user_id)\r\n          return {\r\n            id: post.id,\r\n            content: post.caption || '',\r\n            category: post.category,\r\n            author: {\r\n              id: author?.id || 0,\r\n              name: author?.name || '',\r\n              department: author?.department || '',\r\n              year: author?.year || 0,\r\n            }\r\n          }\r\n        })\r\n      } catch (error) {\r\n        console.error('Post search error:', error)\r\n        // Skip posts if there's an error\r\n      }\r\n    }\r\n\r\n    res.status(200).json({ results })\r\n  } catch (error) {\r\n    console.error('Search error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":21,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[788,791],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[788,791],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":54,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2079,2082],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2079,2082],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, User, Follower } from '../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'GET') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { search, q, department, year, limit = '50', offset = '0' } = req.query\r\n    const limitNum = Math.min(200, Math.max(1, parseInt(limit as string)))\r\n    const offsetNum = Math.max(0, parseInt(offset as string))\r\n\r\n    // Build query filter\r\n    const filter: any = {\r\n      id: { $ne: auth.userId } // Exclude current user\r\n    }\r\n\r\n    const queryText = (typeof q === 'string' && q.trim()) ? q.trim() : (typeof search === 'string' ? search : '')\r\n    if (queryText) {\r\n      filter.$or = [\r\n        { name: { $regex: queryText, $options: 'i' } },\r\n        { college_id: { $regex: queryText, $options: 'i' } },\r\n        { department: { $regex: queryText, $options: 'i' } }\r\n      ]\r\n    }\r\n    if (typeof department === 'string' && department.trim()) {\r\n      filter.department = department.trim()\r\n    }\r\n    if (typeof year === 'string' && year.trim() && !Number.isNaN(parseInt(year))) {\r\n      filter.year = parseInt(year)\r\n    }\r\n\r\n    const usersCollection = await getCollection<User>(Collections.USERS)\r\n    const users = await usersCollection.find(filter)\r\n      .sort({ name: 1 })\r\n      .limit(limitNum)\r\n      .skip(offsetNum)\r\n      .toArray()\r\n\r\n    // Include follow-state for the requester\r\n    let followingSet: Set<number> = new Set()\r\n    if (users.length > 0) {\r\n      const ids = users.map(u => u.id).filter(Boolean) as number[]\r\n      const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n      const myFollowing = await followers.find({\r\n        follower_id: auth.userId,\r\n        following_id: { $in: ids } as any\r\n      }).toArray()\r\n      followingSet = new Set(myFollowing.map(r => r.following_id as number))\r\n    }\r\n\r\n    res.status(200).json({\r\n      users: users.map(user => ({\r\n        id: user.id,\r\n        name: user.name,\r\n        username: user.username,\r\n        email: user.college_id, // ContactsList compatibility\r\n        department: user.department,\r\n        year: user.year,\r\n        bio: user.bio,\r\n        profileImageUrl: user.profile_image, // existing consumers\r\n        profile_image: user.profile_image,   // new Connect page\r\n        createdAt: user.created_at,\r\n        is_following: followingSet.has(user.id!)\r\n      }))\r\n    })\r\n  } catch (error) {\r\n    console.error('Get users error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\[userId].ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":115,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3512,3515],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3512,3515],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3736,3739],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3736,3739],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3785,3788],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3785,3788],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":188,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5998,6001],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5998,6001],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":212,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":212,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6750,6753],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6750,6753],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, withRetry, serializeDoc } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\ninterface User {\r\n  id: number\r\n  name: string\r\n  username: string\r\n  college_id: string\r\n  department: string\r\n  year: string\r\n  bio: string | null\r\n  profile_image: string | null\r\n  is_private: boolean\r\n  created_at: Date\r\n}\r\n\r\ninterface Post {\r\n  id: number\r\n  user_id: number\r\n  caption: string\r\n  category: string\r\n  media_url: string\r\n  media_type: string\r\n  created_at: Date\r\n}\r\n\r\ninterface Aura {\r\n  id: number\r\n  user_id: number\r\n  post_id: number\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method === 'GET') {\r\n    return handleGetUser(req, res)\r\n  }\r\n  \r\n  if (req.method === 'PUT') {\r\n    return handleUpdateUser(req, res)\r\n  }\r\n  \r\n  return res.status(405).json({ error: 'Method not allowed' })\r\n}\r\n\r\nasync function handleGetUser(req: NextApiRequest, res: NextApiResponse) {\r\n  try {\r\n    const { userId } = req.query\r\n    const auth = getUserFromRequest(req)\r\n\r\n    // If userId is 'me', get current user\r\n    let targetUserId: number\r\n    if (userId === 'me') {\r\n      if (!auth) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n      }\r\n      targetUserId = auth.userId\r\n    } else {\r\n      targetUserId = parseInt(userId as string)\r\n    }\r\n\r\n    if (isNaN(targetUserId)) {\r\n      return res.status(400).json({ error: 'Invalid user ID' })\r\n    }\r\n\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    const posts = await getCollection<Post>(Collections.POSTS)\r\n    const auras = await getCollection<Aura>(Collections.AURAS)\r\n    const comments = await getCollection(Collections.COMMENTS)\r\n    const followers = await getCollection(Collections.FOLLOWERS)\r\n    const followRequests = await getCollection(Collections.FOLLOW_REQUESTS)\r\n    const blocks = await getCollection(Collections.BLOCKS)\r\n\r\n    // Get user\r\n    const user = await withRetry(async () => {\r\n      return users.findOne({ id: targetUserId })\r\n    })\r\n\r\n    if (!user) {\r\n      return res.status(404).json({ error: 'User not found' })\r\n    }\r\n\r\n    // Check if either user has blocked the other\r\n    if (auth && auth.userId !== targetUserId) {\r\n      const blockExists = await blocks.findOne({\r\n        $or: [\r\n          { blocker_id: auth.userId, blocked_user_id: targetUserId },\r\n          { blocker_id: targetUserId, blocked_user_id: auth.userId }\r\n        ]\r\n      })\r\n\r\n      if (blockExists) {\r\n        return res.status(403).json({ \r\n          error: 'User not accessible',\r\n          blocked: true \r\n        })\r\n      }\r\n    }\r\n\r\n    // Get user's posts\r\n    const userPosts = await withRetry(async () => {\r\n      console.log('≡ƒöì Fetching posts for user:', targetUserId)\r\n      const foundPosts = await posts.find({ user_id: targetUserId }).sort({ created_at: -1 }).limit(20).toArray()\r\n      console.log('≡ƒô¥ Found', foundPosts.length, 'posts for user', targetUserId)\r\n      \r\n      // Debug: Check if posts exist with different field\r\n      const allPosts = await posts.find({}).limit(5).toArray()\r\n      console.log('≡ƒôè Sample posts in DB:', allPosts.map(p => ({ id: p.id, user_id: p.user_id, _id: p._id })))\r\n      \r\n      return foundPosts\r\n    })\r\n\r\n    // Get auras for these posts\r\n    const postIds = userPosts.map(p => p.id)\r\n    const postAuras = postIds.length > 0 ? await auras.find({ post_id: { $in: postIds } as any }).toArray() : []\r\n\r\n    // Get comment counts for posts\r\n    const commentCounts = new Map<number, number>()\r\n    if (postIds.length > 0) {\r\n      const postComments = await comments.find({ post_id: { $in: postIds } as any }).toArray()\r\n      postComments.forEach((c: any) => {\r\n        commentCounts.set(c.post_id, (commentCounts.get(c.post_id) || 0) + 1)\r\n      })\r\n    }\r\n\r\n    // Get follower/following counts and status\r\n    const [\r\n      followerCount,\r\n      followingCount,\r\n      isFollowingDoc,\r\n      pendingRequestDoc\r\n    ] = await Promise.all([\r\n      followers.countDocuments({ following_id: targetUserId }),\r\n      followers.countDocuments({ follower_id: targetUserId }),\r\n      auth ? followers.findOne({\r\n        follower_id: auth.userId,\r\n        following_id: targetUserId\r\n      }) : null,\r\n      auth ? followRequests.findOne({\r\n        requester_id: auth.userId,\r\n        target_id: targetUserId\r\n      }) : null\r\n    ])\r\n\r\n    // Gate posts if target user is private and viewer is not following\r\n    let canViewPrivate = true\r\n    if (user.is_private) {\r\n      canViewPrivate = !!isFollowingDoc || (!!auth && auth.userId === targetUserId)\r\n    }\r\n\r\n    // Transform posts\r\n    const transformedPosts = (canViewPrivate ? userPosts : []).map((post) => {\r\n      const postAuraList = postAuras.filter(a => a.post_id === post.id)\r\n      const auraCount = postAuraList.length\r\n      const commentCount = commentCounts.get(post.id) || 0\r\n      const userLiked = auth ? postAuraList.some(a => a.user_id === auth.userId) : false\r\n\r\n      return {\r\n        id: post.id,\r\n        user_id: post.user_id,\r\n        caption: post.caption,\r\n        category: post.category,\r\n        media_url: post.media_url,\r\n        media_type: post.media_type,\r\n        created_at: post.created_at,\r\n        content: post.caption || '',\r\n        aura_count: auraCount,\r\n        comment_count: commentCount,\r\n        user_liked: userLiked,\r\n      }\r\n    })\r\n\r\n    const postCount = await posts.countDocuments({ user_id: targetUserId })\r\n\r\n    const transformedUser = {\r\n      ...serializeDoc(user),\r\n      posts: transformedPosts,\r\n      follower_count: followerCount,\r\n      following_count: followingCount,\r\n      post_count: postCount,\r\n      is_following: !!isFollowingDoc,\r\n      is_private: user.is_private,\r\n      can_view: canViewPrivate,\r\n      requested: !!pendingRequestDoc && !isFollowingDoc,\r\n    }\r\n\r\n    res.status(200).json({ user: transformedUser })\r\n  } catch (error: any) {\r\n    console.error('Get user error:', error.message)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n\r\nasync function handleUpdateUser(req: NextApiRequest, res: NextApiResponse) {\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { userId } = req.query\r\n    \r\n    // Users can only update their own profile\r\n    if (userId !== 'me' && parseInt(userId as string) !== auth.userId) {\r\n      return res.status(403).json({ error: 'Forbidden' })\r\n    }\r\n\r\n    const { name, department, year, bio, profile_image, is_private } = req.body\r\n\r\n    const users = await getCollection<User>(Collections.USERS)\r\n\r\n    const updateData: any = {}\r\n    if (name) updateData.name = name\r\n    if (department) updateData.department = department\r\n    if (year) updateData.year = parseInt(year)\r\n    if (bio !== undefined) updateData.bio = bio\r\n    if (profile_image) updateData.profile_image = profile_image\r\n    if (typeof is_private === 'boolean') updateData.is_private = is_private\r\n\r\n    await users.updateOne(\r\n      { id: auth.userId },\r\n      { $set: updateData }\r\n    )\r\n\r\n    const updatedUser = await users.findOne({ id: auth.userId })\r\n\r\n    res.status(200).json({\r\n      user: {\r\n        id: updatedUser?.id,\r\n        name: updatedUser?.name,\r\n        college_id: updatedUser?.college_id,\r\n        department: updatedUser?.department,\r\n        year: updatedUser?.year,\r\n        bio: updatedUser?.bio,\r\n        profile_image: updatedUser?.profile_image,\r\n        created_at: updatedUser?.created_at,\r\n      },\r\n      message: 'Profile updated successfully'\r\n    })\r\n  } catch (error) {\r\n    console.error('Update user error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\[userId]\\follow.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2208,2211],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2208,2211],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":110,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3570,3573],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3570,3573],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, withRetry, getNextSequenceValue } from '../../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../../lib/auth'\r\n\r\ninterface User {\r\n  id: number\r\n  is_private: boolean\r\n}\r\n\r\ninterface FollowRequest {\r\n  id: number\r\n  requester_id: number\r\n  target_id: number\r\n}\r\n\r\ninterface Follower {\r\n  follower_id: number\r\n  following_id: number\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  const { userId } = req.query\r\n\r\n  if (req.method === 'POST') {\r\n    // Follow user\r\n    try {\r\n      const auth = getUserFromRequest(req)\r\n      if (!auth) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n      }\r\n\r\n      const targetUserId = parseInt(userId as string, 10)\r\n      if (isNaN(targetUserId) || targetUserId <= 0) {\r\n        return res.status(400).json({ error: 'Invalid user ID format' })\r\n      }\r\n\r\n      // Can't follow yourself\r\n      if (targetUserId === auth.userId) {\r\n        return res.status(400).json({ error: 'You cannot follow yourself' })\r\n      }\r\n\r\n      const users = await getCollection<User>(Collections.USERS)\r\n      const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n      const followRequests = await getCollection<FollowRequest>(Collections.FOLLOW_REQUESTS)\r\n\r\n      // Check if target user exists\r\n      const targetUser = await withRetry(async () => {\r\n        return users.findOne({ id: targetUserId })\r\n      })\r\n\r\n      if (!targetUser) {\r\n        return res.status(404).json({ error: 'User not found' })\r\n      }\r\n\r\n      // If target is private, create or confirm a pending request\r\n      if (targetUser.is_private) {\r\n        const existingRequest = await followRequests.findOne({\r\n          requester_id: auth.userId,\r\n          target_id: targetUserId\r\n        })\r\n\r\n        if (!existingRequest) {\r\n          const requestId = await getNextSequenceValue('follow_requests')\r\n          await withRetry(async () => {\r\n            return followRequests.insertOne({\r\n              id: requestId,\r\n              requester_id: auth.userId,\r\n              target_id: targetUserId\r\n            } as any)\r\n          })\r\n        }\r\n\r\n        const followerCount = await withRetry(async () => {\r\n          return followers.countDocuments({ following_id: targetUserId })\r\n        })\r\n        const followingCount = await withRetry(async () => {\r\n          return followers.countDocuments({ follower_id: auth.userId })\r\n        })\r\n\r\n        return res.status(200).json({\r\n          message: 'Follow request sent',\r\n          requested: true,\r\n          is_following: false,\r\n          follower_count: followerCount,\r\n          following_count: followingCount\r\n        })\r\n      }\r\n\r\n      // Public account: follow immediately\r\n      const existingFollow = await followers.findOne({\r\n        follower_id: auth.userId,\r\n        following_id: targetUserId\r\n      })\r\n\r\n      if (existingFollow) {\r\n        const followerCount = await followers.countDocuments({ following_id: targetUserId })\r\n        const followingCount = await followers.countDocuments({ follower_id: auth.userId })\r\n        return res.status(200).json({\r\n          message: 'Already following',\r\n          is_following: true,\r\n          follower_count: followerCount,\r\n          following_count: followingCount\r\n        })\r\n      }\r\n\r\n      await withRetry(async () => {\r\n        return followers.insertOne({\r\n          follower_id: auth.userId,\r\n          following_id: targetUserId\r\n        } as any)\r\n      })\r\n\r\n      const followerCount = await followers.countDocuments({ following_id: targetUserId })\r\n      const followingCount = await followers.countDocuments({ follower_id: auth.userId })\r\n\r\n      res.status(200).json({\r\n        message: 'User followed successfully',\r\n        is_following: true,\r\n        follower_count: followerCount,\r\n        following_count: followingCount\r\n      })\r\n    } catch (error) {\r\n      console.error('Follow error:', error)\r\n      res.status(500).json({ error: 'Internal server error' })\r\n    }\r\n  } else if (req.method === 'DELETE') {\r\n    // Unfollow user\r\n    try {\r\n      const auth = getUserFromRequest(req)\r\n      if (!auth) {\r\n        return res.status(401).json({ error: 'Unauthorized' })\r\n      }\r\n\r\n      const targetUserId = parseInt(userId as string, 10)\r\n      if (isNaN(targetUserId) || targetUserId <= 0) {\r\n        return res.status(400).json({ error: 'Invalid user ID format' })\r\n      }\r\n\r\n      const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n      const followRequests = await getCollection<FollowRequest>(Collections.FOLLOW_REQUESTS)\r\n\r\n      // If there is a pending follow request, cancel it\r\n      const request = await withRetry(async () => {\r\n        return followRequests.findOne({\r\n          requester_id: auth.userId,\r\n          target_id: targetUserId\r\n        })\r\n      })\r\n\r\n      if (request) {\r\n        await withRetry(async () => {\r\n          return followRequests.deleteOne({ id: request.id })\r\n        })\r\n        const followerCount = await followers.countDocuments({ following_id: targetUserId })\r\n        const followingCount = await followers.countDocuments({ follower_id: auth.userId })\r\n        return res.status(200).json({\r\n          message: 'Follow request cancelled',\r\n          requested: false,\r\n          is_following: false,\r\n          follower_count: followerCount,\r\n          following_count: followingCount\r\n        })\r\n      }\r\n\r\n      // Unfollow\r\n      const existingFollow = await followers.findOne({\r\n        follower_id: auth.userId,\r\n        following_id: targetUserId\r\n      })\r\n\r\n      if (!existingFollow) {\r\n        const followerCount = await followers.countDocuments({ following_id: targetUserId })\r\n        const followingCount = await followers.countDocuments({ follower_id: auth.userId })\r\n        return res.status(200).json({\r\n          message: 'Not following',\r\n          is_following: false,\r\n          follower_count: followerCount,\r\n          following_count: followingCount\r\n        })\r\n      }\r\n\r\n      await withRetry(async () => {\r\n        return followers.deleteOne({\r\n          follower_id: auth.userId,\r\n          following_id: targetUserId\r\n        })\r\n      })\r\n\r\n      const followerCount = await followers.countDocuments({ following_id: targetUserId })\r\n      const followingCount = await followers.countDocuments({ follower_id: auth.userId })\r\n\r\n      res.status(200).json({\r\n        message: 'User unfollowed successfully',\r\n        is_following: false,\r\n        follower_count: followerCount,\r\n        following_count: followingCount\r\n      })\r\n    } catch (error) {\r\n      console.error('Unfollow error:', error)\r\n      res.status(500).json({ error: 'Internal server error' })\r\n    }\r\n  } else {\r\n    res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\[userId]\\followers.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1715,1718],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1715,1718],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2015,2018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2015,2018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections } from '../../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../../lib/auth'\r\n\r\ninterface User {\r\n  id: number\r\n  name: string\r\n  username: string\r\n  department: string\r\n  year: string\r\n  profile_image: string | null\r\n}\r\n\r\ninterface Follower {\r\n  follower_id: number\r\n  following_id: number\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'GET') {\r\n    res.setHeader('Allow', ['GET'])\r\n    return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n  }\r\n\r\n  try {\r\n    const { userId, limit = '20', offset = '0' } = req.query\r\n    const auth = getUserFromRequest(req)\r\n\r\n    if (!userId || Array.isArray(userId)) {\r\n      return res.status(400).json({ error: 'Invalid user id' })\r\n    }\r\n\r\n    const targetId = userId === 'me' ? auth?.userId : parseInt(userId)\r\n    if (!targetId || Number.isNaN(targetId)) {\r\n      return res.status(400).json({ error: 'Invalid user id' })\r\n    }\r\n\r\n    const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n    const users = await getCollection<User>(Collections.USERS)\r\n\r\n    // Followers of targetId (people who follow targetId)\r\n    const followerDocs = await followers\r\n      .find({ following_id: targetId })\r\n      .skip(parseInt(offset as string))\r\n      .limit(parseInt(limit as string))\r\n      .toArray()\r\n\r\n    const followerIds = followerDocs.map(f => f.follower_id)\r\n\r\n    if (followerIds.length === 0) {\r\n      return res.status(200).json({ users: [] })\r\n    }\r\n\r\n    // Get user details\r\n    const followerUsers = await users.find({ id: { $in: followerIds } as any }).toArray()\r\n\r\n    // For requester's follow state of each listed user\r\n    let followingSet: Set<number> = new Set()\r\n    if (auth && followerUsers.length > 0) {\r\n      const myFollowing = await followers.find({\r\n        follower_id: auth.userId,\r\n        following_id: { $in: followerIds } as any\r\n      }).toArray()\r\n      followingSet = new Set(myFollowing.map(r => r.following_id))\r\n    }\r\n\r\n    const result = followerUsers.map(u => ({\r\n      id: u.id,\r\n      name: u.name,\r\n      username: u.username,\r\n      department: u.department,\r\n      year: u.year,\r\n      profile_image: u.profile_image,\r\n      is_following: auth ? followingSet.has(u.id) : false\r\n    }))\r\n\r\n    return res.status(200).json({ users: result })\r\n  } catch (error) {\r\n    console.error('Get followers error:', error)\r\n    return res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\[userId]\\following.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1723,1726],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1723,1726],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2025,2028],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2025,2028],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections } from '../../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../../lib/auth'\r\n\r\ninterface User {\r\n  id: number\r\n  name: string\r\n  username: string\r\n  department: string\r\n  year: string\r\n  profile_image: string | null\r\n}\r\n\r\ninterface Follower {\r\n  follower_id: number\r\n  following_id: number\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'GET') {\r\n    res.setHeader('Allow', ['GET'])\r\n    return res.status(405).json({ error: `Method ${req.method} not allowed` })\r\n  }\r\n\r\n  try {\r\n    const { userId, limit = '20', offset = '0' } = req.query\r\n    const auth = getUserFromRequest(req)\r\n\r\n    if (!userId || Array.isArray(userId)) {\r\n      return res.status(400).json({ error: 'Invalid user id' })\r\n    }\r\n\r\n    const targetId = userId === 'me' ? auth?.userId : parseInt(userId)\r\n    if (!targetId || Number.isNaN(targetId)) {\r\n      return res.status(400).json({ error: 'Invalid user id' })\r\n    }\r\n\r\n    const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n    const users = await getCollection<User>(Collections.USERS)\r\n\r\n    // Following of targetId (people targetId is following)\r\n    const followingDocs = await followers\r\n      .find({ follower_id: targetId })\r\n      .skip(parseInt(offset as string))\r\n      .limit(parseInt(limit as string))\r\n      .toArray()\r\n\r\n    const followingIds = followingDocs.map(f => f.following_id)\r\n\r\n    if (followingIds.length === 0) {\r\n      return res.status(200).json({ users: [] })\r\n    }\r\n\r\n    // Get user details\r\n    const followingUsers = await users.find({ id: { $in: followingIds } as any }).toArray()\r\n\r\n    // For requester's follow state of each listed user\r\n    let followingSet: Set<number> = new Set()\r\n    if (auth && followingUsers.length > 0) {\r\n      const myFollowing = await followers.find({\r\n        follower_id: auth.userId,\r\n        following_id: { $in: followingIds } as any\r\n      }).toArray()\r\n      followingSet = new Set(myFollowing.map(r => r.following_id))\r\n    }\r\n\r\n    const result = followingUsers.map(u => ({\r\n      id: u.id,\r\n      name: u.name,\r\n      username: u.username,\r\n      department: u.department,\r\n      year: u.year,\r\n      profile_image: u.profile_image,\r\n      is_following: auth ? followingSet.has(u.id) : false\r\n    }))\r\n\r\n    return res.status(200).json({ users: result })\r\n  } catch (error) {\r\n    console.error('Get following error:', error)\r\n    return res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\block\\[blockedUserId].ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1487,1490],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1487,1490],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next';\r\nimport jwt from 'jsonwebtoken';\r\nimport { connectToDatabase } from '../../../../lib/mongodb';\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';\r\n\r\ninterface JwtPayload {\r\n  userId: number;\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'DELETE') {\r\n    return res.status(405).json({ message: 'Method not allowed' });\r\n  }\r\n\r\n  try {\r\n    const authHeader = req.headers.authorization;\r\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n      return res.status(401).json({ message: 'Unauthorized' });\r\n    }\r\n\r\n    const token = authHeader.split(' ')[1];\r\n    const decoded = jwt.verify(token, JWT_SECRET) as JwtPayload;\r\n    const userId = decoded.userId;\r\n\r\n    const { blockedUserId } = req.query;\r\n\r\n    if (!blockedUserId || typeof blockedUserId !== 'string') {\r\n      return res.status(400).json({ message: 'Blocked user ID is required' });\r\n    }\r\n\r\n    const blockedUserIdNum = parseInt(blockedUserId);\r\n\r\n    const { db } = await connectToDatabase();\r\n\r\n    // Remove the block\r\n    const result = await db.collection('blocks').deleteOne({\r\n      blocker_id: userId,\r\n      blocked_user_id: blockedUserIdNum\r\n    });\r\n\r\n    if (result.deletedCount === 0) {\r\n      return res.status(404).json({ message: 'Block not found' });\r\n    }\r\n\r\n    return res.status(200).json({ message: 'User unblocked successfully' });\r\n  } catch (error: any) {\r\n    console.error('Error unblocking user:', error);\r\n    return res.status(500).json({ message: 'Internal server error' });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\blocked.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1631,1634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1631,1634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next';\r\nimport jwt from 'jsonwebtoken';\r\nimport { connectToDatabase } from '../../../lib/mongodb';\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';\r\n\r\ninterface JwtPayload {\r\n  userId: number;\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'GET') {\r\n    return res.status(405).json({ message: 'Method not allowed' });\r\n  }\r\n\r\n  try {\r\n    const authHeader = req.headers.authorization;\r\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n      return res.status(401).json({ message: 'Unauthorized' });\r\n    }\r\n\r\n    const token = authHeader.split(' ')[1];\r\n    const decoded = jwt.verify(token, JWT_SECRET) as JwtPayload;\r\n    const userId = decoded.userId;\r\n\r\n    const { db } = await connectToDatabase();\r\n\r\n    // Get blocked users with their details\r\n    const blockedUsers = await db.collection('blocks').aggregate([\r\n      { $match: { blocker_id: userId } },\r\n      {\r\n        $lookup: {\r\n          from: 'users',\r\n          localField: 'blocked_user_id',\r\n          foreignField: 'id',\r\n          as: 'blocked_user'\r\n        }\r\n      },\r\n      { $unwind: '$blocked_user' },\r\n      {\r\n        $project: {\r\n          id: '$_id',\r\n          blocked_user_id: 1,\r\n          created_at: 1,\r\n          'blocked_user.id': 1,\r\n          'blocked_user.name': 1,\r\n          'blocked_user.username': 1,\r\n          'blocked_user.profile_image': 1\r\n        }\r\n      },\r\n      { $sort: { created_at: -1 } }\r\n    ]).toArray();\r\n\r\n    return res.status(200).json({ blockedUsers });\r\n  } catch (error: any) {\r\n    console.error('Error fetching blocked users:', error);\r\n    return res.status(500).json({ message: 'Internal server error' });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\deactivate.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Post' is defined but never used.","line":2,"column":55,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":59},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Message' is defined but never used.","line":2,"column":61,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":68},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Comment' is defined but never used.","line":2,"column":70,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":77},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Aura' is defined but never used.","line":2,"column":79,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":83},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Follower' is defined but never used.","line":2,"column":85,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":93},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FollowRequest' is defined but never used.","line":2,"column":95,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":108},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2413,2416],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2413,2416],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, withRetry, User, Post, Message, Comment, Aura, Follower, FollowRequest } from '../../../lib/mongodb'\r\nimport { getUserFromRequest, rateLimitMiddleware, getClientIp, verifyPassword } from '../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  // Rate limiting\r\n  const clientIp = getClientIp(req)\r\n  const { allowed, remaining, resetTime } = await rateLimitMiddleware(clientIp, 20, 60)\r\n  \r\n  res.setHeader('X-RateLimit-Limit', '20')\r\n  res.setHeader('X-RateLimit-Remaining', remaining.toString())\r\n  res.setHeader('X-RateLimit-Reset', new Date(resetTime).toISOString())\r\n  \r\n  if (!allowed) {\r\n    return res.status(429).json({ error: 'Too many requests. Please try again later.' })\r\n  }\r\n  \r\n  // Authenticate user\r\n  const auth = getUserFromRequest(req)\r\n  if (!auth) {\r\n    return res.status(401).json({ error: 'Unauthorized' })\r\n  }\r\n  \r\n  if (req.method === 'POST') {\r\n    return handleDeactivateAccount(req, res, auth.userId)\r\n  }\r\n  \r\n  return res.status(405).json({ error: 'Method not allowed' })\r\n}\r\n\r\nasync function handleDeactivateAccount(req: NextApiRequest, res: NextApiResponse, userId: number) {\r\n  try {\r\n    const { password } = req.body\r\n    \r\n    if (!password) {\r\n      return res.status(400).json({ error: 'Password is required to deactivate account' })\r\n    }\r\n    \r\n    const users = await getCollection<User>(Collections.USERS)\r\n    \r\n    // Verify user and password\r\n    const user = await withRetry(async () => {\r\n      return users.findOne({ id: userId })\r\n    })\r\n    \r\n    if (!user) {\r\n      return res.status(404).json({ error: 'User not found' })\r\n    }\r\n    \r\n    const isValidPassword = await verifyPassword(password, user.password_hash)\r\n    if (!isValidPassword) {\r\n      return res.status(401).json({ error: 'Invalid password' })\r\n    }\r\n    \r\n    // Mark account as deactivated (soft delete)\r\n    await withRetry(async () => {\r\n      return users.updateOne(\r\n        { id: userId },\r\n        { \r\n          $set: { \r\n            is_deactivated: true,\r\n            deactivated_at: new Date()\r\n          } \r\n        }\r\n      )\r\n    })\r\n    \r\n    res.status(200).json({ \r\n      message: 'Account deactivated successfully',\r\n      info: 'You can reactivate your account by logging in again within 30 days'\r\n    })\r\n  } catch (error: any) {\r\n    console.error('Deactivate account error:', error)\r\n    res.status(500).json({ error: 'Failed to deactivate account' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\delete.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3376,3379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3376,3379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, withRetry, User, Post, Message, Comment, Aura, Follower, FollowRequest } from '../../../lib/mongodb'\r\nimport { getUserFromRequest, rateLimitMiddleware, getClientIp, verifyPassword } from '../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  // Strict rate limiting for delete operations\r\n  const clientIp = getClientIp(req)\r\n  const { allowed, remaining, resetTime } = await rateLimitMiddleware(clientIp, 5, 3600) // 5 requests per hour\r\n  \r\n  res.setHeader('X-RateLimit-Limit', '5')\r\n  res.setHeader('X-RateLimit-Remaining', remaining.toString())\r\n  res.setHeader('X-RateLimit-Reset', new Date(resetTime).toISOString())\r\n  \r\n  if (!allowed) {\r\n    return res.status(429).json({ error: 'Too many delete requests. Please try again later.' })\r\n  }\r\n  \r\n  // Authenticate user\r\n  const auth = getUserFromRequest(req)\r\n  if (!auth) {\r\n    return res.status(401).json({ error: 'Unauthorized' })\r\n  }\r\n  \r\n  if (req.method === 'DELETE') {\r\n    return handleDeleteAccount(req, res, auth.userId)\r\n  }\r\n  \r\n  return res.status(405).json({ error: 'Method not allowed' })\r\n}\r\n\r\nasync function handleDeleteAccount(req: NextApiRequest, res: NextApiResponse, userId: number) {\r\n  try {\r\n    const { password, confirmation } = req.body\r\n    \r\n    if (!password || confirmation !== 'DELETE MY ACCOUNT') {\r\n      return res.status(400).json({ \r\n        error: 'Password and confirmation text required',\r\n        required_confirmation: 'DELETE MY ACCOUNT'\r\n      })\r\n    }\r\n    \r\n    const users = await getCollection<User>(Collections.USERS)\r\n    \r\n    // Verify user and password\r\n    const user = await withRetry(async () => {\r\n      return users.findOne({ id: userId })\r\n    })\r\n    \r\n    if (!user) {\r\n      return res.status(404).json({ error: 'User not found' })\r\n    }\r\n    \r\n    const isValidPassword = await verifyPassword(password, user.password_hash)\r\n    if (!isValidPassword) {\r\n      return res.status(401).json({ error: 'Invalid password' })\r\n    }\r\n    \r\n    // Delete user data (GDPR compliance)\r\n    await withRetry(async () => {\r\n      const posts = await getCollection<Post>(Collections.POSTS)\r\n      const messages = await getCollection<Message>(Collections.MESSAGES)\r\n      const comments = await getCollection<Comment>(Collections.COMMENTS)\r\n      const auras = await getCollection<Aura>(Collections.AURAS)\r\n      const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n      const followRequests = await getCollection<FollowRequest>(Collections.FOLLOW_REQUESTS)\r\n      \r\n      // Delete in parallel for better performance\r\n      await Promise.all([\r\n        posts.deleteMany({ user_id: userId }),\r\n        messages.deleteMany({ $or: [{ sender_id: userId }, { receiver_id: userId }] }),\r\n        comments.deleteMany({ user_id: userId }),\r\n        auras.deleteMany({ user_id: userId }),\r\n        followers.deleteMany({ $or: [{ follower_id: userId }, { following_id: userId }] }),\r\n        followRequests.deleteMany({ $or: [{ requester_id: userId }, { target_id: userId }] }),\r\n        users.deleteOne({ id: userId })\r\n      ])\r\n    })\r\n    \r\n    res.status(200).json({ \r\n      message: 'Account permanently deleted',\r\n      info: 'All your data has been removed from our servers'\r\n    })\r\n  } catch (error: any) {\r\n    console.error('Delete account error:', error)\r\n    res.status(500).json({ error: 'Failed to delete account' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\export-data.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'password_hash' is assigned a value but never used.","line":52,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":52,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3116,3119],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3116,3119],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, withRetry, User, Post, Message, Comment, serializeDocs } from '../../../lib/mongodb'\r\nimport { getUserFromRequest, rateLimitMiddleware, getClientIp } from '../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  // Rate limiting for data export\r\n  const clientIp = getClientIp(req)\r\n  const { allowed, remaining, resetTime } = await rateLimitMiddleware(clientIp, 3, 3600) // 3 requests per hour\r\n  \r\n  res.setHeader('X-RateLimit-Limit', '3')\r\n  res.setHeader('X-RateLimit-Remaining', remaining.toString())\r\n  res.setHeader('X-RateLimit-Reset', new Date(resetTime).toISOString())\r\n  \r\n  if (!allowed) {\r\n    return res.status(429).json({ error: 'Too many export requests. Please try again later.' })\r\n  }\r\n  \r\n  // Authenticate user\r\n  const auth = getUserFromRequest(req)\r\n  if (!auth) {\r\n    return res.status(401).json({ error: 'Unauthorized' })\r\n  }\r\n  \r\n  if (req.method === 'GET') {\r\n    return handleDataExport(req, res, auth.userId)\r\n  }\r\n  \r\n  return res.status(405).json({ error: 'Method not allowed' })\r\n}\r\n\r\nasync function handleDataExport(req: NextApiRequest, res: NextApiResponse, userId: number) {\r\n  try {\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    const posts = await getCollection<Post>(Collections.POSTS)\r\n    const messages = await getCollection<Message>(Collections.MESSAGES)\r\n    const comments = await getCollection<Comment>(Collections.COMMENTS)\r\n    \r\n    // Fetch all user data\r\n    const [user, userPosts, sentMessages, receivedMessages, userComments] = await Promise.all([\r\n      withRetry(async () => users.findOne({ id: userId })),\r\n      withRetry(async () => posts.find({ user_id: userId }).toArray()),\r\n      withRetry(async () => messages.find({ sender_id: userId }).toArray()),\r\n      withRetry(async () => messages.find({ receiver_id: userId }).toArray()),\r\n      withRetry(async () => comments.find({ user_id: userId }).toArray())\r\n    ])\r\n    \r\n    if (!user) {\r\n      return res.status(404).json({ error: 'User not found' })\r\n    }\r\n    \r\n    // Remove sensitive data from export\r\n    const { password_hash, ...userWithoutPassword } = user\r\n    \r\n    // Prepare export data (GDPR compliant)\r\n    const exportData = {\r\n      export_date: new Date().toISOString(),\r\n      user_data: userWithoutPassword,\r\n      posts: serializeDocs(userPosts),\r\n      sent_messages: serializeDocs(sentMessages),\r\n      received_messages: serializeDocs(receivedMessages),\r\n      comments: serializeDocs(userComments),\r\n      statistics: {\r\n        total_posts: userPosts.length,\r\n        total_messages_sent: sentMessages.length,\r\n        total_messages_received: receivedMessages.length,\r\n        total_comments: userComments.length\r\n      }\r\n    }\r\n    \r\n    // Set headers for file download\r\n    res.setHeader('Content-Type', 'application/json')\r\n    res.setHeader('Content-Disposition', `attachment; filename=\"uni-x-data-export-${userId}-${Date.now()}.json\"`)\r\n    \r\n    res.status(200).json(exportData)\r\n  } catch (error: any) {\r\n    console.error('Data export error:', error)\r\n    res.status(500).json({ error: 'Failed to export data' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\follow.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1902,1905],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1902,1905],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2029,2032],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2029,2032],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2063,2066],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2063,2066],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, User, Follower, getNextSequenceValue, serializeDoc } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { userId } = req.body\r\n\r\n    if (!userId) {\r\n      return res.status(400).json({ error: 'User ID is required' })\r\n    }\r\n\r\n    // Can't follow yourself\r\n    if (parseInt(userId) === auth.userId) {\r\n      return res.status(400).json({ error: 'You cannot follow yourself' })\r\n    }\r\n\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n\r\n    // Check if target user exists\r\n    const targetUser = await users.findOne({ id: parseInt(userId) })\r\n\r\n    if (!targetUser) {\r\n      return res.status(404).json({ error: 'User not found' })\r\n    }\r\n\r\n    // Check if already following\r\n    const existingFollow = await followers.findOne({\r\n      follower_id: auth.userId,\r\n      following_id: parseInt(userId)\r\n    })\r\n\r\n    let action: 'followed' | 'unfollowed'\r\n\r\n    if (existingFollow) {\r\n      // Unfollow the user\r\n      await followers.deleteOne({\r\n        follower_id: auth.userId,\r\n        following_id: parseInt(userId)\r\n      })\r\n      action = 'unfollowed'\r\n    } else {\r\n      // Follow the user\r\n      const followId = await getNextSequenceValue('followers')\r\n      await followers.insertOne({\r\n        id: followId,\r\n        follower_id: auth.userId,\r\n        following_id: parseInt(userId),\r\n        created_at: new Date()\r\n      } as any)\r\n      action = 'followed'\r\n\r\n      // Emit follow notification to the followed user\r\n      try {\r\n        if ((global as any).io) {\r\n          ;(global as any).io.to(`user-${parseInt(userId)}`).emit('notification', {\r\n            id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\r\n            type: 'follow',\r\n            message: 'You have a new follower',\r\n            time: new Date().toISOString(),\r\n            read: false,\r\n            meta: { actorId: auth.userId }\r\n          })\r\n        }\r\n      } catch {}\r\n    }\r\n\r\n    // Get updated counts\r\n    const [followerCount, followingCount] = await Promise.all([\r\n      followers.countDocuments({ following_id: parseInt(userId) }),\r\n      followers.countDocuments({ follower_id: parseInt(userId) })\r\n    ])\r\n\r\n    const serializedUser = serializeDoc(targetUser)\r\n    \r\n    res.status(200).json({\r\n      action,\r\n      message: `User ${action} successfully`,\r\n      user: {\r\n        ...serializedUser,\r\n        follower_count: followerCount,\r\n        following_count: followingCount,\r\n        is_following: action === 'followed'\r\n      }\r\n    })\r\n  } catch (error) {\r\n    console.error('Follow/unfollow error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\me.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1805,1808],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1805,1808],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1959,1962],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1959,1962],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":51,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2352,2355],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2352,2355],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3088,3091],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3088,3091],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":105,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4135,4138],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4135,4138],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":127,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":127,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5148,5151],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5148,5151],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5313,5316],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5313,5316],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, User, Post, Aura, Comment, Follower, serializeDoc, withRetry } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  const auth = getUserFromRequest(req)\r\n  if (!auth) return res.status(401).json({ error: 'Unauthorized' })\r\n\r\n  if (req.method === 'GET') {\r\n    try {\r\n      res.setHeader('Cache-Control', 'private, max-age=30') // Cache for 30 seconds\r\n      \r\n      // Use withRetry for critical database operations\r\n      const [users, posts, auras, comments, followers] = await Promise.all([\r\n        withRetry(() => getCollection<User>(Collections.USERS)),\r\n        withRetry(() => getCollection<Post>(Collections.POSTS)),\r\n        withRetry(() => getCollection<Aura>(Collections.AURAS)),\r\n        withRetry(() => getCollection<Comment>(Collections.COMMENTS)),\r\n        withRetry(() => getCollection<Follower>(Collections.FOLLOWERS))\r\n      ])\r\n\r\n      // Load current user\r\n      const rawUser = await withRetry(() => users.findOne({ id: auth.userId }))\r\n      \r\n      if (!rawUser) return res.status(404).json({ error: 'User not found' })\r\n\r\n      // Get user's posts with retry\r\n      const userPosts = await withRetry(() => \r\n        posts.find({ user_id: auth.userId })\r\n          .sort({ created_at: -1 })\r\n          .limit(20)\r\n          .toArray()\r\n      )\r\n\r\n      // Get counts for each post\r\n      const postIds = userPosts.map(p => p.id).filter(Boolean) as number[]\r\n      \r\n      const [postAuras, postComments, followerCount, followingCount, postCount] = await Promise.all([\r\n        postIds.length > 0 \r\n          ? withRetry(() => auras.find({ post_id: { $in: postIds } as any }).toArray())\r\n          : Promise.resolve([]),\r\n        postIds.length > 0\r\n          ? withRetry(() => comments.find({ post_id: { $in: postIds } as any }).toArray())\r\n          : Promise.resolve([]),\r\n        withRetry(() => followers.countDocuments({ following_id: auth.userId })),\r\n        withRetry(() => followers.countDocuments({ follower_id: auth.userId })),\r\n        withRetry(() => posts.countDocuments({ user_id: auth.userId }))\r\n      ])\r\n\r\n      // Transform posts with counts\r\n      const transformedPosts = userPosts.map((post: any) => {\r\n        const auraCount = postAuras.filter(a => a.post_id === post.id).length\r\n        const commentCount = postComments.filter(c => c.post_id === post.id).length\r\n        \r\n        return {\r\n          ...serializeDoc(post),\r\n          content: post.caption || '',\r\n          aura_count: auraCount,\r\n          comment_count: commentCount,\r\n          user_liked: false,\r\n        }\r\n      })\r\n\r\n      const user = {\r\n        ...serializeDoc(rawUser),\r\n        posts: transformedPosts,\r\n        follower_count: followerCount,\r\n        following_count: followingCount,\r\n        post_count: postCount,\r\n        is_following: false,\r\n        can_view: true,\r\n      }\r\n\r\n      return res.status(200).json({ user })\r\n    } catch (e: any) {\r\n      console.error('Γ¥î Error loading user profile:', e.message)\r\n      \r\n      // Try to at least return basic user info\r\n      try {\r\n        const users = await withRetry(() => getCollection<User>(Collections.USERS))\r\n        const base = await withRetry(() => users.findOne({ id: auth.userId }))\r\n        \r\n        if (!base) return res.status(404).json({ error: 'User not found' })\r\n        \r\n        return res.status(200).json({ \r\n          user: { \r\n            ...serializeDoc(base), \r\n            posts: [], \r\n            follower_count: 0, \r\n            following_count: 0, \r\n            post_count: 0, \r\n            is_following: false, \r\n            is_private: false, \r\n            can_view: true \r\n          } \r\n        })\r\n      } catch (fallbackError) {\r\n        console.error('Γ¥î Fallback also failed:', fallbackError)\r\n        return res.status(500).json({ error: 'Failed to load profile' })\r\n      }\r\n    }\r\n  }\r\n\r\n  if (req.method === 'PUT') {\r\n    const { name, bio, profile_image, username, is_private } = req.body as any\r\n\r\n    const users = await getCollection<User>(Collections.USERS)\r\n\r\n    // Enforce username cooldown (30 days)\r\n    if (typeof username === 'string') {\r\n      const current = await users.findOne({ id: auth.userId })\r\n      \r\n      // Only check cooldown if username is actually being changed\r\n      if (current?.username && username !== current.username) {\r\n        const now = new Date()\r\n        const last = current?.username_changed_at ? new Date(current.username_changed_at) : null\r\n        \r\n        // Only enforce cooldown if user has changed username before\r\n        if (last) {\r\n          const diffDays = Math.floor((now.getTime() - last.getTime()) / (1000 * 60 * 60 * 24))\r\n          if (diffDays < 30) {\r\n            return res.status(400).json({ error: `You can change your username again in ${30 - diffDays} days` })\r\n          }\r\n        }\r\n        \r\n        // Check uniqueness only if username is changing\r\n        const exists = await users.findOne({ username, id: { $ne: auth.userId } as any })\r\n        if (exists) return res.status(400).json({ error: 'Username is already taken' })\r\n      }\r\n    }\r\n\r\n    // Build update object\r\n    const updateData: any = {}\r\n    if (typeof name === 'string' && name.trim()) updateData.name = name.trim()\r\n    if (typeof bio === 'string') updateData.bio = bio\r\n    if (typeof profile_image === 'string') updateData.profile_image = profile_image\r\n    if (typeof is_private === 'boolean') updateData.is_private = is_private\r\n    \r\n    // Only update username_changed_at if username is actually being changed\r\n    if (typeof username === 'string') {\r\n      const current = await users.findOne({ id: auth.userId })\r\n      if (!current?.username || username !== current.username) {\r\n        // Username is being set for first time or is being changed\r\n        updateData.username = username\r\n        updateData.username_changed_at = new Date()\r\n      }\r\n    }\r\n\r\n    // Update user\r\n    await users.updateOne(\r\n      { id: auth.userId },\r\n      { $set: updateData }\r\n    )\r\n\r\n    // Fetch updated user\r\n    const updated = await users.findOne({ id: auth.userId })\r\n    \r\n    return res.status(200).json({ \r\n      user: serializeDoc(updated), \r\n      message: 'Profile updated successfully' \r\n    })\r\n  }\r\n\r\n  return res.status(405).json({ error: 'Method not allowed' })\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\me\\tagged.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[594,597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[594,597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getUserFromRequest } from '../../../../lib/auth'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'GET') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    // For now, return empty array since we don't have user tagging functionality yet\r\n    // TODO: Implement user tagging feature\r\n    const posts: any[] = []\r\n\r\n    res.status(200).json({ posts })\r\n  } catch (error) {\r\n    console.error('Get tagged posts error:', error)\r\n    res.status(500).json({ error: 'Internal server error' })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\privacy.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'serializeDoc' is defined but never used.","line":2,"column":55,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":67},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":51,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1825,1828],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1825,1828],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1912,1915],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1912,1915],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":53,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1996,1999],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1996,1999],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":54,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2093,2096],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2093,2096],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":58,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2245,2248],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2245,2248],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2852,2855],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2852,2855],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":108,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3964,3967],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3964,3967],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4481,4484],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4481,4484],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, withRetry, User, serializeDoc } from '../../../lib/mongodb'\r\nimport { getUserFromRequest, rateLimitMiddleware, getClientIp } from '../../../lib/auth'\r\nimport { validatePrivacySettings } from '../../../lib/validation'\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  // Rate limiting\r\n  const clientIp = getClientIp(req)\r\n  const { allowed, remaining, resetTime } = await rateLimitMiddleware(clientIp, 100, 60)\r\n  \r\n  res.setHeader('X-RateLimit-Limit', '100')\r\n  res.setHeader('X-RateLimit-Remaining', remaining.toString())\r\n  res.setHeader('X-RateLimit-Reset', new Date(resetTime).toISOString())\r\n  \r\n  if (!allowed) {\r\n    return res.status(429).json({ error: 'Too many requests. Please try again later.' })\r\n  }\r\n  \r\n  // Authenticate user\r\n  const auth = getUserFromRequest(req)\r\n  if (!auth) {\r\n    return res.status(401).json({ error: 'Unauthorized' })\r\n  }\r\n  \r\n  if (req.method === 'GET') {\r\n    return handleGetPrivacySettings(req, res, auth.userId)\r\n  }\r\n  \r\n  if (req.method === 'PUT') {\r\n    return handleUpdatePrivacySettings(req, res, auth.userId)\r\n  }\r\n  \r\n  return res.status(405).json({ error: 'Method not allowed' })\r\n}\r\n\r\nasync function handleGetPrivacySettings(req: NextApiRequest, res: NextApiResponse, userId: number) {\r\n  try {\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    \r\n    const user = await withRetry(async () => {\r\n      return users.findOne({ id: userId })\r\n    })\r\n    \r\n    if (!user) {\r\n      return res.status(404).json({ error: 'User not found' })\r\n    }\r\n    \r\n    // Return privacy settings (with defaults if not set)\r\n    const privacySettings = {\r\n      is_private: user.is_private || false,\r\n      show_online_status: (user as any).show_online_status !== false, // Default true\r\n      show_read_receipts: (user as any).show_read_receipts !== false, // Default true\r\n      who_can_message: (user as any).who_can_message || 'everyone', // 'everyone' | 'followers'\r\n      who_can_comment: (user as any).who_can_comment || 'everyone', // 'everyone' | 'followers'\r\n    }\r\n    \r\n    res.status(200).json({ privacy: privacySettings })\r\n  } catch (error: any) {\r\n    console.error('Get privacy settings error:', error)\r\n    res.status(500).json({ error: 'Failed to retrieve privacy settings' })\r\n  }\r\n}\r\n\r\nasync function handleUpdatePrivacySettings(req: NextApiRequest, res: NextApiResponse, userId: number) {\r\n  try {\r\n    const updates = req.body\r\n    \r\n    // Validate input\r\n    const validation = validatePrivacySettings(updates)\r\n    if (!validation.valid) {\r\n      return res.status(400).json({ error: validation.error })\r\n    }\r\n    \r\n    const users = await getCollection<User>(Collections.USERS)\r\n    \r\n    // Build update object\r\n    const updateDoc: any = {}\r\n    if (typeof updates.is_private === 'boolean') {\r\n      updateDoc.is_private = updates.is_private\r\n    }\r\n    if (typeof updates.show_online_status === 'boolean') {\r\n      updateDoc.show_online_status = updates.show_online_status\r\n    }\r\n    if (typeof updates.show_read_receipts === 'boolean') {\r\n      updateDoc.show_read_receipts = updates.show_read_receipts\r\n    }\r\n    if (updates.who_can_message && ['everyone', 'followers'].includes(updates.who_can_message)) {\r\n      updateDoc.who_can_message = updates.who_can_message\r\n    }\r\n    if (updates.who_can_comment && ['everyone', 'followers'].includes(updates.who_can_comment)) {\r\n      updateDoc.who_can_comment = updates.who_can_comment\r\n    }\r\n    \r\n    // Update user\r\n    const result = await withRetry(async () => {\r\n      return users.findOneAndUpdate(\r\n        { id: userId },\r\n        { $set: updateDoc },\r\n        { returnDocument: 'after' }\r\n      )\r\n    })\r\n    \r\n    if (!result) {\r\n      return res.status(404).json({ error: 'User not found' })\r\n    }\r\n    \r\n    // Return updated privacy settings\r\n    const updatedUser = result as any\r\n    const privacySettings = {\r\n      is_private: updatedUser.is_private || false,\r\n      show_online_status: updatedUser.show_online_status !== false,\r\n      show_read_receipts: updatedUser.show_read_receipts !== false,\r\n      who_can_message: updatedUser.who_can_message || 'everyone',\r\n      who_can_comment: updatedUser.who_can_comment || 'everyone',\r\n    }\r\n    \r\n    res.status(200).json({ \r\n      privacy: privacySettings,\r\n      message: 'Privacy settings updated successfully'\r\n    })\r\n  } catch (error: any) {\r\n    console.error('Update privacy settings error:', error)\r\n    res.status(500).json({ error: 'Failed to update privacy settings' })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\requests.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1195,1198],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1195,1198],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":76,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2548,2551],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2548,2551],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\ninterface User {\r\n  id: number\r\n  name: string\r\n  department: string\r\n  year: string\r\n  profile_image: string | null\r\n}\r\n\r\ninterface FollowRequest {\r\n  id: number\r\n  requester_id: number\r\n  target_id: number\r\n}\r\n\r\ninterface Follower {\r\n  follower_id: number\r\n  following_id: number\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  const auth = getUserFromRequest(req)\r\n  if (!auth) return res.status(401).json({ error: 'Unauthorized' })\r\n\r\n  if (req.method === 'GET') {\r\n    // List incoming follow requests for current user\r\n    const followRequests = await getCollection<FollowRequest>(Collections.FOLLOW_REQUESTS)\r\n    const users = await getCollection<User>(Collections.USERS)\r\n\r\n    const requests = await followRequests.find({ target_id: auth.userId }).toArray()\r\n    \r\n    // Get requester details\r\n    const requesterIds = requests.map(r => r.requester_id)\r\n    const requesters = requesterIds.length > 0 \r\n      ? await users.find({ id: { $in: requesterIds } as any }).toArray()\r\n      : []\r\n\r\n    const requesterMap = new Map(requesters.map(u => [u.id, u]))\r\n\r\n    const result = requests.map(r => ({\r\n      ...r,\r\n      requester: requesterMap.get(r.requester_id) || null\r\n    }))\r\n\r\n    return res.status(200).json({ requests: result })\r\n  }\r\n\r\n  if (req.method === 'POST') {\r\n    const { requestId, action } = req.body as { requestId?: number, action?: 'approve' | 'reject' }\r\n    if (!requestId || !action) return res.status(400).json({ error: 'requestId and action required' })\r\n\r\n    const followRequests = await getCollection<FollowRequest>(Collections.FOLLOW_REQUESTS)\r\n    const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n\r\n    const fr = await followRequests.findOne({ id: requestId })\r\n    if (!fr || fr.target_id !== auth.userId) return res.status(404).json({ error: 'Request not found' })\r\n\r\n    if (action === 'reject') {\r\n      await followRequests.deleteOne({ id: requestId })\r\n      return res.status(200).json({ message: 'Request rejected' })\r\n    }\r\n\r\n    // Approve: create follower and delete request\r\n    const exists = await followers.findOne({\r\n      follower_id: fr.requester_id,\r\n      following_id: fr.target_id\r\n    })\r\n\r\n    if (!exists) {\r\n      await followers.insertOne({\r\n        follower_id: fr.requester_id,\r\n        following_id: fr.target_id\r\n      } as any)\r\n    }\r\n\r\n    await followRequests.deleteOne({ id: requestId })\r\n\r\n    return res.status(200).json({ message: 'Request approved' })\r\n  }\r\n\r\n  return res.status(405).json({ error: 'Method not allowed' })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\suggestions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'withRetry' is defined but never used.","line":2,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":47},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2070,2073],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2070,2073],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":100,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2897,2900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2897,2900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":109,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3154,3157],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3154,3157],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":110,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3173,3176],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3173,3176],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":164,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4899,4902],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4899,4902],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":165,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4918,4921],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4918,4921],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextApiRequest, NextApiResponse } from 'next'\r\nimport { getCollection, Collections, withRetry } from '../../../lib/mongodb'\r\nimport { getUserFromRequest } from '../../../lib/auth'\r\n\r\ninterface User {\r\n  id: number\r\n  name: string\r\n  username?: string\r\n  college_id: string\r\n  department: string\r\n  year: number\r\n  bio?: string\r\n  profile_image?: string\r\n  is_private: boolean\r\n}\r\n\r\ninterface Follower {\r\n  id: number\r\n  follower_id: number\r\n  following_id: number\r\n}\r\n\r\ninterface SuggestionScore {\r\n  userId: number\r\n  mutualFriends: number\r\n  mutualFollowerIds: number[]\r\n  sameDepartment: boolean\r\n  sameYear: boolean\r\n  sameCollege: boolean\r\n  totalScore: number\r\n}\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'GET') {\r\n    return res.status(405).json({ error: 'Method not allowed' })\r\n  }\r\n\r\n  try {\r\n    const auth = getUserFromRequest(req)\r\n    if (!auth) {\r\n      return res.status(401).json({ error: 'Unauthorized' })\r\n    }\r\n\r\n    const { limit = '10', algorithm = 'advanced' } = req.query\r\n    const limitNum = parseInt(limit as string)\r\n    const currentUserId = auth.userId\r\n\r\n    console.log('≡ƒöì Generating suggestions for user:', currentUserId)\r\n\r\n    const users = await getCollection<User>(Collections.USERS)\r\n    const followers = await getCollection<Follower>(Collections.FOLLOWERS)\r\n    const followRequests = await getCollection(Collections.FOLLOW_REQUESTS)\r\n\r\n    // Get current user info\r\n    const currentUser = await users.findOne({ id: currentUserId })\r\n    if (!currentUser) {\r\n      return res.status(404).json({ error: 'User not found' })\r\n    }\r\n\r\n    // Get users the current user is already following\r\n    const following = await followers\r\n      .find({ follower_id: currentUserId })\r\n      .toArray()\r\n    const followingIds = following.map(f => f.following_id)\r\n\r\n    // Get pending follow requests\r\n    const pendingRequests = await followRequests\r\n      .find({ requester_id: currentUserId })\r\n      .toArray()\r\n    const requestedIds = pendingRequests.map((r: any) => r.target_id)\r\n\r\n    // Exclude: self, already following, and pending requests\r\n    const excludeIds = [currentUserId, ...followingIds, ...requestedIds]\r\n\r\n    console.log('≡ƒæÑ User is following:', followingIds.length, 'users')\r\n    console.log('≡ƒÜ½ Excluding:', excludeIds.length, 'users')\r\n\r\n    if (algorithm === 'simple') {\r\n      // Simple algorithm: just suggest users from same department/year\r\n      return handleSimpleSuggestions(\r\n        res,\r\n        users,\r\n        followers,\r\n        currentUser,\r\n        excludeIds,\r\n        limitNum\r\n      )\r\n    }\r\n\r\n    // Advanced algorithm: Friends of friends + similarity scoring\r\n    return handleAdvancedSuggestions(\r\n      res,\r\n      users,\r\n      followers,\r\n      currentUser,\r\n      followingIds,\r\n      excludeIds,\r\n      limitNum\r\n    )\r\n  } catch (error: any) {\r\n    console.error('Γ¥î Error generating suggestions:', error)\r\n    res.status(500).json({ error: 'Failed to generate suggestions' })\r\n  }\r\n}\r\n\r\n// Simple suggestion algorithm\r\nasync function handleSimpleSuggestions(\r\n  res: NextApiResponse,\r\n  users: any,\r\n  followers: any,\r\n  currentUser: User,\r\n  excludeIds: number[],\r\n  limit: number\r\n) {\r\n  console.log('≡ƒôè Using simple suggestion algorithm')\r\n\r\n  // Find users from same department or year\r\n  const suggestions = await users\r\n    .find({\r\n      id: { $nin: excludeIds },\r\n      $or: [\r\n        { department: currentUser.department, year: currentUser.year },\r\n        { department: currentUser.department },\r\n        { year: currentUser.year }\r\n      ]\r\n    })\r\n    .limit(limit)\r\n    .toArray()\r\n\r\n  // Get follower counts\r\n  const suggestionIds = suggestions.map((s: User) => s.id)\r\n  const followerCounts = await Promise.all(\r\n    suggestionIds.map(async (id: number) => {\r\n      const count = await followers.countDocuments({ following_id: id })\r\n      return { id, count }\r\n    })\r\n  )\r\n  const followerCountMap = new Map(followerCounts.map(fc => [fc.id, fc.count]))\r\n\r\n  const transformedSuggestions = suggestions.map((user: User) => ({\r\n    id: user.id,\r\n    name: user.name,\r\n    username: user.username,\r\n    department: user.department,\r\n    year: user.year,\r\n    profile_image: user.profile_image,\r\n    bio: user.bio,\r\n    follower_count: followerCountMap.get(user.id) || 0,\r\n    mutualFriends: 0,\r\n    reason: user.department === currentUser.department && user.year === currentUser.year\r\n      ? 'Same department and year'\r\n      : user.department === currentUser.department\r\n      ? 'Same department'\r\n      : 'Same year'\r\n  }))\r\n\r\n  console.log('Γ£à Returning', transformedSuggestions.length, 'simple suggestions')\r\n  return res.status(200).json({ suggestions: transformedSuggestions })\r\n}\r\n\r\n// Advanced suggestion algorithm with friends-of-friends\r\nasync function handleAdvancedSuggestions(\r\n  res: NextApiResponse,\r\n  users: any,\r\n  followers: any,\r\n  currentUser: User,\r\n  followingIds: number[],\r\n  excludeIds: number[],\r\n  limit: number\r\n) {\r\n  console.log('≡ƒºá Using advanced suggestion algorithm')\r\n\r\n  // Step 1: Get friends of friends (people followed by people you follow)\r\n  const friendsOfFriends = await followers\r\n    .find({ follower_id: { $in: followingIds } })\r\n    .toArray()\r\n\r\n  console.log('≡ƒæÑ Found', friendsOfFriends.length, 'friends-of-friends connections')\r\n\r\n  // Step 2: Count mutual friends and build suggestion scores\r\n  const suggestionMap = new Map<number, SuggestionScore>()\r\n\r\n  for (const fof of friendsOfFriends) {\r\n    const candidateId = fof.following_id\r\n\r\n    // Skip if already excluded\r\n    if (excludeIds.includes(candidateId)) continue\r\n\r\n    if (!suggestionMap.has(candidateId)) {\r\n      suggestionMap.set(candidateId, {\r\n        userId: candidateId,\r\n        mutualFriends: 0,\r\n        mutualFollowerIds: [],\r\n        sameDepartment: false,\r\n        sameYear: false,\r\n        sameCollege: false,\r\n        totalScore: 0\r\n      })\r\n    }\r\n\r\n    const score = suggestionMap.get(candidateId)!\r\n    score.mutualFriends++\r\n    score.mutualFollowerIds.push(fof.follower_id)\r\n  }\r\n\r\n  console.log('≡ƒôè Found', suggestionMap.size, 'potential suggestions')\r\n\r\n  // If we don't have enough suggestions, add users from same department/year\r\n  if (suggestionMap.size < limit) {\r\n    console.log('Γ₧ò Adding users from same department/year to fill suggestions')\r\n    \r\n    const sameDeptUsers = await users\r\n      .find({\r\n        id: { $nin: excludeIds },\r\n        $or: [\r\n          { department: currentUser.department, year: currentUser.year },\r\n          { department: currentUser.department },\r\n          { year: currentUser.year }\r\n        ]\r\n      })\r\n      .limit(limit * 2)\r\n      .toArray()\r\n\r\n    for (const user of sameDeptUsers) {\r\n      if (!suggestionMap.has(user.id)) {\r\n        suggestionMap.set(user.id, {\r\n          userId: user.id,\r\n          mutualFriends: 0,\r\n          mutualFollowerIds: [],\r\n          sameDepartment: user.department === currentUser.department,\r\n          sameYear: user.year === currentUser.year,\r\n          sameCollege: user.college_id === currentUser.college_id,\r\n          totalScore: 0\r\n        })\r\n      }\r\n    }\r\n  }\r\n\r\n  // Step 3: Get user details for all candidates\r\n  const candidateIds = Array.from(suggestionMap.keys())\r\n  const candidateUsers = await users\r\n    .find({ id: { $in: candidateIds } })\r\n    .toArray()\r\n\r\n  console.log('≡ƒæñ Fetched', candidateUsers.length, 'candidate user profiles')\r\n\r\n  // Step 4: Calculate scores\r\n  for (const user of candidateUsers) {\r\n    const score = suggestionMap.get(user.id)!\r\n    \r\n    // Update similarity flags\r\n    score.sameDepartment = user.department === currentUser.department\r\n    score.sameYear = user.year === currentUser.year\r\n    score.sameCollege = user.college_id === currentUser.college_id\r\n\r\n    // Calculate total score\r\n    let totalScore = 0\r\n    \r\n    // Mutual friends are most important (3 points each)\r\n    totalScore += score.mutualFriends * 3\r\n    \r\n    // Same department and year is very relevant (5 points)\r\n    if (score.sameDepartment && score.sameYear) {\r\n      totalScore += 5\r\n    } else if (score.sameDepartment) {\r\n      totalScore += 3\r\n    } else if (score.sameYear) {\r\n      totalScore += 2\r\n    }\r\n    \r\n    // Same college (1 point)\r\n    if (score.sameCollege) {\r\n      totalScore += 1\r\n    }\r\n\r\n    score.totalScore = totalScore\r\n  }\r\n\r\n  // Step 5: Sort by score and take top N\r\n  const sortedSuggestions = Array.from(suggestionMap.values())\r\n    .sort((a, b) => {\r\n      // Primary sort: total score\r\n      if (b.totalScore !== a.totalScore) {\r\n        return b.totalScore - a.totalScore\r\n      }\r\n      // Secondary sort: mutual friends\r\n      return b.mutualFriends - a.mutualFriends\r\n    })\r\n    .slice(0, limit)\r\n\r\n  // Step 6: Get follower counts and mutual friend names\r\n  const finalUserIds = sortedSuggestions.map(s => s.userId)\r\n  const followerCounts = await Promise.all(\r\n    finalUserIds.map(async (id: number) => {\r\n      const count = await followers.countDocuments({ following_id: id })\r\n      return { id, count }\r\n    })\r\n  )\r\n  const followerCountMap = new Map(followerCounts.map(fc => [fc.id, fc.count]))\r\n\r\n  // Get mutual friend details for display\r\n  const mutualFriendIds = new Set<number>()\r\n  sortedSuggestions.forEach(s => {\r\n    s.mutualFollowerIds.forEach(id => mutualFriendIds.add(id))\r\n  })\r\n  const mutualFriendUsers = await users\r\n    .find({ id: { $in: Array.from(mutualFriendIds) } })\r\n    .toArray()\r\n  const mutualFriendMap = new Map(mutualFriendUsers.map((u: User) => [u.id, u]))\r\n\r\n  // Step 7: Build final response\r\n  const transformedSuggestions = sortedSuggestions.map(score => {\r\n    const user = candidateUsers.find((u: User) => u.id === score.userId)\r\n    if (!user) return null\r\n\r\n    // Get names of mutual friends (up to 3)\r\n    const mutualFriendNames = score.mutualFollowerIds\r\n      .slice(0, 3)\r\n      .map(id => {\r\n        const friend = mutualFriendMap.get(id) as User | undefined\r\n        return friend?.name\r\n      })\r\n      .filter(Boolean) as string[]\r\n\r\n    // Generate reason text\r\n    let reason = ''\r\n    if (score.mutualFriends > 0) {\r\n      if (mutualFriendNames.length > 0) {\r\n        const friendsList = mutualFriendNames.join(', ')\r\n        const andMore = score.mutualFriends > mutualFriendNames.length \r\n          ? ` and ${score.mutualFriends - mutualFriendNames.length} other${score.mutualFriends - mutualFriendNames.length > 1 ? 's' : ''}`\r\n          : ''\r\n        reason = `Followed by ${friendsList}${andMore}`\r\n      } else {\r\n        reason = `${score.mutualFriends} mutual friend${score.mutualFriends > 1 ? 's' : ''}`\r\n      }\r\n    } else if (score.sameDepartment && score.sameYear) {\r\n      reason = `${user.department} ΓÇó ${user.year}${getYearSuffix(user.year)} Year`\r\n    } else if (score.sameDepartment) {\r\n      reason = `Same department (${user.department})`\r\n    } else if (score.sameYear) {\r\n      reason = `Same year (${user.year}${getYearSuffix(user.year)})`\r\n    } else {\r\n      reason = 'Suggested for you'\r\n    }\r\n\r\n    return {\r\n      id: user.id,\r\n      name: user.name,\r\n      username: user.username,\r\n      department: user.department,\r\n      year: user.year,\r\n      profile_image: user.profile_image,\r\n      bio: user.bio,\r\n      follower_count: followerCountMap.get(user.id) || 0,\r\n      mutualFriends: score.mutualFriends,\r\n      mutualFriendNames,\r\n      reason,\r\n      score: score.totalScore\r\n    }\r\n  }).filter(Boolean)\r\n\r\n  console.log('Γ£à Returning', transformedSuggestions.length, 'advanced suggestions')\r\n  console.log('≡ƒôè Top suggestion scores:', transformedSuggestions.slice(0, 3).map(s => s?.score))\r\n\r\n  return res.status(200).json({ suggestions: transformedSuggestions })\r\n}\r\n\r\nfunction getYearSuffix(year: number): string {\r\n  if (year === 1) return 'st'\r\n  if (year === 2) return 'nd'\r\n  if (year === 3) return 'rd'\r\n  return 'th'\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\pages\\api\\users\\upload-profile-pic.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\scripts\\init-social-graph.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":9,"column":25,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":9,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Social Graph Initialization Script\r\n * \r\n * Run this script to initialize the social graph indexes in MongoDB.\r\n * \r\n * Usage: node scripts/init-social-graph.js\r\n */\r\n\r\nconst { MongoClient } = require('mongodb')\r\n\r\n// MongoDB Connection\r\nconst MONGODB_URI = process.env.MONGODB_URI || process.env.DATABASE_URL || ''\r\nconst DB_NAME = process.env.MONGODB_DB_NAME || 'unix'\r\n\r\n// Collection names\r\nconst GraphCollections = {\r\n    GRAPH_EDGES: 'graph_edges',\r\n    USER_GRAPH_CACHE: 'user_graph_cache',\r\n}\r\n\r\nasync function initializeSocialGraph() {\r\n    console.log('≡ƒÜÇ Initializing Social Graph...\\n')\r\n\r\n    if (!MONGODB_URI) {\r\n        console.error('Γ¥î Error: MONGODB_URI environment variable is not set')\r\n        process.exit(1)\r\n    }\r\n\r\n    let client\r\n\r\n    try {\r\n        // Connect to MongoDB\r\n        console.log('Connecting to MongoDB...')\r\n        client = await MongoClient.connect(MONGODB_URI, {\r\n            maxPoolSize: 5,\r\n            serverSelectionTimeoutMS: 30000,\r\n        })\r\n\r\n        const db = client.db(DB_NAME)\r\n        console.log(`Γ£à Connected to database: ${DB_NAME}\\n`)\r\n\r\n        // Create graph_edges collection and indexes\r\n        console.log('Creating graph_edges indexes...')\r\n        const edgesCollection = db.collection(GraphCollections.GRAPH_EDGES)\r\n\r\n        // Unique compound index for relationship lookups\r\n        await edgesCollection.createIndex(\r\n            { sourceUserId: 1, targetUserId: 1 },\r\n            { unique: true, name: 'idx_source_target_unique' }\r\n        )\r\n        console.log('  Γ£ô Created unique index: sourceUserId + targetUserId')\r\n\r\n        // Index for fetching all users someone follows\r\n        await edgesCollection.createIndex(\r\n            { sourceUserId: 1 },\r\n            { name: 'idx_source' }\r\n        )\r\n        console.log('  Γ£ô Created index: sourceUserId')\r\n\r\n        // Index for fetching all followers of a user\r\n        await edgesCollection.createIndex(\r\n            { targetUserId: 1 },\r\n            { name: 'idx_target' }\r\n        )\r\n        console.log('  Γ£ô Created index: targetUserId')\r\n\r\n        // Index for sorting by interaction weight\r\n        await edgesCollection.createIndex(\r\n            { sourceUserId: 1, interactionWeight: -1 },\r\n            { name: 'idx_source_weight' }\r\n        )\r\n        console.log('  Γ£ô Created index: sourceUserId + interactionWeight')\r\n\r\n        // Index for time-based queries\r\n        await edgesCollection.createIndex(\r\n            { lastInteractionTimestamp: -1 },\r\n            { name: 'idx_last_interaction' }\r\n        )\r\n        console.log('  Γ£ô Created index: lastInteractionTimestamp')\r\n\r\n        // Index for created_at queries\r\n        await edgesCollection.createIndex(\r\n            { createdAt: -1 },\r\n            { name: 'idx_created' }\r\n        )\r\n        console.log('  Γ£ô Created index: createdAt\\n')\r\n\r\n        // Verify indexes\r\n        const indexes = await edgesCollection.indexes()\r\n        console.log(`≡ƒôè Total indexes on graph_edges: ${indexes.length}`)\r\n        indexes.forEach(idx => {\r\n            console.log(`   - ${idx.name}: ${JSON.stringify(idx.key)}`)\r\n        })\r\n\r\n        console.log('\\nΓ£à Social Graph initialization complete!')\r\n        console.log('\\nAvailable API Endpoints:')\r\n        console.log('  POST   /api/graph/follow      - Follow a user')\r\n        console.log('  DELETE /api/graph/follow      - Unfollow a user')\r\n        console.log('  GET    /api/graph/followers   - Get followers list')\r\n        console.log('  GET    /api/graph/following   - Get following list')\r\n        console.log('  GET    /api/graph/relationship- Check relationship strength')\r\n        console.log('  GET    /api/graph/mutual      - Get mutual connections')\r\n        console.log('  GET    /api/graph/suggestions - Get user suggestions')\r\n        console.log('  POST   /api/graph/interaction - Record an interaction')\r\n        console.log('  GET    /api/graph/stats       - Get graph statistics')\r\n\r\n    } catch (error) {\r\n        console.error('Γ¥î Error initializing social graph:', error)\r\n        process.exit(1)\r\n    } finally {\r\n        if (client) {\r\n            await client.close()\r\n            console.log('\\n≡ƒöî MongoDB connection closed')\r\n        }\r\n    }\r\n}\r\n\r\n// Run the initialization\r\ninitializeSocialGraph()\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\scripts\\migrate-categories.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[664,667],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[664,667],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\nasync function migrateCategories() {\n  try {\n    console.log('≡ƒöä Starting category migration...');\n\n    // Mapping old enum values to new ones\n    const categoryMapping = {\n      'EVENT': 'EVENTS',\n      'INTERNSHIP': 'GENERAL', // Map internships to general for now\n      'WORKSHOP': 'ACADEMIC',  // Map workshops to academic\n      'LIBRARY_MEMORY': 'GENERAL' // Map library memory to general\n    };\n\n    // Get all posts with their current categories\n    const posts = await prisma.$queryRaw`\n      SELECT id, category FROM \"Post\" \n    `;\n\n    console.log(`≡ƒôè Found ${(posts as any[]).length} posts to migrate`);\n\n    // Update each post's category using raw SQL to bypass enum constraints\n    for (const mapping of Object.entries(categoryMapping)) {\n      const [oldCategory, newCategory] = mapping;\n      \n      const result = await prisma.$executeRaw`\n        UPDATE \"Post\" SET category = ${newCategory}\n        WHERE category::text = ${oldCategory}\n      `;\n      \n      console.log(`Γ£à Updated ${result} posts from ${oldCategory} to ${newCategory}`);\n    }\n\n    console.log('≡ƒÄë Category migration completed successfully!');\n  } catch (error) {\n    console.error('Γ¥î Migration failed:', error);\n    throw error;\n  } finally {\n    await prisma.$disconnect();\n  }\n}\n\nmigrateCategories()\n  .catch((error) => {\n    console.error(error);\n    process.exit(1);\n  });","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\scripts\\migration-helper.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\scripts\\test-mongodb-connection.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":8,"column":25,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":8,"endColumn":43},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":9,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":9,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Test MongoDB Connection\r\n * Run this to verify your MongoDB connection before deploying\r\n * \r\n * Usage: node scripts/test-mongodb-connection.js\r\n */\r\n\r\nconst { MongoClient } = require('mongodb');\r\nrequire('dotenv').config({ path: '.env.local' });\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI;\r\nconst DB_NAME = process.env.MONGODB_DB_NAME || 'unix';\r\n\r\nasync function testConnection() {\r\n  console.log('≡ƒöì Testing MongoDB connection...\\n');\r\n  \r\n  if (!MONGODB_URI) {\r\n    console.error('Γ¥î ERROR: MONGODB_URI is not set in .env.local');\r\n    process.exit(1);\r\n  }\r\n\r\n  // Check if using local or Atlas\r\n  const isLocal = MONGODB_URI.includes('127.0.0.1') || MONGODB_URI.includes('localhost');\r\n  console.log(`≡ƒôì Connection Type: ${isLocal ? 'LOCAL MongoDB' : 'MongoDB ATLAS (Cloud)'}`);\r\n  console.log(`≡ƒöù URI: ${MONGODB_URI.replace(/\\/\\/([^:]+):([^@]+)@/, '//$1:****@')}\\n`);\r\n\r\n  if (isLocal) {\r\n    console.log('ΓÜá∩╕Å  WARNING: You are using LOCAL MongoDB!');\r\n    console.log('   This will NOT work on Vercel deployment.');\r\n    console.log('   Please use MongoDB Atlas for production.\\n');\r\n  }\r\n\r\n  let client;\r\n  try {\r\n    console.log('ΓÅ│ Connecting...');\r\n    \r\n    client = await MongoClient.connect(MONGODB_URI, {\r\n      maxPoolSize: 10,\r\n      serverSelectionTimeoutMS: 10000,\r\n      connectTimeoutMS: 10000,\r\n      ...(isLocal && { directConnection: true }),\r\n    });\r\n\r\n    console.log('Γ£à Successfully connected to MongoDB!');\r\n    \r\n    const db = client.db(DB_NAME);\r\n    console.log(`≡ƒôª Database: ${DB_NAME}`);\r\n    \r\n    // Test database access\r\n    await db.admin().ping();\r\n    console.log('Γ£à Database ping successful!\\n');\r\n    \r\n    // List collections\r\n    const collections = await db.listCollections().toArray();\r\n    console.log(`≡ƒôè Collections (${collections.length}):`);\r\n    collections.forEach(col => {\r\n      console.log(`   - ${col.name}`);\r\n    });\r\n    \r\n    // Test users collection\r\n    const users = db.collection('users');\r\n    const userCount = await users.countDocuments();\r\n    console.log(`\\n≡ƒæÑ Total users: ${userCount}`);\r\n    \r\n    console.log('\\nΓ£à All tests passed! Your MongoDB connection is working.\\n');\r\n    \r\n    if (isLocal) {\r\n      console.log('ΓÜá∩╕Å  REMINDER: Switch to MongoDB Atlas before deploying to Vercel!');\r\n    } else {\r\n      console.log('Γ£à You are using MongoDB Atlas - ready for Vercel deployment!');\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('\\nΓ¥î Connection failed!');\r\n    console.error('Error:', error.message);\r\n    \r\n    if (error.message.includes('ENOTFOUND') || error.message.includes('querySrv')) {\r\n      console.error('\\n≡ƒÆí DNS resolution failed. Solutions:');\r\n      console.error('   1. Check your internet connection');\r\n      console.error('   2. Verify the MongoDB URI is correct');\r\n      console.error('   3. Check if VPN/proxy is blocking MongoDB Atlas');\r\n    } else if (error.message.includes('ECONNREFUSED')) {\r\n      console.error('\\n≡ƒÆí Connection refused. Solutions:');\r\n      console.error('   1. Make sure MongoDB is running (if local)');\r\n      console.error('   2. Check if MongoDB Atlas cluster is running');\r\n      console.error('   3. Verify your IP is whitelisted (0.0.0.0/0)');\r\n    } else if (error.message.includes('Authentication failed')) {\r\n      console.error('\\n≡ƒÆí Authentication failed. Solutions:');\r\n      console.error('   1. Check your MongoDB username and password');\r\n      console.error('   2. Make sure the user has proper permissions');\r\n    }\r\n    \r\n    process.exit(1);\r\n  } finally {\r\n    if (client) {\r\n      await client.close();\r\n      console.log('\\n≡ƒöî Connection closed.');\r\n    }\r\n  }\r\n}\r\n\r\ntestConnection();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\server.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":41},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":19,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":4,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":4,"endColumn":40},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":5,"column":13,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":5,"endColumn":36}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const { createServer } = require('http');\r\nconst { parse } = require('url');\r\nconst next = require('next');\r\nconst { Server } = require('socket.io');\r\nconst jwt = require('jsonwebtoken');\r\n\r\nconst dev = process.env.NODE_ENV !== 'production';\r\nconst hostname = 'localhost';\r\nconst port = process.env.PORT || 3000;\r\n\r\nconst app = next({ dev, hostname, port });\r\nconst handle = app.getRequestHandler();\r\n\r\n// Database connection keeper to prevent Neon hibernation\r\nfunction startDatabaseKeeper() {\r\n  const keepAliveInterval = 4 * 60 * 1000; // 4 minutes\r\n  \r\n  setInterval(async () => {\r\n    try {\r\n      // Use health endpoint to keep database alive\r\n      const response = await fetch(`http://localhost:${port}/api/health`, {\r\n        method: 'GET',\r\n        headers: { 'Connection': 'keep-alive' }\r\n      }).catch(() => null);\r\n      \r\n      if (response?.ok) {\r\n        console.log('≡ƒöä Database connection keep-alive successful');\r\n      } else {\r\n        console.warn('ΓÜá∩╕Å Database keep-alive failed - server response:', response?.status);\r\n      }\r\n    } catch (error) {\r\n      console.warn('ΓÜá∩╕Å Database keep-alive error:', error.message);\r\n    }\r\n  }, keepAliveInterval);\r\n  \r\n  console.log('≡ƒÜÇ Database connection keeper started (4min intervals)');\r\n}\r\n\r\napp.prepare().then(() => {\r\n  const server = createServer((req, res) => {\r\n    handle(req, res, parse(req.url, true));\r\n  });\r\n\r\n  // Initialize Socket.io with authentication\r\n  const io = new Server(server, {\r\n    cors: {\r\n      origin: process.env.NODE_ENV === 'production' ? false : \"*\",\r\n      methods: [\"GET\", \"POST\"],\r\n      credentials: true\r\n    }\r\n  });\r\n\r\n  // Authentication middleware\r\n  io.use(async (socket, next) => {\r\n    try {\r\n      const token = socket.handshake.auth.token;\r\n      if (!token) {\r\n        return next(new Error('No token provided'));\r\n      }\r\n\r\n      const decoded = jwt.verify(token, process.env.JWT_SECRET);\r\n      if (!decoded || !decoded.userId) {\r\n        return next(new Error('Invalid token'));\r\n      }\r\n\r\n      socket.userId = decoded.userId;\r\n      socket.userName = decoded.name || `User ${decoded.userId}`;\r\n      next();\r\n    } catch (error) {\r\n      console.error('Socket authentication error:', error);\r\n      next(new Error('Authentication failed'));\r\n    }\r\n  });\r\n\r\n  // Socket.io connection handling\r\n  io.on('connection', (socket) => {\r\n    console.log(`Γ£à User ${socket.userName} (${socket.userId}) connected:`, socket.id);\r\n\r\n    // Auto-join user to their personal room\r\n    socket.join(`user-${socket.userId}`);\r\n    console.log(`≡ƒæñ User ${socket.userId} auto-joined room user-${socket.userId}`);\r\n\r\n    // Join conversation room\r\n    socket.on('join-conversation', (conversationId) => {\r\n      socket.join(`conversation-${conversationId}`);\r\n      console.log(`Socket ${socket.id} joined conversation-${conversationId}`);\r\n    });\r\n\r\n    // Leave conversation room\r\n    socket.on('leave-conversation', (conversationId) => {\r\n      socket.leave(`conversation-${conversationId}`);\r\n      console.log(`Socket ${socket.id} left conversation-${conversationId}`);\r\n    });\r\n\r\n    // Handle new message with database storage\r\n    socket.on('send-message', async (messageData) => {\r\n      try {\r\n        const { receiverId, messageText, mediaUrl, clientId, replyToId } = messageData;\r\n        \r\n        if (!receiverId || (!messageText?.trim() && !mediaUrl)) {\r\n          socket.emit('error', { message: 'Invalid message data' });\r\n          return;\r\n        }\r\n\r\n        // Store message in database via API\r\n        const response = await fetch(`http://localhost:${port}/api/messages`, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            'Authorization': `Bearer ${socket.handshake.auth.token}`\r\n          },\r\n          body: JSON.stringify({\r\n            receiverId: parseInt(receiverId),\r\n            messageText: messageText?.trim(),\r\n            replyToId: replyToId || null\r\n          })\r\n        });\r\n\r\n        if (!response.ok) {\r\n          const errorText = await response.text();\r\n          throw new Error(`Failed to save message: ${errorText}`);\r\n        }\r\n\r\n        const result = await response.json();\r\n        const savedMessage = result.message;\r\n        \r\n        // Format for frontend\r\n        const formattedMessage = {\r\n          id: savedMessage.id,\r\n          senderId: savedMessage.sender_id,\r\n          receiverId: savedMessage.receiver_id,\r\n          messageText: savedMessage.message_text,\r\n          mediaUrl: savedMessage.media_url,\r\n          createdAt: savedMessage.created_at,\r\n          sender: savedMessage.sender,\r\n          receiver: savedMessage.receiver,\r\n          replyTo: savedMessage.replyTo || null,\r\n          clientId: clientId || undefined\r\n        };\r\n\r\n        // Emit to conversation room\r\n        const conversationId = [socket.userId, parseInt(receiverId)].sort().join('-');\r\n        io.to(`conversation-${conversationId}`).emit('new-message', formattedMessage);\r\n        \r\n        // Also emit to receiver's personal room\r\n        io.to(`user-${receiverId}`).emit('message-notification', {\r\n          message: formattedMessage,\r\n          from: { id: socket.userId, name: socket.userName }\r\n        });\r\n\r\n        console.log(`Message sent from ${socket.userId} to ${receiverId}`);\r\n      } catch (error) {\r\n        console.error('Error sending message:', error);\r\n        socket.emit('error', { message: 'Failed to send message' });\r\n      }\r\n    });\r\n\r\n    // Generic notifications (likes, comments, follows)\r\n    socket.on('notify', (payload) => {\r\n      // payload: { userId, type, message, meta }\r\n      const { userId, type, message, meta } = payload || {}\r\n      if (!userId || !type) return\r\n      io.to(`user-${userId}`).emit('notification', {\r\n        id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\r\n        type,\r\n        message,\r\n        time: new Date().toISOString(),\r\n        read: false,\r\n        ...meta\r\n      })\r\n    })\r\n\r\n    // Handle typing indicators\r\n    socket.on('typing-start', (data) => {\r\n      socket.to(`conversation-${data.conversationId}`).emit('user-typing', {\r\n        userId: data.userId,\r\n        userName: data.userName\r\n      });\r\n    });\r\n\r\n    socket.on('typing-stop', (data) => {\r\n      socket.to(`conversation-${data.conversationId}`).emit('user-stopped-typing', {\r\n        userId: data.userId\r\n      });\r\n    });\r\n\r\n    // Handle message read status\r\n    socket.on('mark-messages-read', (data) => {\r\n      socket.to(`conversation-${data.conversationId}`).emit('messages-marked-read', {\r\n        conversationId: data.conversationId,\r\n        userId: data.userId,\r\n        readAt: new Date()\r\n      });\r\n    });\r\n\r\n    // Handle user online status\r\n    socket.on('user-online', () => {\r\n      socket.broadcast.emit('user-status-change', {\r\n        userId: socket.userId,\r\n        status: 'online',\r\n        lastSeen: new Date()\r\n      });\r\n    });\r\n\r\n    socket.on('disconnect', () => {\r\n      console.log(`User ${socket.userName} (${socket.userId}) disconnected:`, socket.id);\r\n      // Handle user going offline\r\n      socket.broadcast.emit('user-status-change', {\r\n        userId: socket.userId,\r\n        status: 'offline',\r\n        lastSeen: new Date()\r\n      });\r\n    });\r\n  });\r\n\r\n  // Make io available globally for API routes\r\n  global.io = io;\r\n\r\n  // Start database connection keeper\r\n  setTimeout(() => {\r\n    startDatabaseKeeper();\r\n  }, 10000); // Wait 10 seconds after server start\r\n\r\n  server\r\n    .once('error', (err) => {\r\n      console.error(err);\r\n      process.exit(1);\r\n    })\r\n    .listen(port, () => {\r\n      console.log(`> Ready on http://${hostname}:${port}`);\r\n      console.log('> Socket.io server initialized');\r\n    });\r\n});","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\socket-server.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":41},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":40},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":13,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":36},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":4,"column":17,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":4,"endColumn":35}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const { createServer } = require('http');\r\nconst { Server } = require('socket.io');\r\nconst jwt = require('jsonwebtoken');\r\nconst express = require('express');\r\n\r\nconst app = express();\r\nconst port = process.env.SOCKET_PORT || process.env.PORT || 3001;\r\n\r\n// Health check endpoint\r\napp.get('/health', (req, res) => {\r\n  res.json({ status: 'ok', timestamp: new Date().toISOString() });\r\n});\r\n\r\nconst server = createServer(app);\r\n\r\n// Initialize Socket.io with CORS for your Next.js app\r\nconst allowedOrigins = [\r\n  'http://localhost:3000',\r\n  'http://localhost:3001',\r\n  process.env.CORS_ORIGIN,\r\n  process.env.NEXT_PUBLIC_APP_URL\r\n].filter(Boolean);\r\n\r\nconst io = new Server(server, {\r\n  cors: {\r\n    origin: (origin, callback) => {\r\n      // Allow requests with no origin (like mobile apps or Postman)\r\n      if (!origin) return callback(null, true);\r\n      \r\n      // Check if origin is in allowed list or if we're using wildcard in development\r\n      if (allowedOrigins.includes(origin) || (process.env.NODE_ENV === 'development' && !process.env.CORS_ORIGIN)) {\r\n        callback(null, true);\r\n      } else {\r\n        callback(new Error('Not allowed by CORS'));\r\n      }\r\n    },\r\n    methods: [\"GET\", \"POST\"],\r\n    credentials: true\r\n  },\r\n  transports: ['polling', 'websocket'],\r\n  allowEIO3: true\r\n});\r\n\r\n// Authentication middleware\r\nio.use(async (socket, next) => {\r\n  try {\r\n    const token = socket.handshake.auth.token;\r\n    if (!token) {\r\n      return next(new Error('No token provided'));\r\n    }\r\n\r\n    // Validate JWT_SECRET is configured\r\n    if (!process.env.JWT_SECRET) {\r\n      console.error('Γ¥î CRITICAL: JWT_SECRET not configured in socket server');\r\n      return next(new Error('Server configuration error'));\r\n    }\r\n\r\n    // Enhanced JWT verification matching lib/auth.ts\r\n    const decoded = jwt.verify(token, process.env.JWT_SECRET, {\r\n      algorithms: ['HS256'],\r\n      issuer: 'unix-social',\r\n      audience: 'unix-api'\r\n    });\r\n    \r\n    if (!decoded || !decoded.userId) {\r\n      return next(new Error('Invalid token'));\r\n    }\r\n\r\n    socket.userId = decoded.userId;\r\n    socket.userName = decoded.name || `User ${decoded.userId}`;\r\n    socket.tokenJti = decoded.jti; // Store token ID for potential revocation\r\n    next();\r\n  } catch (error) {\r\n    console.error('Socket authentication error:', error.message);\r\n    \r\n    // Provide specific error messages\r\n    if (error.name === 'JsonWebTokenError') {\r\n      return next(new Error('Authentication failed: Invalid token signature'));\r\n    } else if (error.name === 'TokenExpiredError') {\r\n      return next(new Error('Authentication failed: Token expired'));\r\n    } else if (error.name === 'NotBeforeError') {\r\n      return next(new Error('Authentication failed: Token not active'));\r\n    }\r\n    \r\n    next(new Error('Authentication failed'));\r\n  }\r\n});\r\n\r\n// Socket.io connection handling\r\nio.on('connection', (socket) => {\r\n  console.log(`Γ£à User ${socket.userName} (${socket.userId}) connected:`, socket.id);\r\n\r\n  // Auto-join user to their personal room\r\n  socket.join(`user-${socket.userId}`);\r\n  console.log(`≡ƒæñ User ${socket.userId} auto-joined room user-${socket.userId}`);\r\n\r\n  // Join conversation room\r\n  socket.on('join-conversation', (conversationId) => {\r\n    socket.join(`conversation-${conversationId}`);\r\n    console.log(`Socket ${socket.id} joined conversation-${conversationId}`);\r\n  });\r\n\r\n  // Leave conversation room\r\n  socket.on('leave-conversation', (conversationId) => {\r\n    socket.leave(`conversation-${conversationId}`);\r\n    console.log(`Socket ${socket.id} left conversation-${conversationId}`);\r\n  });\r\n\r\n  // Handle new message with database storage\r\n  socket.on('send-message', async (messageData) => {\r\n    try {\r\n      const { receiverId, messageText, mediaUrl, clientId, replyToId } = messageData;\r\n      \r\n      if (!receiverId || (!messageText?.trim() && !mediaUrl)) {\r\n        console.error('Invalid message data:', messageData);\r\n        socket.emit('message-error', { \r\n          message: 'Invalid message data',\r\n          clientId \r\n        });\r\n        return;\r\n      }\r\n\r\n      // Call your Next.js API to store message\r\n      const apiUrl = process.env.NEXTJS_API_URL || 'http://localhost:3000';\r\n      console.log(`≡ƒôñ Sending message to API: ${apiUrl}/api/messages`);\r\n      \r\n      const response = await fetch(`${apiUrl}/api/messages`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${socket.handshake.auth.token}`\r\n        },\r\n        body: JSON.stringify({\r\n          receiverId: parseInt(receiverId),\r\n          messageText: messageText?.trim(),\r\n          replyToId: replyToId || null\r\n        })\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        console.error(`API Error (${response.status}):`, errorText);\r\n        throw new Error(`Failed to save message: ${response.status} ${errorText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      const savedMessage = result.message;\r\n      \r\n      // Format for frontend\r\n      const formattedMessage = {\r\n        id: savedMessage.id,\r\n        senderId: savedMessage.sender_id,\r\n        receiverId: savedMessage.receiver_id,\r\n        messageText: savedMessage.message_text,\r\n        mediaUrl: savedMessage.media_url,\r\n        createdAt: savedMessage.created_at,\r\n        sender: savedMessage.sender,\r\n        receiver: savedMessage.receiver,\r\n        replyTo: savedMessage.replyTo || null,\r\n        clientId: clientId || undefined\r\n      };\r\n\r\n      // Emit to conversation room\r\n      const conversationId = [socket.userId, parseInt(receiverId)].sort().join('-');\r\n      io.to(`conversation-${conversationId}`).emit('new-message', formattedMessage);\r\n      \r\n      // Also emit to receiver's personal room\r\n      io.to(`user-${receiverId}`).emit('message-notification', {\r\n        message: formattedMessage,\r\n        from: { id: socket.userId, name: socket.userName }\r\n      });\r\n\r\n      console.log(`Γ£à Message sent from ${socket.userId} to ${receiverId}`);\r\n    } catch (error) {\r\n      console.error('Γ¥î Error sending message:', error.message);\r\n      console.error('Stack:', error.stack);\r\n      socket.emit('message-error', { \r\n        message: error.message || 'Failed to send message',\r\n        clientId: messageData?.clientId \r\n      });\r\n    }\r\n  });\r\n\r\n  // Typing indicators\r\n  socket.on('typing', ({ otherUserId, userId, userName }) => {\r\n    io.to(`user-${otherUserId}`).emit('user-typing', { userId, userName });\r\n  });\r\n\r\n  socket.on('stop-typing', ({ otherUserId, userId }) => {\r\n    io.to(`user-${otherUserId}`).emit('user-stopped-typing', { userId });\r\n  });\r\n\r\n  // User status\r\n  socket.on('user-online', () => {\r\n    socket.broadcast.emit('user-status', { userId: socket.userId, status: 'online' });\r\n  });\r\n\r\n  socket.on('user-offline', (userId) => {\r\n    socket.broadcast.emit('user-status', { userId, status: 'offline' });\r\n  });\r\n\r\n  socket.on('disconnect', (reason) => {\r\n    console.log(`≡ƒöî User ${socket.userId} disconnected:`, reason);\r\n    socket.broadcast.emit('user-status', { userId: socket.userId, status: 'offline' });\r\n  });\r\n\r\n  socket.on('error', (error) => {\r\n    console.error('Socket error:', error);\r\n  });\r\n});\r\n\r\nserver.listen(port, () => {\r\n  console.log(`≡ƒÜÇ Socket.IO server running on port ${port}`);\r\n  console.log(`≡ƒôí Accepting connections from: ${process.env.CORS_ORIGIN || '*'}`);\r\n  console.log(`≡ƒöù Health check: http://localhost:${port}/health`);\r\n});\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', () => {\r\n  console.log('SIGTERM signal received: closing HTTP server');\r\n  server.close(() => {\r\n    console.log('HTTP server closed');\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\socket-server\\health-check.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":41,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":41,"endColumn":25}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const http = require('http');\r\nconst https = require('https');\r\n\r\nconst colors = {\r\n  reset: '\\x1b[0m',\r\n  green: '\\x1b[32m',\r\n  red: '\\x1b[31m',\r\n  yellow: '\\x1b[33m',\r\n  blue: '\\x1b[36m'\r\n};\r\n\r\nasync function checkHealth(urlString) {\r\n  return new Promise((resolve) => {\r\n    try {\r\n      console.log(`${colors.blue}Checking: ${urlString}${colors.reset}`);\r\n      \r\n      const url = new URL(urlString);\r\n      const protocol = url.protocol === 'https:' ? https : http;\r\n      \r\n      const req = protocol.get(urlString, (res) => {\r\n        let data = '';\r\n        \r\n        res.on('data', (chunk) => {\r\n          data += chunk;\r\n        });\r\n        \r\n        res.on('end', () => {\r\n          try {\r\n            const json = JSON.parse(data);\r\n            \r\n            if (res.statusCode === 200) {\r\n              console.log(`${colors.green}Γ£à Server is healthy${colors.reset}`);\r\n              console.log(`   Status: ${json.status}`);\r\n              console.log(`   Connections: ${json.connections || 0}`);\r\n              console.log(`   Uptime: ${Math.floor(json.uptime || 0)}s`);\r\n              resolve(true);\r\n            } else {\r\n              console.log(`${colors.red}Γ¥î Server returned error (${res.statusCode})${colors.reset}`);\r\n              resolve(false);\r\n            }\r\n          } catch (error) {\r\n            console.log(`${colors.red}Γ¥î Invalid JSON response${colors.reset}`);\r\n            resolve(false);\r\n          }\r\n        });\r\n      });\r\n      \r\n      req.on('error', (error) => {\r\n        console.log(`${colors.red}Γ¥î Cannot connect: ${error.code || error.message}${colors.reset}`);\r\n        console.log(`   Error details:`, error);\r\n        resolve(false);\r\n      });\r\n      \r\n      req.setTimeout(10000, () => {\r\n        req.destroy();\r\n        console.log(`${colors.red}Γ¥î Request timeout${colors.reset}`);\r\n        resolve(false);\r\n      });\r\n      \r\n    } catch (error) {\r\n      console.log(`${colors.red}Γ¥î Cannot connect: ${error.message}${colors.reset}`);\r\n      resolve(false);\r\n    }\r\n  });\r\n}\r\n\r\nasync function main() {\r\n  console.log('\\n≡ƒöì Socket.IO Server Health Check\\n');\r\n  console.log('================================\\n');\r\n\r\n  const serverUrl = process.env.SOCKET_URL || 'http://localhost:3001';\r\n  \r\n  console.log(`Testing: ${serverUrl}\\n`);\r\n\r\n  const healthy = await checkHealth(`${serverUrl}/health`);\r\n\r\n  console.log('\\n================================\\n');\r\n\r\n  if (healthy) {\r\n    console.log(`${colors.green}≡ƒÄë Socket server is running!${colors.reset}\\n`);\r\n    console.log('Next steps:');\r\n    console.log('1. Make sure NEXT_PUBLIC_SOCKET_URL is set in your main app');\r\n    console.log('2. Restart your Next.js dev server');\r\n    console.log('3. Open your app and check browser console');\r\n  } else {\r\n    console.log(`${colors.red}ΓÜá∩╕Å  Socket server is not responding${colors.reset}\\n`);\r\n    console.log('Troubleshooting:');\r\n    console.log('1. Make sure the server is running: npm run dev');\r\n    console.log('2. Check the URL is correct');\r\n    console.log('3. Check firewall settings');\r\n    console.log('4. Check if port 3001 is available');\r\n  }\r\n\r\n  console.log('');\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\socket-server\\keep-alive.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":16,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":16,"endColumn":31},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":17,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":17,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Keep-Alive Service\r\n * \r\n * This script pings your Render socket server every 14 minutes\r\n * to prevent it from going to sleep (free tier sleeps after 15 min inactivity)\r\n * \r\n * Usage:\r\n *   node keep-alive.js\r\n * \r\n * Or add to package.json:\r\n *   \"keep-alive\": \"node keep-alive.js\"\r\n */\r\n\r\nconst https = require('https');\r\nconst http = require('http');\r\n\r\n// Your Render socket server URL\r\nconst SOCKET_URL = process.env.SOCKET_URL || 'http://localhost:3001';\r\nconst PING_INTERVAL = 14 * 60 * 1000; // 14 minutes in milliseconds\r\n\r\nconsole.log('≡ƒöÑ Keep-Alive Service Started');\r\nconsole.log(`≡ƒôí Target: ${SOCKET_URL}`);\r\nconsole.log(`ΓÅ▒∩╕Å  Interval: 14 minutes\\n`);\r\n\r\nfunction ping() {\r\n  const url = new URL(`${SOCKET_URL}/health`);\r\n  const protocol = url.protocol === 'https:' ? https : http;\r\n  \r\n  const startTime = Date.now();\r\n  \r\n  protocol.get(url.toString(), (res) => {\r\n    const duration = Date.now() - startTime;\r\n    \r\n    if (res.statusCode === 200) {\r\n      console.log(`Γ£à [${new Date().toLocaleTimeString()}] Ping successful (${duration}ms)`);\r\n    } else {\r\n      console.log(`ΓÜá∩╕Å  [${new Date().toLocaleTimeString()}] Ping returned ${res.statusCode}`);\r\n    }\r\n  }).on('error', (err) => {\r\n    console.error(`Γ¥î [${new Date().toLocaleTimeString()}] Ping failed:`, err.message);\r\n  });\r\n}\r\n\r\n// First ping immediately\r\nping();\r\n\r\n// Then ping every 14 minutes\r\nsetInterval(ping, PING_INTERVAL);\r\n\r\nconsole.log('≡ƒÜÇ First ping sent. Will ping every 14 minutes...\\n');\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\socket-server\\server.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":1,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":18},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":4,"column":17,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":4,"endColumn":35},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":5,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":5,"endColumn":41},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":6,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":6,"endColumn":40},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":7,"column":13,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":7,"endColumn":36},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":8,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":8,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'senderId' is assigned a value but never used.","line":62,"column":32,"nodeType":null,"messageId":"unusedVar","endLine":62,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'receiverId' is assigned a value but never used.","line":62,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":62,"endColumn":52}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Load environment variables from .env file\r\nrequire('dotenv').config();\r\n\r\nconst express = require('express');\r\nconst { createServer } = require('http');\r\nconst { Server } = require('socket.io');\r\nconst jwt = require('jsonwebtoken');\r\nconst cors = require('cors');\r\n\r\nconst app = express();\r\nconst server = createServer(app);\r\n\r\n// Environment variables\r\nconst PORT = process.env.PORT || 3001;\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';\r\nconst FRONTEND_URL = process.env.FRONTEND_URL || 'http://localhost:3000';\r\nconst API_BASE_URL = process.env.API_BASE_URL || 'http://localhost:3000';\r\n\r\n// CORS configuration\r\napp.use(cors({\r\n  origin: [FRONTEND_URL, 'https://uni-x.vercel.app', 'https://uni-x-zeta.vercel.app'],\r\n  credentials: true\r\n}));\r\n\r\n// Health check endpoint\r\napp.get('/', (req, res) => {\r\n  res.json({\r\n    status: 'ok',\r\n    message: 'Socket.IO server is running',\r\n    timestamp: new Date().toISOString()\r\n  });\r\n});\r\n\r\napp.get('/health', (req, res) => {\r\n  res.json({\r\n    status: 'healthy',\r\n    connections: io.engine.clientsCount,\r\n    uptime: process.uptime()\r\n  });\r\n});\r\n\r\n// Endpoint to emit message unsend event\r\napp.post('/emit-message-unsend', express.json(), (req, res) => {\r\n  try {\r\n    const { messageId, senderId, receiverId } = req.body;\r\n\r\n    // Notify both users\r\n    io.to(`user-${senderId}`).emit('message-unsent', { messageId });\r\n    io.to(`user-${receiverId}`).emit('message-unsent', { messageId });\r\n\r\n    console.log(`≡ƒôñ Message ${messageId} unsent notification sent`);\r\n    res.status(200).json({ success: true });\r\n  } catch (error) {\r\n    console.error('Error emitting message unsend:', error);\r\n    res.status(500).json({ error: 'Failed to emit event' });\r\n  }\r\n});\r\n\r\n// Endpoint to emit message delete event\r\napp.post('/emit-message-delete', express.json(), (req, res) => {\r\n  try {\r\n    const { messageId, userId, senderId, receiverId } = req.body;\r\n\r\n    // Only notify the user who deleted it (for their other devices)\r\n    io.to(`user-${userId}`).emit('message-deleted', { messageId });\r\n\r\n    console.log(`≡ƒùæ∩╕Å Message ${messageId} delete notification sent to user ${userId}`);\r\n    res.status(200).json({ success: true });\r\n  } catch (error) {\r\n    console.error('Error emitting message delete:', error);\r\n    res.status(500).json({ error: 'Failed to emit event' });\r\n  }\r\n});\r\n\r\n// Track online users: Map<userId, Set<socketId>>\r\nconst onlineUsers = new Map();\r\n\r\n// Helper to check if user is online\r\nconst isUserOnline = (userId) => onlineUsers.has(userId) && onlineUsers.get(userId).size > 0;\r\n\r\n// Helper to get online user IDs\r\nconst getOnlineUserIds = () => Array.from(onlineUsers.keys());\r\n\r\n// Endpoint to get online users\r\napp.get('/online-users', (req, res) => {\r\n  res.json({\r\n    onlineUsers: getOnlineUserIds(),\r\n    count: onlineUsers.size\r\n  });\r\n});\r\n\r\n// Initialize Socket.io with CORS\r\nconst io = new Server(server, {\r\n  cors: {\r\n    origin: [FRONTEND_URL, 'https://uni-x-zeta.vercel.app'],\r\n    methods: [\"GET\", \"POST\"],\r\n    credentials: true\r\n  },\r\n  transports: ['websocket', 'polling'],\r\n  allowEIO3: true,\r\n  pingTimeout: 60000,\r\n  pingInterval: 25000\r\n});\r\n\r\n// Authentication middleware\r\nio.use(async (socket, next) => {\r\n  try {\r\n    const token = socket.handshake.auth.token;\r\n    if (!token) {\r\n      return next(new Error('No token provided'));\r\n    }\r\n\r\n    if (!JWT_SECRET || JWT_SECRET === 'your-secret-key') {\r\n      console.error('Γ¥î CRITICAL: JWT_SECRET not configured properly!');\r\n      return next(new Error('Server configuration error'));\r\n    }\r\n\r\n    // Enhanced JWT verification matching lib/auth.ts\r\n    const decoded = jwt.verify(token, JWT_SECRET, {\r\n      algorithms: ['HS256'],\r\n      issuer: 'unix-social',\r\n      audience: 'unix-api'\r\n    });\r\n\r\n    if (!decoded || !decoded.userId) {\r\n      return next(new Error('Invalid token'));\r\n    }\r\n\r\n    socket.userId = decoded.userId;\r\n    socket.userName = decoded.name || `User ${decoded.userId}`;\r\n    socket.tokenJti = decoded.jti; // Store token ID\r\n    next();\r\n  } catch (error) {\r\n    console.error('Γ¥î Socket authentication error:', error.message);\r\n\r\n    if (error.name === 'JsonWebTokenError') {\r\n      return next(new Error('Authentication failed: Invalid token signature'));\r\n    } else if (error.name === 'TokenExpiredError') {\r\n      return next(new Error('Authentication failed: Token expired'));\r\n    } else if (error.name === 'NotBeforeError') {\r\n      return next(new Error('Authentication failed: Token not active'));\r\n    }\r\n\r\n    next(new Error('Authentication failed'));\r\n  }\r\n});\r\n\r\n// Socket.io connection handling\r\nio.on('connection', (socket) => {\r\n  console.log(`Γ£à User ${socket.userName} (${socket.userId}) connected:`, socket.id);\r\n\r\n  // Track user as online\r\n  if (!onlineUsers.has(socket.userId)) {\r\n    onlineUsers.set(socket.userId, new Set());\r\n  }\r\n  onlineUsers.get(socket.userId).add(socket.id);\r\n\r\n  // Broadcast online status\r\n  socket.broadcast.emit('user-status-change', {\r\n    userId: socket.userId,\r\n    status: 'online',\r\n    lastSeen: new Date()\r\n  });\r\n\r\n  // Auto-join user to their personal room\r\n  socket.join(`user-${socket.userId}`);\r\n  console.log(`≡ƒæñ User ${socket.userId} auto-joined room user-${socket.userId}`);\r\n\r\n  // Join conversation room\r\n  socket.on('join-conversation', (conversationId) => {\r\n    socket.join(`conversation-${conversationId}`);\r\n    console.log(`Socket ${socket.id} joined conversation-${conversationId}`);\r\n  });\r\n\r\n  // Leave conversation room\r\n  socket.on('leave-conversation', (conversationId) => {\r\n    socket.leave(`conversation-${conversationId}`);\r\n    console.log(`Socket ${socket.id} left conversation-${conversationId}`);\r\n  });\r\n\r\n  // Handle new message with database storage\r\n  socket.on('send-message', async (messageData) => {\r\n    try {\r\n      const { receiverId, messageText, mediaUrl, clientId, replyToId } = messageData;\r\n\r\n      if (!receiverId || (!messageText?.trim() && !mediaUrl)) {\r\n        console.error('Γ¥î Invalid message data:', messageData);\r\n        socket.emit('message-error', {\r\n          message: 'Invalid message data',\r\n          clientId\r\n        });\r\n        return;\r\n      }\r\n\r\n      console.log(`≡ƒôñ Sending message from ${socket.userId} to ${receiverId}`);\r\n\r\n      // Store message in database via API\r\n      const response = await fetch(`${API_BASE_URL}/api/messages`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${socket.handshake.auth.token}`\r\n        },\r\n        body: JSON.stringify({\r\n          receiverId: parseInt(receiverId),\r\n          messageText: messageText?.trim(),\r\n          replyToId: replyToId || null\r\n        })\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        console.error(`Γ¥î API Error (${response.status}):`, errorText);\r\n        throw new Error(`Failed to save message: ${response.status} - ${errorText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      const savedMessage = result.message;\r\n\r\n      // Format for frontend\r\n      const formattedMessage = {\r\n        id: savedMessage.id,\r\n        senderId: savedMessage.sender_id,\r\n        receiverId: savedMessage.receiver_id,\r\n        messageText: savedMessage.message_text,\r\n        mediaUrl: savedMessage.media_url,\r\n        createdAt: savedMessage.created_at,\r\n        sender: savedMessage.sender,\r\n        receiver: savedMessage.receiver,\r\n        replyTo: savedMessage.replyTo || null,\r\n        clientId: clientId || undefined\r\n      };\r\n\r\n      // Emit to conversation room\r\n      const conversationId = [socket.userId, parseInt(receiverId)].sort().join('-');\r\n      io.to(`conversation-${conversationId}`).emit('new-message', formattedMessage);\r\n\r\n      // Also emit to receiver's personal room\r\n      io.to(`user-${receiverId}`).emit('message-notification', {\r\n        message: formattedMessage,\r\n        from: { id: socket.userId, name: socket.userName }\r\n      });\r\n\r\n      // Send acknowledgment to sender (message saved successfully)\r\n      socket.emit('message-ack', {\r\n        clientId,\r\n        messageId: savedMessage.id,\r\n        status: 'sent',\r\n        sentAt: new Date().toISOString()\r\n      });\r\n\r\n      // If receiver is online, it will be delivered immediately\r\n      if (isUserOnline(parseInt(receiverId))) {\r\n        socket.emit('message-delivered', {\r\n          messageId: savedMessage.id,\r\n          clientId,\r\n          deliveredTo: parseInt(receiverId),\r\n          deliveredAt: new Date().toISOString()\r\n        });\r\n      }\r\n\r\n      console.log(`Γ£à Message sent from ${socket.userId} to ${receiverId}`);\r\n    } catch (error) {\r\n      console.error('Γ¥î Error sending message:', error.message);\r\n      console.error('Stack:', error.stack);\r\n      socket.emit('message-error', {\r\n        message: error.message || 'Failed to send message',\r\n        clientId: messageData?.clientId\r\n      });\r\n    }\r\n  });\r\n\r\n  // Generic notifications (likes, comments, follows)\r\n  socket.on('notify', (payload) => {\r\n    const { userId, type, message, meta } = payload || {}\r\n    if (!userId || !type) return\r\n    io.to(`user-${userId}`).emit('notification', {\r\n      id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\r\n      type,\r\n      message,\r\n      time: new Date().toISOString(),\r\n      read: false,\r\n      ...meta\r\n    })\r\n  })\r\n\r\n  // Handle typing indicators\r\n  socket.on('typing-start', (data) => {\r\n    socket.to(`conversation-${data.conversationId}`).emit('user-typing', {\r\n      userId: data.userId,\r\n      userName: data.userName\r\n    });\r\n  });\r\n\r\n  socket.on('typing-stop', (data) => {\r\n    socket.to(`conversation-${data.conversationId}`).emit('user-stopped-typing', {\r\n      userId: data.userId\r\n    });\r\n  });\r\n\r\n  // Handle message received acknowledgment (for delivery status)\r\n  socket.on('message-received', (data) => {\r\n    const { messageId, senderId } = data;\r\n    if (!messageId || !senderId) return;\r\n\r\n    // Notify sender that message was delivered\r\n    io.to(`user-${senderId}`).emit('message-delivered', {\r\n      messageId,\r\n      deliveredTo: socket.userId,\r\n      deliveredAt: new Date().toISOString()\r\n    });\r\n    console.log(`≡ƒô¼ Message ${messageId} delivered to user ${socket.userId}`);\r\n  });\r\n\r\n  // Handle message read status (for read receipts)\r\n  socket.on('mark-messages-read', (data) => {\r\n    const { conversationId, messageIds, senderId } = data;\r\n\r\n    // Notify conversation participants\r\n    socket.to(`conversation-${conversationId}`).emit('messages-marked-read', {\r\n      conversationId,\r\n      messageIds: messageIds || [],\r\n      readBy: socket.userId,\r\n      readAt: new Date().toISOString()\r\n    });\r\n\r\n    // Also notify sender's personal room for multi-device sync\r\n    if (senderId) {\r\n      io.to(`user-${senderId}`).emit('messages-read', {\r\n        messageIds: messageIds || [],\r\n        readBy: socket.userId,\r\n        readAt: new Date().toISOString()\r\n      });\r\n    }\r\n\r\n    console.log(`≡ƒæü∩╕Å Messages marked read by user ${socket.userId}`);\r\n  });\r\n\r\n  // Handle user online status\r\n  socket.on('user-online', () => {\r\n    socket.broadcast.emit('user-status-change', {\r\n      userId: socket.userId,\r\n      status: 'online',\r\n      lastSeen: new Date()\r\n    });\r\n  });\r\n\r\n  socket.on('user-offline', (userId) => {\r\n    socket.broadcast.emit('user-status-change', {\r\n      userId: userId || socket.userId,\r\n      status: 'offline',\r\n      lastSeen: new Date()\r\n    });\r\n  });\r\n\r\n  socket.on('disconnect', () => {\r\n    console.log(`Γ¥î User ${socket.userName} (${socket.userId}) disconnected:`, socket.id);\r\n\r\n    // Remove socket from online tracking\r\n    if (onlineUsers.has(socket.userId)) {\r\n      onlineUsers.get(socket.userId).delete(socket.id);\r\n      // If no more sockets for this user, remove from map and broadcast offline\r\n      if (onlineUsers.get(socket.userId).size === 0) {\r\n        onlineUsers.delete(socket.userId);\r\n        socket.broadcast.emit('user-status-change', {\r\n          userId: socket.userId,\r\n          status: 'offline',\r\n          lastSeen: new Date()\r\n        });\r\n      }\r\n    }\r\n  });\r\n});\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGTERM', () => {\r\n  console.log('SIGTERM signal received: closing HTTP server');\r\n  server.close(() => {\r\n    console.log('HTTP server closed');\r\n  });\r\n});\r\n\r\n// Start server\r\nserver.listen(PORT, () => {\r\n  console.log(`≡ƒÜÇ Socket.IO server running on port ${PORT}`);\r\n  console.log(`≡ƒôí Accepting connections from: ${FRONTEND_URL}`);\r\n  console.log(`≡ƒöù API Base URL: ${API_BASE_URL}`);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\tailwind.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Projects\\UNI-X\\test-mongo-connection.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":25,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":43},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":4,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":4,"endColumn":29}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Test MongoDB Connection\r\nconst { MongoClient } = require('mongodb')\r\nconst fs = require('fs')\r\nconst path = require('path')\r\n\r\n// Read .env.local file manually\r\nconst envPath = path.join(__dirname, '.env.local')\r\nconst envContent = fs.readFileSync(envPath, 'utf8')\r\nconst envLines = envContent.split('\\n')\r\n\r\nenvLines.forEach(line => {\r\n  const match = line.match(/^([^#][^=]*)=(.*)$/)\r\n  if (match) {\r\n    const key = match[1].trim()\r\n    const value = match[2].trim().replace(/^[\"']|[\"']$/g, '')\r\n    process.env[key] = value\r\n  }\r\n})\r\n\r\nconst uri = process.env.MONGODB_URI\r\n\r\nconsole.log('≡ƒöì Testing MongoDB Connection...')\r\nconsole.log('≡ƒôì URI:', uri?.replace(/:[^:@]*@/, ':****@')) // Hide password\r\n\r\nasync function testConnection() {\r\n  try {\r\n    console.log('\\nΓÅ│ Attempting to connect...')\r\n    \r\n    const client = await MongoClient.connect(uri, {\r\n      serverSelectionTimeoutMS: 10000,\r\n      connectTimeoutMS: 10000,\r\n      directConnection: true, // Direct connection to single server\r\n    })\r\n    \r\n    console.log('Γ£à Successfully connected to MongoDB!')\r\n    \r\n    // Test database access\r\n    const db = client.db('unix')\r\n    await db.admin().ping()\r\n    console.log('Γ£à Database ping successful!')\r\n    \r\n    // List collections\r\n    const collections = await db.listCollections().toArray()\r\n    console.log(`\\n≡ƒôª Found ${collections.length} collections:`)\r\n    collections.forEach(col => console.log(`   - ${col.name}`))\r\n    \r\n    await client.close()\r\n    console.log('\\nΓ£à Connection test completed successfully!')\r\n    process.exit(0)\r\n    \r\n  } catch (error) {\r\n    console.error('\\nΓ¥î Connection failed:', error.message)\r\n    \r\n    if (error.message.includes('ENOTFOUND') || error.message.includes('querySrv') || error.message.includes('ECONNREFUSED')) {\r\n      console.error('\\n≡ƒÆí DNS Resolution Error - Try these fixes:')\r\n      console.error('   1. Check your internet connection')\r\n      console.error('   2. Flush DNS cache: ipconfig /flushdns')\r\n      console.error('   3. Change DNS to Google (8.8.8.8) or Cloudflare (1.1.1.1)')\r\n      console.error('   4. Disable VPN/proxy temporarily')\r\n      console.error('   5. Check Windows Firewall settings')\r\n    }\r\n    \r\n    process.exit(1)\r\n  }\r\n}\r\n\r\ntestConnection()\r\n","usedDeprecatedRules":[]}]
